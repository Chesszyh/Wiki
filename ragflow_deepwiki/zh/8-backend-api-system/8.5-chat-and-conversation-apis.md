# 8.5 聊天与对话 API (Chat and Conversation APIs)

相关源文件：

- [api/apps/sdk/session.py](https://github.com/infiniflow/ragflow/blob/80a16e71/api/apps/sdk/session.py)
- [api/db/services/dialog_service.py](https://github.com/infiniflow/ragflow/blob/80a16e71/api/db/services/dialog_service.py)
- [api/db/services/conversation_service.py](https://github.com/infiniflow/ragflow/blob/80a16e71/api/db/services/conversation_service.py)
- [rag/nlp/search.py](https://github.com/infiniflow/ragflow/blob/80a16e71/rag/nlp/search.py)
- [rag/prompts/generator.py](https://github.com/infiniflow/ragflow/blob/80a16e71/rag/prompts/generator.py)

本文档详细介绍了 RAGFlow 中的聊天补全（Chat Completion）和会话管理 API，涵盖了原生端点和 OpenAI 兼容端点。这些 API 实现了基于知识库检索的问答（RAG）、自动引用插入以及多轮对话追踪。

---

## 概述 (Overview)

RAGFlow 提供两种类型的对话接口：

1.  **聊天助手 (Chat Assistants)**：基于 `Dialog` 模型，通过 LLM 结合数据集检索生成带引用的回答。会话通过 `Conversation` 会话进行追踪。
2.  **智能体工作流 (Agent Workflows)**：基于 `UserCanvas` 模型，执行多步推理工作流。会话通过 `API4Conversation` 会话进行追踪。

两种接口均支持流式响应（Streaming）、会话持久化以及 OpenAI 兼容协议。

---

## 聊天补全流程 (Chat Completion Flow)

### 端到端 RAG 管道
典型的 RAG 聊天补全请求流程如下：
1.  **解析与验证**：验证 API Token 并获取请求 JSON。
2.  **模型绑定**：根据助手配置绑定嵌入模型、聊天模型和重排序模型。
3.  **查询预处理**：可选的多轮查询精炼（Refine）、跨语言翻译或关键词提取。
4.  **混合检索**：在向量数据库中执行全文检索与向量搜索，并进行加权融合。
5.  **重排序**：使用 Rerank 模型对检索结果进行精细打分。
6.  **提示词组装**：将检索到的切片（Chunks）按 Token 预算填入上下文。
7.  **LLM 生成**：调用模型生成回答，支持 SSE 流式传输。
8.  **引用处理**：自动计算回答与切片的相似度，并插入 `[ID:n]` 形式的引用。

---

## 会话管理 (Session Management)

### 会话生命周期
- **创建会话**：`POST /api/v1/chats/{chat_id}/sessions`。初始化时会包含助手配置中的“开场白（Prologue）”。
- **更新会话**：`PUT /api/v1/chats/{chat_id}/sessions/{session_id}`。通常用于修改会话名称。
- **列出会话**：`GET /api/v1/chats/{chat_id}/sessions`。支持分页和排序，返回历史消息及对应的引用数据。
- **删除会话**：`DELETE /api/v1/chats/{chat_id}/sessions`。支持批量删除。

---

## 聊天补全接口 (Chat Completion APIs)

### RAGFlow 原生格式
**端点**: `POST /api/v1/chats/{chat_id}/completions`

**关键参数**：
- `question`: 用户问题。
- `stream`: 是否启用 SSE 流式传输（默认开启）。
- `quote`: 是否自动插入引用。
- `doc_ids`: 可选的文档 ID 列表，用于在检索时限制范围。

### OpenAI 兼容格式
**端点**: `POST /api/v1/chats_openai/{chat_id}/chat/completions`

遵循 OpenAI 的 [Chat Completions API](https://platform.openai.com/docs/api-reference/chat/create) 格式。支持通过 `extra_body` 传递 `reference: true` 来获取引用数据。

---

## 高级特性 (Advanced Features)

### 引用机制 (Citation Mechanisms)
RAGFlow 会自动处理引用：
- **语义引用**：如果模型没有生成 `[ID:n]`，系统会通过句子级相似度计算自动插入引用。
- **引用修复**：自动纠正模型生成的非标准引用格式（如 `(ID:12)` -> `[ID:12]`）。

### 查询精炼 (Query Refinement)
支持基于对话历史重写当前问题，使其成为一个独立、完整的查询词，提高检索精度。

### SQL 检索
对于结构化数据集，系统支持使用 LLM 生成 SQL 并在数据库上执行，直接返回表格数据和引用。

### 推理模式 (Reasoning Mode)
支持 Deep Research 等任务，实时流式输出模型的思考过程（Thought process）。

---

## 性能优化 (Performance Optimizations)

- **Token 预算控制**：动态计算历史消息和切片占用的 Token，确保不超出上下文窗口。
- **流式块阈值**：累积超过 16 个 Token 才发送一次流式块，减少网络开销。
- **耗时指标**：响应中包含详细的耗时分解（检索耗时、生成耗时等），便于性能监控。
- **Langfuse 集成**：支持对接 Langfuse 进行全链路 LLM 调用追踪。
