# 9.7 画布 API 与管理 (Canvas API and Management)

相关源文件：

- [agent/canvas.py](https://github.com/infiniflow/ragflow/blob/80a16e71/agent/canvas.py)
- [api/apps/canvas_app.py](https://github.com/infiniflow/ragflow/blob/80a16e71/api/apps/canvas_app.py)
- [api/db/services/canvas_service.py](https://github.com/infiniflow/ragflow/blob/80a16e71/api/db/services/canvas_service.py)
- [api/db/services/conversation_service.py](https://github.com/infiniflow/ragflow/blob/80a16e71/api/db/services/conversation_service.py)

本页面介绍了用于管理和执行画布工作流的 HTTP API 端点。画布 API 提供了针对 CRUD 操作、执行控制、调试、版本管理和会话追踪的 RESTful 接口。

---

## API 端点组织 (API Endpoint Organization)

画布 API 主要由 `api/apps/canvas_app.py` 实现，功能划分为以下几类：
- **CRUD 操作**：`/set` (保存/更新), `/get` (获取), `/rm` (删除), `/list` (列表)。
- **执行控制**：`/completion` (流式执行), `/cancel` (取消执行), `/reset` (重置状态)。
- **调试与辅助**：`/debug` (组件隔离调试), `/test_db_connect` (测试数据库连接), `/trace` (获取执行日志)。
- **版本与模板**：`/getlistversion` (版本列表), `/templates` (获取画布模板)。

---

## 画布 CRUD 操作 (Canvas CRUD Operations)

### 创建与更新
`/set` 端点统一处理画布的创建与更新。画布数据包含 DSL 定义、元数据以及版本信息。系统在保存时会自动创建版本快照，命名格式为 `{标题}_{时间戳}`。

### 获取与列表
- **`/get/<id>`**：用于 Web UI 访问（基于 Session）。
- **`/getsse/<id>`**：用于 API/SDK 访问（基于 Token）。
- **`/list`**：支持多租户查询，可根据关键字、分类、所有者等进行分页过滤。

---

## 画布执行 API (Canvas Execution API)

### 流式执行 (SSE)
`/completion` 端点通过 Server-Sent Events (SSE) 执行画布，实时推送 `workflow_started`、`node_started`、`message`、`node_finished` 等事件。

**请求参数**：
- `id`：画布 ID。
- `query`：用户问题（映射至 `sys.query`）。
- `inputs`：预设的组件输入值，用于参数化执行。

---

## 状态与版本管理 (State and Version Management)

### 重置状态
`/reset` 端点会调用 `canvas.reset()`，清空执行历史、检索上下文和 Redis 中的日志/取消标志，但保留 DSL 定义。

### 版本管理
系统在每次保存画布时都会在 `UserCanvasVersion` 表中插入一条记录。用户可以通过 `/getlistversion` 查看历史版本，并通过 `/getversion` 检索特定版本的 DSL。

---

## 调试与测试 (Debugging and Testing)

### 组件调试
`/debug` 端点允许在隔离环境下测试单个组件。它接收组件 ID 和模拟输入，完全消费组件产生的任何流式输出，并返回最终结果 JSON。

### 数据库连接测试
`/test_db_connect` 用于在保存组件配置前验证数据库凭据。支持 MySQL、PostgreSQL、MSSQL、DB2 和 Trino 等多种类型。

---

## 访问控制与多租户 (Access Control)

所有操作均强制执行所有权检查。用户只能操作自己拥有的画布。在列表查询中，系统会自动合并用户个人画布及其所属租户（组织）内共享的画布。

---

## 总结 (Summary)

画布 API 为 RAGFlow 的可视化编排能力提供了强大的后端支撑：
- **全生命周期管理**：涵盖从模板起步、可视化编辑到版本回滚的全流程。
- **高性能执行引擎**：支持流式反馈和分布式任务取消。
- **完善的调试工具**：提供组件级隔离测试和详细的工具执行轨迹（Trace）。
- **企业级安全**：多租户隔离与细粒度的权限校验。
