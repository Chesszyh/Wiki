# 9.4 工作流执行与流式输出 (Workflow Execution and Streaming)

相关源文件：

- [agent/canvas.py](https://github.com/infiniflow/ragflow/blob/80a16e71/agent/canvas.py)
- [agent/component/agent_with_tools.py](https://github.com/infiniflow/ragflow/blob/80a16e71/agent/component/agent_with_tools.py)
- [agent/component/base.py](https://github.com/infiniflow/ragflow/blob/80a16e71/agent/component/base.py)
- [api/apps/canvas_app.py](https://github.com/infiniflow/ragflow/blob/80a16e71/api/apps/canvas_app.py)

本文档介绍了 **画布工作流执行引擎**，该引擎负责编排异步组件执行，并通过服务器发送事件 (SSE) 传输实时事件。`Canvas` 类实现了一个基于图的执行模型，支持取消、错误恢复和动态路径规划。

---

## 工作流执行概述 (Workflow Execution Overview)

### Canvas.run() 方法
`Canvas.run()` 异步生成器是智能体工作流的核心执行引擎。它采用路径驱动模型，按 `self.path` 顺序执行组件，并支持将独立的组件划分为批次并行运行。

**执行特征**：
- **异步生成器**：实时产生 SSE 事件以更新前端状态。
- **并发控制**：在 `_run_batch()` 中利用线程池并发执行不相关的组件。
- **容错处理**：支持通过异常处理器进行路径跳转（Goto）或返回默认值。

---

## SSE 事件流 (SSE Event Streaming)

画布以 JSON 对象形式生成统一结构的 SSE 事件。

### 事件类型
| 事件类型 | 触发时机 | 包含数据 |
| --- | --- | --- |
| `workflow_started` | 执行开始前 | 输入参数 |
| `node_started` | 组件执行前 | 组件 ID、类型、思考内容 (Thoughts) |
| `node_finished` | 组件执行后 | 输入/输出数据、耗时、错误信息 |
| `message` | 消息组件流式输出中 | 文本块、音频二进制、思考状态标志 |
| `message_end` | 消息组件结束后 | 状态码、附件、引用信息 |
| `workflow_finished`| 工作流成功结束后 | 最终输出、总耗时 |
| `user_inputs` | 遇到 `UserFillUp` 组件时 | 待填写的表单模式、提示信息 |

---

## 异步组件执行 (Async Component Execution)

### 批量执行模型
`_run_batch()` 函数负责并发执行组件：
1. **取消检查**：在批次开始前检查 Redis 取消标志。
2. **依赖校验**：若组件引用的上游组件尚未执行，则跳过该组件。
3. **异步探测**：优先调用 `invoke_async`，否则在线程中运行 `invoke`。
4. **并发协同**：使用 `asyncio.gather()` 等待当前批次内所有任务完成。

---

## 消息组件流式处理 (Message Component Streaming)

当 `Message` 组件输出流式内容时，画布会逐块处理：
- **流式探测**：检测到输出为 `partial()` 生成器。
- **TTS 集成**：若开启 `auto_play`，文本将按 16 字符缓冲并转换为语音二进制。
- **思考标签**：识别 `<think>` 标签并发出对应的开始/结束思考事件。
- **引用检测**：识别 `[ID:n]` 标记，并在 `message_end` 事件中附带对应的切片和文档元数据。

---

## 取消机制 (Cancellation Mechanism)

工作流支持基于 Redis 的分布式取消：
- **Redis 标志**：API 接收取消请求后设置 `{task_id}-cancel` 键。
- **多点检查**：画布在批次间隙及组件内部逻辑点调用 `is_canceled()`。一旦检测到标志，抛出 `TaskCanceledException` 并通过 SSE 发出通知。

---

## 错误处理与恢复 (Error Handling and Recovery)

组件可定义自定义异常处理器：
- **跳转 (Goto)**：发生错误时，将执行路径重定向到预设的补偿组件。
- **默认值 (Default)**：忽略错误并返回一个预设的“降级”回复。
- **停止**：若无处理器且发生错误，设置 `self.error` 并中断工作流。

---

## 总结 (Summary)

画布执行引擎结合了 `asyncio` 的高性能和 SSE 的实时性，提供了以下能力：
- **高并发执行**：通过批次化处理最大化利用系统资源。
- **富交互体验**：支持流式文本、实时语音及思考过程展示。
- **稳健的生命周期管理**：涵盖了从任务初始化、中途干预（UserFillUp）到异常恢复的全流程。
