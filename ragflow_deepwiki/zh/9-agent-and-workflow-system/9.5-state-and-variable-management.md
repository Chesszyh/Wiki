# 9.5 状态与变量管理 (State and Variable Management)

相关源文件：

- [agent/canvas.py](https://github.com/infiniflow/ragflow/blob/80a16e71/agent/canvas.py)
- [agent/component/agent_with_tools.py](https://github.com/infiniflow/ragflow/blob/80a16e71/agent/component/agent_with_tools.py)
- [agent/component/base.py](https://github.com/infiniflow/ragflow/blob/80a16e71/agent/component/base.py)
- [api/apps/canvas_app.py](https://github.com/infiniflow/ragflow/blob/80a16e71/api/apps/canvas_app.py)

本文档描述了 RAGFlow 智能体画布系统在工作流执行期间如何管理状态和变量，涵盖了变量命名空间、解析机制、组件输入/输出管理以及全局状态持久化。

---

## 概述 (Overview)

画布工作流引擎 (`agent.canvas.Canvas`) 通过层级化的变量系统维护状态。该系统主要包括：
- **系统变量** (`sys.*`)：由运行时管理，追踪用户输入、对话上下文等。
- **环境变量** (`env.*`)：用户在 DSL 中定义，跨工作流运行持久化。
- **组件输出** (`{component_id@output_name}`)：存储组件的执行结果，供下游组件引用。

---

## 变量命名空间 (Variable Namespaces)

### 系统变量命名空间 (`sys.*`)
提供执行上下文，并在每次工作流开始时初始化。
- `sys.query`：当前用户查询。
- `sys.user_id`：租户/用户标识符。
- `sys.conversation_turns`：对话轮数（跨轮次递增）。
- `sys.files`：上传的图片（Base64）或解析后的文档文本。

### 环境变量命名空间 (`env.*`)
由用户在工作流 DSL 中定义，通常用于存储 API 密钥、配置阈值等。支持 `string`、`number`、`boolean`、`object` 和 `array` 类型。

### 组件输出命名空间
允许通过 `{component_id@output_name}` 引用其他组件的输出，形成数据流依赖。支持通过点号（`.`）访问嵌套属性，如 `{retrieval_0@chunks.0.content}`。

---

## 变量解析机制 (Variable Resolution)

### 解析逻辑
系统使用正则表达式扫描字符串中的变量引用，并按以下步骤解析：
1. **模式匹配**：通过正则表达式识别 `{{...}}` 或 `{...}`。
2. **命名空间查找**：判断是 `sys`、`env` 还是组件输出。
3. **嵌套路径遍历**：如果包含点号，则递归地在字典、列表或对象属性中查找。
4. **值替换**：将解析后的运行时值替换回原字符串。

### 延迟计算与流式处理
如果引用的变量是一个 `partial` 生成器（如流式生成的回复），解析引擎会自动消费生成器并缓冲完整文本，以确保变量替换的正确性。

---

## 组件输入/输出管理 (Input/Output Management)

组件通过内部的输入（inputs）和输出（outputs）字典管理其状态。

- **输入解析**：在组件调用 `_invoke` 前，系统会调用 `get_input()`，自动解析其参数中引用的所有画布变量。
- **输出存储**：组件执行完成后，通过 `set_output()` 将结果存入 `_param.outputs`。特殊键（如 `_ERROR`, `_elapsed_time`）用于存储元数据。

---

## 状态持久化与重置 (State Persistence and Reset)

### DSL 序列化
画布状态通过 `__str__` 方法序列化为 JSON DSL 格式，包含历史记录、检索结果、记忆和变量。该状态被存储在数据库中，以支持跨会话的对话。

### 状态重置
`reset(mem=False)` 方法用于清除执行状态。
- **系统变量**：重置为类型默认值（如空字符串、0）。
- **环境变量**：恢复为 DSL 中定义的初始值。
- **记忆与历史**：除非 `mem=True`，否则会被清空。

---

## 总结 (Summary)

状态与变量管理系统为 RAGFlow 的数据流编程提供了灵活且类型感知的机制：
- **解耦定义与执行**：通过变量引用实现组件间的松耦合。
- **复杂的路径支持**：支持对深层嵌套数据的精确访问。
- **跨运行持久化**：确保了多轮对话和复杂工作流的连贯性。
