# 10.2 混合搜索架构 (Hybrid Search Architecture)

相关源文件：

- [api/db/services/dialog_service.py](https://github.com/infiniflow/ragflow/blob/80a16e71/api/db/services/dialog_service.py)
- [rag/nlp/query.py](https://github.com/infiniflow/ragflow/blob/80a16e71/rag/nlp/query.py)
- [rag/nlp/search.py](https://github.com/infiniflow/ragflow/blob/80a16e71/rag/nlp/search.py)
- [rag/svr/task_executor.py](https://github.com/infiniflow/ragflow/blob/80a16e71/rag/svr/task_executor.py)

本页面详细介绍了 RAGFlow 的混合搜索架构，该架构结合了向量相似度搜索与全文匹配，以检索相关的文档切片。系统通过融合语义理解（通过嵌入向量）和精确关键词匹配，提高了针对多样化查询类型的检索质量。

---

## 架构概览 (Architecture Overview)

混合搜索架构通过多阶段流水线运行：
1. **表达式构建**：将自然语言查询转化为结构化的搜索表达式。
2. **并行搜索**：在底层存储引擎（Elasticsearch/Infinity）中同时执行向量搜索和全文搜索。
3. **分数融合**：使用可配置权重的 `weighted_sum` 将两路分数进行融合。
4. **结果重排序**：对融合后的候选结果进行二次打分。

---

## 核心组件 (Core Components)

### Dealer 类
`Dealer` 类 (`rag/nlp/search.py`) 是检索操作的协调者：
- **`qryr` (FulltextQueryer)**：负责文本处理、分词和相似度计算。
- **`dataStore` (DocStoreConnection)**：数据库接口，封装了对不同存储引擎的 `search` 调用。

### 搜索表达式类型
- **MatchText**：全文匹配表达式，作用于 `content_ltks` 和 `title_tks` 字段。
- **MatchDense**：向量相似度表达式，作用于 `q_N_vec` 字段（N 为向量维度）。
- **FusionExpr**：融合表达式，使用 `weighted_sum` 结合上述两路得分。默认权重为：5% 全文匹配 + 95% 向量相似度。

---

## 混合搜索执行流程 (Execution Flow)

### 检索接口 (`retrieval`)
`Dealer.retrieval()` 提供给聊天系统调用的高级接口，其流程如下：
1. **计算 Rerank 限制**：通常选取前 64 条候选数据进行重排序。
2. **执行混合搜索**：调用 `Dealer.search()`。
3. **归一化处理**：
   - **Infinity 引擎**：由于引擎内部已完成归一化和分数融合，可直接使用。
   - **Elasticsearch 引擎**：引擎未提供自动归一化，需调用 `rerank()` 方法重新计算相似度并归一化。
4. **格式化输出**：返回包含总数、切片详情及文档聚合信息的字典。

---

## 回退策略 (Fallback Strategies)

混合搜索具备多级回退机制，以防结果不足：
- **精确过滤回退**：如果设置了 `doc_id` 过滤但无匹配，则返回该文档的所有内容。
- **阈值放宽回退**：自动将关键词匹配要求从 `min_match=0.3` 降至 `0.1`，将相似度阈值从 `0.2` 降至 `0.17`。

---

## 引擎特定行为 (Engine-Specific Behavior)

RAGFlow 适配了多种后端引擎：
- **Infinity**：原生支持向量、全文和加权融合的原子操作，性能更佳，返回分数已归一化。
- **Elasticsearch**：需要通过 Python 代码处理各路搜索分数的归一化及二次重排序（Rerank）。

---

## 总结 (Summary)

混合搜索架构是 RAGFlow 高质量回答的基础：
- **语义与词法的平衡**：通过 5:95 的经典权重分配，兼顾语义深度与术语精确度。
- **自适应检索**：通过多级回退确保即使在极端条件下也能提供背景知识。
- **高度集成**：紧密结合了嵌入模型、分词器和多种底层数据库，为上层智能体和对话系统提供了统一的知识召回能力。
