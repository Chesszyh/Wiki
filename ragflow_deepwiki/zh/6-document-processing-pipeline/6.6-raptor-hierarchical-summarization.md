# 6.6 RAPTOR 分层摘要 (RAPTOR Hierarchical Summarization)

相关源文件：

- [agent/tools/retrieval.py](https://github.com/infiniflow/ragflow/blob/80a16e71/agent/tools/retrieval.py)
- [api/apps/chunk_app.py](https://github.com/infiniflow/ragflow/blob/80a16e71/api/apps/chunk_app.py)
- [api/db/services/dialog_service.py](https://github.com/infiniflow/ragflow/blob/80a16e71/api/db/services/dialog_service.py)
- [api/db/services/document_service.py](https://github.com/infiniflow/ragflow/blob/80a16e71/api/db/services/document_service.py)
- [rag/nlp/search.py](https://github.com/infiniflow/ragflow/blob/80a16e71/rag/nlp/search.py)
- [rag/svr/task_executor.py](https://github.com/infiniflow/ragflow/blob/80a16e71/rag/svr/task_executor.py)
- [rag/raptor.py](https://github.com/infiniflow/ragflow/blob/80a16e71/rag/raptor.py)

RAPTOR (Recursive Abstractive Processing for Tree-Organized Retrieval，树状组织检索的递归抽象处理) 是一种高级文档处理技术，它通过现有的文档切片创建多级分层摘要。该方法通过在不同粒度级别生成抽象表示，显著提高了检索质量，从而实现针对复杂查询更有效的上下文检索。

有关其他高级检索功能的信息，请参阅 [知识图谱构建 (GraphRAG and Knowledge Graph Construction)](/zh/6-document-processing-pipeline/6.5-knowledge-graph-construction)。有关基础文档解析和切片策略，请参阅 [文档处理流水线 (Document Processing Pipeline)](/zh/6-document-processing-pipeline)。

## 概述与目的 (Overview and Purpose)

RAPTOR 解决了检索增强生成 (RAG) 中的一个核心挑战：为给定查询寻找合适的抽象级别。传统的 RAG 系统检索的是单个切片，而 RAPTOR 生成分层摘要，捕捉从详细的叶子节点到高层抽象摘要的多个尺度。

该系统的工作原理如下：
1.  根据语义相似度对现有文档切片进行**聚类 (Clustering)**。
2.  使用 LLM 为每个聚类生成**摘要 (Summaries)**。
3.  创建包含这些摘要的新 **"raptor" 切片**。
4.  递归重复此过程以构建**树状结构 (Tree Structure)**。
5.  将所有级别的摘要与原始切片一同索引以供检索。

**核心优势：**
-   **多尺度检索**：同时回答细节性问题和宏观性问题。
-   **上下文连贯性**：相关的切片被分组并共同总结。
-   **提高召回率**：更广泛的摘要有助于检索到相关的详细切片。
-   **可配置范围**：可按单个文档操作，也可跨整个数据集操作。

## 配置参数 (Configuration Parameters)

RAPTOR 处理通过知识库解析器配置中的 `Knowledgebase.parser_config["raptor"]` 进行设置。

### 核心配置字段

| 参数 | 类型 | 描述 | 默认值 |
| --- | --- | --- | --- |
| `max_cluster` | 整数 | 每层最大聚类数量 | 64 |
| `prompt` | 字符串 | 用于摘要的 LLM 提示词模板 | 系统默认 |
| `max_token` | 整数 | 每个摘要的最大 Token 数 | 取决于模型 |
| `threshold` | 浮点数 | 聚类的相似度阈值 (0-1) | 0.1 |
| `random_seed` | 整数 | 用于可重复聚类的随机种子 | 随机 |
| `scope` | 字符串 | 处理范围："file" (文件) 或 "dataset" (数据集) | "file" |

### 范围选项 (Scope Options)

-   **文件范围 (`"file"`)**：RAPTOR 独立处理每个文档，在文档边界内创建分层摘要。适合具有内部结构的长文档。
-   **数据集范围 (`"dataset"`)**：RAPTOR 处理整个知识库中的所有切片，创建跨文档的分层摘要。适合发现多个文档之间的共同主题。

## 触发 RAPTOR 处理 (Triggering RAPTOR Processing)

### 通过 API 手动触发

RAPTOR 处理通过知识库 API 端点发起：`POST /api/v1/kb/raptor`。系统会验证前提条件，包括文档是否已解析、切片是否存在以及当前是否已有任务在运行。

## RAPTOR 处理流水线 (RAPTOR Processing Pipeline)

### 处理流程

1.  **任务接收**：任务执行器接收 RAPTOR 任务。
2.  **加载配置**：从知识库加载解析配置。
3.  **获取切片**：从存储中获取现有切片（根据 `scope` 决定范围）。
4.  **聚类**：使用 `Raptor.cluster()` 对相似切片分组。
5.  **总结**：使用 `Raptor.summarize()` 调用 LLM 生成摘要。
6.  **嵌入**：为生成的摘要生成向量嵌入。
7.  **递归**：在摘要层重复聚类和总结过程，直到满足终止条件。
8.  **索引**：将 RAPTOR 切片插入存储，并带有 `raptor_kwd` 标记。

## 数据流与存储 (Data Flow and Storage)

### 存储架构

RAPTOR 切片存储在与常规切片相同的索引中，但具有区分性的元数据字段：
-   `raptor_kwd`: 特殊标记字段，设置为 `"raptor"` 以识别此类切片。
-   `doc_id`: 在文件范围下为实际文档 ID，在数据集范围下为 `GRAPH_RAPTOR_FAKE_DOC_ID` (`graph_raptor_x`)。
-   `content_with_weight`: 生成的摘要文本。

## 检索系统集成 (Integration with Retrieval System)

### RAPTOR 切片过滤

在检索过程中，可以根据需要包含或排除 RAPTOR 切片。`raptor_kwd` 字段可实现高效过滤：
-   **默认检索**：通常包含原始切片和 RAPTOR 切片。
-   **仅原始切片**：过滤掉 `raptor_kwd="raptor"` 的内容。
-   **仅 RAPTOR**：仅检索 `raptor_kwd="raptor"` 的内容。

### 搜索评分调整

RAPTOR 切片与原始切片共同参与混合搜索。它们在向量搜索和关键词匹配中处于平等竞争地位，重排序 (Rerank) 模型可以进一步调整它们的评分。

## 错误处理与局限性 (Error Handling and Limitations)

-   **计算成本**：RAPTOR 是 LLM 密集型的，因为它为每个聚类生成摘要。数据集范围的处理对大型知识库来说可能非常昂贵。
-   **错误恢复**：包含针对 LLM API 失败的重试机制（指数退避）。
-   **适用场景**：适用于具有层次结构的文档、需要宏观综述的查询、跨文档主题检测。对于极小的数据集或对成本极度敏感的应用，可以跳过 RAPTOR。
