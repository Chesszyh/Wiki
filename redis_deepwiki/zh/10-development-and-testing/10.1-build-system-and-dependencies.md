# 构建系统与依赖

相关源文件

-   [Makefile](https://github.com/redis/redis/blob/8ad54215/Makefile)

## 目的与范围

本文涵盖了 Redis 的顶层构建编排、依赖管理和编译过程。它解释了分层的 `Makefile` 结构、外部依赖集成、内存分配器选择以及将源代码转换为 Redis 可执行文件的平台特定构建配置。

有关 Redis 测试框架的信息，请参阅第 10.2 页。有关持续集成的详细信息，请参阅第 10.3 页。

## 构建系统架构

### 分层 Makefile 结构

Redis 实现了一个分层的 GNU Make 构建系统，其中根目录下的 `Makefile` 通过 `SUBDIRS` 变量和 `.DEFAULT` 目标委托给专门的子目录：

根 `Makefile` 使用简单的循环模式在 `$(SUBDIRS)` 中调用目标，而 `src/Makefile` 包含主要的编译逻辑，具有 `FINAL_CFLAGS`、`FINAL_LIBS` 和特定于目标的 object 定义。

**来源：** [Makefile1-17](https://github.com/redis/redis/blob/8ad54215/Makefile#L1-L17)

## 核心构建目标与对象编译

### 主要可执行文件目标

构建系统通过特定的对象集合和链接策略生成 Redis 可执行文件：

### 链接与依赖集成

每个可执行文件都链接到特定的依赖组合：

| 目标 | 对象集合 | 外部依赖 |
| --- | --- | --- |
| `redis-server$(PROG_SUFFIX)` | `$(REDIS_SERVER_OBJ)` | 所有 `$(DEPENDENCY_TARGETS)` |
| `redis-cli$(PROG_SUFFIX)` | `$(REDIS_CLI_OBJ)` | `../deps/hiredis/libhiredis.a`, `../deps/linenoise/linenoise.o` |
| `redis-benchmark$(PROG_SUFFIX)` | `$(REDIS_BENCHMARK_OBJ)` | `../deps/hiredis/libhiredis.a` |

实用工具二进制文件（`redis-sentinel`、`redis-check-rdb`、`redis-check-aof`）被创建为指向 `redis-server` 的符号链接，因为服务器二进制文件包含了这些模式所需的所有功能。

**来源：** [Makefile1-17](https://github.com/redis/redis/blob/8ad54215/Makefile#L1-L17)

## 依赖管理与外部库

### 依赖目标系统

Redis 通过 `DEPENDENCY_TARGETS` 变量协调外部库的构建，该变量在链接 Redis 二进制文件之前触发 `deps/` 目录中的编译：

| 依赖项 | 库输出 | 集成点 | 用途 |
| --- | --- | --- | --- |
| `hiredis` | `../deps/hiredis/libhiredis.a` | `$(REDIS_CLI_OBJ)`, `$(REDIS_BENCHMARK_OBJ)` | Redis C 客户端库 |
| `linenoise` | `../deps/linenoise/linenoise.o` | `$(REDIS_CLI_OBJ)` | CLI 的行编辑功能 |
| `lua` | `../deps/lua/src/liblua.a` | `$(REDIS_SERVER_OBJ)` | 嵌入式脚本引擎 |
| `hdr_histogram` | `../deps/hdr_histogram/libhdrhistogram.a` | `$(REDIS_SERVER_OBJ)` | 延迟直方图指标 |
| `fpconv` | `../deps/fpconv/fpconv.o` | `$(REDIS_SERVER_OBJ)` | 快速浮点转换 |
| `fast_float` | 仅头文件 | 编译时集成 | 快速字符串转浮点数解析 |
| `jemalloc` | `../deps/jemalloc/lib/libjemalloc.a` | 可选的 `$(REDIS_SERVER_OBJ)` | 备选内存分配器 |

### 构建前提与依赖链

构建系统通过前提目标确保正确的依赖顺序：

`.make-prerequisites` 目标确保在 Redis 对象编译之前构建依赖项，而 `persist-settings` 则在增量构建中保持构建配置的一致性。

**来源：** [Makefile1-17](https://github.com/redis/redis/blob/8ad54215/Makefile#L1-L17)

## 内存分配器选择与配置

### 分配器自动检测

构建系统根据平台检测和通过 `MALLOC` 变量进行的显式覆盖来选择内存分配器：

### 分配器覆盖变量

构建系统支持通过环境变量进行显式的分配器选择：

| 变量 | 效果 | 编译标志 | 链接库 |
| --- | --- | --- | --- |
| `USE_JEMALLOC=yes` | 强制使用 jemalloc | `-DUSE_JEMALLOC -I../deps/jemalloc/include` | `../deps/jemalloc/lib/libjemalloc.a` |
| `USE_TCMALLOC=yes` | 使用 Google tcmalloc | `-DUSE_TCMALLOC` | `-ltcmalloc` |
| `USE_TCMALLOC_MINIMAL=yes` | 使用 minimal tcmalloc | `-DUSE_TCMALLOC` | `-ltcmalloc_minimal` |
| `SANITIZER=address` | 强制使用 libc (兼容性) | 标准 Sanitizer 标志 | 仅系统 malloc |

### Sanitizer 集成

当指定了 `SANITIZER` 时，构建系统会自动设置 `MALLOC=libc`，以确保与地址 (address)、未定义行为 (undefined behavior)、线程 (thread) 和内存 (memory) Sanitizer 的兼容性。

**来源：** [Makefile1-17](https://github.com/redis/redis/blob/8ad54215/Makefile#L1-L17)

## 构建配置与编译器检测

### 编译标志组装

构建系统通过系统的平台和特性检测来构建 `FINAL_CFLAGS` 和 `FINAL_LIBS`：

### 核心配置变量

构建系统使用以下可被覆盖的主要配置变量：

| 变量 | 默认值 | 用途 | 覆盖示例 |
| --- | --- | --- | --- |
| `OPTIMIZATION` | `-O3` | 编译器优化级别 | `make OPTIMIZATION=-O0` |
| `STD` | `-pedantic -DREDIS_STATIC` | C 标准合规性 | 自定义标准标志 |
| `WARN` | `-Wall -W -Werror=deprecated-declarations` | 警告配置 | 禁用特定警告 |
| `DEBUG` | `-g -ggdb` | 调试符号生成 | 增强的调试信息 |
| `MALLOC` | 平台相关 | 内存分配器选择 | `make MALLOC=tcmalloc` |
| `CC` | 
$(shell sh -c 'type $(CC) >/dev/null 2>/dev/null && echo $(CC) |  | echo gcc')
 | 指定编译器 |

### 特性自动检测

构建过程会执行针对编译器和平台能力的运行时检查，自动调整标志以在不同环境中实现最优构建。

**来源：** [Makefile1-17](https://github.com/redis/redis/blob/8ad54215/Makefile#L1-L17)

## 平台特定构建适配

### 操作系统库需求

构建系统通过 `uname_S` 检测目标操作系统，并应用平台特定的链接需求：

### 架构特定适配

构建系统根据 `uname_M` 检测结果应用架构特定的标志：

| 架构 | 检测模式 | 额外标志 | 目的 |
| --- | --- | --- | --- |
| ARM | `uname_M` 中的 `arm*` | `-funwind-tables` | 堆栈回溯支持 |
| ARM32 | 32 位 ARM 变体 | `-latomic` | 原子操作链接 |
| x86_64 | `x86_64` 检测 | 平台优化 | 针对 64 位的特定优化 |
| 通用 64 位 | 自动检测逻辑 | 架构标志 | 跨平台兼容性 |

### 平台特定编译器行为

不同的平台需要对以下内容进行特定处理：

-   **动态库加载**：Linux 上的 `-rdynamic` 用于正确的符号导出。
-   **线程库**：平台特定的 pthread 实现。
-   **网络库**：套接字和网络 API 的变体。
-   **内存管理**：平台特定的分配器优化。

**来源：** [Makefile1-17](https://github.com/redis/redis/blob/8ad54215/Makefile#L1-L17)

## 开发与调试构建变体

### 专门构建目标

构建系统提供了专注于开发的、会修改 `OPTIMIZATION` 和 `FINAL_CFLAGS` 的目标：

| Make 目标 | 配置覆盖 | 编译器标志 | 目的 |
| --- | --- | --- | --- |
| `gcov` | `OPTIMIZATION=-O0` | `-fprofile-arcs -ftest-coverage` | 代码覆盖率分析 |
| `noopt` | `OPTIMIZATION=-O0` | 调试友好型编译 | 开发调试 |
| `valgrind` | `OPTIMIZATION=-O0 MALLOC=libc` | 内存调试兼容性 | Valgrind 分析 |
| `helgrind` | `OPTIMIZATION=-O0` | `-D__ATOMIC_VAR_FORCE_SYNC_MACROS` | 线程调试 |
| `32bit` | 交叉编译 | `-m32` | 32 位架构测试 |

### Sanitizer 集成框架

`SANITIZER` 变量会自动配置编译器 Sanitizer 并强制执行兼容的内存分配：

### 调试符号与性能分析支持

开发构建会自动包含：

-   **调试符号**：`-g -ggdb` 用于增强调试信息。
-   **帧指针**：使用 Sanitizer 时的 `-fno-omit-frame-pointer`。
-   **覆盖率数据**：针对 gcov 集成的 `-fprofile-arcs -ftest-coverage`。
-   **未优化的代码**：`-O0` 以防止调试干扰。

**来源：** [Makefile1-17](https://github.com/redis/redis/blob/8ad54215/Makefile#L1-L17)

## 安装与清理目标

### 安装过程

`install` 目标处理二进制文件的部署：

1.  创建 `$(INSTALL_BIN)` 目录（默认：`/usr/local/bin`）。
2.  使用 `$(INSTALL)` 命令安装主二进制文件。
3.  为实用工具创建符号链接。

### 清理操作

-   `clean`：移除构建产物，保留设置。
-   `distclean`：深度清理，包括依赖项和设置。
-   通过 `.d` 文件进行的自动依赖追踪。

**来源：** [src/Makefile540-551](https://github.com/redis/redis/blob/8ad54215/src/Makefile#L540-L551) [src/Makefile482-494](https://github.com/redis/redis/blob/8ad54215/src/Makefile#L482-L494)
