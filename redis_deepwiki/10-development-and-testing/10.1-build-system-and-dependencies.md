# Build System and Dependencies

Relevant source files

-   [Makefile](https://github.com/redis/redis/blob/8ad54215/Makefile)

## Purpose and Scope

This document covers Redis's top-level build orchestration, dependency management, and compilation process. It explains the hierarchical `Makefile` structure, external dependency integration, memory allocator selection, and platform-specific build configurations that transform source code into Redis executables.

For information about the Redis testing framework, see page 10.2. For continuous integration details, see page 10.3.

## Build System Architecture

### Hierarchical Makefile Structure

Redis implements a hierarchical GNU Make build system where the root `Makefile` delegates to specialized subdirectories through the `SUBDIRS` variable and `.DEFAULT` target:

The root `Makefile` uses a simple loop pattern to invoke targets across `$(SUBDIRS)`, while `src/Makefile` contains the primary compilation logic with `FINAL_CFLAGS`, `FINAL_LIBS`, and target-specific object definitions.

Sources: [Makefile1-17](https://github.com/redis/redis/blob/8ad54215/Makefile#L1-L17)

## Core Build Targets and Object Compilation

### Primary Executable Targets

The build system generates Redis executables through specific object collections and linking strategies:

### Linking and Dependency Integration

Each executable links against specific dependency combinations:

| Target | Object Collection | External Dependencies |
| --- | --- | --- |
| `redis-server$(PROG_SUFFIX)` | `$(REDIS_SERVER_OBJ)` | All `$(DEPENDENCY_TARGETS)` |
| `redis-cli$(PROG_SUFFIX)` | `$(REDIS_CLI_OBJ)` | `../deps/hiredis/libhiredis.a`, `../deps/linenoise/linenoise.o` |
| `redis-benchmark$(PROG_SUFFIX)` | `$(REDIS_BENCHMARK_OBJ)` | `../deps/hiredis/libhiredis.a` |

The utility binaries (`redis-sentinel`, `redis-check-rdb`, `redis-check-aof`) are created as symbolic links to `redis-server` since the server binary contains all necessary functionality for these modes.

Sources: [Makefile1-17](https://github.com/redis/redis/blob/8ad54215/Makefile#L1-L17)

## Dependency Management and External Libraries

### Dependency Target System

Redis coordinates external library builds through the `DEPENDENCY_TARGETS` variable, which triggers compilation in the `deps/` directory before linking Redis binaries:

| Dependency | Library Output | Integration Point | Purpose |
| --- | --- | --- | --- |
| `hiredis` | `../deps/hiredis/libhiredis.a` | `$(REDIS_CLI_OBJ)`, `$(REDIS_BENCHMARK_OBJ)` | Redis C client library |
| `linenoise` | `../deps/linenoise/linenoise.o` | `$(REDIS_CLI_OBJ)` | Line editing for CLI |
| `lua` | `../deps/lua/src/liblua.a` | `$(REDIS_SERVER_OBJ)` | Embedded scripting engine |
| `hdr_histogram` | `../deps/hdr_histogram/libhdrhistogram.a` | `$(REDIS_SERVER_OBJ)` | Latency histogram metrics |
| `fpconv` | `../deps/fpconv/fpconv.o` | `$(REDIS_SERVER_OBJ)` | Fast floating-point conversion |
| `fast_float` | Header-only | Compile-time | Fast string-to-float parsing |
| `jemalloc` | `../deps/jemalloc/lib/libjemalloc.a` | Optional `$(REDIS_SERVER_OBJ)` | Alternative memory allocator |

### Build Prerequisites and Dependency Chain

The build system ensures proper dependency ordering through prerequisite targets:

The `.make-prerequisites` target ensures dependencies are built before Redis object compilation, while `persist-settings` maintains build configuration consistency across incremental builds.

Sources: [Makefile1-17](https://github.com/redis/redis/blob/8ad54215/Makefile#L1-L17)

## Memory Allocator Selection and Configuration

### Automatic Allocator Detection

The build system selects memory allocators based on platform detection and explicit overrides through the `MALLOC` variable:

### Allocator Override Variables

The build system supports explicit allocator selection through environment variables:

| Variable | Effect | Compile Flags | Link Libraries |
| --- | --- | --- | --- |
| `USE_JEMALLOC=yes` | Force jemalloc | `-DUSE_JEMALLOC -I../deps/jemalloc/include` | `../deps/jemalloc/lib/libjemalloc.a` |
| `USE_TCMALLOC=yes` | Use Google tcmalloc | `-DUSE_TCMALLOC` | `-ltcmalloc` |
| `USE_TCMALLOC_MINIMAL=yes` | Use minimal tcmalloc | `-DUSE_TCMALLOC` | `-ltcmalloc_minimal` |
| `SANITIZER=address` | Force libc (compatibility) | Standard sanitizer flags | System malloc only |

### Sanitizer Integration

When `SANITIZER` is specified, the build system automatically sets `MALLOC=libc` to ensure compatibility with address, undefined behavior, thread, and memory sanitizers.

Sources: [Makefile1-17](https://github.com/redis/redis/blob/8ad54215/Makefile#L1-L17)

## Build Configuration and Compiler Detection

### Compilation Flag Assembly

The build system constructs `FINAL_CFLAGS` and `FINAL_LIBS` through systematic platform and feature detection:

### Core Configuration Variables

The build system uses these primary configuration variables that can be overridden:

| Variable | Default Value | Purpose | Override Example |
| --- | --- | --- | --- |
| `OPTIMIZATION` | `-O3` | Compiler optimization level | `make OPTIMIZATION=-O0` |
| `STD` | `-pedantic -DREDIS_STATIC` | C standard compliance | Custom standard flags |
| `WARN` | `-Wall -W -Werror=deprecated-declarations` | Warning configuration | Disable specific warnings |
| `DEBUG` | `-g -ggdb` | Debug symbol generation | Enhanced debugging info |
| `MALLOC` | Platform-dependent | Memory allocator selection | `make MALLOC=tcmalloc` |
| `CC` | \`$(shell sh -c 'type $(CC) >/dev/null 2>/dev/null && echo $(CC) |  | echo gcc')\` |

### Automatic Feature Detection

The build process performs runtime checks for compiler and platform capabilities, adjusting flags automatically for optimal builds across different environments.

Sources: [Makefile1-17](https://github.com/redis/redis/blob/8ad54215/Makefile#L1-L17)

## Platform-Specific Build Adaptations

### Operating System Library Requirements

The build system detects the target OS through `uname_S` and applies platform-specific linking requirements:

### Architecture-Specific Adaptations

The build system applies architecture-specific flags based on `uname_M` detection:

| Architecture | Detection Pattern | Additional Flags | Purpose |
| --- | --- | --- | --- |
| ARM | `arm*` in `uname_M` | `-funwind-tables` | Stack trace support |
| ARM32 | 32-bit ARM variants | `-latomic` | Atomic operation linking |
| x86\_64 | `x86_64` detection | Platform optimization | 64-bit specific optimizations |
| Generic 64-bit | Auto-detection logic | Architecture flags | Cross-platform compatibility |

### Platform-Specific Compiler Behavior

Different platforms require specific handling for:

-   **Dynamic library loading**: `-rdynamic` on Linux for proper symbol export
-   **Threading libraries**: Platform-specific pthread implementations
-   **Network libraries**: Socket and networking API variations
-   **Memory management**: Platform-specific allocator optimizations

Sources: [Makefile1-17](https://github.com/redis/redis/blob/8ad54215/Makefile#L1-L17)

## Development and Debug Build Variants

### Specialized Build Targets

The build system provides development-focused targets that modify `OPTIMIZATION` and `FINAL_CFLAGS`:

| Make Target | Configuration Override | Compiler Flags | Purpose |
| --- | --- | --- | --- |
| `gcov` | `OPTIMIZATION=-O0` | `-fprofile-arcs -ftest-coverage` | Code coverage analysis |
| `noopt` | `OPTIMIZATION=-O0` | Debug-friendly compilation | Development debugging |
| `valgrind` | `OPTIMIZATION=-O0 MALLOC=libc` | Memory debugging compatibility | Valgrind analysis |
| `helgrind` | `OPTIMIZATION=-O0` | `-D__ATOMIC_VAR_FORCE_SYNC_MACROS` | Thread debugging |
| `32bit` | Cross-compilation | `-m32` | 32-bit architecture testing |

### Sanitizer Integration Framework

The `SANITIZER` variable automatically configures compiler sanitizers and forces compatible memory allocation:

### Debug Symbol and Profiling Support

Development builds automatically include:

-   **Debug symbols**: `-g -ggdb` for enhanced debugging information
-   **Frame pointers**: `-fno-omit-frame-pointer` when using sanitizers
-   **Coverage data**: `-fprofile-arcs -ftest-coverage` for gcov integration
-   **Unoptimized code**: `-O0` to prevent debugging interference

Sources: [Makefile1-17](https://github.com/redis/redis/blob/8ad54215/Makefile#L1-L17)

## Installation and Clean Targets

### Installation Process

The `install` target handles binary deployment:

1.  Creates `$(INSTALL_BIN)` directory (default: `/usr/local/bin`)
2.  Installs primary binaries with `$(INSTALL)` command
3.  Creates symbolic links for utility tools

### Clean Operations

-   `clean`: Removes build artifacts, preserves settings
-   `distclean`: Deep clean including dependencies and settings
-   Automatic dependency tracking via `.d` files

Sources: [src/Makefile540-551](https://github.com/redis/redis/blob/8ad54215/src/Makefile#L540-L551) [src/Makefile482-494](https://github.com/redis/redis/blob/8ad54215/src/Makefile#L482-L494)
