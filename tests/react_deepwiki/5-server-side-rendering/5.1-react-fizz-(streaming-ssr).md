# React Fizz (Streaming SSR)

Relevant source files

-   [packages/react-dom-bindings/src/client/ReactDOMComponentTree.js](https://github.com/facebook/react/blob/65eec428/packages/react-dom-bindings/src/client/ReactDOMComponentTree.js)
-   [packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js](https://github.com/facebook/react/blob/65eec428/packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js)
-   [packages/react-dom-bindings/src/server/ReactFizzConfigDOMLegacy.js](https://github.com/facebook/react/blob/65eec428/packages/react-dom-bindings/src/server/ReactFizzConfigDOMLegacy.js)
-   [packages/react-dom-bindings/src/shared/ReactDOMResourceValidation.js](https://github.com/facebook/react/blob/65eec428/packages/react-dom-bindings/src/shared/ReactDOMResourceValidation.js)
-   [packages/react-dom/src/\_\_tests\_\_/ReactDOMFizzServer-test.js](https://github.com/facebook/react/blob/65eec428/packages/react-dom/src/__tests__/ReactDOMFizzServer-test.js)
-   [packages/react-dom/src/\_\_tests\_\_/ReactDOMFizzServerBrowser-test.js](https://github.com/facebook/react/blob/65eec428/packages/react-dom/src/__tests__/ReactDOMFizzServerBrowser-test.js)
-   [packages/react-dom/src/\_\_tests\_\_/ReactDOMFizzServerNode-test.js](https://github.com/facebook/react/blob/65eec428/packages/react-dom/src/__tests__/ReactDOMFizzServerNode-test.js)
-   [packages/react-dom/src/\_\_tests\_\_/ReactDOMFizzStatic-test.js](https://github.com/facebook/react/blob/65eec428/packages/react-dom/src/__tests__/ReactDOMFizzStatic-test.js)
-   [packages/react-dom/src/\_\_tests\_\_/ReactDOMFizzStaticBrowser-test.js](https://github.com/facebook/react/blob/65eec428/packages/react-dom/src/__tests__/ReactDOMFizzStaticBrowser-test.js)
-   [packages/react-dom/src/\_\_tests\_\_/ReactDOMFizzStaticNode-test.js](https://github.com/facebook/react/blob/65eec428/packages/react-dom/src/__tests__/ReactDOMFizzStaticNode-test.js)
-   [packages/react-dom/src/\_\_tests\_\_/ReactDOMFizzSuppressHydrationWarning-test.js](https://github.com/facebook/react/blob/65eec428/packages/react-dom/src/__tests__/ReactDOMFizzSuppressHydrationWarning-test.js)
-   [packages/react-dom/src/\_\_tests\_\_/ReactDOMFloat-test.js](https://github.com/facebook/react/blob/65eec428/packages/react-dom/src/__tests__/ReactDOMFloat-test.js)
-   [packages/react-dom/src/\_\_tests\_\_/ReactDOMHydrationDiff-test.js](https://github.com/facebook/react/blob/65eec428/packages/react-dom/src/__tests__/ReactDOMHydrationDiff-test.js)
-   [packages/react-dom/src/\_\_tests\_\_/ReactDOMServerPartialHydration-test.internal.js](https://github.com/facebook/react/blob/65eec428/packages/react-dom/src/__tests__/ReactDOMServerPartialHydration-test.internal.js)
-   [packages/react-dom/src/\_\_tests\_\_/ReactDOMSingletonComponents-test.js](https://github.com/facebook/react/blob/65eec428/packages/react-dom/src/__tests__/ReactDOMSingletonComponents-test.js)
-   [packages/react-dom/src/\_\_tests\_\_/ReactRenderDocument-test.js](https://github.com/facebook/react/blob/65eec428/packages/react-dom/src/__tests__/ReactRenderDocument-test.js)
-   [packages/react-dom/src/\_\_tests\_\_/ReactServerRenderingHydration-test.js](https://github.com/facebook/react/blob/65eec428/packages/react-dom/src/__tests__/ReactServerRenderingHydration-test.js)
-   [packages/react-dom/src/server/ReactDOMFizzServerBrowser.js](https://github.com/facebook/react/blob/65eec428/packages/react-dom/src/server/ReactDOMFizzServerBrowser.js)
-   [packages/react-dom/src/server/ReactDOMFizzServerBun.js](https://github.com/facebook/react/blob/65eec428/packages/react-dom/src/server/ReactDOMFizzServerBun.js)
-   [packages/react-dom/src/server/ReactDOMFizzServerEdge.js](https://github.com/facebook/react/blob/65eec428/packages/react-dom/src/server/ReactDOMFizzServerEdge.js)
-   [packages/react-dom/src/server/ReactDOMFizzServerNode.js](https://github.com/facebook/react/blob/65eec428/packages/react-dom/src/server/ReactDOMFizzServerNode.js)
-   [packages/react-dom/src/server/ReactDOMFizzStaticBrowser.js](https://github.com/facebook/react/blob/65eec428/packages/react-dom/src/server/ReactDOMFizzStaticBrowser.js)
-   [packages/react-dom/src/server/ReactDOMFizzStaticEdge.js](https://github.com/facebook/react/blob/65eec428/packages/react-dom/src/server/ReactDOMFizzStaticEdge.js)
-   [packages/react-dom/src/server/ReactDOMFizzStaticNode.js](https://github.com/facebook/react/blob/65eec428/packages/react-dom/src/server/ReactDOMFizzStaticNode.js)
-   [packages/react-markup/src/ReactFizzConfigMarkup.js](https://github.com/facebook/react/blob/65eec428/packages/react-markup/src/ReactFizzConfigMarkup.js)
-   [packages/react-noop-renderer/src/ReactNoopServer.js](https://github.com/facebook/react/blob/65eec428/packages/react-noop-renderer/src/ReactNoopServer.js)
-   [packages/react-reconciler/src/ReactFiberHydrationContext.js](https://github.com/facebook/react/blob/65eec428/packages/react-reconciler/src/ReactFiberHydrationContext.js)
-   [packages/react-server-dom-fb/src/\_\_tests\_\_/ReactDOMServerFB-test.internal.js](https://github.com/facebook/react/blob/65eec428/packages/react-server-dom-fb/src/__tests__/ReactDOMServerFB-test.internal.js)
-   [packages/react-server/src/ReactFizzServer.js](https://github.com/facebook/react/blob/65eec428/packages/react-server/src/ReactFizzServer.js)
-   [packages/react-server/src/forks/ReactFizzConfig.custom.js](https://github.com/facebook/react/blob/65eec428/packages/react-server/src/forks/ReactFizzConfig.custom.js)

## Purpose and Scope

React Fizz is the streaming server-side rendering (SSR) system that generates HTML progressively, sending content to the client as it becomes ready. This document covers the core Fizz rendering engine, its request/task/segment model, resource management, and platform-specific implementations for Node.js, Web streams, and static generation.

For information about React Server Components (RSC) and the Flight protocol, see [React Server Components (Flight)](/facebook/react/5.2-react-server-components-(flight)). For client-side hydration, see [Hydration System](/facebook/react/6.3-hydration-system).

## High-Level Architecture

React Fizz operates as a streaming HTML renderer that processes React elements and outputs HTML chunks incrementally. The system is platform-agnostic at its core, with platform-specific adapters for different streaming targets.

**Fizz Architecture Overview**

```mermaid
flowchart TD
    NodeEntry["renderToPipeableStream(Node.js)"]
    BrowserEntry["renderToReadableStream(Web Streams)"]
    StaticEntry["prerender(Static Generation)"]
    CreateRequest["createRequest()createPrerenderRequest()resumeRequest()"]
    StartWork["startWork()Process pingedTasks"]
    PerformWork["performWork()Main work loop"]
    RenderTask["renderNode()Component rendering"]
    Request["RequestallPendingTaskspingedTaskscompletedBoundaries"]
    Task["TaskRenderTask | ReplayTasknode, segment, boundary"]
    Segment["Segmentchunks, childrenstatus, boundary"]
    Boundary["SuspenseBoundarypendingTaskscompletedSegmentscontentState/fallbackState"]
    RenderState["RenderStatehoistableChunksbootstrapChunksstyles, scripts"]
    ResumableState["ResumableStateresumable resourcesidPrefix, nextFormID"]
    FlushFunctions["writeCompletedRoot()writeCompletedBoundary()writeCompletedSegment()"]
    Destination["Destination(Writable | Controller)"]
    StreamConfig["ReactServerStreamConfigwriteChunk()scheduleWork()"]

    NodeEntry --> CreateRequest
    BrowserEntry --> CreateRequest
    StaticEntry --> CreateRequest
    CreateRequest --> Request
    CreateRequest --> StartWork
    StartWork --> PerformWork
    PerformWork --> RenderTask
    RenderTask --> Task
    Task --> Segment
    Task --> Boundary
    Request --> RenderState
    Request --> ResumableState
    PerformWork --> FlushFunctions
    FlushFunctions --> StreamConfig
    StreamConfig --> Destination
    Boundary --> RenderState
```
Sources: [packages/react-server/src/ReactFizzServer.js1-4000](https://github.com/facebook/react/blob/65eec428/packages/react-server/src/ReactFizzServer.js#L1-L4000) [packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js1-500](https://github.com/facebook/react/blob/65eec428/packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js#L1-L500) [packages/react-dom/src/server/ReactDOMFizzServerNode.js1-300](https://github.com/facebook/react/blob/65eec428/packages/react-dom/src/server/ReactDOMFizzServerNode.js#L1-L300)

## Core Data Structures

### Request

The `Request` is the top-level rendering context that tracks the entire SSR operation.

**Request Structure**

| Field | Type | Purpose |
| --- | --- | --- |
| `destination` | `Destination | null` | Output stream target |
| `resumableState` | `ResumableState` | Serializable state for resuming |
| `renderState` | `RenderState` | Per-request working state |
| `allPendingTasks` | `number` | Total tasks to complete |
| `pendingRootTasks` | `number` | Tasks blocking shell completion |
| `pingedTasks` | `Array<Task>` | High-priority tasks ready to work |
| `completedBoundaries` | `Array<SuspenseBoundary>` | Boundaries ready to flush |
| `clientRenderedBoundaries` | `Array<SuspenseBoundary>` | Errored boundaries |
| `partialBoundaries` | `Array<SuspenseBoundary>` | Boundaries with partial content |
| `abortableTasks` | `Set<Task>` | Tasks that can be aborted |
| `trackedPostpones` | `PostponedHoles | null` | For prerendering resume |

Sources: [packages/react-server/src/ReactFizzServer.js359-400](https://github.com/facebook/react/blob/65eec428/packages/react-server/src/ReactFizzServer.js#L359-L400)

### Task Types

Tasks represent units of work in the rendering pipeline. There are two types:

**RenderTask vs ReplayTask**

```mermaid
flowchart TD
    RPT_replay["replay: ReplaySet"]
    RPT_render["Validates against replay nodes"]
    RPT_node["node: ReactNodeList"]
    RPT_segment["blockedSegment: null"]
    RPT_boundary["blockedBoundary: Root|SuspenseBoundary"]
    RT_replay["replay: null"]
    RT_node["node: ReactNodeList"]
    RT_render["Writes to segment.chunks"]
    RT_segment["blockedSegment: Segment"]
    RT_boundary["blockedBoundary: Root|SuspenseBoundary"]

    RPT --> replay_RPT_render
    RPT --> node_RPT_render
    RT --> node_RT_render
    RT --> segment_RT_render
```
Sources: [packages/react-server/src/ReactFizzServer.js272-324](https://github.com/facebook/react/blob/65eec428/packages/react-server/src/ReactFizzServer.js#L272-L324)

### Segment

A `Segment` represents a chunk of HTML output with its rendering status.

**Segment Lifecycle**

> **[Mermaid stateDiagram]**
> *(图表结构无法解析)*

| Status | Value | Description |
| --- | --- | --- |
| `PENDING` | 0 | Waiting to render |
| `COMPLETED` | 1 | Rendered successfully |
| `FLUSHED` | 2 | Written to destination |
| `ABORTED` | 3 | Rendering canceled |
| `ERRORED` | 4 | Error during rendering |
| `POSTPONED` | 5 | Postponed for later |
| `RENDERING` | 6 | Currently rendering |

Sources: [packages/react-server/src/ReactFizzServer.js326-351](https://github.com/facebook/react/blob/65eec428/packages/react-server/src/ReactFizzServer.js#L326-L351)

### SuspenseBoundary

A `SuspenseBoundary` manages Suspense boundaries, tracking pending work and managing fallback rendering.

**SuspenseBoundary Fields**

| Field | Type | Purpose |
| --- | --- | --- |
| `status` | `0 | 1 | 4 | 5` | PENDING, COMPLETED, CLIENT\_RENDERED, POSTPONED |
| `rootSegmentID` | `number` | ID for boundary's root segment |
| `pendingTasks` | `number` | Tasks blocking completion |
| `completedSegments` | `Array<Segment>` | Ready but not flushed |
| `byteSize` | `number` | Total size for inlining decisions |
| `defer` | `boolean` | Never inline deferred boundaries |
| `contentState` | `HoistableState` | Resources for content |
| `fallbackState` | `HoistableState` | Resources for fallback |
| `fallbackAbortableTasks` | `Set<Task>` | Cancel if content completes |
| `errorDigest` | `?string` | Error hash if errored |

Sources: [packages/react-server/src/ReactFizzServer.js248-270](https://github.com/facebook/react/blob/65eec428/packages/react-server/src/ReactFizzServer.js#L248-L270)

## Rendering Pipeline

The rendering pipeline flows from request creation through task processing to HTML output.

**Complete Rendering Flow**

```mermaid
flowchart TD
    Create["createRequest(children, options)"]
    RootSegment["createPendingSegment()Root segment"]
    RootTask["createRenderTask()Initial task"]
    PushTask["pingedTasks.push(rootTask)"]
    StartWork["startWork(request)"]
    PerformWork["performWork(request)"]
    ProcessTask["processTask(task)"]
    RenderNode["renderNode(request, task, node)"]
    CheckType["Check node type(Element, Suspense, etc.)"]
    RenderElement["renderElement(task, type, props)"]
    RenderSuspense["renderSuspenseBoundary(task, props)"]
    RenderText["pushTextInstance(target, text)"]
    FinishTask["finishedTask(request, boundary, segment)"]
    CompleteSegment["segment.status = COMPLETED"]
    DecrementPending["boundary.pendingTasks--"]
    CheckBoundary["pendingTasks === 0?"]
    CompleteBoundary["boundary.status = COMPLETED"]
    QueueBoundary["completedBoundaries.push(boundary)"]
    FlushBoundary["flushCompletedBoundary()"]
    WriteInstructions["writeCompletedBoundaryInstruction()"]
    WriteSegments["writeCompletedSegmentInstruction()"]
    FlushDestination["flushBuffered(destination)"]

    Create --> RootSegment
    RootSegment --> RootTask
    RootTask --> PushTask
    PushTask --> StartWork
    StartWork --> PerformWork
    PerformWork --> ProcessTask
    ProcessTask --> RenderNode
    RenderNode --> CheckType
    CheckType --> RenderElement
    CheckType --> RenderSuspense
    CheckType --> RenderText
    RenderElement --> FinishTask
    FinishTask --> CompleteSegment
    CompleteSegment --> DecrementPending
    DecrementPending --> CheckBoundary
    CheckBoundary --> CompleteBoundary
    CompleteBoundary --> QueueBoundary
    QueueBoundary --> FlushBoundary
    FlushBoundary --> WriteInstructions
    WriteInstructions --> WriteSegments
    WriteSegments --> FlushDestination
```
Sources: [packages/react-server/src/ReactFizzServer.js548-800](https://github.com/facebook/react/blob/65eec428/packages/react-server/src/ReactFizzServer.js#L548-L800) [packages/react-server/src/ReactFizzServer.js1600-2000](https://github.com/facebook/react/blob/65eec428/packages/react-server/src/ReactFizzServer.js#L1600-L2000)

## Task Scheduling and Execution

### Task Creation

Tasks are created when starting rendering or when Suspense boundaries need to render their content or fallback.

**Task Creation Functions**

```mermaid
flowchart TD
    CreateRenderTask["createRenderTask()Regular rendering"]
    CreateReplayTask["createReplayTask()Resume rendering"]
    Node["node: ReactNodeListWhat to render"]
    Segment["blockedSegment: SegmentWhere to write (render only)"]
    Boundary["blockedBoundary: Root|SuspenseBoundaryParent boundary"]
    Context["context: ContextSnapshottreeContext, legacyContext"]
    FormatContext["formatContext: FormatContextHTML/SVG/MathML context"]
    KeyPath["keyPath: Root|KeyNodeComponent key path"]
    AddToAbortSet["abortSet.add(task)"]
    IncrementPending["allPendingTasks++boundary.pendingTasks++"]
    PingTask["pingTask(request, task)Schedule work"]

    CreateRenderTask --> Node
    CreateRenderTask --> Segment
    CreateReplayTask --> Node
    Node --> AddToAbortSet
    Segment --> IncrementPending
    Boundary --> IncrementPending
    IncrementPending --> PingTask
```
Sources: [packages/react-server/src/ReactFizzServer.js843-953](https://github.com/facebook/react/blob/65eec428/packages/react-server/src/ReactFizzServer.js#L843-L953)

### performWork Loop

The `performWork` function is the main work loop that processes tasks and flushes output.

**performWork Execution**

```mermaid
flowchart TD
    Entry["performWork(request)"]
    CheckStatus["request.status === OPEN?"]
    PopTask["task = pingedTasks.pop()"]
    HasTask["task !== undefined?"]
    SetCurrentRequest["currentRequest = request"]
    RenderWithResumeId["renderNodeWithResumeId(request, task)"]
    RerenderTask["Try rerender taskif it suspended"]
    ClearCurrentRequest["currentRequest = null"]
    FlushClientRendered["flushClientRenderedBoundaries()Error boundaries"]
    FlushCompleted["flushCompletedBoundaries()Ready boundaries"]
    FlushPartial["flushPartialBoundaries()Partial boundaries"]
    AllComplete["allPendingTasks === 0?"]
    CloseRequest["request.status = CLOSEDclose(destination)"]
    FlushHeaders["flushHeaders()Send Link headers"]

    Entry --> CheckStatus
    CheckStatus --> PopTask
    PopTask --> HasTask
    HasTask --> SetCurrentRequest
    SetCurrentRequest --> RenderWithResumeId
    RenderWithResumeId --> RerenderTask
    RerenderTask --> ClearCurrentRequest
    ClearCurrentRequest --> PopTask
    HasTask --> FlushClientRendered
    FlushClientRendered --> FlushCompleted
    FlushCompleted --> FlushPartial
    FlushPartial --> AllComplete
    AllComplete --> CloseRequest
    CloseRequest --> FlushHeaders
    CheckStatus --> FlushHeaders
```
Sources: [packages/react-server/src/ReactFizzServer.js2800-3000](https://github.com/facebook/react/blob/65eec428/packages/react-server/src/ReactFizzServer.js#L2800-L3000)

### renderNode Dispatch

The `renderNode` function dispatches to specialized rendering logic based on node type.

**Node Type Dispatch**

| Node Type | Symbol | Rendering Function |
| --- | --- | --- |
| React Element | `REACT_ELEMENT_TYPE` | `renderElement(request, task, type, props, ref)` |
| Lazy Component | `REACT_LAZY_TYPE` | `renderLazyComponent(request, task, lazyComponent)` |
| Suspense | `REACT_SUSPENSE_TYPE` | `renderSuspenseBoundary(request, task, props)` |
| SuspenseList | `REACT_SUSPENSE_LIST_TYPE` | `renderSuspenseList(request, task, props)` |
| Fragment | `REACT_FRAGMENT_TYPE` | `renderNodeFragment(request, task, children)` |
| Provider | `REACT_CONTEXT_TYPE` | `pushProvider(context, value)` |
| Forward Ref | `REACT_FORWARD_REF_TYPE` | `renderForwardRef(request, task, render, props, ref)` |
| Memo | `REACT_MEMO_TYPE` | `renderMemo(request, task, type, props)` |
| Portal | `REACT_PORTAL_TYPE` | Error - not supported |
| String/Number | primitive | `pushTextInstance(segment, text)` |
| Array | `isArray(node)` | `renderChildrenArray(request, task, children)` |
| Async Iterable | `node[ASYNC_ITERATOR]` | `renderAsyncIterable(request, task, iterable)` |

Sources: [packages/react-server/src/ReactFizzServer.js1800-2400](https://github.com/facebook/react/blob/65eec428/packages/react-server/src/ReactFizzServer.js#L1800-L2400)

## Suspense Boundary Management

Suspense boundaries enable streaming and progressive rendering by allowing parts of the tree to suspend while other parts complete.

**Suspense Boundary Rendering Flow**

```mermaid
flowchart TD
    CreateBoundary["createSuspenseBoundary(request, row, fallbackTasks, defer)"]
    ContentSegment["Create content segmentsegment.boundary = boundary"]
    FallbackSegment["Create fallback segment"]
    ContentTask["createRenderTask(content)boundary.pendingTasks++"]
    FallbackTask["createRenderTask(fallback)fallbackAbortableTasks.add()"]
    RenderContent["Render content children"]
    ContentSuspends["Content suspends?"]
    ContentComplete["Content completesboundary.pendingTasks--"]
    Pending["PENDINGStill waiting"]
    Completed["COMPLETEDContent readycancelFallbackTasks()"]
    ClientRendered["CLIENT_RENDEREDError occurred"]
    CheckEligible["isEligibleForOutlining()byteSize > 500"]
    Inline["Inline contentWrite directly"]
    Outline["Outline boundaryWrite template + script"]

    CreateBoundary --> ContentSegment
    CreateBoundary --> FallbackSegment
    ContentSegment --> ContentTask
    FallbackSegment --> FallbackTask
    ContentTask --> RenderContent
    RenderContent --> ContentSuspends
    ContentSuspends --> Pending
    ContentSuspends --> ContentComplete
    ContentComplete --> Completed
    Completed --> CheckEligible
    CheckEligible --> Inline
    CheckEligible --> Outline
```
Sources: [packages/react-server/src/ReactFizzServer.js796-841](https://github.com/facebook/react/blob/65eec428/packages/react-server/src/ReactFizzServer.js#L796-L841) [packages/react-server/src/ReactFizzServer.js2500-2700](https://github.com/facebook/react/blob/65eec428/packages/react-server/src/ReactFizzServer.js#L2500-L2700)

### Boundary Completion and Flushing

When a boundary completes, it moves through queues before being flushed to the output.

**Boundary Flush Process**

```mermaid
flowchart TD
    DecPending["boundary.pendingTasks--"]
    CheckZero["pendingTasks === 0?"]
    SetCompleted["boundary.status = COMPLETED"]
    QueueCompleted["completedBoundaries.push(boundary)"]
    CheckShell["Shell completed?"]
    QueuePartial["partialBoundaries.push(boundary)"]
    FlushCompleted["flushCompletedBoundary(request, destination, boundary)"]
    WriteStart["writeStartCompletedSuspenseBoundary()"]
    WriteSegments["Write all completedSegments"]
    WriteEnd["writeEndCompletedSuspenseBoundary()"]
    WriteInstruction["writeCompletedBoundaryInstruction(boundaryID, contentSegmentID)"]

    DecPending --> CheckZero
    CheckZero --> SetCompleted
    SetCompleted --> CheckShell
    CheckShell --> QueueCompleted
    CheckShell --> QueuePartial
    QueueCompleted --> FlushCompleted
    FlushCompleted --> WriteStart
    WriteStart --> WriteSegments
    WriteSegments --> WriteEnd
    WriteEnd --> WriteInstruction
```
Sources: [packages/react-server/src/ReactFizzServer.js3200-3500](https://github.com/facebook/react/blob/65eec428/packages/react-server/src/ReactFizzServer.js#L3200-L3500)

## Resource Management

React Fizz manages resources (scripts, stylesheets, preloads) through the `RenderState` and `ResumableState` structures to optimize loading and prevent duplicates.

**Resource State Architecture**

```mermaid
flowchart TD
    DNS["dnsResources: {[key]: Exists}DNS prefetches"]
    Connect["connectResources:default/anonymous/credentials{[key]: Exists}"]
    Style["styleResources: {[key]: Exists|Preloaded}"]
    Script["scriptResources: {[key]: Exists|Preloaded}"]
    ModuleScript["moduleScriptResources: {[key]: Exists|Preloaded}"]
    Image["imageResources: {[key]: Preloaded}"]
    Preconnects["preconnects: SetFlush early"]
    FontPreloads["fontPreloads: SetFlush early"]
    HighImagePreloads["highImagePreloads: SetFlush early"]
    Styles["styles: MapStylesheets + dependencies"]
    Scripts["scripts: SetScript tags"]
    BulkPreloads["bulkPreloads: SetRegular preloads"]
    BoundaryStyles["styles: SetRequired stylesheets"]
    BoundaryScripts["scripts: SetRequired scripts"]
    HeadersObj["headers: {preconnects: string,fontPreloads: string,highImagePreloads: string,remainingCapacity: number}"]
    OnHeaders["onHeaders(headers: HeadersDescriptor)"]

    DNS --> Preconnects
    Connect --> Preconnects
    Style --> Styles
    Script --> Scripts
    Image --> HighImagePreloads
    Styles --> BoundaryStyles
    Scripts --> BoundaryScripts
    Preconnects --> HeadersObj
    FontPreloads --> HeadersObj
    HighImagePreloads --> HeadersObj
    HeadersObj --> OnHeaders
```
Sources: [packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js260-310](https://github.com/facebook/react/blob/65eec428/packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js#L260-L310) [packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js148-234](https://github.com/facebook/react/blob/65eec428/packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js#L148-L234)

### Resource Deduplication

Resources are tracked in `ResumableState` to prevent duplicate output across boundaries and resume scenarios.

**Resource Tracking Types**

| Type | Tracked By | Values |
| --- | --- | --- |
| DNS Prefetch | `href` | `EXISTS` (null) |
| Preconnect | `href` + `crossOrigin` | `EXISTS` (null) |
| Stylesheet | `href` | `EXISTS` | `[crossOrigin, integrity]` |
| Script | `src` | `EXISTS` | `[crossOrigin, integrity]` |
| Module | `src` | `EXISTS` | `[crossOrigin, integrity]` |
| Image Preload | `href` + `imageSrcSet` + `imageSizes` | `[]` (empty array) |
| Font Preload | `href` | `[]` (empty array) |

Sources: [packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js236-258](https://github.com/facebook/react/blob/65eec428/packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js#L236-L258)

### Resource Flushing Order

Resources are flushed in a specific order to optimize page load performance.

**Resource Flush Sequence**

```mermaid
flowchart TD
    Start["Start Flushing"]
    Charset["1. charsetChunks"]
    Viewport["2. viewportChunks"]
    EarlyPreconnects["3. preconnects (Set)"]
    EarlyFontPreloads["4. fontPreloads (Set)"]
    EarlyImagePreloads["5. highImagePreloads (Set)"]
    Hoistables["6. hoistableChunksOther / tags"]
    BoundaryStyles["7. Boundary styleswriteHoistablesForBoundary()"]
    BoundaryScripts["8. Boundary scriptsRequired dependencies"]
    BulkPreloads["9. bulkPreloadsRegular priority preloads"]
    BootstrapScripts["10. bootstrapScriptsApplication initialization"]

    Start --> Charset
    Charset --> Viewport
    Viewport --> EarlyPreconnects
    EarlyPreconnects --> EarlyFontPreloads
    EarlyFontPreloads --> EarlyImagePreloads
    EarlyImagePreloads --> Hoistables
    Hoistables --> BoundaryStyles
    BoundaryStyles --> BoundaryScripts
    BoundaryScripts --> BulkPreloads
    BulkPreloads --> BootstrapScripts
```
Sources: [packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js3800-4200](https://github.com/facebook/react/blob/65eec428/packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js#L3800-L4200)

## Platform-Specific Implementations

React Fizz has multiple entry points for different JavaScript environments, each adapting the core engine to platform-specific streaming APIs.

**Platform Entry Points**

```mermaid
flowchart TD
    NodeEntry["ReactDOMFizzServerNode.jsrenderToPipeableStream()"]
    NodeStream["Node Writable Stream"]
    NodeDestination["Destination = Writable"]
    BrowserEntry["ReactDOMFizzServerBrowser.jsrenderToReadableStream()"]
    WebStream["ReadableStream (Web Streams API)"]
    WebDestination["Destination = ReadableStreamController"]
    EdgeEntry["ReactDOMFizzServerEdge.jsrenderToReadableStream()"]
    EdgeStream["ReadableStream"]
    BunEntry["ReactDOMFizzServerBun.jsrenderToReadableStream()"]
    BunStream["ReadableStream"]
    StaticNode["ReactDOMFizzStaticNode.jsprerender()"]
    StaticBrowser["ReactDOMFizzStaticBrowser.jsprerender()"]
    StaticEdge["ReactDOMFizzStaticEdge.jsprerender()"]
    PrerenderRequest["createPrerenderRequest()trackedPostpones"]
    FizzServer["ReactFizzServer.jscreateRequest()performWork()"]
    StreamConfig["ReactServerStreamConfigwriteChunk()scheduleWork()"]

    NodeEntry --> NodeStream
    NodeStream --> NodeDestination
    NodeDestination --> FizzServer
    BrowserEntry --> WebStream
    WebStream --> WebDestination
    WebDestination --> FizzServer
    EdgeEntry --> EdgeStream
    BunEntry --> BunStream
    EdgeStream --> FizzServer
    BunStream --> FizzServer
    StaticNode --> PrerenderRequest
    StaticBrowser --> PrerenderRequest
    StaticEdge --> PrerenderRequest
    PrerenderRequest --> FizzServer
    FizzServer --> StreamConfig
```
Sources: [packages/react-dom/src/server/ReactDOMFizzServerNode.js1-300](https://github.com/facebook/react/blob/65eec428/packages/react-dom/src/server/ReactDOMFizzServerNode.js#L1-L300) [packages/react-dom/src/server/ReactDOMFizzServerBrowser.js1-200](https://github.com/facebook/react/blob/65eec428/packages/react-dom/src/server/ReactDOMFizzServerBrowser.js#L1-L200) [packages/react-dom/src/server/ReactDOMFizzStaticBrowser.js1-200](https://github.com/facebook/react/blob/65eec428/packages/react-dom/src/server/ReactDOMFizzStaticBrowser.js#L1-L200)

### Node.js: renderToPipeableStream

The Node.js implementation uses Node's `Writable` stream interface with backpressure support.

**Node.js Streaming Flow**

```mermaid
flowchart TD
    Render["renderToPipeableStream(children, options)"]
    PipeableStream["PipeableStream{pipe, abort}"]
    CreateReq["createRequestImpl()createResumableState()createRenderState()"]
    StartWork["startWork(request)"]
    Pipe["pipe(destination: Writable)"]
    DrainHandler["'drain' eventstartFlowing()"]
    ErrorHandler["'error' eventabort()"]
    CloseHandler["'close' eventabort()"]
    OnShellReady["onShellReady()Initial HTML ready"]
    OnAllReady["onAllReady()All content ready"]
    OnShellError["onShellError(error)Shell failed"]

    Render --> CreateReq
    CreateReq --> StartWork
    StartWork --> PipeableStream
    PipeableStream --> Pipe
    Pipe --> DrainHandler
    Pipe --> ErrorHandler
    Pipe --> CloseHandler
    StartWork --> OnShellReady
    StartWork --> OnAllReady
    StartWork --> OnShellError
```
Sources: [packages/react-dom/src/server/ReactDOMFizzServerNode.js131-166](https://github.com/facebook/react/blob/65eec428/packages/react-dom/src/server/ReactDOMFizzServerNode.js#L131-L166)

### Browser/Edge: renderToReadableStream

The browser implementation uses the Web Streams API's `ReadableStream` with a bytes source.

**Web Streams Flow**

```mermaid
flowchart TD
    Render["renderToReadableStream(children, options)"]
    Promise["Promise"]
    ReadableStream["ReadableStream & {allReady: Promise}"]
    BytesSource["ReadableStream({type: 'bytes'})"]
    Pull["pull(controller)startFlowing(request, controller)"]
    Cancel["cancel(reason)abort(request, reason)"]
    ShellPromise["Shell promiseresolve(stream)"]
    AllReadyPromise["allReady promiseresolve when done"]
    OnShellReady["onShellReady()resolve shell promise"]
    OnShellError["onShellError(error)reject shell promise"]
    OnFatalError["onFatalError(error)reject allReady"]

    Render --> BytesSource
    BytesSource --> Pull
    BytesSource --> Cancel
    Pull --> OnShellReady
    OnShellReady --> ShellPromise
    ShellPromise --> Promise
    Promise --> ReadableStream
    ReadableStream --> AllReadyPromise
    OnFatalError --> AllReadyPromise
```
Sources: [packages/react-dom/src/server/ReactDOMFizzServerBrowser.js75-165](https://github.com/facebook/react/blob/65eec428/packages/react-dom/src/server/ReactDOMFizzServerBrowser.js#L75-L165)

## Prerendering and Resumability

Prerendering generates static HTML while tracking postponed boundaries for later resumption.

**Prerender Architecture**

```mermaid
flowchart TD
    CreatePrerender["createPrerenderRequest(children)trackedPostpones = {  workingMap: Map,  rootNodes: Array,  rootSlots: ResumeSlots}"]
    ComponentKey["keyPath: Root|KeyNodeUnique path in tree"]
    ReplayNode["ReplayNode[name, key, children, slots]"]
    ReplaySuspense["ReplaySuspenseBoundary[name, key, children, contentSlots, fallback, rootSegmentID]"]
    WorkingMap["workingMap.set(keyPath, replayNode)"]
    PostponedState["getPostponedState(request){  replayNodes,  replaySlots,  resumableState,  nextSegmentId,  ...formatContext}"]
    ResumeRequest["resumeRequest(children, postponedState)ORresumeAndPrerenderRequest(children, postponedState)"]
    CreateReplayTasks["createReplayTask(replay: ReplaySet)Validates against tracked nodes"]
    ReplayContinue["Continue from postponed holes"]

    CreatePrerender --> ComponentKey
    ComponentKey --> ReplayNode
    ReplayNode --> ReplaySuspense
    ReplaySuspense --> WorkingMap
    WorkingMap --> PostponedState
    PostponedState --> ResumeRequest
    ResumeRequest --> CreateReplayTasks
    CreateReplayTasks --> ReplayContinue
```
Sources: [packages/react-server/src/ReactFizzServer.js615-770](https://github.com/facebook/react/blob/65eec428/packages/react-server/src/ReactFizzServer.js#L615-L770)

### PostponedState Structure

The `PostponedState` captures everything needed to resume rendering from postponed boundaries.

**PostponedState Fields**

| Field | Type | Purpose |
| --- | --- | --- |
| `replayNodes` | `Array<ReplayNode>` | Tree of tracked component keys |
| `replaySlots` | `ResumeSlots` | Segment IDs to resume |
| `resumableState` | `ResumableState` | Resource state to continue |
| `nextSegmentId` | `number` | Next available segment ID |
| `rootFormatContext` | `FormatContext` | HTML/SVG/MathML context |
| `progressiveChunkSize` | `number` | Chunk size setting |

Sources: [packages/react-server/src/ReactFizzServer.js3900-4000](https://github.com/facebook/react/blob/65eec428/packages/react-server/src/ReactFizzServer.js#L3900-L4000)

### ReplayTask Validation

When resuming, `ReplayTask` instances validate that the component tree matches the tracked structure.

**Replay Validation Flow**

```mermaid
flowchart TD
    RenderReplay["renderNode(request, task, node)task.replay !== null"]
    GetKey["getKeyPath(task)"]
    FindReplayNode["Find matching ReplayNodein replay.nodes"]
    KeyMatches["Keys match?"]
    IsSuspense["Is Suspense boundary?"]
    ReplaySuspenseBoundary["Cast to ReplaySuspenseBoundary"]
    ResumeChildren["Create ReplayTask for children"]
    ResumeFallback["Track fallback if present"]
    NoMatch["No matching ReplayNode"]
    AbortReplay["Abort replayClient render boundary"]

    RenderReplay --> GetKey
    GetKey --> FindReplayNode
    FindReplayNode --> KeyMatches
    KeyMatches --> IsSuspense
    KeyMatches --> NoMatch
    NoMatch --> AbortReplay
    IsSuspense --> ReplaySuspenseBoundary
    ReplaySuspenseBoundary --> ResumeChildren
    ReplaySuspenseBoundary --> ResumeFallback
```
Sources: [packages/react-server/src/ReactFizzServer.js1900-2100](https://github.com/facebook/react/blob/65eec428/packages/react-server/src/ReactFizzServer.js#L1900-L2100)

## Streaming Format and Instructions

React Fizz can output HTML in two formats: inline scripts or data attributes with an external runtime.

**Streaming Formats**

| Format | Value | Configuration | Use Case |
| --- | --- | --- | --- |
| `ScriptStreamingFormat` | 0 | Default | Inline instructions in `<script>` tags |
| `DataStreamingFormat` | 1 | `unstable_externalRuntimeSrc` | Instructions via data attributes, separate runtime |

Sources: [packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js122-124](https://github.com/facebook/react/blob/65eec428/packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js#L122-L124)

### Instruction State Bits

The `InstructionState` tracks which instructions have been sent to avoid duplication.

**InstructionState Flags**

| Flag | Bit | Purpose |
| --- | --- | --- |
| `SentCompleteSegmentFunction` | 0b000000001 | `completeSegment` function sent |
| `SentCompleteBoundaryFunction` | 0b000000010 | `completeBoundary` function sent |
| `SentClientRenderFunction` | 0b000000100 | `clientRenderBoundary` function sent |
| `SentStyleInsertionFunction` | 0b000001000 | `completeBoundaryWithStyles` sent |
| `SentFormReplayingRuntime` | 0b000010000 | Form replaying runtime sent |
| `SentCompletedShellId` | 0b000100000 | Shell completion marker sent |
| `SentMarkShellTime` | 0b001000000 | Shell timing marker sent |
| `NeedUpgradeToViewTransitions` | 0b010000000 | View transitions needed |
| `SentUpgradeToViewTransitions` | 0b100000000 | View transition upgrade sent |

Sources: [packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js127-136](https://github.com/facebook/react/blob/65eec428/packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js#L127-L136)

### Boundary Completion Instructions

When a boundary completes, an inline script or data attribute instructs the client to reveal the content.

**Boundary Instruction Output**

```mermaid
flowchart TD
    FunctionCall["$RC(boundaryID, contentSegmentID)"]
    DataAttr["data-dgst=errorDigest"]
    DataRender["data-msg=errorMessage"]
    TemplateEnd[">"]
    Runtime["React runtime on client"]
    RevealContent["Reveal completed content"]
    RemoveFallback["Remove fallback"]

    ScriptStart --> FunctionCall
    FunctionCall --> ScriptEnd
    ScriptEnd --> Runtime
    Template --> DataAttr
    DataAttr --> DataRender
    DataRender --> TemplateEnd
    TemplateEnd --> Runtime
    Runtime --> RevealContent
    RevealContent --> RemoveFallback
```
Sources: [packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js4500-4700](https://github.com/facebook/react/blob/65eec428/packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js#L4500-L4700)

## Error Handling and Recovery

React Fizz handles errors at different levels with different recovery strategies.

**Error Handling Hierarchy**

```mermaid
flowchart TD
    RootError["Root ErrorNo error boundary"]
    BoundaryError["Boundary ErrorWithin Suspense"]
    FallbackError["Fallback ErrorWithin fallback"]
    RootAbort["Abort entire request"]
    RejectPromise["Reject entry point promise"]
    CloseWithError["closeWithError(destination, error)"]
    MarkClientRendered["boundary.status = CLIENT_RENDEREDboundary.errorDigest = digest"]
    QueueClientRender["clientRenderedBoundaries.push(boundary)"]
    FlushClientRender["writeClientRenderBoundaryInstruction(boundaryID, digest, message)"]
    OnError["onError(error, errorInfo)Returns error digest"]
    OnShellError["onShellError(error)Called for shell errors"]
    OnFatalError["onFatalError(error)Called for unrecoverable errors"]

    RootError --> RootAbort
    RootAbort --> OnShellError
    RootAbort --> OnFatalError
    RootAbort --> RejectPromise
    RejectPromise --> CloseWithError
    BoundaryError --> MarkClientRendered
    MarkClientRendered --> OnError
    OnError --> QueueClientRender
    QueueClientRender --> FlushClientRender
    FallbackError --> RootAbort
```
Sources: [packages/react-server/src/ReactFizzServer.js3600-3800](https://github.com/facebook/react/blob/65eec428/packages/react-server/src/ReactFizzServer.js#L3600-L3800)

### Error Information

The `onError` callback receives detailed error information for logging and monitoring.

**ErrorInfo Structure**

| Field | Type | Description |
| --- | --- | --- |
| `componentStack` | `string` | Component stack trace |
| `error` | `mixed` | The thrown error object |
| `errorInfo.digest` | `?string` | Error hash for client matching |

Sources: [packages/react-server/src/ReactFizzServer.js384-400](https://github.com/facebook/react/blob/65eec428/packages/react-server/src/ReactFizzServer.js#L384-L400)

## Performance Optimizations

### Progressive Chunk Size

The `progressiveChunkSize` option controls how much HTML is buffered before flushing.

**Default Chunk Size Calculation**

The default of 12,800 bytes is based on:

-   3G network speed: ~500 kbits/second
-   Target: Send content every 500ms
-   500ms × (500 kbits/s) × 0.8 (realistic throughput) × 0.5 (HTML overhead) / 2 = 12.5kb

Sources: [packages/react-server/src/ReactFizzServer.js414-429](https://github.com/facebook/react/blob/65eec428/packages/react-server/src/ReactFizzServer.js#L414-L429)

### Boundary Inlining

Small boundaries can be inlined directly instead of being outlined with separate instructions.

**Outlining Eligibility**

```
function isEligibleForOutlining(request, boundary) {
  return (
    (boundary.byteSize > 500 ||
      hasSuspenseyContent(boundary.contentState) ||
      boundary.defer) &&
    boundary.preamble === null
  );
}
```
-   Boundaries < 500 bytes: Inlined
-   Boundaries ≥ 500 bytes: Outlined with instructions
-   Defer boundaries: Always outlined
-   Preamble boundaries: Never outlined (for render-blocking)

Sources: [packages/react-server/src/ReactFizzServer.js466-482](https://github.com/facebook/react/blob/65eec428/packages/react-server/src/ReactFizzServer.js#L466-L482)

### Early Headers

The `onHeaders` callback allows sending `Link` headers before any HTML for early hints.

**Header Capacity Management**

Resources are accumulated into Link headers until capacity is reached:

-   Default capacity: 2000 UTF-16 code units (~2KB)
-   Priority order: preconnects, font preloads, high-priority image preloads
-   Remaining resources flush in HTML `<link>` tags

Sources: [packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js367-489](https://github.com/facebook/react/blob/65eec428/packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js#L367-L489)
