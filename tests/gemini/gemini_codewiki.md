# google-gemini/gemini-cli

[](https://github.com/google-gemini/gemini-cli)

This wiki was automatically generated on Jan 26, 2026 based on commit [`cb772a5`](https://github.com/google-gemini/gemini-cli/tree/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed). Gemini can make mistakes, so double-check it.

The Gemini CLI is a command-line tool that enables AI agents to interact with the local environment, execute shell commands, and manage files. It serves as a programmable interface, leveraging generative AI models for tasks such as code generation and repository analysis, and supports integrating custom tools and logic.

The CLI integrates with generative AI models like Gemini 3 Pro and Gemini 3 Flash for content generation and chat sessions [Leveraging Gemini 3 Pro/Flash Models](https://codewiki.google/github.com/google-gemini/gemini-cli#getting-started-with-gemini-cli-leveraging-gemini-3-proflash-models). Users customize its behavior through a layered configuration system, which defines settings from defaults to command-line arguments [Advanced Configuration Management and Precedence](https://codewiki.google/github.com/google-gemini/gemini-cli#getting-started-with-gemini-cli-advanced-configuration-management-and-precedence). Multiple authentication methods, including Google login and Gemini API keys, secure access to AI services [Comprehensive Authentication and Credential Management](https://codewiki.google/github.com/google-gemini/gemini-cli#getting-started-with-gemini-cli-comprehensive-authentication-and-credential-management).

It supports extending capabilities through a modular system of extensions, hooks, and agent skills [Extending Gemini CLI with Extensions, Hooks, and Skills](https://codewiki.google/github.com/google-gemini/gemini-cli#extending-gemini-cli-with-extensions-hooks-and-skills). Extensions bundle custom commands, Model Context Protocol (MCP) servers, and agent skills. Hooks inject custom logic into the agent's workflow without modifying the source code, while agent skills provide specialized, context-aware model behaviors.

The CLI enables AI agents to utilize a suite of built-in tools for file system manipulation and shell command execution. A policy engine enforces rules for tool execution, ensuring security and user confirmation for sensitive actions [Tool Management and Policy Enforcement](https://codewiki.google/github.com/google-gemini/gemini-cli#tool-management-and-policy-enforcement). An experimental Agent-to-Agent (A2A) server facilitates communication and orchestration among agents, allowing them to manage tasks and execute tools cooperatively [Agent-to-Agent (A2A) Communication and Orchestration](https://codewiki.google/github.com/google-gemini/gemini-cli#agent-to-agent-a2a-communication-and-orchestration).

The terminal user interface provides an interactive experience, featuring extensible components and themes. A dedicated VS Code extension integrates the CLI with the IDE, providing contextual information and enabling native diffing capabilities within the development environment [User Interface and IDE Integration](https://codewiki.google/github.com/google-gemini/gemini-cli#user-interface-and-ide-integration).

## Getting Started with Gemini CLI



The Gemini Command Line Interface (CLI) provides a user-friendly way to interact with Gemini AI models directly from the terminal. It facilitates tasks such as code generation, repository analysis, and file system operations. New users can quickly get started by following installation and authentication procedures, configuring settings, and exploring practical examples.

Installation of the Gemini CLI can be achieved through various methods, including [`npm`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/utils/installationInfo.ts#L16) for standard setups, [`npx`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/utils/installationInfo.ts#L23) for temporary execution, and Docker/Podman for sandboxed environments. For detailed installation steps and architectural insights, refer to [Gemini CLI Installation Methods and Architecture](https://codewiki.google/github.com/google-gemini/gemini-cli#getting-started-with-gemini-cli-gemini-cli-installation-methods-and-architecture). After installation, authentication is required to access Gemini services. The CLI supports several authentication methods, including Google login, Gemini API keys, and Vertex AI integration, allowing flexibility based on user environment and security requirements. A comprehensive guide to setting up and managing credentials can be found in [Comprehensive Authentication and Credential Management](https://codewiki.google/github.com/google-gemini/gemini-cli#getting-started-with-gemini-cli-comprehensive-authentication-and-credential-management).

The behavior of the Gemini CLI can be customized through its layered configuration system. Settings can be defined through default values, [`settings.json`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/README.md?plain=1#L340) files at various scopes (system, user, project), environment variables, and command-line arguments, with a clear precedence hierarchy. This allows for fine-grained control over aspects such as model selection, tool execution policies, and user interface preferences. For an in-depth understanding of configuration management, including the structure and precedence of settings, see [Advanced Configuration Management and Precedence](https://codewiki.google/github.com/google-gemini/gemini-cli#getting-started-with-gemini-cli-advanced-configuration-management-and-precedence). While a newer configuration system is in place, legacy [`v1`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/cli/custom-commands.md?plain=1#L33) configurations are still supported and documented in [Understanding Deprecated v1 Configuration](https://codewiki.google/github.com/google-gemini/gemini-cli#getting-started-with-gemini-cli-understanding-deprecated-v1-configuration).

A key feature of the Gemini CLI is its ability to leverage powerful models like Gemini 3 Pro and Gemini 3 Flash. Users can enable and manage these models, understand usage limits, handle capacity errors, and choose different model routing strategies to optimize performance and cost. Integration with Gemini Code Assist is also available for a streamlined development workflow. For specific instructions on utilizing these advanced models, refer to [Leveraging Gemini 3 Pro/Flash Models](https://codewiki.google/github.com/google-gemini/gemini-cli#getting-started-with-gemini-cli-leveraging-gemini-3-proflash-models).

The practical applications of the Gemini CLI extend to various use cases, such as explaining code repositories, generating unit tests, interacting with the file system, performing content analysis, and facilitating code generation. These examples demonstrate how the CLI can be integrated into daily development tasks to enhance productivity. For practical demonstrations and examples, refer to [Practical Applications and Use Cases](https://codewiki.google/github.com/google-gemini/gemini-cli#getting-started-with-gemini-cli-practical-applications-and-use-cases). The initial quickstart guide, located in [`docs/get-started/index.md`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/get-started/index.md), serves as an entry point, directing users to more detailed documentation for each of these areas.

### Gemini CLI Installation Methods and Architecture



The Gemini CLI offers several methods for installation and execution, catering to various user needs from quick trials to development and sandboxed environments. The underlying architecture ensures flexibility through distinct NPM packages and efficient build processes.

For standard usage, the Gemini CLI can be installed globally via [`npm`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/utils/installationInfo.ts#L16) or executed on-demand using [`npx`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/utils/installationInfo.ts#L23), as detailed in the quickstart guide [Getting Started with Gemini CLI](https://codewiki.google/github.com/google-gemini/gemini-cli#getting-started-with-gemini-cli). This approach provides immediate access to the CLI's functionalities.

To enhance security and provide an isolated execution environment, the Gemini CLI supports running within sandboxes like Docker or Podman. Users can either run a pre-built [`gemini-cli-sandbox`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/Dockerfile#L3) Docker image or enable sandbox mode with an existing local CLI installation using the [`--sandbox`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/cli/sandbox.md?plain=1#L75) flag. This ensures that potentially risky operations are contained, protecting the host system.

Developers and contributors can run the Gemini CLI directly from its source code. This method, typically involving [`npm run start`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/Makefile#L3) for development, supports features like hot-reloading and allows for simulating a global installation for testing purposes using [`npm link packages/cli`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/GEMINI.md?plain=1#L20). For testing unreleased features, the CLI can also be executed directly from GitHub using [`npx`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/utils/installationInfo.ts#L23).

The deployment architecture of the Gemini CLI leverages a monorepo structure, publishing two main NPM packages: [`@google/gemini-cli-core`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/npm.md?plain=1#L17), which encapsulates the core backend logic, and [`@google/gemini-cli`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/README.md?plain=1#L5), serving as the user-facing frontend. The build process for these packages involves TypeScript transpilation to JavaScript using [`tsc`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/scripts/build_package.js#L32) for NPM publication. Additionally, for [`npx`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/utils/installationInfo.ts#L23) execution directly from GitHub, [`esbuild`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/esbuild.config.js#L13) is utilized to bundle the application on-the-fly via a [`prepare`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/LICENSE#L70) script within the [`package.json`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/faq.md?plain=1#L27). This dual approach ensures both stable releases and dynamic execution of the latest development versions.

### Comprehensive Authentication and Credential Management

link

| Authentication Method | Primary Use Case | Configuration |
| --- | --- | --- |
| Login with Google | Interactive use for individual, company, school, or Google Workspace accounts | `gemini` command, then select "Login with Google" in the browser prompt. |
| Gemini API Key | AI Studio users; non-interactive environments where Google login isn't feasible | Set `GEMINI_API_KEY` environment variable with your key from Google AI Studio. |
| Vertex AI (ADC via `gcloud`) | Google Cloud users with `gcloud` CLI installed; interactive or programmatic access | `gcloud auth application-default login` command; ensure `GOOGLE_CLOUD_PROJECT` and `GOOGLE_CLOUD_LOCATION` environment variables are set. |
| Vertex AI (Service Account JSON Key) | Non-interactive environments, CI/CD pipelines, or restricted user-based authentication | Create a service account key, download its JSON file, and set `GOOGLE_APPLICATION_CREDENTIALS` environment variable to the file's path. Ensure `GOOGLE_CLOUD_PROJECT` and `GOOGLE_CLOUD_LOCATION` are set. |
| Vertex AI (Google Cloud API Key) | Google Cloud users with an API key, for specific use cases | Obtain a Google Cloud API key and set `GOOGLE_API_KEY` environment variable. Ensure `GOOGLE_CLOUD_PROJECT` and `GOOGLE_CLOUD_LOCATION` are set. |
| Headless Mode | Non-interactive use without an existing authentication credential cache | Configure either `GEMINI_API_KEY` or the relevant Vertex AI environment variables (`GOOGLE_API_KEY`, `GOOGLE_APPLICATION_CREDENTIALS`, `GOOGLE_CLOUD_PROJECT`, `GOOGLE_CLOUD_LOCATION`). |
| Google Cloud Environments | Automatic authentication in Cloud Shell or Compute Engine | Authentication is typically automatic via Cloud Shell credentials or Compute Engine's Application Default Credentials (ADC). If automatic authentication fails, use one of the interactive methods. Note for Cloud Shell: `GOOGLE_CLOUD_PROJECT` set in global environment will be overridden; use a `.env` file to specify a different project. |

The Gemini CLI supports multiple authentication methods to interact with Gemini services, catering to various user scenarios and environments. These methods range from simple interactive Google logins to more complex integrations with Google Cloud's Vertex AI. The CLI prioritizes ease of use while providing robust options for enterprise and automated workflows. The authentication process is managed through configuration layers, environment variables, and command-line arguments, which determine how credentials are provided and prioritized.

For most individual users operating on a local machine, the recommended approach is to log in directly with a Google account. This interactive flow typically prompts the user to authenticate via a web browser when the [`gemini`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/types.ts#L344) command is first run. For non-interactive environments or specific use cases, an API key can be utilized by setting the [`GEMINI_API_KEY`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/README.md?plain=1#L191) environment variable. This key is obtained from Google AI Studio and should be treated as sensitive information. For more detailed guidance, see [`docs/get-started/authentication.md`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/get-started/authentication.md).

When integrating with Google Cloud's Vertex AI platform, the Gemini CLI offers several robust authentication pathways:

-   **Application Default Credentials (ADC)**: This method is suitable for users who have the Google Cloud CLI ([`gcloud`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/package.json#L27)) installed. By executing [`gcloud auth application-default login`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/cli/telemetry.md?plain=1#L137), users can set up ADC, which allows the Gemini CLI to automatically discover and use their Google Cloud credentials. This approach streamlines authentication for developers already working within the Google Cloud ecosystem.
-   **Service Account JSON Keys**: For non-interactive or programmatic environments, authentication can be performed using a service account JSON key. This involves creating a service account in Google Cloud, downloading its JSON key, and then setting the [`GOOGLE_APPLICATION_CREDENTIALS`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/cli/telemetry.md?plain=1#L121) environment variable to the path of this key file. This is particularly useful for deployments in virtual machines or CI/CD pipelines.
-   **Google Cloud API Key**: Alternatively, a Google Cloud API key can be used by setting the [`GOOGLE_API_KEY`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/README.md?plain=1#L207) environment variable. This method is simpler than service accounts but may have different security implications depending on the scope of the key.

Regardless of the chosen authentication method, the Gemini CLI often requires users to specify their Google Cloud Project. This is especially relevant for organization accounts, specific licenses, or when leveraging Vertex AI. The project ID can be configured via environment variables such as [`GOOGLE_CLOUD_PROJECT`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/faq.md?plain=1#L72) or [`GOOGLE_CLOUD_PROJECT_ID`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/troubleshooting.md?plain=1#L16).

To ensure credentials and configurations persist across sessions, environment variables can be set in shell configuration files (e.g., [`~/.bashrc`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/faq.md?plain=1#L83), [`~/.zshrc`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/get-started/authentication.md?plain=1#L261)) or by using a [`.env`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/faq.md?plain=1#L92) file, preferably located at [`~/.gemini/.env`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/get-started/authentication.md?plain=1#L277). The CLI loads environment variables from multiple sources, with [`.env`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/faq.md?plain=1#L92) files in the current and parent directories taking precedence. For a comprehensive overview of configuration management and precedence, including environment variables, refer to [Advanced Configuration Management and Precedence](https://codewiki.google/github.com/google-gemini/gemini-cli#getting-started-with-gemini-cli-advanced-configuration-management-and-precedence). The CLI also supports a legacy [`v1`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/cli/custom-commands.md?plain=1#L33) configuration format, which outlines similar mechanisms for setting environment variables and command-line arguments, as detailed in [Understanding Deprecated v1 Configuration](https://codewiki.google/github.com/google-gemini/gemini-cli#getting-started-with-gemini-cli-understanding-deprecated-v1-configuration).

In Google Cloud environments like Google Cloud Shell or Compute Engine, authentication is often handled automatically through the instance's identity, simplifying the setup process further. For headless mode operations, the CLI relies on existing cached credentials or explicitly provided environment variables, such as [`GEMINI_API_KEY`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/README.md?plain=1#L191) or the Vertex AI-related variables.

### Advanced Configuration Management and Precedence



The Gemini CLI employs a layered configuration system to manage its behavior, allowing for flexible and granular control over settings. This system prioritizes settings from various sources, ensuring that the most specific or explicit configurations take precedence.

Settings are applied in a defined order: default values establish the baseline, followed by system-wide default files, user-specific settings, project-level configurations, and finally, system-wide override files. Environment variables further influence these settings, and command-line arguments provide the highest level of precedence, overriding all other configurations for a given session. This hierarchy ensures that users can customize the CLI's operation at different scopes, from global defaults to single-command invocations.

Persistent configurations are primarily managed through JSON [`settings.json`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/README.md?plain=1#L340) files. These files can be found in several locations, including system-wide default paths (e.g., [`/etc/gemini-cli/system-defaults.json`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/get-started/configuration.md?plain=1#L45) on Linux), user-specific directories ([`~/.gemini/settings.json`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/README.md?plain=1#L340)), and within project roots ([`.gemini/settings.json`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/faq.md?plain=1#L105)). A system-wide override file (e.g., [`/etc/gemini-cli/settings.json`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/hooks/index.md?plain=1#L112) on Linux) allows administrators to enforce specific settings across an entire system. These [`settings.json`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/README.md?plain=1#L340) files support referencing environment variables, enabling dynamic configuration based on the execution environment. The CLI also provides a schema ([`https://raw.githubusercontent.com/google-gemini/gemini-cli/main/schemas/settings.schema.json`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/schemas/settings.schema.json#L3)) for [`settings.json`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/README.md?plain=1#L340) files to aid in validation and autocompletion in JSON-aware editors.

Environmental variables play a significant role in configuring the CLI, offering a convenient way to set parameters without modifying files. The CLI automatically loads variables from [`.env`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/faq.md?plain=1#L92) files, searching for them in the current directory, parent directories up to the project root, and the user's home directory ([`~/.env`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/CONTRIBUTING.md?plain=1#L212)). Key environment variables include [`GEMINI_API_KEY`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/README.md?plain=1#L191) for authentication, [`GOOGLE_CLOUD_PROJECT`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/faq.md?plain=1#L72) for specifying a Google Cloud project, and [`GEMINI_SANDBOX`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/package.json#L48) for controlling sandbox mode. The system also supports redacting sensitive environment variables for security, with configurable allowed and blocked lists.

Context files, typically named [`GEMINI.md`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/README.md?plain=1#L131), are Markdown files that provide hierarchical instructional context to the Gemini model. These files can contain project-specific guidelines, coding styles, or background information, influencing the model's responses. They are loaded from a global location, the project root and its ancestral directories, and specific subdirectories. Content from more specific locations takes precedence, allowing for fine-grained control over the context provided to the AI. Commands like [`/memory refresh`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/core/index.md?plain=1#L94) reload these contexts, and [`/memory show`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/core/index.md?plain=1#L93) displays the combined instructional content. Importing other Markdown files within [`GEMINI.md`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/README.md?plain=1#L131) is also supported.

The CLI incorporates sandboxing capabilities to isolate potentially unsafe operations. Sandboxing, which can be enabled via command-line arguments (e.g., [`--sandbox`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/cli/sandbox.md?plain=1#L75)) or environment variables (e.g., [`GEMINI_SANDBOX`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/package.json#L48)), executes commands within a secure environment, such as a Docker container using the [`gemini-cli-sandbox`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/Dockerfile#L3) image. Projects can also define custom sandbox environments using a [`sandbox.Dockerfile`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/CONTRIBUTING.md?plain=1#L439) within their [`.gemini`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/faq.md?plain=1#L92) directory.

Telemetry and usage statistics collection are configurable, allowing users to control whether anonymized data about tool calls, model usage, and CLI configuration is sent to Google to improve the product. This feature can be toggled via [`privacy.usageStatisticsEnabled`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/get-started/configuration.md?plain=1#L293) in [`settings.json`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/README.md?plain=1#L340), ensuring user control over data sharing. The CLI is designed to avoid collecting personally identifiable information (PII), prompt/response content, or file content. For more details on authentication, refer to [Comprehensive Authentication and Credential Management](https://codewiki.google/github.com/google-gemini/gemini-cli#getting-started-with-gemini-cli-comprehensive-authentication-and-credential-management). For deprecated configuration settings, refer to [Understanding Deprecated v1 Configuration](https://codewiki.google/github.com/google-gemini/gemini-cli#getting-started-with-gemini-cli-understanding-deprecated-v1-configuration).

### Understanding Deprecated v1 Configuration



The Gemini CLI previously utilized a legacy [`v1`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/cli/custom-commands.md?plain=1#L33) format for its [`settings.json`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/README.md?plain=1#L340) configuration, which, despite its deprecation, remains active until a planned migration date. This [`v1`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/cli/custom-commands.md?plain=1#L33) configuration allows for detailed customization of the CLI's behavior through various layers of precedence, from system defaults to command-line arguments.

Configuration settings in [`v1`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/cli/custom-commands.md?plain=1#L33) are loaded hierarchically. The lowest precedence is given to hardcoded default values, followed by a system defaults file ([`/etc/gemini-cli/system-defaults.json`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/get-started/configuration.md?plain=1#L45) on Linux). User-specific settings are then applied from [`~/.gemini/settings.json`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/README.md?plain=1#L340), which can be overridden by project-specific settings found in [`.gemini/settings.json`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/faq.md?plain=1#L105) within the project root. Finally, a system-wide settings file ([`/etc/gemini-cli/settings.json`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/hooks/index.md?plain=1#L112) on Linux) can apply overrides with the highest precedence among settings files. Environment variables and command-line arguments provide the ultimate overrides for a given session. For more information on configuration precedence in general, see [Advanced Configuration Management and Precedence](https://codewiki.google/github.com/google-gemini/gemini-cli#getting-started-with-gemini-cli-advanced-configuration-management-and-precedence).

The [`v1`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/cli/custom-commands.md?plain=1#L33) [`settings.json`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/README.md?plain=1#L340) defines a wide array of properties, including:

-   **Context Management**: [`contextFileName`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/hooks/useShowMemoryCommand.ts#L35) specifies the name of instructional context files, such as [`GEMINI.md`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/README.md?plain=1#L131). These files provide project-specific instructions to the Gemini model. The CLI loads these context files hierarchically, concatenating their content to inform the model.
-   **Tool Configuration**: Settings like [`coreTools`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/config/config.test.ts#L946), [`allowedTools`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/config/config.ts#L592), and [`excludeTools`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/config/config.ts#L634) control which tools are available to the model and whether they require user confirmation. It also supports [`allowMCPServers`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/get-started/configuration-v1.md?plain=1#L190) and [`excludeMCPServers`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/get-started/configuration-v1.md?plain=1#L204) for managing Model-Context Protocol (MCP) servers.
-   **Behavioral Control**: [`autoAccept`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/config/settingsSchema.ts#L1015) allows automatic acceptance of safe tool calls, while [`sandbox`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/test-utils/src/test-rig.ts#L346) enables sandboxed execution for potentially unsafe operations. Other settings manage the visual theme ([`theme`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/themes/theme.ts#L143)), Vim-style input ([`vimMode`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/hooks/vim.ts#L130)), and preferred editor for diffs ([`preferredEditor`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/config/settingsSchema.ts#L176)).
-   **Telemetry and Usage Statistics**: [`telemetry`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/test-utils/src/test-rig.ts#L329) and [`usageStatisticsEnabled`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/config/config.test.ts#L228) manage the collection of anonymized usage data.
-   **Session Management**: [`maxSessionTurns`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/config/settingsSchema.ts#L684) limits the number of turns in a chat session.

Environment variables can influence the CLI's behavior, with the [`v1`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/cli/custom-commands.md?plain=1#L33) configuration supporting loading from [`.env`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/faq.md?plain=1#L92) files. These files are searched in a specific order: the current directory, parent directories up to the project root or home directory, and finally [`~/.env`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/CONTRIBUTING.md?plain=1#L212). Examples of important environment variables include [`GEMINI_API_KEY`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/README.md?plain=1#L191) for authentication, [`GEMINI_MODEL`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/cli/model-routing.md?plain=1#L35) to specify the default model, and [`GOOGLE_CLOUD_PROJECT`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/faq.md?plain=1#L72) for Vertex AI integration.

Command-line arguments provide temporary overrides for [`v1`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/cli/custom-commands.md?plain=1#L33) settings during a session. For instance, [`--model`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/cli/model.md?plain=1#L8) or [`-m`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/README.md?plain=1#L234) can specify the AI model for a particular command, [`--prompt`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/cli/index.md?plain=1#L58) or [`-p`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/README.md?plain=1#L242) allows non-interactive prompting, and [`--sandbox`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/cli/sandbox.md?plain=1#L75) or [`-s`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/scripts/build.js#L38) can enable sandbox mode for a session. The [`--yolo`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/cli/headless.md?plain=1#L306) argument, for example, bypasses all tool call confirmations for a given session.

### Leveraging Gemini 3 Pro/Flash Models



The Gemini CLI supports the use of Gemini 3 Pro and Gemini 3 Flash models, which are powerful generative AI models. To begin using these models, users must first update their [`Gemini CLI`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/README.md?plain=1#L1) installation to version [`0.21.1`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/get-started/gemini-3.md?plain=1#L13) or newer. Once updated, users enable experimental features via the [`/settings`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/index.md?plain=1#L62) command by toggling [`Preview Features`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/README.md?plain=1#L79) to [`true`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/config/config.ts#L674). Finally, the desired model, such as [`Auto (Gemini 3)`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/cli/model.md?plain=1#L24), can be selected using the [`/model`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/cli/model.md?plain=1#L12) command.

The CLI manages usage of these models, including daily limits for Gemini 3 Pro. If these limits are reached, the system will prompt the user to switch to alternative, less capable models like Gemini 2.5 Pro or Gemini 2.5 Flash, or to consider upgrading their plan for increased capacity. When the Gemini 3 Pro model experiences high demand or capacity errors, the CLI provides options to either [`Keep trying`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/get-started/gemini-3.md?plain=1#L34) with an exponential backoff strategy or to [`fallback`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/tools/shell.ts#L112) to Gemini 2.5 Pro, ensuring continuous operation.

Two primary model routing strategies are available:

-   **Auto routing:** This strategy intelligently selects models based on the complexity of the prompt. It typically routes simpler requests to Gemini 2.5 Flash and more complex ones to Gemini 3 Pro (if enabled) or Gemini 2.5 Pro.
-   **Pro routing:** Accessible by selecting [`Pro`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/faq.md?plain=1#L110) via the [`/model`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/cli/model.md?plain=1#L12) command, this strategy prioritizes the most capable available model, including Gemini 3 Pro.

For users leveraging Gemini Code Assist, specific integration steps are required to enable Gemini 3 Pro. This involves an administrator setting the [`Release channels for Gemini Code Assist in local IDEs`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/get-started/gemini-3.md?plain=1#L1) to [`Preview`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/README.md?plain=1#L79) within Google Cloud Project settings. Following this administrative action, individual users can then enable [`Preview Features`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/README.md?plain=1#L79) in their [`Gemini CLI`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/README.md?plain=1#L1) interface. Further details on these steps are available in [`docs/get-started/gemini-3.md`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/get-started/gemini-3.md).

For general authentication procedures, refer to [Comprehensive Authentication and Credential Management](https://codewiki.google/github.com/google-gemini/gemini-cli#getting-started-with-gemini-cli-comprehensive-authentication-and-credential-management). Configuration settings, including model selection, are outlined in [Advanced Configuration Management and Precedence](https://codewiki.google/github.com/google-gemini/gemini-cli#getting-started-with-gemini-cli-advanced-configuration-management-and-precedence) and [`docs/get-started/configuration.md`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/get-started/configuration.md).

### Practical Applications and Use Cases

link

cli

content\_copyCopy

\# Clone the 'chalk' repository, read its key source files, and explain how it works. Clone the 'chalk' repository from https://github.com/chalk/chalk, read its key source files, and explain how it works.

The Gemini CLI provides a variety of practical applications, enabling users to interact with AI models for diverse tasks. Examples include analyzing code, generating unit tests, interacting with the file system, and general content analysis and code generation, as detailed in the [`docs/get-started/examples.md`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/get-started/examples.md) document.

For instance, the CLI can be used to explain a code repository by first cloning a Git repository and then analyzing its source files to provide a summary of the code's functionality. This involves the CLI's ability to execute shell commands (like [`git clone`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/README.md?plain=1#L133)) and read files, with user permission. Similarly, the CLI can generate unit tests for existing code by understanding its logic and writing appropriate test cases, including mocking API calls and testing various scenarios. This often requires permissions to create new files.

Beyond code-centric tasks, the Gemini CLI supports general content analysis and generation. Users can provide prompts to perform actions like renaming files based on their content, requiring the CLI to analyze the content and request permission for file system modifications. Another application is combining spreadsheet data, where the CLI can process multiple CSV files, extract relevant information, and merge them into a single output file, necessitating permission to write the combined data. These interactions demonstrate the CLI's capability to understand natural language prompts, perform file system operations, and generate relevant content or code outputs. Comprehensive guidance on configuration, authentication, and model usage is available in [Getting Started with Gemini CLI](https://codewiki.google/github.com/google-gemini/gemini-cli#getting-started-with-gemini-cli).

## Gemini CLI Architecture and Core Functionality



The Gemini CLI's architecture integrates a user-facing frontend ([`packages/cli`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli)) with a robust backend ([`packages/core`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core)) to manage user interactions, process commands, and interact with generative AI models. The frontend handles CLI input and output, terminal UI, and configuration, while the backend orchestrates AI interactions, tool execution, and session management. This design allows for a flexible and extensible system where core functionalities are separated from the presentation layer.

At its core, the CLI manages an application lifecycle that begins with global error handling, such as for [`uncaughtException`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/index.ts#L17) in [`packages/cli/index.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/index.ts). Argument parsing and initial configuration loading set the stage for execution. A key architectural decision is the dynamic dispatch between interactive UI rendering, primarily built with [`Ink`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/GEMINI.md?plain=1#L15) (detailed further in [User Interface and IDE Integration](https://codewiki.google/github.com/google-gemini/gemini-cli#user-interface-and-ide-integration)), and non-interactive command execution, as seen in [`main`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/scripts/lint.js#L347) within [`packages/cli/src/gemini.tsx`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/gemini.tsx). This flexibility ensures the CLI can adapt to various usage scenarios, from direct user interaction to scripting and automation.

Authentication flows are a critical component, with the CLI supporting various methods like Google login, Gemini API keys, and Vertex AI integration. These mechanisms are managed within the core and validated during application initialization using functions like [`validateAuthMethod`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/config/auth.ts#L10) in [`packages/cli/src/config/auth.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/config/auth.ts), ensuring secure access to Gemini services. For a comprehensive overview of these methods, refer to [Comprehensive Authentication and Credential Management](https://codewiki.google/github.com/google-gemini/gemini-cli#getting-started-with-gemini-cli-comprehensive-authentication-and-credential-management).

The CLI employs a hierarchical settings management system that consolidates configurations from various sources, including default values, [`settings.json`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/README.md?plain=1#L340) files, environmental variables, and command-line arguments. This layered approach allows for granular control and precedence rules, ensuring that settings can be tailored to specific user, project, or environment needs. The [`loadCliConfig`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/config/config.ts#L415) function in [`packages/cli/src/config/config.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/config/config.ts) orchestrates this process, resolving parameters such as approval modes and tool exclusions. More details on this system can be found in [Advanced Configuration Management and Precedence](https://codewiki.google/github.com/google-gemini/gemini-cli#getting-started-with-gemini-cli-advanced-configuration-management-and-precedence).

Core functionalities are extensively managed within the backend ([`packages/core`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core)):

-   **Generative AI Interaction**: The backend facilitates interactions with generative AI models, including the LLM client for generating content and embeddings. It supports Gemini chat sessions, manages conversation history, and integrates external tools into the AI's capabilities.
-   **Command Execution**: The CLI processes various command types, including built-in commands (extensions, hooks, skills), slash commands for interactive use, and prompts. [`CommandService`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/services/CommandService.ts#L22) in [`packages/cli/src/services`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/services) is responsible for loading and managing these commands.
-   **Policy Enforcement**: A robust policy engine, described in [Tool Management and Policy Enforcement](https://codewiki.google/github.com/google-gemini/gemini-cli#tool-management-and-policy-enforcement), evaluates tool calls against predefined rules to determine whether to allow, deny, or seek user confirmation for execution. This is implemented by the [`PolicyEngine`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/policy/policy-engine.ts#L81) in [`packages/core/src/policy/policy-engine.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/policy/policy-engine.ts).
-   **Tool Scheduling**: The [`CoreToolScheduler`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/core/coreToolScheduler.ts#L99) in [`packages/core/src/core/coreToolScheduler.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/core/coreToolScheduler.ts) manages the lifecycle of tool execution, from request validation to user interaction and state management.
-   **Code Assistance**: The CLI integrates with code assistance features, providing functionalities like content streaming and experiment management through [`getCodeAssistServer`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/code_assist/codeAssist.ts#L41) in [`packages/core/src/code_assist`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/code_assist).
-   **Terminal Utilities**: The CLI provides utilities for processing and rendering ANSI escape codes in terminal output, ensuring a rich and readable user experience.
-   **Extension Management**: The extension system allows for expanding CLI capabilities through custom tools, commands, and agent skills. [`ExtensionManager`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/config/extension-manager.ts#L87) in [`packages/cli/src/config/extension-manager.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/config/extension-manager.ts) handles the lifecycle of extensions. Further details are available in [Extending Gemini CLI with Extensions, Hooks, and Skills](https://codewiki.google/github.com/google-gemini/gemini-cli#extending-gemini-cli-with-extensions-hooks-and-skills).
-   **Agent Orchestration**: Experimental Agent-to-Agent (A2A) communication and orchestration are supported, enabling agents to communicate, manage tasks, and execute tools, as detailed in [Agent-to-Agent (A2A) Communication and Orchestration](https://codewiki.google/github.com/google-gemini/gemini-cli#agent-to-agent-a2a-communication-and-orchestration).

The CLI also incorporates a [`ClearcutLogger`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/telemetry/clearcut-logger/clearcut-logger.ts#L231) for telemetry, tracking user actions and system events to aid in understanding usage patterns and improving the product. Error handling is centralized, providing specific mechanisms for Google API quota errors and other HTTP-related issues to ensure system stability and provide informative feedback to users.

### Application Lifecycle and Execution Management



The application's lifecycle begins with global error handling for uncaught exceptions, primarily addressing specific issues like [`node-pty`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/package.json#L132) race conditions on Windows. The core application logic is then initiated, encompassing several critical phases that orchestrate its behavior from startup to shutdown.

The [`main`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/scripts/lint.js#L347) function, located in [`packages/cli/src/gemini.tsx`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/gemini.tsx), orchestrates this lifecycle. It begins by registering cleanup routines from [`packages/cli/src/utils/cleanup.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/utils/cleanup.ts) to ensure proper resource management when the application exits. Following this, it loads application settings, parses command-line arguments, and constructs the initial application configuration. This process also involves resolving any [`TrustedFoldersError`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/gemini.tsx#L21) that may arise.

A crucial aspect of execution management is the handling of sandboxed environments. The application determines if it needs to operate within a sandbox or relaunch itself as a child process, optimizing memory usage during this transition. Authentication is orchestrated by validating and refreshing credentials, involving the selection and verification of various authentication methods. For a more detailed guide on authentication, refer to [Comprehensive Authentication and Credential Management](https://codewiki.google/github.com/google-gemini/gemini-cli#getting-started-with-gemini-cli-comprehensive-authentication-and-credential-management).

Administrative controls are set up to manage specific settings dynamically, and the terminal environment is configured by setting properties such as raw mode, alternate buffer, line wrapping, and the window title.

The application then dynamically dispatches execution based on whether an interactive UI is required. If the configuration dictates an interactive session, an [`Ink`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/GEMINI.md?plain=1#L15)\-based user interface is rendered, leveraging a rich set of React context providers for managing application state, user input, and session statistics. Conversely, for non-interactive scenarios, commands are executed directly, handling standard input, logging user prompts, and managing session data.

Throughout its execution, the application incorporates robust error handling mechanisms for various scenarios, such as invalid input combinations, ensuring graceful termination. Performance is also profiled during startup to optimize the application's initial load times.

### Command and Prompt Processing



The Gemini CLI implements a robust command management system to process user input, ranging from core built-in commands to custom extensions and interactive slash commands. This system orchestrates the execution of these commands and processes prompts by dynamically loading and interpreting various input types.

The core of the CLI's command handling resides within the [`packages/cli`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli) directory, particularly its [`src`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/GEMINI.md?plain=1#L25) subdirectory. This includes the application's overall lifecycle management and command processing.

Built-in commands provide foundational functionalities and are organized into logical groups:

-   **Extensions**: The [`extensionsCommand`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/commands/extensionsCommand.ts#L671) within [`packages/cli/src/commands`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/commands) manages the lifecycle of Gemini CLI extensions, encompassing installation, uninstallation, enabling, disabling, and updating. This allows users to expand the CLI's capabilities through custom tools and functionalities. See [Developing and Releasing Gemini CLI Extensions](https://codewiki.google/github.com/google-gemini/gemini-cli#extending-gemini-cli-with-extensions-hooks-and-skills-developing-and-releasing-gemini-cli-extensions) and [Managing Gemini CLI Extensions](https://codewiki.google/github.com/google-gemini/gemini-cli#extending-gemini-cli-with-extensions-hooks-and-skills-managing-gemini-cli-extensions) for more details.
-   **Hooks**: The [`hooksCommand`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/commands/hooksCommand.ts#L394) in [`packages/cli/src/commands`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/commands) facilitates the migration of older hook configurations, ensuring compatibility and providing a mechanism for injecting custom logic into the agentic loop. See [Implementing and Managing Hooks](https://codewiki.google/github.com/google-gemini/gemini-cli#extending-gemini-cli-with-extensions-hooks-and-skills-implementing-and-managing-hooks) for more information.
-   **MCP Servers**: The [`mcpCommand`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/commands/mcp.ts#L16) also in [`packages/cli/src/commands`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/commands) handles the configuration and interaction with Model Context Protocol (MCP) servers, which are external services that can provide additional tools and context to the Gemini model. See [MCP Server Integration in Extensions](https://codewiki.google/github.com/google-gemini/gemini-cli#extending-gemini-cli-with-extensions-hooks-and-skills-mcp-server-integration-in-extensions) for more information.
-   **Agent Skills**: The [`skillsCommand`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/commands/skillsCommand.ts#L282) within [`packages/cli/src/commands`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/commands) enables the management of agent skills, which are specialized knowledge modules or workflows that the Gemini model can utilize. See [Designing and Structuring Agent Skills](https://codewiki.google/github.com/google-gemini/gemini-cli#extending-gemini-cli-with-extensions-hooks-and-skills-designing-and-structuring-agent-skills) and [Discovering and Prioritizing Agent Skills](https://codewiki.google/github.com/google-gemini/gemini-cli#extending-gemini-cli-with-extensions-hooks-and-skills-discovering-and-prioritizing-agent-skills) for additional details.

Beyond these built-in commands, the CLI also supports slash commands and integrates various prompt processors for flexible input handling. Slash commands, processed by [`handleSlashCommand`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/nonInteractiveCliCommands.ts#L32) in [`packages/cli/src/nonInteractiveCliCommands.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/nonInteractiveCliCommands.ts), allow users to interact with the CLI through a structured command syntax, even in non-interactive modes. The [`packages/cli/src/services`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/services) directory plays a central role here, leveraging a [`CommandService`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/services/CommandService.ts#L22) to aggregate commands from different loaders, including [`BuiltinCommandLoader`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/services/BuiltinCommandLoader.ts#L57), [`McpPromptLoader`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/services/McpPromptLoader.ts#L22), and [`FileCommandLoader`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/services/FileCommandLoader.ts#L66). This service handles command conflicts and orchestrates the processing of prompts through implementations like [`DefaultArgumentProcessor`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/services/prompt-processors/argumentProcessor.ts#L17), [`AtFileProcessor`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/services/prompt-processors/atFileProcessor.ts#L21), and [`ShellProcessor`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/services/prompt-processors/shellProcessor.ts#L53), which manage dynamic argument handling, file content injections, and shell command execution.

### Generative AI Interaction and Chat Sessions



The Gemini CLI manages interactions with generative AI models, facilitating content generation and chat sessions. The core framework for stateless Large Language Model (LLM) calls is provided by [`BaseLlmClient`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/core/baseLlmClient.ts#L101) in [`packages/core/src/core`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/core). This client supports various generative tasks, including [`generateJson`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/core/baseLlmClient.ts#L108), [`generateContent`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/core/baseLlmClient.ts#L209), and [`generateEmbedding`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/core/baseLlmClient.ts#L161), incorporating retry logic and integrating with the model availability service. Content generation capabilities are abstracted through instances of [`ContentGenerator`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/core/contentGenerator.ts#L31) in [`packages/core/src/core/contentGenerator.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/core/contentGenerator.ts), which can be configured based on the authentication type ([`AuthType`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/core/contentGenerator.ts#L51)) to use [`FakeContentGenerator`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/core/fakeContentGenerator.ts#L42), [`RecordingContentGenerator`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/core/recordingContentGenerator.ts#L27), or Google-authenticated generators. Access to code assistance features is also provided via [`getCodeAssistServer`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/code_assist/codeAssist.ts#L41), detailed further in [Code Assist](https://codewiki.google/github.com/google-gemini/gemini-cli#gemini-cli-architecture-and-core-functionality-generative-ai-interaction-and-chat-sessions).

Gemini chat sessions are managed by the [`GeminiClient`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/core/client.ts#L81) class in [`packages/core/src/core/client.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/core/client.ts). This class orchestrates conversational interactions, maintains chat history through [`GeminiChat`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/core/geminiChat.ts#L233) in [`packages/core/src/core/geminiChat.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/core/geminiChat.ts), and integrates with various tools and the IDE context. The [`GeminiChat`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/core/geminiChat.ts#L233) component specifically handles message streaming, manages the conversation history, integrates with the [`hookSystem`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/core/geminiChat.ts#L506) for customizable logic, and logs telemetry data. For more information on the hook system, see [Implementing and Managing Hooks](https://codewiki.google/github.com/google-gemini/gemini-cli#extending-gemini-cli-with-extensions-hooks-and-skills-implementing-and-managing-hooks).

A crucial aspect of reliable generative AI interaction is handling model availability and implementing fallback policies. The [`packages/core/src/availability`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/availability) directory is dedicated to this. The [`ModelAvailabilityService`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/availability/modelAvailabilityService.ts#L41) tracks the health and status of different AI models, marking them as [`terminal`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/utils/terminalSetup.ts#L352) (permanently unavailable due to quotas or capacity issues), [`sticky_retry`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/availability/policyHelpers.ts#L215) (temporarily unavailable with a retry mechanism per turn), or [`healthy`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/core/geminiChat.test.ts#L2084). If a primary model becomes unavailable, the system can dynamically switch to alternative models, such as "flash" models, to ensure continuous operation. This process involves classifying errors to inform policy decisions and selecting models based on predefined policy chains. These policies, which can be configured to either [`silent`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/cli/model-routing.md?plain=1#L21)ly fallback or [`prompt`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/evals/test-helper.ts#L95) the user, are managed and provided by the policy catalog in [`packages/core/src/availability/policyCatalog.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/availability/policyCatalog.ts). Further details on error handling can be found in [Utilities, Testing, and Patches](https://codewiki.google/github.com/google-gemini/gemini-cli#gemini-cli-architecture-and-core-functionality-utilities-testing-and-patches).

The system also includes mechanisms for chat history compression, which automatically reduces conversation history to stay within token limits while aiming for lossless content reduction. This is important for managing costs and improving model performance. For more about core functionalities, see [`docs/core/index.md`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/core/index.md).

### Utilities, Testing, and Patches

link

| Utility Function | Category | File Path | Description |
| --- | --- | --- | --- |
| `ActivityLogger` | Logging & Monitoring | `src/utils/activityLogger.ts` | Captures session activities (network and console logs) and emits them as events, with options for sanitizing sensitive data and persisting to a JSONL file. |
| `enableAgent`, `disableAgent`, `renderAgentActionFeedback` | Agent Management | `src/utils/agentSettings.ts`, `src/utils/agentUtils.ts` | Functions to enable/disable agents across different scopes and format feedback for agent-related operations. |
| `assumeExhaustive`, `checkExhaustive` | Type Checking | `src/utils/checks.ts` | Utility functions for compile-time and runtime exhaustive type checking, useful in `switch` statements for `never` types. |
| `registerCleanup`, `runExitCleanup`, `cleanupCheckpoints` | Application Lifecycle & Cleanup | `src/utils/cleanup.ts` | Manages registration and execution of cleanup functions for graceful application exit, including telemetry shutdown and temporary file removal. |
| `parseSlashCommand` | Command Parsing | `src/utils/commands.ts` | Parses raw slash command strings into structured objects, identifying the command to execute and its arguments. |
| `updateSettingsFilePreservingFormat` | Configuration Management | `src/utils/commentJson.ts` | Updates JSON configuration files while preserving comments and original formatting using `comment-json`. |
| `customDeepMerge` | Data Manipulation | `src/utils/deepMerge.ts` | Deeply merges multiple objects with support for custom merge strategies for arrays and shallow object merges. |
| `handleError`, `handleToolError`, `handleCancellationError`, `handleMaxTurnsExceededError` | Error Handling | `src/utils/errors.ts` | Centralized error handling for the CLI, providing consistent output formatting (JSON/text) and appropriate exit codes for various error types, including tool execution and cancellation. |
| `isGitHubRepository`, `getGitRepoRoot`, `getLatestGitHubRelease`, `getGitHubRepoInfo` | Git Utilities | `src/utils/gitUtils.ts` | Provides utilities for interacting with Git repositories, such as checking for GitHub origin, getting repository root, fetching latest GitHub releases, and extracting repository information. |
| `handleAutoUpdate`, `setUpdateHandler` | Auto Update | `src/utils/handleAutoUpdate.ts`, `src/utils/updateEventEmitter.ts`, `src/utils/installationInfo.ts` | Manages automatic updates for the CLI, detecting installation methods, initiating update commands, and emitting update status events. |
| `lerp` | Math | `src/utils/math.ts` | Linearly interpolates between two numeric values. |
| `PersistentState` | State Management | `src/utils/persistentState.ts` | Manages application-wide persistent state by storing and retrieving key-value pairs from a JSON file. |
| `relaunchApp`, `relaunchOnExitCode`, `relaunchAppInChildProcess` | Process Management | `src/utils/processUtils.ts`, `src/utils/relaunch.ts` | Provides functionality to relaunch the CLI process, either signaling the parent to restart or spawning a new child process with inherited context. |
| `readStdin` | Input/Output | `src/utils/readStdin.ts` | Asynchronously reads input from `stdin` with a maximum size limit and handles cases where input is not piped. |
| `resolvePath` | Path Utilities | `src/utils/resolvePath.ts` | Resolves and normalizes file paths, expanding user-specific shortcuts like `~` and `%userprofile%`. |
| `start_sandbox`, `getContainerPath`, `shouldUseCurrentUserInSandbox`, `parseImageName`, `ports`, `entrypoint` | Sandboxing | `src/utils/sandbox.ts`, `src/utils/sandboxUtils.ts` | Manages the execution of the CLI within a containerized sandbox environment (Docker, Podman, macOS Seatbelt), handling image pulling, volume mounting, environment variable passing, and user/group ID management. |
| `cleanupExpiredSessions`, `identifySessionsToDelete`, `parseRetentionPeriod`, `validateRetentionConfig`, `listSessions`, `deleteSession`, `hasUserOrAssistantMessage`, `extractFirstUserMessage`, `formatRelativeTime`, `getAllSessionFiles`, `getSessionFiles`, `SessionSelector` | Session Management | `src/utils/sessionCleanup.ts`, `src/utils/sessions.ts`, `src/utils/sessionUtils.ts` | Comprehensive utilities for managing chat sessions, including cleanup of expired/corrupted sessions, listing, deleting, loading, and searching historical sessions. |
| `getFlattenedSchema`, `getSettingsByCategory`, `getSettingDefinition`, `requiresRestart`, `getDefaultValue`, `getEffectiveDefaultValue`, `getAllSettingKeys`, `getSettingsByType`, `getSettingsRequiringRestart`, `isValidSettingKey`, `getSettingCategory`, `shouldShowInDialog`, `getDialogSettingsByCategory`, `getDialogSettingsByType`, `getDialogSettingKeys`, `getSettingValue`, `isSettingModified`, `settingExistsInScope`, `setPendingSettingValue`, `setPendingSettingValueAny`, `hasRestartRequiredSettings`, `getRestartRequiredFromModified`, `saveModifiedSettings`, `getDisplayValue`, `isDefaultValue`, `isValueInherited`, `getEffectiveDisplayValue` | Settings Management | `src/utils/settingsUtils.ts` | Provides a robust set of functions for interacting with application settings, including schema flattening, default value retrieval, scope-based value resolution, modification tracking, and persistence across different scopes. |
| `enableSkill`, `disableSkill`, `renderSkillActionFeedback`, `installSkill`, `uninstallSkill` | Skill Management | `src/utils/skillSettings.ts`, `src/utils/skillUtils.ts` | Functions to enable/disable skills across different scopes, install/uninstall skills from various sources (Git, local files), and format feedback for skill-related operations. |
| `spawnWrapper` | Process Spawning | `src/utils/spawnWrapper.ts` | A simple wrapper around `node:child_process.spawn` for consistent process creation. |
| `getStartupWarnings` | Startup Warnings | `src/utils/startupWarnings.ts`, `src/utils/userStartupWarnings.ts` | Retrieves and manages warnings generated during CLI startup, including user-specific warnings related to directory context. |
| `setupTerminalAndTheme` | Terminal & Theme | `src/utils/terminalTheme.ts` | Initializes terminal capabilities and loads/sets the active UI theme based on configuration and detected terminal background. |
| `computeTerminalTitle` | UI | `src/utils/windowTitle.ts` | Dynamically generates the terminal window title based on the CLI's current state (e.g., idle, working, confirming). |
| `isInCi` | CI Environment Detection | `src/patches/is-in-ci.ts` | A patched module that always returns `false` for CI environment detection to ensure consistent UI rendering. |

A comprehensive set of utility functions supports the Gemini CLI, facilitating various operational aspects from logging and configuration management to file system interactions and process control. An [`ActivityLogger`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/utils/activityLogger.ts#L43) in [`packages/cli/src/utils/activityLogger.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/utils/activityLogger.ts) intercepts and logs network requests and console messages, providing insights into application behavior. Agent management utilities, such as [`enableAgent`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/utils/agentSettings.ts#L35) and [`disableAgent`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/utils/agentSettings.ts#L89) in [`packages/cli/src/utils/agentSettings.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/utils/agentSettings.ts), manage the state of agents, while [`renderAgentActionFeedback`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/utils/agentUtils.ts#L18) in [`packages/cli/src/utils/agentUtils.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/utils/agentUtils.ts) handles user feedback for agent actions.

Type checking functions, [`assumeExhaustive`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/utils/checks.ts#L8) and [`checkExhaustive`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/utils/checks.ts#L22) in [`packages/cli/src/utils/checks.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/utils/checks.ts), enforce type safety within the codebase. For graceful application shutdown, [`cleanupCheckpoints`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/utils/cleanup.ts#L103), [`registerCleanup`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/scripts/telemetry_utils.js#L404), and [`registerSyncCleanup`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/utils/cleanup.ts#L24) in [`packages/cli/src/utils/cleanup.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/utils/cleanup.ts) ensure proper resource release. Command parsing is handled by [`parseSlashCommand`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/utils/commands.ts#L23) in [`packages/cli/src/utils/commands.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/utils/commands.ts), which converts raw user input into structured commands. Configuration management benefits from [`updateSettingsFilePreservingFormat`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/utils/commentJson.ts#L19) in [`packages/cli/src/utils/commentJson.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/utils/commentJson.ts), which updates JSON files while retaining comments, and [`customDeepMerge`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/utils/deepMerge.ts#L82) in [`packages/cli/src/utils/deepMerge.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/utils/deepMerge.ts), which merges objects deeply with customizable strategies.

The CLI includes robust error handling utilities, such as [`handleError`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/utils/errors.ts#L70), [`handleToolError`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/utils/errors.ts#L126), [`handleCancellationError`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/utils/errors.ts#L174), and [`handleMaxTurnsExceededError`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/utils/errors.ts#L213) in [`packages/cli/src/utils/errors.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/utils/errors.ts), centralizing the management of various error types. Interactions with Git and GitHub are facilitated by [`isGitHubRepository`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/utils/gitUtils.ts#L15), [`getGitRepoRoot`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/utils/gitUtils.ts#L38), [`getLatestGitHubRelease`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/utils/gitUtils.ts#L56), and [`getGitHubRepoInfo`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/utils/gitUtils.ts#L102) in [`packages/cli/src/utils/gitUtils.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/utils/gitUtils.ts), which extract repository information and manage releases. The [`handleAutoUpdate`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/utils/handleAutoUpdate.ts#L16) function in [`packages/cli/src/utils/handleAutoUpdate.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/utils/handleAutoUpdate.ts) manages updates to the CLI itself, ensuring users have access to the latest versions. Persistent state management, handled by [`PersistentState`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/utils/persistentState.ts#L20) in [`packages/cli/src/utils/persistentState.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/utils/persistentState.ts), stores user-specific data across sessions. Process utilities, including [`relaunchApp`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/utils/processUtils.ts#L17) in [`packages/cli/src/utils/processUtils.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/utils/processUtils.ts), manage the application's process lifecycle, while [`readStdin`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/utils/readStdin.ts#L9) reads input from standard input.

The CLI also incorporates a comprehensive testing infrastructure, primarily leveraging [`vitest`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/eslint.config.js#L237). The [`packages/cli/vitest.config.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/vitest.config.ts) file configures [`vitest`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/eslint.config.js#L237) for robust testing, defining test file patterns, environment settings, and extensive coverage reporting. The setup ensures that React component behaviors are correctly tested by catching and failing tests due to [`act(...)`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/test-setup.ts#L28) warnings through an interception of [`console.error`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/scripts/lint.js#L148), as configured in [`packages/cli/test-setup.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/test-setup.ts). This setup also provides custom matchers to extend [`vitest`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/eslint.config.js#L237)'s assertion capabilities.

Furthermore, the [`packages/cli/src/patches`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/patches) directory houses specific patches to external libraries. For instance, [`packages/cli/src/patches/is-in-ci.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/patches/is-in-ci.ts) modifies the [`is-in-ci`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/esbuild.config.js#L89) package to force [`isInCi`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/patches/is-in-ci.ts#L14) to [`false`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/config/config.ts#L432), which is critical for ensuring the interactive Ink user interface renders correctly even in continuous integration environments.

## Extending Gemini CLI with Extensions, Hooks, and Skills



The Gemini CLI is designed with extensibility at its core, allowing engineers to customize and expand its capabilities through extensions, hooks, and skills. This modularity enables users to integrate custom tools, commands, and contextual information into the CLI's workflow without modifying its core codebase.

Extensions act as packaged units that can bundle prompts, Model Context Protocol (MCP) servers, agent skills, and custom commands. These packages can be shared and installed to enhance the CLI's functionality. The lifecycle of an extension, from its development to its release and management, is supported by the CLI. For instance, creating a new extension project can be initiated using templates. Extensions can define custom tools that the Gemini model can utilize via an MCP server, implementing functions like [`registerTool`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/tools/tool-registry.ts#L214) to describe new tools with their input schemas. Custom commands can be implemented through TOML files that define prompt templates, allowing for the dynamic insertion of arguments and the execution of shell commands, with their output integrated into the prompt. Persistent conversational context can be provided to the model through a [`GEMINI.md`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/README.md?plain=1#L131) file, while [`Agent Skills`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/cli/skills.md?plain=1#L1) can offer specialized, context-aware model behavior. Local development is facilitated by the [`link`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/themes/theme.ts#L434) command, which symbolically links a development extension directory to the Gemini CLI installation, enabling real-time reflection of changes. Release mechanisms include direct installation from Git repositories, which supports specifying a [`ref`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/tools/tools.ts#L599) (branch, tag, or commit) for version control, and GitHub Releases, which allows for the distribution of extensions as archives, including platform-specific binaries through a defined naming convention. The management of extensionsincluding installation, uninstallation, enabling, disabling, and updatingis handled through dedicated CLI commands such as [`gemini extensions install`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/README.md?plain=1#L1) and [`gemini extensions update`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/faq.md?plain=1#L48). Configuration details for extensions are primarily managed through the [`gemini-extension.json`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/extensions/index.md?plain=1#L140) file, which defines properties like the extension's name, version, and MCP server configurations. Detailed examples for building various aspects of extensions, including accessible Ink components, extension hooks, and MCP servers, are provided in the [`examples`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/core/memport.md?plain=1#L42) directory under [`packages/cli/src/commands/extensions`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/commands/extensions).

Hooks provide a mechanism for injecting custom logic into the agentic loop at specific points without altering the source code of the CLI. These external scripts or programs communicate with the Gemini CLI via standard input/output streams using JSON, with logging and debugging output directed to standard error. The execution outcome of a hook is determined by its exit code: an exit code of [`0`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/LICENSE#L3) indicates success, [`2`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/LICENSE#L3) signifies a critical system block, and any other code results in a non-fatal warning. Hooks are triggered by various events in the CLI's lifecycle, such as [`SessionStart`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/config/settingsSchema.ts#L1687), [`BeforeAgent`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/config/settingsSchema.ts#L1651) (before agent planning), [`BeforeTool`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/hooks/types.ts#L34) (before a tool executes), and [`AfterModel`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/config/settingsSchema.ts#L1735) (after an LLM response). Hooks can be filtered using [`matchers`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/keyMatchers.ts#L59) defined in their configuration, allowing them to run only for specific tools or lifecycle events. Configuration for hooks is managed within [`settings.json`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/README.md?plain=1#L340), where their execution type (currently only "command" is supported), the command to execute, name, timeout, and description are defined. Hooks execute in a sanitized environment, with specific environment variables provided. Security considerations are addressed by fingerprinting project-level hooks and warning users about changes, as hooks execute arbitrary code with user privileges. Best practices for developing hooks emphasize performance optimization, robust debugging strategies, and secure coding practices, including input validation and timeout settings. Detailed specifications for hook types, including their input and output schemas, are available. More information on developing and managing hooks is available in [Implementing and Managing Hooks](https://codewiki.google/github.com/google-gemini/gemini-cli#extending-gemini-cli-with-extensions-hooks-and-skills-implementing-and-managing-hooks).

Agent Skills are a way to extend the Gemini CLI with specialized, context-aware model behaviors. The structure of a skill is typically defined by a [`SKILL.md`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/cli/skills.md?plain=1#L114) file, which includes YAML frontmatter for metadata (like [`name`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/eslint.config.js#L180) and [`description`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/tools/shell.md?plain=1#L5)) and a Markdown body that guides the model. Skills can also bundle scripts, references, and assets. Tooling is provided for the creation, packaging, and validation of these skills. For instance, [`packages/core/src/skills/builtin/skill-creator/scripts/init_skill.cjs`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/skills/builtin/skill-creator/scripts/init_skill.cjs) initializes a new skill directory, and [`packages/core/src/skills/builtin/skill-creator/scripts/package_skill.cjs`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/skills/builtin/skill-creator/scripts/package_skill.cjs) packages a skill folder into a distributable [`.skill`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/cli/skills.md?plain=1#L74) file. Validation, performed by [`validateSkill`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/skills/builtin/skill-creator/scripts/package_skill.cjs#L14) in [`packages/core/src/skills/builtin/skill-creator/scripts/validate_skill.cjs`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/skills/builtin/skill-creator/scripts/validate_skill.cjs), ensures that skill directories conform to structural and content rules. The [`SkillManager`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/skills/skillManager.ts#L17) in [`packages/core/src/skills/skillManager.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/skills/skillManager.ts) is central to managing the skill ecosystem, handling the discovery, loading, and prioritization of skills. It loads skills from various sources, such as built-in skills, extensions, user-defined skills, and workspace-defined skills, applying precedence rules where later-loaded skills with the same name override earlier ones. This manager also controls the enabled/disabled state of skills and manages administrative settings. The CLI provides commands to enable, disable, install, uninstall, and list skills, managing them across user-global and workspace-specific scopes. Further details on designing and structuring skills can be found in [Designing and Structuring Agent Skills](https://codewiki.google/github.com/google-gemini/gemini-cli#extending-gemini-cli-with-extensions-hooks-and-skills-designing-and-structuring-agent-skills).

### Developing and Releasing Gemini CLI Extensions



Developing extensions for the Gemini CLI allows engineers to expand its capabilities through custom tools, commands, and AI agent skills. The entire lifecycle of an extension, from initial creation to distribution, is supported.

Extensions are initialized using the [`gemini extensions new`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/README.md?plain=1#L1) command, which can scaffold projects from templates, such as an [`mcp-server`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/README.md?plain=1#L309) template for creating custom tools. The central configuration for an extension is defined in its [`gemini-extension.json`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/extensions/index.md?plain=1#L140) manifest file, which specifies its name, version, and how its components, like [`McpServer`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/tools/mcp-server.md?plain=1#L847)s, are loaded and configured. An [`McpServer`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/tools/mcp-server.md?plain=1#L847) ([`@modelcontextprotocol/sdk/server/mcp.js`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/tools/mcp-server.md?plain=1#L847)) runs as a separate process and exposes custom tools to the Gemini model, registering them with a [`description`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/tools/shell.md?plain=1#L5) and [`inputSchema`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/subagent-tool.ts#L28) using methods like [`registerTool`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/tools/tool-registry.ts#L214). Communication with the MCP server is facilitated by a [`StdioServerTransport`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/tools/mcp-server.md?plain=1#L848) ([`@modelcontextprotocol/sdk/server/stdio.js`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/tools/mcp-server.md?plain=1#L848)).

Beyond custom tools, extensions can define custom commands using TOML files within a [`commands/`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/extensions/index.md?plain=1#L244) subdirectory. These commands provide shortcuts to complex prompts, integrating shell commands and dynamic arguments. To provide persistent context to the model, an extension can include a [`GEMINI.md`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/README.md?plain=1#L131) file, specified by [`contextFileName`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/hooks/useShowMemoryCommand.ts#L35) in [`gemini-extension.json`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/extensions/index.md?plain=1#L140). For more specialized, context-aware AI behavior, [`Agent Skills`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/cli/skills.md?plain=1#L1) can be defined in [`SKILL.md`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/cli/skills.md?plain=1#L114) files within a [`skills/`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/changelogs/index.md?plain=1#L116) subdirectory. [Designing and Structuring Agent Skills](https://codewiki.google/github.com/google-gemini/gemini-cli#extending-gemini-cli-with-extensions-hooks-and-skills-designing-and-structuring-agent-skills) provides further details on skill design.

During development, local extensions can be symbolically linked to the Gemini CLI installation using [`gemini extensions link .`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/cli/telemetry.md?plain=1#L518), allowing for real-time iteration without repeated installation. Variable substitution, such as [`${extensionPath}`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/extensions/index.md?plain=1#L332) and [`${workspacePath}`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/extensions/index.md?plain=1#L375), ensures portability of extension configurations. Extensions can also define [`hooks`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/index.md?plain=1#L110) in [`hooks/hooks.json`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/extensions/index.md?plain=1#L318) to inject custom logic into specific lifecycle events of the CLI. [Implementing and Managing Hooks](https://codewiki.google/github.com/google-gemini/gemini-cli#extending-gemini-cli-with-extensions-hooks-and-skills-implementing-and-managing-hooks) elaborates on this.

For distribution, there are two primary release methods. Extensions can be released directly from a Git repository, allowing users to install them via [`gemini extensions install <your-repo-uri>`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/extensions/extension-releasing.md?plain=1#L3). This method supports specifying a Git [`ref`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/tools/tools.ts#L599) (branch, tag, or commit) for version control and allows developers to manage release channels (e.g., [`stable`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/README.md?plain=1#L89), [`preview`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/README.md?plain=1#L79), [`dev`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/scripts/start.js#L66)). Alternatively, extensions can be released through GitHub Releases. This method allows for the distribution of pre-built archives, which is particularly useful for extensions that require a build step or include platform-specific binaries. The [`gemini`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/types.ts#L344) CLI automatically detects the correct platform-specific binary based on a naming convention like [`{platform}.{arch}.{name}.{extension}`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/extensions/extension-releasing.md?plain=1#L109). An example GitHub Actions workflow is provided in the documentation ([`docs/extensions/extension-releasing.md`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/extensions/extension-releasing.md)) to demonstrate automating multi-platform builds and releases. These archives must be self-contained, with [`gemini-extension.json`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/extensions/index.md?plain=1#L140) at the root.

The extension management system also handles scenarios such as command naming conflicts, where extension commands are automatically prefixed (e.g., [`/gcp.deploy`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/extensions/index.md?plain=1#L360)) to maintain uniqueness. Experimental features, like user-configurable settings within extensions, are explicitly managed and can be configured during installation or via the [`gemini extensions config`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/faq.md?plain=1#L48) command. The CLI provides commands for managing installed extensions, including [`gemini extensions install`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/README.md?plain=1#L1), [`gemini extensions uninstall`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/README.md?plain=1#L379), [`gemini extensions disable`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/eslint.config.js#L71), [`gemini extensions enable`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/index.md?plain=1#L101), and [`gemini extensions update`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/faq.md?plain=1#L48) for updating to newer versions. [Managing Gemini CLI Extensions](https://codewiki.google/github.com/google-gemini/gemini-cli#extending-gemini-cli-with-extensions-hooks-and-skills-managing-gemini-cli-extensions) covers these commands in detail.

### Managing Gemini CLI Extensions



The Gemini CLI provides a suite of command-line interface commands for managing installed extensions, allowing users to install, update, uninstall, enable, disable, and configure extensions. The core logic for these operations is centralized within the [`ExtensionManager`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/config/extension-manager.ts#L87) class, which handles the loading, state management, and lifecycle of extensions.

Extensions can be installed from various sources, including Git repositories (via HTTP, HTTPS, Git, or SSO protocols) or local file paths. The [`install`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/ide/ide-installer.ts#L16) command, defined in [`packages/cli/src/commands/extensions/install.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/commands/extensions/install.ts), orchestrates this process, inferring installation metadata, handling user consent, and coordinating with the [`ExtensionManager`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/config/extension-manager.ts#L87) to perform the installation or update. Similarly, local extensions can be integrated into a workspace using the [`link`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/themes/theme.ts#L434) command, as defined in [`packages/cli/src/commands/extensions/link.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/commands/extensions/link.ts), which treats local paths as a specific type of installation.

To view currently installed extensions, the [`list`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/README.md?plain=1#L344) command, described in [`packages/cli/src/commands/extensions/list.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/commands/extensions/list.ts), retrieves and displays their names and versions. For removing extensions, the [`uninstall`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/README.md?plain=1#L379) command, implemented in [`packages/cli/src/commands/extensions/uninstall.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/commands/extensions/uninstall.ts), processes requests for single or multiple extensions by name or source URL, reporting any failures while attempting to complete all specified uninstallation tasks.

The state of extensions can be managed through enablement and disablement. The [`enable`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/utils/activityLogger.ts#L111) command in [`packages/cli/src/commands/extensions/enable.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/commands/extensions/enable.ts) activates an extension, while the [`disable`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/config/mcp/mcpServerEnablement.ts#L268) command in [`packages/cli/src/commands/extensions/disable.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/commands/extensions/disable.ts) deactivates it. Both commands allow specifying a [`scope`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/core/prompts.ts#L209) ([`User`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/hooks/types.ts#L25) or [`Workspace`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/config/settings.ts#L105)) to control whether the change applies globally or to a specific project. When no scope is provided for enablement, the extension is enabled across all scopes.

Extensions can also be kept up-to-date using the [`update`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/zed-integration/zedIntegration.ts#L382) command, which handles both individual and bulk updates for all installed extensions. This process involves checking for available updates, performing the necessary updates, and logging the status.

Configuration settings for extensions are managed through the [`configure`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/get-started/index.md?plain=1#L51) command, found in [`packages/cli/src/commands/extensions/configure.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/commands/extensions/configure.ts). This command allows users to set specific configuration values for an extension, configure all settings for a given extension, or iterate through all installed extensions to configure their settings. This supports both user-level and workspace-level settings, allowing for flexible and hierarchical management of extension behavior. The [`configure`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/get-started/index.md?plain=1#L51) command interactively prompts users, especially when overwriting existing settings, ensuring controlled and intentional configuration changes. These configuration capabilities are fundamental for tailoring extensions to specific workflows and preferences.

### Implementing and Managing Hooks



The Gemini CLI utilizes an experimental [`hooks`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/index.md?plain=1#L110) system to enable developers to extend and customize the CLI's behavior by injecting custom logic into the agentic loop. These hooks are external scripts or programs that the CLI executes at specific lifecycle events, allowing for modifications or validations without altering the CLI's core source code. The primary mechanisms for interaction involve standard input ([`stdin`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/zed-integration/zedIntegration.ts#L58)) for receiving JSON data, standard output ([`stdout`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/test-utils/src/test-rig.ts#L1175)) for returning JSON results to the CLI, and standard error ([`stderr`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/test-utils/src/test-rig.ts#L1176)) for logging and debugging messages.

Hooks are triggered by a variety of events within the Gemini CLI's operation. These can include [`SessionStart`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/config/settingsSchema.ts#L1687) (at the beginning of a session), [`BeforeAgent`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/config/settingsSchema.ts#L1651) (before the agent plans its actions), [`BeforeTool`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/hooks/types.ts#L34) (before a tool is invoked), [`AfterTool`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/config/settingsSchema.ts#L1639) (after a tool executes), [`BeforeModel`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/config/settingsSchema.ts#L1723) (before an LLM request is sent), and [`AfterModel`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/config/settingsSchema.ts#L1735) (after an LLM response is received). Each event provides specific input fields and expects certain output fields, enabling fine-grained control over the CLI's flow. For instance, a hook can block a tool execution or rewrite its input before it runs. Further details on specific events and their respective inputs and outputs can be found in [Gemini CLI Installation Methods and Architecture](https://codewiki.google/github.com/google-gemini/gemini-cli#getting-started-with-gemini-cli-gemini-cli-installation-methods-and-architecture).

Configuration of hooks is managed through [`settings.json`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/README.md?plain=1#L340) files, where hooks are defined under a [`hooks`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/index.md?plain=1#L110) key, nested by event type. Each hook definition specifies its type (currently, only [`"command"`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/hooks/types.ts#L87) for shell commands is supported), the command to execute, a name, a timeout, and a description. A crucial aspect of hook configuration is the [`matcher`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/hooks/hookPlanner.ts#L79) field, which uses regular expressions for tool-related events and exact strings for lifecycle events to filter when a hook runs, thereby optimizing performance by preventing unnecessary executions. Configuration precedence follows a hierarchy, with project-specific settings overriding user, system, and extension-defined settings.

The CLI uses exit codes to interpret a hook's outcome: an exit code of [`0`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/LICENSE#L3) indicates success, parsing [`stdout`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/test-utils/src/test-rig.ts#L1175) for its JSON content to influence logic; an exit code of [`2`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/LICENSE#L3) signifies a critical system block, aborting the target action with the reason provided in [`stderr`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/test-utils/src/test-rig.ts#L1176); any other exit code results in a non-fatal warning, allowing the interaction to proceed with original parameters. This system provides a structured way for hooks to control or influence the CLI's operation.

Best practices for implementing hooks emphasize performance, security, and maintainability. To ensure performance, hooks should be fast, ideally using parallel operations and caching expensive computations. Filtering with specific [`matcher`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/hooks/hookPlanner.ts#L79) patterns is recommended to limit execution to relevant events. For security, [`Gemini CLI`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/README.md?plain=1#L1) flags modifications to project-level hooks and warns users, as hooks execute arbitrary code. Validation of all inputs, setting strict timeouts, and limiting permissions are crucial for authoring secure hooks. Privacy considerations also guide hook development, with options to suppress output and manage sensitive data in logs.

Practical applications of hooks span various use cases, such as logging tool executions ([`docs/hooks/writing-hooks.md`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/hooks/writing-hooks.md)), dynamically injecting Git commit history as context before agent planning ([`docs/hooks/writing-hooks.md`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/hooks/writing-hooks.md)), filtering tools based on user messages for RAG-based interactions ([`docs/hooks/writing-hooks.md`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/hooks/writing-hooks.md)), or implementing security checks to block actions if sensitive data is detected ([`docs/hooks/writing-hooks.md`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/hooks/writing-hooks.md)). The CLI also offers commands like [`/hooks panel`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/hooks/best-practices.md?plain=1#L239) to view configured hooks, and [`/hooks enable`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/index.md?plain=1#L33)/[`/hooks disable`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/hooks/index.md?plain=1#L176) to manage their activation. For an example of an [`on-start`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/commands/extensions/examples/hooks/hooks/hooks.json#L8) hook, refer to [`packages/cli/src/commands/extensions/examples/hooks/scripts/on-start.js`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/commands/extensions/examples/hooks/scripts/on-start.js).

### Designing and Structuring Agent Skills

link

Agent skills extend the Gemini CLI's capabilities, allowing it to integrate specialized knowledge, workflows, and tool interactions. These skills transform the CLI into a more specialized agent by providing it with procedural knowledge. The methodology for designing and structuring these skills emphasizes conciseness, appropriate levels of specificity, and efficient context management, primarily through a principle known as progressive disclosure.

The anatomical structure of a skill is centered around a [`SKILL.md`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/cli/skills.md?plain=1#L114) file, which includes YAML [`frontmatter`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/agentLoader.ts#L204) for metadata such as [`name`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/eslint.config.js#L180) and [`description`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/tools/shell.md?plain=1#L5), and a Markdown [`body`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/agentLoader.ts#L168) for instructions. Beyond the core [`SKILL.md`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/cli/skills.md?plain=1#L114), skills can incorporate optional bundled resources in specific subdirectories:

-   [`scripts/`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/eslint.config.js#L40): Contains executable code (e.g., [`.cjs`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/utils/language-detection.ts#L13) files) for deterministic reliability or repetitive tasks, promoting token efficiency and reliable execution.
-   [`references/`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/skills/builtin/skill-creator/SKILL.md?plain=1#L79): Stores documentation and reference materials (e.g., Markdown files) that are loaded on demand to inform the [`gemini-cli`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/Makefile#L1)'s process, keeping the main [`SKILL.md`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/cli/skills.md?plain=1#L114) lean.
-   [`assets/`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/vscode-ide-companion/.vscodeignore#L7): Holds files that are not loaded into context but are used in the [`gemini-cli`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/Makefile#L1)'s output, such as images or templates.

A key design principle, progressive disclosure, ensures efficient management of the context window. This system operates in three levels:

1.  **Metadata**: The skill's name and description are always kept in context, allowing the CLI to quickly identify and suggest relevant skills.
2.  **[`SKILL.md`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/cli/skills.md?plain=1#L114) Body**: The main instructions and guidance within the [`SKILL.md`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/cli/skills.md?plain=1#L114) file are loaded only when the skill is triggered.
3.  **Bundled Resources**: Additional resources in [`scripts/`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/eslint.config.js#L40) and [`references/`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/skills/builtin/skill-creator/SKILL.md?plain=1#L79) are loaded only as needed, further minimizing token cost and preventing context overflow.

The creation of a new skill typically follows a structured process. It begins with understanding the desired skill and planning its reusable components. A skill can be initialized using the [`packages/core/src/skills/builtin/skill-creator/scripts/init_skill.cjs`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/skills/builtin/skill-creator/scripts/init_skill.cjs) script, which scaffolds a new skill directory with a predefined structure and templated files. After initialization, the skill's content is edited, adhering to writing guidelines for [`SKILL.md`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/cli/skills.md?plain=1#L114), including strict [`frontmatter`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/agentLoader.ts#L204) requirements and clear instructions in the [`body`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/agentLoader.ts#L168).

This structured approach ensures consistency, facilitates efficient context management, and provides a clear path for integrating specialized knowledge into the [`gemini-cli`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/Makefile#L1). For further details on the lifecycle and management of extensions, hooks, and skills, refer to [Extending Gemini CLI with Extensions, Hooks, and Skills](https://codewiki.google/github.com/google-gemini/gemini-cli#extending-gemini-cli-with-extensions-hooks-and-skills). The full details of the skill creation guidance are available in [`packages/core/src/skills/builtin/skill-creator/SKILL.md`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/skills/builtin/skill-creator/SKILL.md).

### Packaging and Validating Agent Skills



Agent skills, which extend the Gemini CLI's capabilities, are designed to be distributable and adhere to specific structural and content rules. This involves both packaging the skills into a portable format and validating their integrity and correctness. The entire process is supported by specialized scripts that facilitate initialization, packaging, and validation, ensuring that skills are well-formed and ready for use. For a comprehensive understanding of skill development, refer to [Developing and Releasing Gemini CLI Extensions](https://codewiki.google/github.com/google-gemini/gemini-cli#extending-gemini-cli-with-extensions-hooks-and-skills-developing-and-releasing-gemini-cli-extensions).

The process begins with skill creation, where the structure of a new skill is scaffolded using an initialization script located at [`packages/core/src/skills/builtin/skill-creator/scripts/init_skill.cjs`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/skills/builtin/skill-creator/scripts/init_skill.cjs). This script creates the necessary directories and template files, including the crucial [`SKILL.md`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/cli/skills.md?plain=1#L114) file, which defines the skill's metadata and instructions.

Once a skill is developed, it must be validated to ensure it conforms to predefined standards. The validation script, found at [`packages/core/src/skills/builtin/skill-creator/scripts/validate_skill.cjs`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/skills/builtin/skill-creator/scripts/validate_skill.cjs), performs several checks. It verifies the existence of the [`SKILL.md`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/cli/skills.md?plain=1#L114) file and scrutinizes its YAML frontmatter for mandatory fields like [`name`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/eslint.config.js#L180) and [`description`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/tools/shell.md?plain=1#L5), ensuring they follow specific formatting and length constraints. Additionally, the validator scans all skill files for 'TODO:' markers, issuing warnings if they are found, thereby promoting clean and complete skill definitions. The design principles behind structuring skills, including the use of [`SKILL.md`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/cli/skills.md?plain=1#L114) and associated resources, are detailed in [`packages/core/src/skills/builtin/skill-creator/SKILL.md`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/skills/builtin/skill-creator/SKILL.md).

After successful validation, the skill is ready for packaging into a distributable [`.skill`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/cli/skills.md?plain=1#L74) file. The packaging script, located at [`packages/core/src/skills/builtin/skill-creator/scripts/package_skill.cjs`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/skills/builtin/skill-creator/scripts/package_skill.cjs), compresses the skill's directory into a zip archive. This [`.skill`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/cli/skills.md?plain=1#L74) file serves as a portable unit that can be easily shared and installed, allowing the Gemini CLI to extend its functionalities by incorporating new agent capabilities. This systematic approach to packaging and validation helps maintain consistency and reliability across various agent skills, as discussed further in [Designing and Structuring Agent Skills](https://codewiki.google/github.com/google-gemini/gemini-cli#extending-gemini-cli-with-extensions-hooks-and-skills-designing-and-structuring-agent-skills).

### Discovering and Prioritizing Agent Skills



Agent skills in the Gemini CLI enhance its capabilities by providing specialized knowledge and workflows. The system manages skills through a structured process of discovery, loading, and prioritization, ensuring that the most relevant and up-to-date skill definitions are always available. This framework allows for the seamless integration of skills from various sources and provides mechanisms for their enablement, disablement, and activation.

Skill definitions are discovered and loaded from multiple sources, each with a defined precedence. This layered approach allows for modularity and customization:

-   **Built-in Skills:** These are skills bundled with the Gemini CLI itself, serving as foundational capabilities.
-   **Extension Skills:** Skills provided by installed extensions. See [Developing and Releasing Gemini CLI Extensions](https://codewiki.google/github.com/google-gemini/gemini-cli#extending-gemini-cli-with-extensions-hooks-and-skills-developing-and-releasing-gemini-cli-extensions) for more details.
-   **User-Defined Skills:** Skills created and managed by individual users, typically stored in a user-specific directory.
-   **Workspace-Defined Skills:** Skills specific to a particular project or workspace, which can override user-defined skills for that context.

The [`SkillManager`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/skills/skillManager.ts#L17) in [`packages/core/src/skills/skillManager.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/skills/skillManager.ts) orchestrates this discovery process. It loads skills in a specific order: built-in, then extension, user-defined, and finally workspace-defined. This order establishes a clear set of precedence rules: if multiple skills share the same name, the skill from the source with higher precedence (e.g., workspace-defined over user-defined) will be used, effectively overriding earlier definitions. This "last one wins" strategy ensures that localized or project-specific skill definitions can take priority over more general ones.

Skill definitions are extracted from [`SKILL.md`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/cli/skills.md?plain=1#L114) files, which contain YAML frontmatter for metadata (like [`name`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/eslint.config.js#L180) and [`description`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/tools/shell.md?plain=1#L5)) and a Markdown body for instructions. The [`skillLoader`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/index.ts#L107) module in [`packages/core/src/skills/skillLoader.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/skills/skillLoader.ts) is responsible for parsing these files, extracting the relevant information, and handling potential parsing errors, even when descriptions contain special characters.

Once discovered, skills can be managed via CLI commands. Users can [Managing Gemini CLI Extensions](https://codewiki.google/github.com/google-gemini/gemini-cli#extending-gemini-cli-with-extensions-hooks-and-skills-managing-gemini-cli-extensions) or disable skills either globally for their user profile or specifically for a workspace. Disabling a skill prevents its execution without removing its definition. The [`SkillManager`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/skills/skillManager.ts#L17) also tracks currently active skills and offers administrative controls to globally enable or disable skill functionality. The [`skills`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/core/prompts.ts#L190) command group in [`packages/cli/src/commands/skills`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/commands/skills) provides the CLI interface for these management actions.

### MCP Server Integration in Extensions



Extensions within the Gemini CLI can integrate custom tools and prompts through Model Context Protocol (MCP) servers, which facilitate communication between the CLI and external services. This integration allows extensions to expose specialized functionalities that the Gemini model can then leverage.

A core component of this integration is the registration of tools and prompts. Tools are defined with an input schema that specifies the arguments they expect. For instance, an extension can register a tool that fetches data from an external API, with its input schema defining any necessary parameters for the API call. Similarly, prompts can be registered with argument schemas, allowing them to accept specific inputs to generate content, such as a prompt for writing a poem based on a given title and mood. The example MCP server in [`packages/cli/src/commands/extensions/examples/mcp-server/example.js`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/commands/extensions/examples/mcp-server/example.js) demonstrates this by registering a [`fetch_posts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/extensions/getting-started-extensions.md?plain=1#L88) tool and a [`poem-writer`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/tools/mcp-server.md?plain=1#L857) prompt.

Communication with these MCP servers can be configured using various transport types. For example, [`StdioServerTransport`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/tools/mcp-server.md?plain=1#L848) utilizes standard input/output streams for communication. When developing a new extension that includes an MCP server, the [`gemini extensions new`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/README.md?plain=1#L1) command can be used to generate a template that includes this type of server, simplifying the initial setup.

Once an MCP server is defined within an extension, it needs to be configured within the Gemini CLI. The CLI provides commands for managing MCP servers, allowing users to add, list, enable, disable, and remove server configurations. For example, the [`gemini mcp add`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/cli/commands.md?plain=1#L3) command, defined in [`packages/cli/src/commands/mcp/add.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/commands/mcp/add.ts), allows users to register a new MCP server, specifying its transport type (e.g., [`stdio`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/scripts/lint.js#L129), [`sse`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/tools/mcp-server.md?plain=1#L456), or [`http`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/utils/activityLogger.ts#L314)), command, URL, and other options like environment variables or HTTP headers. The [`gemini mcp list`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/README.md?plain=1#L1) command, implemented in [`packages/cli/src/commands/mcp/list.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/commands/mcp/list.ts), displays all configured MCP servers, including those provided by extensions, along with their connection status. Managing the enablement and disablement of these servers is handled by commands such as [`gemini mcp enable`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/ROADMAP.md?plain=1#L1) and [`gemini mcp disable`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/cli/settings.md?plain=1#L1), which are defined in [`packages/cli/src/commands/mcp/enableDisable.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/commands/mcp/enableDisable.ts). These commands respect configuration precedence, ensuring that settings from extensions are handled appropriately. Further details on managing these servers can be found in [Model Context Protocol (MCP) and Authentication](https://codewiki.google/github.com/google-gemini/gemini-cli#model-context-protocol-mcp-and-authentication).

### Accessible Ink Component Development for Extensions

link

tsx

content\_copyCopy

function AccessibleButton({ children, onPress, ...props }) { const isScreenReaderEnabled = useIsScreenReaderEnabled(); // Conditionally render content based on screen reader status if (isScreenReaderEnabled) { return ( <Box aria-role\="button" // Semantic role for screen readers aria-label\={typeof children === 'string' ? children : 'Custom action'} // Descriptive label aria-state\={{ pressed: props.isPressed }} // Example of state // onSelect is a common prop for Ink components, similar to onClick onSelect\={onPress} {...props} > <Text\> {children} (Press to activate) </Text\> </Box\> ); } return ( <Box onSelect\={onPress} {...props}> <Text\>{children}</Text\> </Box\> ); }

Accessible Ink Component Development for Extensions provides guidance on building [`Ink`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/GEMINI.md?plain=1#L15) custom components that are accessible to a broad user base, including those who rely on screen readers. The approach emphasizes integrating accessibility considerations throughout the development process. A core aspect involves the detection of an active screen reader, which enables the CLI to provide alternative, more descriptive output. This functionality is primarily facilitated by the [`useIsScreenReaderEnabled`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/App.tsx#L7) hook, which allows developers to conditionally render UI elements or content based on the user's accessibility needs.

To enhance semantic understanding for screen readers, the framework encourages the use of ARIA (Accessible Rich Internet Applications) properties. Specifically, developers are guided to use [`aria-role`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/components/messages/Todo.tsx#L93), [`aria-state`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/components/shared/BaseSelectionList.tsx#L154), and [`aria-label`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/components/InputPrompt.tsx#L1106) properties on [`Box`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/test-utils/render.tsx#L8) and [`Text`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/cli/headless.md?plain=1#L76) components. These properties convey the purpose and state of UI elements, making the interface more comprehensible for assistive technologies. The guidance, detailed in [`packages/cli/src/commands/extensions/examples/context/GEMINI.md`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/commands/extensions/examples/context/GEMINI.md), aims to help developers create inclusive CLIs by leveraging [`Ink`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/GEMINI.md?plain=1#L15) features and established ARIA standards.

## Agent-to-Agent (A2A) Communication and Orchestration



The Gemini CLI incorporates an experimental Agent-to-Agent (A2A) server that facilitates communication and orchestration among agents. This server ([`packages/a2a-server`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server)) defines a [`development-tool`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/development-extension-rfc.md?plain=1#L1) extension that standardizes how clients and agents interact, covering aspects like agent configuration, tool execution, user confirmation, and command handling. The communication schemas for this extension are detailed in [`packages/a2a-server/development-extension-rfc.md`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/development-extension-rfc.md).

The A2A server manages the complete lifecycle of agent tasks. A [`Task`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/agent/task.ts#L62) ([`packages/a2a-server/src/agent/task.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/agent/task.ts)) object represents an individual task, managing interactions with the Gemini large language model (LLM), scheduling tool calls, handling user confirmations, and checkpointing file modifications. The [`CoderAgentExecutor`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/agent/executor.ts#L83) ([`packages/a2a-server/src/agent/executor.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/agent/executor.ts)) orchestrates the agent's interaction loop, creating, retrieving, and persisting tasks.

Agent definitions are loaded and validated from various sources. The [`AgentRegistry`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/registry.ts#L38) ([`packages/core/src/agents/registry.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/registry.ts)) discovers and registers agents from built-in definitions, user-defined configurations, project settings, and extensions. Agent definitions can be structured as Markdown files with YAML frontmatter, allowing for clear specification of prompts, tools, and model configurations, processed by functions such as [`loadAgentsFromDirectory`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/agentLoader.ts#L302) ([`packages/core/src/agents/agentLoader.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/agentLoader.ts)). These definitions are validated against [`zod`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/tools/mcp-server.md?plain=1#L849) schemas to ensure structural integrity. For more details on agent definition, loading, and validation, refer to [Agent Definition, Loading, and Validation](https://codewiki.google/github.com/google-gemini/gemini-cli#agent-to-agent-a2a-communication-and-orchestration-agent-definition-loading-and-validation).

Agent execution can occur locally or remotely. For local agents, the [`LocalAgentExecutor`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/local-executor.ts#L81) ([`packages/core/src/agents/local-executor.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/local-executor.ts)) manages the execution loop, including model interaction, tool execution, and termination conditions. Specific local agents, such as [`CliHelpAgent`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/cli-help-agent.ts#L26) ([`packages/core/src/agents/cli-help-agent.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/cli-help-agent.ts)) and [`CodebaseInvestigatorAgent`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/codebase-investigator.ts#L51) ([`packages/core/src/agents/codebase-investigator.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/codebase-investigator.ts)), are tailored for specialized tasks, leveraging specific tools and prompts.

Remote agent interactions are managed by the [`A2AClientManager`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/a2a-client-manager.ts#L27) ([`packages/core/src/agents/a2a-client-manager.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/a2a-client-manager.ts)), which handles the loading, caching, and communication with remote A2A agents. This manager operates as a singleton to ensure consistent interaction and supports authentication via mechanisms such as Google Application Default Credentials. Subagents can be integrated as tools, allowing parent agents to delegate tasks to other agents. The [`SubagentToolWrapper`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/subagent-tool-wrapper.ts#L23) ([`packages/core/src/agents/subagent-tool-wrapper.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/subagent-tool-wrapper.ts)) dynamically exposes agent definitions as declarative tools, facilitating both local and remote subagent invocations. For more details on local and remote agent execution, see [Local and Remote Agent Execution and Invocation](https://codewiki.google/github.com/google-gemini/gemini-cli#agent-to-agent-a2a-communication-and-orchestration-local-and-remote-agent-execution-and-invocation).

The A2A server also provides an HTTP API ([`packages/a2a-server/src/http`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/http)) for external interaction, enabling task creation, metadata retrieval, and command execution. Task persistence is managed, notably with [`GCSTaskStore`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/persistence/gcs.ts#L33) ([`packages/a2a-server/src/persistence/gcs.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/persistence/gcs.ts)) for saving task states and workspaces to Google Cloud Storage. For further information on task and workspace persistence, refer to [Agent Task and Workspace Persistence](https://codewiki.google/github.com/google-gemini/gemini-cli#agent-to-agent-a2a-communication-and-orchestration-agent-task-and-workspace-persistence).

### A2A Server Protocol and Client-Agent Communication



The A2A server in the Gemini CLI introduces an experimental [`development-tool`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/development-extension-rfc.md?plain=1#L1) extension, which defines a standardized protocol for client-agent communication. This protocol enables interactive workflows by establishing a structured way for clients to interact with the Gemini CLI agent.

At its core, the [`development-tool`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/development-extension-rfc.md?plain=1#L1) extension, detailed in [`packages/a2a-server/development-extension-rfc.md`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/development-extension-rfc.md), specifies schemas for various aspects of agent interaction. It begins with [`AgentSettings`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/types.ts#L46), allowing clients to provide initial configurations, including the [`workspace_path`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/development-extension-rfc.md?plain=1#L106) for the agent to operate within.

During an interaction, the agent communicates its progress and internal state through [`TaskStatusUpdateEvent`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/agent/task.ts#L36) messages. These messages contain [`DevelopmentToolEvent`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/development-extension-rfc.md?plain=1#L306) data, which can indicate several types of events such as [`TOOL_CALL_CONFIRMATION`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/development-extension-rfc.md?plain=1#L312), [`TOOL_CALL_UPDATE`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/development-extension-rfc.md?plain=1#L313), [`TEXT_CONTENT`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/development-extension-rfc.md?plain=1#L314), [`STATE_CHANGE`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/development-extension-rfc.md?plain=1#L315), or [`THOUGHT`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/development-extension-rfc.md?plain=1#L316). This streaming model keeps the client updated on the agent's actions and reasoning.

A key aspect of this communication is the [`ToolCall`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/scheduler/types.ts#L120) object, which represents the lifecycle of a tool's execution. It includes [`tool_call_id`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/cli/commands.md?plain=1#L166), [`status`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/utils/retry.ts#L115) (e.g., [`PENDING`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/constants.ts#L22), [`EXECUTING`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/scripts/sync_project_dry_run.js#L225), [`SUCCEEDED`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/development-extension-rfc.md?plain=1#L146), [`FAILED`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/scripts/sync_project_dry_run.js#L232), [`CANCELLED`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/development-extension-rfc.md?plain=1#L146)), [`tool_name`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/hooks/types.ts#L406), [`input_parameters`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/development-extension-rfc.md?plain=1#L172), and the [`result`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/evals/test-helper.ts#L62) (either [`ToolOutput`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/development-extension-rfc.md?plain=1#L181) or [`ErrorDetails`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/development-extension-rfc.md?plain=1#L183)). When the agent requires user intervention, a [`ConfirmationRequest`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/types.ts#L437) is issued, detailing the proposed action and offering [`ConfirmationOption`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/development-extension-rfc.md?plain=1#L224)s for the user to select from. Clients respond with a [`ToolCallConfirmation`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/types.ts#L52), potentially including [`modified_details`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/development-extension-rfc.md?plain=1#L356) if the user adjusts a proposed file change.

Beyond tool execution, the protocol also supports command discovery and execution. Clients can use a [`commands/get`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/development-extension-rfc.md?plain=1#L373) method to retrieve a list of [`SlashCommand`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/commands/types.ts#L178)s, each with its [`name`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/eslint.config.js#L180), [`description`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/tools/shell.md?plain=1#L5), and [`arguments`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/tools/shell.md?plain=1#L17). Once a command is identified, clients can use a [`command/execute`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/development-extension-rfc.md?plain=1#L409) method, specifying the [`command_path`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/development-extension-rfc.md?plain=1#L422) and [`args`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/evals/gitRepo.eval.ts#L38), to initiate its execution. The immediate response, [`ExecuteSlashCommandResponse`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/development-extension-rfc.md?plain=1#L412), provides an [`execution_id`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/development-extension-rfc.md?plain=1#L446) and an initial [`CommandExecutionStatus`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/development-extension-rfc.md?plain=1#L428), indicating whether the command has started or requires further confirmation. This allows for both interactive and programmatic control over the agent's capabilities.

### Agent Task Lifecycle and Execution Orchestration

link

Agent tasks within the Gemini CLI are managed through a structured lifecycle that encompasses their creation, execution, and persistence. This lifecycle is orchestrated by the [`CoderAgentExecutor`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/agent/executor.ts#L83) which handles the agent's interaction loop.

When a task is initiated, a new [`Task`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/agent/task.ts#L62) object is created, encapsulating its state and configuration. The [`CoderAgentExecutor`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/agent/executor.ts#L83) stores these tasks as [`TaskWrapper`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/agent/executor.ts#L44) instances, which abstract the underlying task and facilitate conversion to/from an SDK's [`SDKTask`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/agent/executor.ts#L7) for persistence. Tasks can be reconstructed from previously saved [`SDKTask`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/agent/executor.ts#L7) data, allowing continuity across sessions.

The agent's interaction loop, driven by the [`execute`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/tools/ls.ts#L140) method of the [`CoderAgentExecutor`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/agent/executor.ts#L83), processes user messages, manages tool calls, and integrates with the Gemini Large Language Model (LLM). This loop asynchronously handles the agent's turns, processing incoming messages, scheduling tool executions, and feeding completed tool results back to the LLM.

Tool execution is a central part of task management. The agent schedules tool calls, which may involve user confirmation. This confirmation flow ensures that the agent's actions, particularly those that modify the environment, are reviewed and approved. For tools that modify files, a checkpointing mechanism is integrated with a [`gitService`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/agent/task.ts#L582) to allow for rollback and maintain a history of changes. This is important for tasks such as code generation and modification, where version control provides safety and traceability.

The persistence layer handles saving and loading task state and associated workspaces. Tasks can be persisted to Google Cloud Storage ([`GCSTaskStore`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/persistence/gcs.ts#L33)) or handled by a no-operation fallback ([`NoOpTaskStore`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/persistence/gcs.ts#L301)). This includes serializing task metadata and archiving the workspace using gzipped tar files. The system includes validation to prevent path traversal vulnerabilities during persistence operations, ensuring secure handling of task IDs.

Agent configurations, environment variables, and extensions are dynamically loaded and integrated into the task execution. This allows for flexible and extensible agent behavior, adapting to different project needs and user preferences. The system also monitors for client disconnections, which can trigger the cancellation of ongoing tasks to ensure graceful handling of interrupted sessions.

For more details on the command processing related to agent tasks, refer to [Command and Prompt Processing](https://codewiki.google/github.com/google-gemini/gemini-cli#gemini-cli-architecture-and-core-functionality-command-and-prompt-processing). The overall architecture of the [`a2a-server`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/GEMINI.md?plain=1#L27) is described in [A2A Server Protocol and Client-Agent Communication](https://codewiki.google/github.com/google-gemini/gemini-cli#agent-to-agent-a2a-communication-and-orchestration-a2a-server-protocol-and-client-agent-communication).

### CLI Command Management and Interaction



The A2A server within the Gemini CLI incorporates a command-line interface (CLI) for managing its various functionalities. This CLI allows users to interact with the agent, manage extensions, initialize projects, perform memory operations, and restore checkpoints. The system is designed for extensibility, where commands are clearly defined, registered, and executed, leveraging a central registry for organization.

Command management is orchestrated by a [`CommandRegistry`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/commands/command-registry.ts#L14) class, located in [`packages/a2a-server/src/commands/command-registry.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/commands/command-registry.ts). This registry serves as a central hub for all available CLI commands, handling their registration and retrieval. During initialization, the [`CommandRegistry`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/commands/command-registry.ts#L14) populates itself with core commands, including those for extension management, project initialization, memory operations, and checkpoint restoration. Commands are defined by a [`Command`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/config/keyBindings.ts#L10) interface, which specifies properties such as the command's name, description, arguments, and nested subcommands, along with an [`execute`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/tools/ls.ts#L140) method that encapsulates the command's logic.

Specific command implementations provide various functionalities:

-   **Extension Management**: The [`ExtensionsCommand`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/commands/extensions.ts#L14) and its subcommands, defined in [`packages/a2a-server/src/commands/extensions.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/commands/extensions.ts), allow users to list installed extensions.
-   **Project Initialization**: The [`InitCommand`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/commands/init.ts#L25), found in [`packages/a2a-server/src/commands/init.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/commands/init.ts), handles the setup of new projects. It often involves analyzing the project structure and creating a [`GEMINI.md`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/README.md?plain=1#L131) file, interacting with the agent executor to manage agentic loops.
-   **Memory Operations**: The [`MemoryCommand`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/commands/memory.ts#L25) and its subcommands, detailed in [`packages/a2a-server/src/commands/memory.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/commands/memory.ts), provide capabilities to show, refresh, and add content to the agent's memory. The [`AddMemoryCommand`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/commands/memory.ts#L84) can also trigger tool execution based on the memory content.
-   **Checkpoint Restoration**: The [`RestoreCommand`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/commands/restore.ts#L21) and [`ListCheckpointsCommand`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/commands/restore.ts#L113), located in [`packages/a2a-server/src/commands/restore.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/commands/restore.ts), enable users to restore the agent's state to a previous checkpoint and list available checkpoints, respectively. These commands parse and validate checkpoint files to ensure secure and accurate restoration.

The command system emphasizes modularity, with each command or group of commands encapsulated in its own file. This design promotes code reuse and clarity, focusing command implementations on orchestration and specific CLI logic. The [`CommandContext`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/commands/types.ts#L29) provides essential services, such as configuration and the event bus, to commands during their execution, ensuring they have access to the necessary resources. Further details on application lifecycle, which includes argument parsing and command dispatch, can be found in [Application Lifecycle and Execution Management](https://codewiki.google/github.com/google-gemini/gemini-cli#gemini-cli-architecture-and-core-functionality-application-lifecycle-and-execution-management).

### HTTP API for External Agent Interaction



The A2A server provides an HTTP API to enable external clients to interact with agent tasks, execute commands, and discover the agent's capabilities. The core application for the HTTP API is configured within [`packages/a2a-server/src/http/app.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/http/app.ts). This application initializes key components such as configuration settings, extension loaders, and the agent executor, setting up the necessary environment for processing requests.

A central feature of the HTTP API is its ability to publish an agent card, which describes the agent's metadata, including its name, description, capabilities, and skills. This card is exposed at the [`/.well-known/agent-card.json`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/http/app.ts#L346) endpoint and is dynamically updated for discoverability.

The API supports managing agent tasks through endpoints for creating new tasks ([`POST /tasks`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/http/endpoints.test.ts#L79)) and retrieving metadata for individual tasks or all tasks ([`GET /tasks/:taskId/metadata`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/http/endpoints.test.ts#L129) and [`GET /tasks/metadata`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/http/endpoints.test.ts#L129) respectively). These functionalities are essential for external systems to initiate and monitor the agent's work and to manage its persistent state. The HTTP API also handles command execution and listing. The [`handleExecuteCommand`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/http/app.ts#L81) function processes requests to execute specific commands, using a command registry to identify and run them. This includes support for streaming command output through Server-Sent Events (SSE). Additionally, clients can retrieve a hierarchical list of available commands and their arguments via the [`listCommands`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/http/app.ts#L234) endpoint.

To manage request-specific data across asynchronous operations, the server uses a request-scoped storage mechanism, provided by [`AsyncLocalStorage`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/utils/promptIdContext.ts#L7) in [`packages/a2a-server/src/http/requestStorage.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/http/requestStorage.ts). This ensures that context remains consistent throughout the processing of a single HTTP request. The HTTP server's main entry point, located at [`packages/a2a-server/src/http/server.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/http/server.ts), handles the application startup and includes robust error handling to ensure graceful termination in case of critical failures.

### Agent Definition, Loading, and Validation



Agent definitions, which describe the behavior and configuration of AI agents, are structured, loaded, and validated from various sources within the Gemini CLI. These definitions can originate from Markdown files, local configurations, and remote URLs, providing flexibility in how agents are introduced into the system.

The core process of handling agent definitions involves several steps:

-   **Definition Structure**: Agent configurations are primarily defined within the YAML frontmatter of Markdown files. These definitions specify whether an agent is [`local`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/scripts/telemetry.js#L72) (containing [`system_prompt`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/agentLoader.test.ts#L263), [`model`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/core/client.ts#L639), [`tools`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/index.md?plain=1#L84)) or [`remote`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/tools/mcp-server.md?plain=1#L187) (referencing an [`agent_card_url`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/agentLoader.ts#L40)). The system uses distinct interfaces like [`FrontmatterLocalAgentDefinition`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/agentLoader.ts#L24) and [`FrontmatterRemoteAgentDefinition`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/agentLoader.ts#L36) to represent these structures, which are then unified under [`FrontmatterAgentDefinition`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/agentLoader.ts#L43).
-   **Parsing**: The system parses agent definitions from these Markdown files. This involves extracting the YAML frontmatter and separating it from the main body of the Markdown content. During this process, the system can infer an agent's [`kind`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/types.ts#L47) as 'remote' if an [`agent_card_url`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/agentLoader.ts#L40) is present, even if not explicitly stated. The [`parseAgentMarkdown`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/agentLoader.ts#L145) function within [`packages/core/src/agents/agentLoader.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/agentLoader.ts) manages this extraction and initial parsing.
-   **Validation**: Robust validation is applied to ensure the integrity and correctness of agent definitions. This uses [`zod`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/tools/mcp-server.md?plain=1#L849) schemas, such as [`localAgentSchema`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/agentLoader.ts#L72), [`remoteAgentSchema`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/agentLoader.ts#L92), and [`markdownFrontmatterSchema`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/agentLoader.ts#L111), to verify that all required fields are present and correctly formatted. This includes ensuring that the agent's [`name`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/eslint.config.js#L180) adheres to slug formatting conventions. In cases of validation failure, a contextual [`AgentLoadError`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/agentLoader.ts#L50) is generated, providing detailed information about the issue and its location.
-   **Conversion and Default Values**: After successful parsing and validation, the raw frontmatter definition is converted into a more comprehensive internal [`AgentDefinition`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/AppContainer.tsx#L40) type by the [`markdownToAgentDefinition`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/agentLoader.ts#L234) function in [`packages/core/src/agents/agentLoader.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/agentLoader.ts). This step applies default values for various configurations, such as [`promptConfig`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/core/prompts.ts#L198), [`modelConfig`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/config/settings.ts#L905), and [`runConfig`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/config/settings.ts#L895), ensuring that each agent has a complete and consistent operational blueprint.
-   **Loading from Directories**: The [`loadAgentsFromDirectory`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/agentLoader.ts#L302) function, also in [`packages/core/src/agents/agentLoader.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/agentLoader.ts), scans specified directories for agent Markdown files. It then processes each valid file, accumulating successfully loaded agents and any [`AgentLoadError`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/agentLoader.ts#L50) instances encountered during parsing or validation. This allows the system to discover and integrate multiple agent definitions from a given filesystem path.

Once defined, loaded, and validated, these agents are managed by the [`AgentRegistry`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/registry.ts#L38) located in [`packages/core/src/agents/registry.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/registry.ts). The registry handles the discovery and registration of agents from various sources, including built-in definitions, user-defined TOML files, project configurations, and extensions. It dynamically refreshes agent definitions in response to model changes and provides access to registered agent information, as detailed in [Gemini CLI Architecture and Core Functionality Command and Prompt Processing](https://codewiki.google/github.com/google-gemini/gemini-cli#gemini-cli-architecture-and-core-functionality-command-and-prompt-processing). The registry also plays a role in applying [`AgentOverride`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/config/config.ts#L166) configurations and managing model configurations through the [`ModelConfigService`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/services/modelConfigService.ts#L68).

### Local and Remote Agent Execution and Invocation



The Gemini CLI supports interaction with both local and remote agents, each with distinct execution and management mechanisms. Local agents execute within the CLI environment, while remote agents communicate with external Agent-to-Agent (A2A) servers.

The [`LocalAgentExecutor`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/local-executor.ts#L81) class, located in [`packages/core/src/agents/local-executor.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/local-executor.ts), orchestrates the execution loop for local agents. This involves initializing the agent, managing interactions with the generative model, executing tools, and handling various termination conditions such as [`maxTurns`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/types.ts#L178) or [`maxTimeMinutes`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/local-executor.ts#L389). It also incorporates a recovery mechanism, giving agents a grace period to complete tasks if they encounter recoverable termination reasons. Each local agent operates with its own isolated [`ToolRegistry`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/tools/tool-registry.ts#L189), which filters allowed tools and prevents recursive subagent calls. The executor uses [`GeminiChat`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/core/geminiChat.ts#L233) to interact with the generative model, processes [`FunctionCall`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/policy/policy-engine.ts#L7)s returned by the model, and utilizes an [`ActivityCallback`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/local-executor.ts#L54) to provide real-time updates on the agent's progress.

When a local subagent is invoked as a tool by a parent agent, the [`LocalSubagentInvocation`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/local-invocation.ts#L32) class, defined in [`packages/core/src/agents/local-invocation.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/local-invocation.ts), wraps the execution. It initializes and runs a [`LocalAgentExecutor`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/local-executor.ts#L81) instance, streams [`THOUGHT_CHUNK`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/types.ts#L59) activities back to the user interface, and formats the subagent's final output into a [`ToolResult`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/tools/edit.ts#L20) object. This ensures that subagent execution integrates seamlessly into the broader tool invocation framework.

Remote agents, on the other hand, are managed through the [`A2AClientManager`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/a2a-client-manager.ts#L27) class, found in [`packages/core/src/agents/a2a-client-manager.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/a2a-client-manager.ts). This class operates as a singleton, centralizing the management of Agent-to-Agent (A2A) client instances. It handles loading remote agent definitions by their URLs, caching their [`AgentCard`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/http/app.ts#L9) and [`Client`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/a2a-client-manager.ts#L9) instances, and providing methods for sending messages, retrieving tasks, and canceling tasks on remote agents. Authentication for remote agent interactions is handled via an optional [`AuthenticationHandler`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/a2a-client-manager.ts#L15), which uses [`createAuthenticatingFetchWithRetry`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/a2a-client-manager.test.ts#L36) to ensure secure and robust communication.

When the CLI interacts with a remote A2A agent, the [`RemoteAgentInvocation`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/remote-invocation.ts#L69) class, defined in [`packages/core/src/agents/remote-invocation.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/remote-invocation.ts), acts as a proxy for tool invocations. It manages the [`contextId`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/http/app.ts#L212) and [`taskId`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/http/app.ts#L208) to maintain conversational state across invocations and uses [`ADCHandler`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/remote-invocation.ts#L33) for Google Application Default Credentials to authenticate requests to remote A2A servers.

The overall agent system supports dynamic loading and validation of agent definitions. The agent loading and parsing functionalities are handled by files within [`packages/core/src/agents`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents). These files are responsible for parsing agent definitions from Markdown files, extracting YAML frontmatter, and validating them against Zod schemas. This process converts raw definitions into structured [`AgentDefinition`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/AppContainer.tsx#L40) objects, which can be either local or remote. The [`AgentRegistry`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/registry.ts#L38), located in [`packages/core/src/agents/registry.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/registry.ts), then manages these definitions, allowing for the discovery and registration of built-in, user-defined, project-specific, and extension-provided agents. For more details on how these definitions are structured and loaded, refer to [Agent Definition, Loading, and Validation](https://codewiki.google/github.com/google-gemini/gemini-cli#agent-to-agent-a2a-communication-and-orchestration-agent-definition-loading-and-validation).

### Agent Task and Workspace Persistence



Agent task state and workspaces are persisted through a dedicated [`TaskStore`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/http/app.ts#L10) interface, with Google Cloud Storage (GCS) serving as the primary implementation for saving and loading task metadata and gzipped workspace archives. This mechanism ensures that agent work is preserved across sessions and can be restored.

The [`GCSTaskStore`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/persistence/gcs.ts#L33) in [`packages/a2a-server/src/persistence/gcs.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/persistence/gcs.ts) handles the specifics of interacting with GCS. Upon initialization, it ensures that the designated GCS bucket exists, creating it if necessary. When saving a task, the store serializes task metadata into a JSON format, compresses it using [`gzip`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/telemetry/sdk.ts#L259), and uploads it to GCS. If the task involves a workspace, a gzipped tar archive of the current working directory is created in a temporary location and then uploaded to GCS. Both the metadata and workspace archives are stored with paths that incorporate the [`taskId`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/http/app.ts#L208).

To prevent security vulnerabilities such as path traversal, the [`GCSTaskStore`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/persistence/gcs.ts#L33) validates task IDs to ensure they contain only alphanumeric characters, dashes, and underscores. This sanitization protects against malicious inputs that could otherwise manipulate file system paths.

Conversely, loading a task involves downloading the gzipped metadata, decompressing it, and parsing the JSON to reconstruct the task's state. If a workspace archive exists, it is downloaded, decompressed, and extracted into a specified working directory, effectively restoring the agent's environment to its prior state.

In scenarios where persistent storage is not required or should be delegated, a [`NoOpTaskStore`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/persistence/gcs.ts#L301) is available. This implementation, also found in [`packages/a2a-server/src/persistence/gcs.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/persistence/gcs.ts), logs persistence operations but does not perform any actual saving. It delegates load operations to an encapsulated [`TaskStore`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/http/app.ts#L10), allowing for flexible control over persistence behavior.

The overall management of agent tasks, including their creation, retrieval, and storage, is orchestrated by the [`CoderAgentExecutor`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/agent/executor.ts#L83) component. This executor uses the [`TaskStore`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/http/app.ts#L10) to save and load [`TaskWrapper`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/agent/executor.ts#L44) instances, which abstract the underlying task objects, ensuring that [`agentSettings`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/http/app.ts#L209) and [`_taskState`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/a2a-server/src/agent/executor.ts#L60) are correctly serialized into and deserialized from task metadata for persistence. For more details on task management, refer to [Agent Task Lifecycle and Execution Orchestration](https://codewiki.google/github.com/google-gemini/gemini-cli#agent-to-agent-a2a-communication-and-orchestration-agent-task-lifecycle-and-execution-orchestration).

## Tool Management and Policy Enforcement



The Gemini CLI utilizes a comprehensive system for tool management and policy enforcement, allowing the Gemini model to interact with the local environment, access information, execute commands, and perform actions. This capability is facilitated by a suite of built-in tools that cover operations such as file system manipulation and shell command execution. The system orchestrates the entire lifecycle of a tool execution, from its initial request by the model to its final completion, incorporating crucial steps like policy checking and user confirmation.

The tool execution lifecycle begins with the model proposing a tool call, which is then ingested by the CLI. A [`Scheduler`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/scheduler/scheduler.ts#L78) in [`packages/core/src/scheduler/scheduler.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/scheduler/scheduler.ts) manages this process, queuing requests, resolving and validating the proposed tools. Before execution, each tool call undergoes a rigorous policy check using a [`PolicyEngine`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/policy/policy-engine.ts#L81) (defined in [`packages/core/src/policy/policy-engine.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/policy/policy-engine.ts)) to determine if the action is [`ALLOW`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/policy/types.ts#L10)ed, [`DENY`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/policy/types.ts#L11)ed, or requires [`ASK_USER`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/policy/types.ts#L12) approval based on predefined rules. If user approval is needed, the system engages an interactive confirmation flow to obtain consent or allow modifications to the proposed tool call. Once approved, a [`ToolExecutor`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/scheduler/tool-executor.ts#L44) ([`packages/core/src/scheduler/tool-executor.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/scheduler/tool-executor.ts)) carries out the command. Throughout this process, a [`SchedulerStateManager`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/scheduler/state-manager.ts#L37) ([`packages/core/src/scheduler/state-manager.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/scheduler/state-manager.ts)) tracks and updates the status of [`ToolCall`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/scheduler/types.ts#L120) objects, ensuring transparency and enabling detailed reporting.

Central to this system is the policy engine, which governs how tools interact with the environment. Policies are defined through rules loaded from TOML files, such as those found in [`docs/tools`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/tools), and are organized into tiers (default, user, admin) to establish precedence. The policy engine evaluates these rules against incoming tool calls, enabling granular control over actions. For sensitive operations like [`run_shell_command`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/tools/shell.md?plain=1#L1), robust safety checks are in place, including mechanisms to split compound commands, detect I/O redirection, and recursively evaluate sub-commands, as detailed in [`packages/core/src/policy`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/policy). This ensures secure execution and mitigates potential risks associated with arbitrary command execution. Policies can also be dynamically updated based on user interactions, such as explicit approvals, and these changes can be persisted to an [`auto-saved.toml`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/policy/config.ts#L345) file, modifying future policy decisions. This dynamic update capability is managed by [`createPolicyUpdater`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/config/policy.ts#L33) in [`packages/core/src/policy/config.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/policy/config.ts).

The suite of built-in tools provides extensive capabilities. For file system interaction, tools allow listing directories, reading and writing files (e.g., [`list_directory`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/tools/file-system.md?plain=1#L13), [`read_file`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/index.md?plain=1#L89), [`write_file`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/index.md?plain=1#L89) in [`docs/tools/file-system.md`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/tools/file-system.md)), globbing for files ([`glob`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/services/FileCommandLoader.test.ts#L83)), and searching file content ([`search_file_content`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/tools/file-system.md?plain=1#L120)). The [`replace`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/utils/llm-edit-fixer.ts#L81) tool enables advanced text editing within files, even incorporating a "multi-stage edit correction" mechanism to refine edits. The [`run_shell_command`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/tools/shell.md?plain=1#L1) tool ([`docs/tools/shell.md`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/tools/shell.md)) facilitates shell command execution, offering detailed feedback and supporting interactive sessions. Beyond direct system interaction, tools like [`web_fetch`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/tools/web-fetch.md?plain=1#L1) ([`docs/tools/web-fetch.md`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/tools/web-fetch.md)) enable summarizing web pages, and [`google_web_search`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/tools/web-search.md?plain=1#L1) ([`docs/tools/web-search.md`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/tools/web-search.md)) performs web searches. The [`save_memory`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/tools/memory.md?plain=1#L1) tool ([`docs/tools/memory.md`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/tools/memory.md)) allows for persistence of facts across CLI sessions, while [`write_todos`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/tools/todos.md?plain=1#L1) ([`docs/tools/todos.md`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/tools/todos.md)) helps the agent manage subtasks for complex requests.

The CLI also integrates external tools and resources through Model Context Protocol (MCP) servers. The [`McpClientManager`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/tools/mcp-client-manager.ts#L28) in [`packages/core/src/tools/mcp-client-manager.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/tools/mcp-client-manager.ts) discovers and manages these servers, wrapping their callable tools ([`DiscoveredMCPTool`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/tools/mcp-tool.ts#L232) in [`packages/core/src/tools/mcp-client.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/tools/mcp-client.ts)) and handling dynamic updates. MCP servers can extend the CLI's capabilities by exposing custom tools and prompts, which are integrated seamlessly into the policy and execution framework. For a deeper understanding of MCP, refer to [Model Context Protocol (MCP) and Authentication](https://codewiki.google/github.com/google-gemini/gemini-cli#model-context-protocol-mcp-and-authentication). The overall architecture, including the CLI's frontend for user interaction, command processing, and application lifecycle management, is described in [Gemini CLI Architecture and Core Functionality](https://codewiki.google/github.com/google-gemini/gemini-cli#gemini-cli-architecture-and-core-functionality).

### Tool Execution Lifecycle and State Management



The Gemini CLI orchestrates the execution of tools through a structured lifecycle, managing requests from initial validation to final state resolution. This process is handled primarily by the [`Scheduler`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/scheduler/scheduler.ts#L78) class in [`packages/core/src/scheduler/scheduler.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/scheduler/scheduler.ts), which coordinates tool calls and their transitions through various states.

When a tool call is initiated, the [`Scheduler`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/scheduler/scheduler.ts#L78) first resolves and validates the tool and its arguments. It then consults a [`PolicyEngine`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/policy/policy-engine.ts#L81) to determine if the tool is allowed to run, requires user confirmation, or is denied. If user confirmation is needed, the [`Scheduler`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/scheduler/scheduler.ts#L78) engages in an interactive confirmation flow, which may involve presenting tool details, awaiting user input, and allowing for modifications to tool parameters. This confirmation process can also include external editor-based changes or inline content updates. See [Tool Confirmation and Modification Workflow](https://codewiki.google/github.com/google-gemini/gemini-cli#tool-management-and-policy-enforcement-tool-confirmation-and-modification-workflow) for more details.

Upon confirmation (or immediate approval by policy), the tool proceeds to execution. The actual execution is delegated to a [`ToolExecutor`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/scheduler/tool-executor.ts#L44) defined in [`packages/core/src/scheduler/tool-executor.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/scheduler/tool-executor.ts). This component handles the invocation of the tool, captures its output, and manages any errors or cancellations that occur during runtime. For shell commands, the [`ToolExecutor`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/scheduler/tool-executor.ts#L44) also manages specific considerations like reporting process IDs (PIDs) and conditionally truncating large outputs to prevent excessive token usage or UI clutter.

Throughout this entire lifecycle, the [`SchedulerStateManager`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/scheduler/state-manager.ts#L37) in [`packages/core/src/scheduler/state-manager.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/scheduler/state-manager.ts) plays a central role in tracking the state of each tool call. It maintains queues for pending calls, records active executions, and archives completed calls. Any significant state changesuch as a call moving from 'validating' to 'scheduled', 'executing', 'awaiting approval', 'success', 'error', or 'cancelled'is published as a [`TOOL_CALLS_UPDATE`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/confirmation-bus/types.ts#L21) event via a [`MessageBus`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/confirmation-bus/message-bus.ts#L15). This event-driven approach ensures that external components, such as the user interface, can react dynamically to changes in the tool execution status without being tightly coupled to the scheduler's internal mechanisms. The system also supports cancellation of individual queued calls or entire active batches, ensuring responsive control over ongoing operations.

### Policy Engine Architecture and Rule Evaluation



The policy engine manages and enforces execution policies for tools and hooks within the system. It determines whether a tool invocation, represented as a [`FunctionCall`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/policy/policy-engine.ts#L7), should be allowed, denied, or require user approval based on a prioritized set of rules and safety checks. This system is critical for security and control over automated actions.

The core of the policy engine is implemented by the [`PolicyEngine`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/policy/policy-engine.ts#L81) class in [`packages/core/src/policy/policy-engine.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/policy/policy-engine.ts). This class evaluates [`FunctionCall`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/policy/policy-engine.ts#L7) objects against [`PolicyRule`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/policy/types.ts#L98) and [`SafetyCheckerRule`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/policy/types.ts#L147) instances. It supports various approval modes, such as a default mode, an [`AUTO_EDIT`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/policy/types.ts#L47) mode for automated modifications, and a [`YOLO`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/policy/types.ts#L48) mode that broadly permits actions. For non-interactive environments, any request for user approval is automatically converted to a denial, preventing the system from halting.

Policies are defined and loaded from TOML files found in designated directories, including default, user-specific, and system-wide (admin) locations. The [`toml-loader`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/index.ts#L16) module in [`packages/core/src/policy/toml-loader.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/policy/toml-loader.ts) handles parsing these files and validating their content against predefined schemas. This ensures that policy definitions adhere to expected structures and types. During loading, rules are assigned a numerical priority based on their source (e.g., admin policies have higher priority than user policies, which in turn override default policies). This tiered priority system ensures that more specific or critical rules take precedence over broader ones.

The [`PolicyEngine`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/policy/policy-engine.ts#L81) also incorporates safety checkers. When a [`PolicyRule`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/policy/types.ts#L98) allows a [`FunctionCall`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/policy/policy-engine.ts#L7), relevant [`SafetyCheckerRule`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/policy/types.ts#L147) objects are evaluated. These checkers can perform additional safety assessments, and their decisions can override policy allowances. For instance, a safety checker denial will result in an overall denial, even if the policy initially allowed the action.

Special handling is implemented for shell command execution. The [`PolicyEngine`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/policy/policy-engine.ts#L81) can parse complex shell commands into sub-commands, allowing individual parts of a compound command to be evaluated against policies. It also detects I/O redirection, which can trigger a request for user approval unless explicitly allowed by the policy.

The system supports dynamic policy updates. A component set up by [`createPolicyUpdater`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/config/policy.ts#L33) in [`packages/core/src/policy/config.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/policy/config.ts), listens for policy update messages. When an [`UPDATE_POLICY`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/confirmation-bus/types.ts#L20) message is received, new rules can be dynamically added to the [`PolicyEngine`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/policy/policy-engine.ts#L81) and optionally persisted to a user-specific [`auto-saved.toml`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/policy/config.ts#L345) file, typically to record user "always allow" decisions. For more details on policy updates and persistence, refer to [Dynamic Policy Updates and Persistence](https://codewiki.google/github.com/google-gemini/gemini-cli#tool-management-and-policy-enforcement-dynamic-policy-updates-and-persistence). The persistence mechanism involves atomic file writes, ensuring data integrity during updates.

### Shell Command Safety and Security Measures



The Gemini CLI implements a robust set of safety and security measures specifically for handling [`run_shell_command`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/tools/shell.md?plain=1#L1) tool calls. These measures are designed to mitigate risks associated with executing shell commands by ensuring that commands are carefully evaluated against defined policies, and that potentially dangerous operations are either denied or require explicit user confirmation.

A core component in this process is the [`PolicyEngine`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/policy/policy-engine.ts#L81) defined in [`packages/core/src/policy/policy-engine.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/policy/policy-engine.ts). This engine evaluates [`FunctionCall`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/policy/policy-engine.ts#L7) requests, including those for shell commands, to determine whether they should be allowed, denied, or prompt the user for approval.

The [`PolicyEngine`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/policy/policy-engine.ts#L81) handles shell commands in a specialized manner:

-   **Splitting Compound Commands**: Complex shell commands, particularly those containing logical operators like [`&&`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/Dockerfile#L9) or [`;`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/LICENSE#L192), are parsed and broken down into their individual sub-commands. This allows for granular policy evaluation of each component of a compound command. For example, a command like [`cmd1 && cmd2`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/hooks/useShellHistory.test.ts#L62) will be evaluated as two separate commands ([`cmd1`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/hooks/trustedHooks.test.ts#L33) and [`cmd2`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/hooks/trustedHooks.test.ts#L76)), each subject to policy checks.
-   **Recursive Evaluation of Sub-commands**: Each identified sub-command is then recursively evaluated against the policy rules. The [`PolicyEngine`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/policy/policy-engine.ts#L81) aggregates the decisions for all sub-commands, applying the most restrictive outcome to the overall shell command. If any sub-command results in a [`DENY`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/policy/types.ts#L11) decision, the entire compound command is denied. If any sub-command requires [`ASK_USER`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/policy/types.ts#L12) approval, the entire compound command will also require approval.
-   **Detection of I/O Redirection**: The system specifically checks for I/O redirection within shell commands (e.g., using [`>`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/README.md?plain=1#L266) or [`<`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/README.md?plain=1#L393)). If redirection is detected and the corresponding policy rule does not explicitly [`allowRedirection`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/policy/policy-engine.test.ts#L993), an [`ALLOW`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/policy/types.ts#L10) decision for the command can be downgraded to [`ASK_USER`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/policy/types.ts#L12) to prompt for user confirmation. This prevents unintended file modifications or data exfiltration.
-   **Robust Argument Pattern Matching**: Policy rules for shell commands can define [`argsPattern`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/policy/config.ts#L325) using regular expressions. To ensure consistent and secure matching, the arguments for a [`run_shell_command`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/tools/shell.md?plain=1#L1) call are converted into a stable JSON string representation before being compared against these patterns. This process accounts for various data types and object structures, ensuring that policy rules are applied predictably. The [`stableStringify`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/policy/stable-stringify.ts#L59) function in [`packages/core/src/policy/stable-stringify.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/policy/stable-stringify.ts) is used for this deterministic stringification, even handling circular references and [`toJSON`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/policy/stable-stringify.ts#L27) methods for custom serialization.
-   **Safety Checker Integration**: Beyond basic policy rules, the [`PolicyEngine`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/policy/policy-engine.ts#L81) integrates with [`SafetyCheckerRule`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/policy/types.ts#L147) objects. These checkers perform additional, often more dynamic, safety assessments. If a policy rule allows a shell command, the relevant safety checkers are then run. A denial or request for user approval from a safety checker can override an initial policy allowance, providing an extra layer of security.

These mechanisms ensure that shell commands executed by the Gemini CLI are subject to comprehensive scrutiny, minimizing the risk of malicious or unintended actions in the local environment. Further details on how execution policies are managed and evaluated can be found in [Tool Management and Policy Enforcement](https://codewiki.google/github.com/google-gemini/gemini-cli#tool-management-and-policy-enforcement) and [Policy Engine Architecture and Rule Evaluation](https://codewiki.google/github.com/google-gemini/gemini-cli#tool-management-and-policy-enforcement-policy-engine-architecture-and-rule-evaluation).

### Dynamic Policy Updates and Persistence



Execution policies can be dynamically adjusted and persisted, particularly when user confirmation is required for tool actions, such as when operating in [`AUTO_EDIT`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/policy/types.ts#L47) mode. This dynamic update mechanism allows explicit user decisions to influence future policy evaluations.

The system uses a mechanism for [`createPolicyUpdater`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/config/policy.ts#L33) which subscribes to messages indicating a policy update. When an [`UPDATE_POLICY`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/confirmation-bus/types.ts#L20) message is received via the [`MessageBus`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/confirmation-bus/message-bus.ts#L15), it registers a new policy rule with the policy engine. If configured for persistence, this new rule is saved to an [`auto-saved.toml`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/policy/config.ts#L345) file located in the user's policy directory. This ensures that user confirmations, such as "always allow" actions for specific commands or tools, are remembered across sessions. The persistence to [`auto-saved.toml`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/policy/config.ts#L345) involves atomically writing the new policy. This means changes are first written to a temporary file, and only after successful writing is the temporary file renamed to replace the original, preventing data corruption during unexpected interruptions.

Policy rules generated through this dynamic process are assigned a high priority within the user policy tier (e.g., 2.95), which allows them to take precedence over most user-defined TOML policies, reflecting the user's explicit choices. These rules can specify details such as the [`commandPrefix`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/policy/persistence.test.ts#L113), [`mcpName`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/policy/persistence.test.ts#L153), or [`toolName`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/core/prompts.ts#L599), enabling granular control over which actions are affected by the persisted policy. For a detailed understanding of how policies are structured and prioritized, refer to [Policy Engine Architecture and Rule Evaluation](https://codewiki.google/github.com/google-gemini/gemini-cli#tool-management-and-policy-enforcement-policy-engine-architecture-and-rule-evaluation).

### Tool Confirmation and Modification Workflow



The Gemini CLI incorporates an interactive process for user confirmation before executing tool calls. This workflow allows users to review, and potentially modify, the parameters of a proposed tool execution, influencing policy decisions for subsequent actions. The [`Scheduler`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/scheduler/scheduler.ts#L78) component is responsible for orchestrating this flow, integrating with a [`PolicyEngine`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/policy/policy-engine.ts#L81) and [`MessageBus`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/confirmation-bus/message-bus.ts#L15) to manage user interactions and policy updates.

When a tool call is initiated, the [`Scheduler`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/scheduler/scheduler.ts#L78) first performs a policy check using [`checkPolicy`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/scheduler/policy.ts#L28) from [`packages/core/src/scheduler/policy.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/scheduler/policy.ts). This determines if the tool is allowed to run immediately, requires user confirmation, or is denied. If user confirmation is required (i.e., [`PolicyDecision.ASK_USER`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/policy/config.ts#L282)), the tool call transitions to a [`WaitingToolCall`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/scheduler/types.ts#L97) state, and the system enters a confirmation loop.

The confirmation loop, managed by [`resolveConfirmation`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/scheduler/confirmation.ts#L97) in [`packages/core/src/scheduler/confirmation.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/scheduler/confirmation.ts), presents the user with the tool's details. The user can then choose to proceed, cancel, or modify the tool parameters. This interaction can occur through the [`MessageBus`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/confirmation-bus/message-bus.ts#L15) or, for integrated development environments (IDEs), through an [`ideConfirmation`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/tools/edit.ts#L701) promise.

Modifications to tool parameters can happen in two primary ways:

1.  **External Editor Modification**: If the user opts to [`ModifyWithEditor`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/tools/tools.ts#L735), the [`ToolModificationHandler`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/scheduler/tool-modifier.ts#L22) in [`packages/core/src/scheduler/tool-modifier.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/scheduler/tool-modifier.ts) launches an external editor (e.g., Vim) with the tool's current arguments. After the user makes changes and saves, the updated parameters are returned to the system, and the [`toolCall`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/tools/tools.ts#L194)'s arguments and invocation are updated in the [`SchedulerStateManager`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/scheduler/state-manager.ts#L37). The confirmation loop then typically re-enters, allowing the user to confirm the modified tool.
2.  **Inline Modification**: Users can also provide new content directly, for example, from a chat interface. In this case, [`applyInlineModify`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/scheduler/tool-modifier.ts#L66) in [`packages/core/src/scheduler/tool-modifier.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/scheduler/tool-modifier.ts) takes the provided [`newContent`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/tools/edit.ts#L713), compares it with the [`originalContent`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/tools/edit.ts#L712) using a diffing mechanism, and generates [`updatedParams`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/tools/modifiable-tool.ts#L129) and a [`updatedDiff`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/tools/modifiable-tool.ts#L134). These changes are then applied to the [`toolCall`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/tools/tools.ts#L194).

After the user makes a decision (proceed, cancel, or modify), the [`updatePolicy`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/scheduler/policy.ts#L61) function from [`packages/core/src/scheduler/policy.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/scheduler/policy.ts) is invoked. This function updates the system's policy based on the [`ToolConfirmationOutcome`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/tools/edit.ts#L16). For instance, if the user chooses [`ProceedAlways`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/tools/edit.ts#L715), the policy might be updated to automatically allow similar tool executions in the future, influencing the behavior of subsequent tool calls. This mechanism also supports transitions to an [`AUTO_EDIT`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/policy/types.ts#L47) approval mode for specific tools, effectively automating certain modification types.

The [`SchedulerStateManager`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/scheduler/state-manager.ts#L37) in [`packages/core/src/scheduler/state-manager.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/scheduler/state-manager.ts) plays a central role in tracking these state changes, ensuring that the system's view of each [`ToolCall`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/scheduler/types.ts#L120)'s lifecycle, from [`validating`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/agents/registry.ts#L422) to [`awaiting_approval`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/scheduler/types.ts#L98) and finally to [`success`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/test-utils/src/test-rig.ts#L800), [`error`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/types.ts#L57), or [`cancelled`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/hooks/useGitBranchName.ts#L45), is consistently maintained and communicated via the [`MessageBus`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/confirmation-bus/message-bus.ts#L15). This state management, combined with the interactive confirmation and dynamic policy updates, provides a flexible and user-controlled environment for tool execution within the Gemini CLI.

### Built-in Tools for File System Interaction

link

| Tool Name | Description |
| --- | --- |
| `list_directory` | Lists file and subdirectory names within a specified path, with optional glob pattern exclusion and `.gitignore` respect. |
| `read_file` | Reads and returns the content of a file, handling various types (text, images, audio, PDF) and supporting line-range reads for text. |
| `write_file` | Writes content to a specified file, overwriting if it exists or creating it (and parent directories) if not. Requires confirmation. |
| `glob` | Finds files matching glob patterns, returning absolute paths sorted by modification time. Automatically ignores common nuisance directories. |
| `search_file_content` | Searches file content for a regular expression pattern within a directory, returning matching lines with file paths and line numbers. Uses `git grep` or system `grep` as preferred methods. |
| `replace` | Replaces exact literal text within a file, designed for precise, targeted changes. Supports multi-stage correction for improved robustness. Requires confirmation. |

The Gemini CLI provides a suite of built-in tools that enable the Gemini model to interact with the local file system. These tools facilitate tasks such as listing directories, reading and writing files, searching for files using glob patterns, searching within file content, and performing advanced file edits. These functionalities allow the model to operate within the local environment, gather information, and perform actions directly on the user's file system, often requiring user confirmation for sensitive operations to ensure security. Further details on the overarching tool system can be found in [Tool Management and Policy Enforcement](https://codewiki.google/github.com/google-gemini/gemini-cli#tool-management-and-policy-enforcement).

The primary tools for file system interaction include:

-   **[`list_directory`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/tools/file-system.md?plain=1#L13)**: This tool allows the model to list the contents of a specified directory, including files and subdirectories. It can be configured to ignore specific patterns or respect [`.gitignore`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/cli/settings.md?plain=1#L86) rules, helping to filter results and focus on relevant files.
-   **[`read_file`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/index.md?plain=1#L89)**: Designed to read the content of files, this tool supports various file types. For text files, it can read the entire content or specific line ranges. For binary files like images, audio, or PDFs, it can return base64-encoded data, allowing the model to interpret their content if capable.
-   **[`write_file`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/index.md?plain=1#L89)**: This tool enables the model to write content to a specified file. It can either create a new file or overwrite an existing one. For security, [`write_file`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/index.md?plain=1#L89) typically requires user confirmation, which often includes displaying a diff of the proposed changes before execution.
-   **[`glob`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/services/FileCommandLoader.test.ts#L83)**: The [`glob`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/services/FileCommandLoader.test.ts#L83) tool facilitates searching for files that match a specified pattern within a given path. It supports case-sensitive searches and can respect [`.gitignore`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/cli/settings.md?plain=1#L86) rules. The results are returned as absolute paths, sorted by modification time to prioritize recently changed files.
-   **[`search_file_content`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/tools/file-system.md?plain=1#L120)**: This tool allows the model to search for specific regular expression patterns within the content of files. It can be directed to search within a particular directory and filter files by an include glob pattern. For efficiency, it leverages system [`grep`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/scripts/lint.js#L102) or [`git grep`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/Dockerfile#L20) when available.
-   **[`replace`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/utils/llm-edit-fixer.ts#L81) (Edit)**: This advanced editing tool replaces a specified [`old_string`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/tools/edit.ts#L116) with a [`new_string`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/tools/edit.ts#L116) within a file. It employs a "multi-stage edit correction" mechanism, which iteratively refines the [`old_string`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/tools/edit.ts#L116) and [`new_string`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/tools/edit.ts#L116) if initial attempts are ambiguous or unsuccessful. This process can involve the Gemini model itself to improve the precision of edits. Similar to [`write_file`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/index.md?plain=1#L89), this tool requires user confirmation, presenting a diff of the changes before applying them.

The underlying implementations for these tools are primarily located in the [`packages/core/src/tools`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/tools) directory. The architecture is designed to validate paths, ensuring operations remain within defined workspace boundaries, and to integrate with the system's policy engine for security and user confirmation. The overall capabilities of these tools are documented in [`docs/tools/index.md`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/tools/index.md) and specifically for file system tools in [`docs/tools/file-system.md`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/tools/file-system.md).

### Multi-Client Protocol (MCP) Tool Discovery and Execution



The Gemini CLI integrates with external services and tools through the Model Context Protocol (MCP). This protocol enables the CLI to discover, execute, and manage tools and resources provided by separate MCP servers. The system is designed to extend the CLI's capabilities beyond its built-in features, allowing interaction with diverse external systems such as databases, APIs, or custom scripts.

A central component of this integration is the [`McpClientManager`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/tools/mcp-client-manager.ts#L28) located in [`packages/core/src/tools/mcp-client-manager.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/tools/mcp-client-manager.ts). This manager oversees the lifecycle of various MCP clients, orchestrating the startup and shutdown of connections to configured servers and the discovery of tools exposed by these servers. It interacts with a [`ToolRegistry`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/tools/tool-registry.ts#L189) to register discovered tools and incorporates configuration settings, such as trusted folders and lists of allowed or blocked servers, to manage security. The manager also coordinates periodic refreshes of MCP context.

Each individual [`McpClient`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/tools/mcp-client.ts#L107) instance, defined in [`packages/core/src/tools/mcp-client.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/tools/mcp-client.ts), handles the connection to a specific MCP server. It discovers the tools, prompts, and resources advertised by that server and manages dynamic updates through notification handlers. The client supports various transport mechanisms, including standard I/O (Stdio), Server-Sent Events (SSE), and streamable HTTP, to facilitate communication. Authentication for these servers is handled through OAuth flows, which include mechanisms for re-authentication and transport fallback in case of connection issues.

When a tool is discovered from an MCP server, it is wrapped by a [`DiscoveredMCPTool`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/tools/mcp-tool.ts#L232) instance. This wrapper, described in [`docs/tools/mcp-server.md`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/tools/mcp-server.md), adds MCP-specific logic, such as processing dynamic content blocks (text, audio, image, resource links) and managing user confirmation. The confirmation mechanism is designed to balance security and usability, leveraging trust settings, allow-listing of servers, and folder trust to determine whether user approval is required before a tool executes.

MCP servers are configured via [`settings.json`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/README.md?plain=1#L340) or through CLI commands like [`gemini mcp add`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/cli/commands.md?plain=1#L3) and [`gemini mcp list`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/README.md?plain=1#L1). These configurations define parameters such as the server's command, URL, arguments, and environment variables. The system supports OAuth 2.0 authentication for remote MCP servers, including automatic discovery, token storage, and refresh mechanisms. For more details on MCP and authentication, refer to [Model Context Protocol (MCP) and Authentication](https://codewiki.google/github.com/google-gemini/gemini-cli#model-context-protocol-mcp-and-authentication). The overall architecture ensures that the Gemini CLI can securely and dynamically integrate with a broad range of external tools, expanding its capabilities for interaction with the local environment and beyond.

## User Interface and IDE Integration



The Gemini CLI's user interface is designed to provide an interactive and responsive experience within the terminal, while also offering seamless integration with IDEs like Visual Studio Code. The core UI ([`App`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/App.tsx#L16)) orchestrates different layouts and displays based on the application's state, including whether a screen reader is enabled for accessibility. The primary UI components are managed and provided through the [`AppContainer`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/AppContainer.tsx#L178) in [`packages/cli/src/ui/AppContainer.tsx`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/AppContainer.tsx), which uses a system of React Contexts to distribute application-wide state. This includes configuration, UI actions, session statistics, and real-time streaming data. For instance, the [`StreamingContext.Provider`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/App.tsx#L24) makes streaming data accessible throughout the UI tree in [`packages/cli/src/ui/App.tsx`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/App.tsx).

The UI supports various user interactions, such as command processing via custom React hooks that handle "at" commands, shell commands, and slash commands. These hooks, located in [`packages/cli/src/ui/hooks`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/hooks), manage input processing, autocompletion, and visual feedback. For example, [`handleAtCommand`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/hooks/atCommandProcessor.ts#L135) (within [`packages/cli/src/ui/hooks/atCommandProcessor.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/hooks/atCommandProcessor.ts)) processes [`@`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/core/index.md?plain=1#L78) commands to resolve file paths, Model Context Protocol (MCP) resources, or agents, injecting relevant content into large language model queries. The [`keyMatchers`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/keyMatchers.ts#L71) in [`packages/cli/src/ui/keyMatchers.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/keyMatchers.ts) map user keypresses to application commands.

Authentication flows are managed through dedicated UI components within [`packages/cli/src/ui/auth`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/auth). This includes [`ApiAuthDialog`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/auth/ApiAuthDialog.tsx#L25) for API key input and [`AuthDialog`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/auth/AuthDialog.tsx#L37) for selecting authentication methods such as Google Login or API keys. These components handle the submission, cancellation, error display, and state transitions during the authentication process. For detailed information on authentication methods, see [Comprehensive Authentication and Credential Management](https://codewiki.google/github.com/google-gemini/gemini-cli#getting-started-with-gemini-cli-comprehensive-authentication-and-credential-management) and [Model Context Protocol (MCP) and Authentication](https://codewiki.google/github.com/google-gemini/gemini-cli#model-context-protocol-mcp-and-authentication).

The theming system, found in [`packages/cli/src/ui/themes`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/themes), provides a robust way to manage visual styles, built-in themes, and color utilities. The [`ThemeManager`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/themes/theme-manager.ts#L38) ([`packages/cli/src/ui/themes/theme-manager.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/themes/theme-manager.ts)) handles theme initialization, activation, and loading of custom themes, ensuring consistent visual presentation across the application. The [`Colors`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/colors.ts#L10) constant in [`packages/cli/src/ui/colors.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/colors.ts) provides a theme-aware interface for UI color definitions, adapting dynamically to the active theme.

The Gemini CLI also integrates with Visual Studio Code through a dedicated extension located in [`packages/vscode-ide-companion`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/vscode-ide-companion). This extension provides crucial IDE context to the CLI, such as open files and selected text, enhancing the CLI's understanding of the developer's current work. The [`IDEServer`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/vscode-ide-companion/src/ide-server.ts#L115) in [`packages/vscode-ide-companion/src/ide-server.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/vscode-ide-companion/src/ide-server.ts) facilitates secure communication between the CLI and the IDE. The [`DiffManager`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/vscode-ide-companion/src/diff-manager.ts#L52) ([`packages/vscode-ide-companion/src/diff-manager.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/vscode-ide-companion/src/diff-manager.ts)) enables native diffing capabilities, allowing users to view, modify, and accept code changes proposed by the Gemini CLI directly within the editor. The [`OpenFilesManager`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/vscode-ide-companion/src/open-files-manager.ts#L19) ([`packages/vscode-ide-companion/src/open-files-manager.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/vscode-ide-companion/src/open-files-manager.ts)) tracks the state of open files, cursor positions, and selected text, providing a dynamic [`IdeContext`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/AppContainer.tsx#L37) to connected clients. An [`IdeIntegrationNudge`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/IdeIntegrationNudge.tsx#L24) component in [`packages/cli/src/ui/IdeIntegrationNudge.tsx`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/IdeIntegrationNudge.tsx) prompts users about connecting their IDE to the Gemini CLI, intelligently adapting its message based on whether the VS Code extension is already detected.

### Core CLI UI Architecture and State Management



The Gemini CLI's user interface is built on a modular architecture that separates concerns, using React components and a rich set of contexts to manage global application state. The UI provides an interactive command-line experience, handling configuration, user input, authentication, session management, and generative AI interactions.

The root of the UI is the [`App`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/App.tsx#L16) component, located in [`packages/cli/src/ui/App.tsx`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/App.tsx). This component is responsible for dynamically rendering different application layouts and displays based on the application's current state and user accessibility settings. For instance, it determines whether to show a quitting display, use an alternate terminal buffer, or render a screen-reader-friendly layout. It also acts as a provider for the [`StreamingContext`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/contexts/StreamingContext.tsx#L10), ensuring that real-time data from Gemini interactions is available to all child components.

The [`AppContainer`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/AppContainer.tsx#L178) component, defined in [`packages/cli/src/ui/AppContainer.tsx`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/AppContainer.tsx), serves as the orchestrator for the top-level UI state and actions. It acts as a central hub, managing state through numerous React hooks and making shared state and functions accessible throughout the component tree via various React contexts. [`AppContainer`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/AppContainer.tsx#L178) integrates with authentication flows, session management, Gemini stream interactions, and slash command processing, coordinating how the UI responds to user input and backend events.

A comprehensive set of React contexts, found in [`packages/cli/src/ui/contexts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/contexts), manage application-wide state. These contexts centralize state management, reducing the need to pass props down deeply nested component trees. Key contexts include:

-   **[`UIStateContext`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/contexts/UIStateContext.tsx#L159)**: Provides access to the global UI state, tracking elements like history, authentication status, dialog visibility, and input handling.
-   **[`UIActionsContext`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/contexts/UIActionsContext.tsx#L74)**: Offers functions to modify UI state and trigger actions, such as theme selection or dialog management.
-   **[`ConfigContext`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/contexts/ConfigContext.tsx#L10)** and **[`AppContext`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/contexts/AppContext.tsx#L14)**: Supply application configuration and general application state, respectively.
-   **[`SettingsContext`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/contexts/SettingsContext.tsx#L10)**: Provides access to loaded configuration settings.
-   **[`KeypressContext`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/gemini.tsx#L85)** and **[`MouseContext`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/gemini.tsx#L79)**: Handle global keyboard and mouse events, parsing terminal sequences and dispatching standardized event objects for interactive control.
-   **[`StreamingContext`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/contexts/StreamingContext.tsx#L10)**: Manages the status of ongoing data streams from the Gemini model.
-   **[`ToolActionsContext`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/AppContainer.tsx#L32)**: Orchestrates user confirmation and cancellation of tool calls.
-   **[`SessionContext`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/mermaid/context.mmd#L16)**: Tracks session-level statistics, such as model usage and token counts.
-   **[`ShellFocusContext`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/contexts/ShellFocusContext.tsx#L9)**: Manages the focus state of the shell.
-   **[`OverflowContext`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/components/Composer.tsx#L19)** and **[`ScrollProvider`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/contexts/ScrollProvider.tsx#L75)**: Address UI element overflow and advanced scrolling functionalities.
-   **[`VimModeContext`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/mermaid/context.mmd#L17)**: Manages the state and settings for Vim emulation within the CLI.

These components and contexts collectively form the foundation of the Gemini CLI's user interface, enabling a responsive and feature-rich terminal experience. The CLI also includes a diverse set of [CLI UI Components, Layouts, and Theming](https://codewiki.google/github.com/google-gemini/gemini-cli#user-interface-and-ide-integration-cli-ui-components-layouts-and-theming) for interactive elements and [Interactive Features: Hooks, Commands, and Input Processing](https://codewiki.google/github.com/google-gemini/gemini-cli#user-interface-and-ide-integration-interactive-features-hooks-commands-and-input-processing) for user interaction logic.

### CLI UI Components, Layouts, and Theming



The Gemini CLI's user interface is constructed from a comprehensive library of reusable React components, primarily located in the [`packages/cli/src/ui/components`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/components) directory. These components handle various aspects of the terminal-based UI, including interactive dialogs, status displays, and output rendering.

The application's visual structure is managed through distinct layouts found in the [`packages/cli/src/ui/layouts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/layouts) directory. The [`DefaultAppLayout`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/layouts/DefaultAppLayout.tsx#L22) provides the standard visual arrangement for the application's UI, while [`ScreenReaderAppLayout`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/layouts/ScreenReaderAppLayout.tsx#L18) is specifically tailored to enhance accessibility for users employing screen readers. These layouts dynamically adjust their rendering based on the application's current state and configuration.

A robust theming system, centered in [`packages/cli/src/ui/themes`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/themes), allows for extensive customization of the CLI's appearance. This system includes a [`ThemeManager`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/themes/theme-manager.ts#L38) in [`packages/cli/src/ui/themes/theme-manager.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/themes/theme-manager.ts) responsible for initialization, activation, and discovery of themes, including custom themes loaded from files. The [`packages/cli/src/ui/themes/theme.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/themes/theme.ts) file defines the core structures for themes and provides utilities for their creation and validation. Built-in themes are provided in separate files (e.g., [`packages/cli/src/ui/themes/ansi.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/themes/ansi.ts), [`packages/cli/src/ui/themes/default.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/themes/default.ts), [`packages/cli/src/ui/themes/dracula.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/themes/dracula.ts)), offering diverse visual styles. Color manipulation utilities in [`packages/cli/src/ui/themes/color-utils.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/themes/color-utils.ts) and semantic tokens defined in [`packages/cli/src/ui/themes/semantic-tokens.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/themes/semantic-tokens.ts) ensure consistent and adaptable coloring across the UI. The [`Colors`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/colors.ts#L10) constant in [`packages/cli/src/ui/colors.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/colors.ts) and the [`theme`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/themes/theme.ts#L143) constant in [`packages/cli/src/ui/semantic-colors.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/semantic-colors.ts) provide theme-aware access points for color definitions, ensuring components automatically adapt to active theme changes.

### Interactive Features: Hooks, Commands, and Input Processing



The Gemini CLI leverages various React hooks to manage UI logic for user interactions, command processing, autocompletion, and visual feedback, fostering an interactive terminal experience.

For processing user input, the CLI employs distinct mechanisms for different command types. At-commands, prefixed with an [`@`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/core/index.md?plain=1#L78), are processed by a hook that resolves them into file paths, Managed Code Platform (MCP) resources, or agents. This involves parsing the command, resolving references via the agent and resource registries, and retrieving content using tools like [`ReadManyFilesTool`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/tools/read-many-files.ts#L444) for local files. Shell commands are managed by a dedicated React hook that orchestrates their execution and display, handling real-time output streaming, working directory changes, and command lifecycle management, including cancellation and error handling. Slash commands, such as [`/help`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/cli/custom-commands.md?plain=1#L46) or [`/clear`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/hooks/reference.md?plain=1#L239), are managed by a hook that loads them from various sources, parses user input, and executes their associated actions, which can range from scheduling tools to updating chat history.

Autocompletion capabilities are provided through several hooks. A general command and prompt autocompletion hook determines the active completion mode based on the text buffer and cursor position, then delegates to specialized hooks for at-command, slash command, and general prompt completions. These specialized hooks manage suggestions for files, resources, and agents, utilizing fuzzy matching algorithms for efficient searching.

Visual and interactive elements are enhanced by hooks like one that manages the visual state and animation of scrollbars, providing color transitions and animation control to highlight user activity. Another hook dynamically reacts to changes in the application's approval mode, which governs user confirmation for certain actions, providing feedback via messages for disabled modes or untrusted folders. Console message management is also handled by a hook that consolidates identical, consecutive messages into a single entry with a count, subscribing to core events to capture messages and batch updates.

Beyond these hooks, the CLI implements a suite of built-in slash commands that enable users to manage various aspects of the application. These include commands to display environment information ([`/about`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/constants/tips.ts#L121)), interact with agents ([`/agents list`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/cli/skills.md?plain=1#L58), [`/agents enable`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/cli/skills.md?plain=1#L60)), manage user authentication ([`/auth login`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/cli/enterprise.md?plain=1#L468), [`/auth logout`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/commands/authCommand.test.ts#L41)), assist with bug reporting ([`/bug`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/README.md?plain=1#L336)), control chat history ([`/chat save`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/README.md?plain=1#L130), [`/chat load`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/cli/commands.md?plain=1#L28), [`/chat delete`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/cli/commands.md?plain=1#L28)), clear the session ([`/clear`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/hooks/reference.md?plain=1#L239)), compress chat history ([`/compress`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/constants/tips.ts#L130)), copy the last AI output ([`/copy`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/constants/tips.ts#L131)), manage workspace directories ([`/directory add`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/cli/commands.md?plain=1#L26)), access documentation ([`/docs`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/README.md?plain=1#L9)), set editor preferences ([`/editor`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/constants/tips.ts#L136)), and manage extensions ([`/extensions install`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/index.md?plain=1#L38), [`/extensions enable`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/index.md?plain=1#L33)). The [`keyToAnsi`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/hooks/keyToAnsi.ts#L18) function also plays a role in input processing by translating keyboard events into their corresponding ANSI escape sequences, facilitating keyboard-driven interaction within the terminal.

These integrated hooks and commands work in concert with the core UI components and layouts, described in [Core CLI UI Architecture and State Management](https://codewiki.google/github.com/google-gemini/gemini-cli#user-interface-and-ide-integration-core-cli-ui-architecture-and-state-management) and [CLI UI Components, Layouts, and Theming](https://codewiki.google/github.com/google-gemini/gemini-cli#user-interface-and-ide-integration-cli-ui-components-layouts-and-theming), to provide a fluid and responsive user experience within the terminal environment. The handling of global keyboard events is orchestrated by [`handleGlobalKeypress`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/AppContainer.tsx#L1321), which dispatches actions based on predefined key bindings, managing commands like quitting, toggling debug views, or managing copy mode.

### VS Code Extension: IDE Context and Diff Management



The Gemini CLI integrates with Visual Studio Code through a dedicated extension ([`packages/vscode-ide-companion`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/vscode-ide-companion)) to enhance developer workflows. This extension enables the CLI to leverage the rich context available within the IDE and facilitates seamless interaction, particularly for operations involving code modifications and generative AI.

A core component of this integration is the [`IDEServer`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/vscode-ide-companion/src/ide-server.ts#L115) ([`packages/vscode-ide-companion/src/ide-server.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/vscode-ide-companion/src/ide-server.ts)). This HTTP server runs within the VS Code extension itself, establishing a secure communication channel between the Gemini CLI and the IDE. It is responsible for synchronizing environment variables, handling authentication, and validating host origins to ensure secure interactions. The [`IDEServer`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/vscode-ide-companion/src/ide-server.ts#L115) uses the Model Context Protocol (MCP) to manage requests, enabling functionalities like opening and closing diffs and broadcasting updates about the IDE's context to connected CLI clients.

The extension continuously tracks the IDE context, including open files and user selections. This functionality is managed by the [`OpenFilesManager`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/vscode-ide-companion/src/open-files-manager.ts#L19) ([`packages/vscode-ide-companion/src/open-files-manager.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/vscode-ide-companion/src/open-files-manager.ts)). It monitors various VS Code events such as changes in active text editors, selections, document closures, file deletions, and renames. This manager aggregates this information into an [`IdeContext`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/AppContainer.tsx#L37) which is then broadcast to the CLI, providing it with up-to-date awareness of the user's current work environment. This allows the Gemini CLI to receive rich contextual information about the code a user is interacting with, enabling more relevant and targeted AI assistance.

Native diffing capabilities are provided through the [`DiffManager`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/vscode-ide-companion/src/diff-manager.ts#L52) ([`packages/vscode-ide-companion/src/diff-manager.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/vscode-ide-companion/src/diff-manager.ts)). This component allows the Gemini CLI to present proposed code changes directly within VS Code's native diff viewer. It facilitates user interaction by allowing them to review, accept, or reject suggested modifications. The [`DiffManager`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/vscode-ide-companion/src/diff-manager.ts#L52) uses a [`DiffContentProvider`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/vscode-ide-companion/src/diff-manager.ts#L16) to dynamically supply content for diff views without saving temporary files to disk, ensuring that proposed changes are shown efficiently.

Beyond these core functionalities, the extension integrates directly with VS Code commands. This allows users to trigger Gemini CLI actions directly from the VS Code Command Palette, such as running a new Gemini CLI session or accepting/canceling diffs. The extension also includes mechanisms to check for updates ([`packages/vscode-ide-companion/src/extension.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/vscode-ide-companion/src/extension.ts)) and provides a logging utility ([`packages/vscode-ide-companion/src/utils/logger.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/vscode-ide-companion/src/utils/logger.ts)) for debugging.

For further details on how extensions are developed and managed, refer to [Developing and Releasing Gemini CLI Extensions](https://codewiki.google/github.com/google-gemini/gemini-cli#extending-gemini-cli-with-extensions-hooks-and-skills-developing-and-releasing-gemini-cli-extensions) and [Managing Gemini CLI Extensions](https://codewiki.google/github.com/google-gemini/gemini-cli#extending-gemini-cli-with-extensions-hooks-and-skills-managing-gemini-cli-extensions). The underlying Model Context Protocol is explained in [Model Context Protocol (MCP) and Authentication](https://codewiki.google/github.com/google-gemini/gemini-cli#model-context-protocol-mcp-and-authentication).

### VS Code Extension Development and Maintenance



The VS Code extension for Gemini CLI supports an integrated development and build process. Local development is facilitated by defining dependencies in the [`package.json`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/faq.md?plain=1#L27) file. To begin, developers install these dependencies and open the [`packages/vscode-ide-companion`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/GEMINI.md?plain=1#L28) directory in VS Code. Continuous compilation is achieved by running [`npm run watch`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/scripts/deflake.js#L28), which uses [`esbuild`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/esbuild.config.js#L13) and TypeScript to monitor file changes and automatically recompile the extension. A dedicated build command, [`npm run build`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/Makefile#L3), is available for single compilations without continuous watching.

The [`esbuild`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/esbuild.config.js#L13) configuration, specified in [`packages/vscode-ide-companion/esbuild.js`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/vscode-ide-companion/esbuild.js), bundles TypeScript source files into a CommonJS module for distribution. This configuration handles environment specifics, such as targeting Node.js and externalizing the [`vscode`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/vscode-ide-companion/src/extension.ts#L135) module, which is provided by the VS Code runtime. It also includes an [`esbuildProblemMatcherPlugin`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/vscode-ide-companion/esbuild.js#L15) to enhance error logging during builds.

Utility scripts streamline various maintenance tasks. The [`packages/vscode-ide-companion/scripts/check-vscode-release.js`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/vscode-ide-companion/scripts/check-vscode-release.js) script automates the process of determining if a new release is necessary by comparing the latest deployed version with recent commits and dependency changes. It identifies new commits within the [`packages/vscode-ide-companion`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/GEMINI.md?plain=1#L28) directory and checks for modifications in the [`NOTICES.txt`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/vscode-ide-companion/.vscodeignore#L6) file, which indicates potential dependency updates. Another critical script, [`packages/vscode-ide-companion/scripts/generate-notices.js`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/vscode-ide-companion/scripts/generate-notices.js), generates the [`NOTICES.txt`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/vscode-ide-companion/.vscodeignore#L6) file itself. This file lists all production dependencies, their licenses (primarily MIT and ISC), and repository information, ensuring open-source compliance. This generation process involves recursively collecting dependencies, fetching license information, and formatting the output.

The extension also incorporates update checks, which are part of its lifecycle. The [`checkForUpdates`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/cli/src/ui/utils/updateCheck.ts#L50) function within [`packages/vscode-ide-companion/src/extension.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/vscode-ide-companion/src/extension.ts) periodically queries the VS Code Marketplace for newer versions and prompts the user to update if one is available. This mechanism ensures that users are informed about and can easily access the latest features and bug fixes. The extension's main functionality, including its lifecycle management via [`activate`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/vscode-ide-companion/src/extension.ts#L106) and [`deactivate`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/vscode-ide-companion/src/extension.ts#L219) functions, is defined in [`packages/vscode-ide-companion/src/extension.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/vscode-ide-companion/src/extension.ts). For more information on the VS Code extension's core functionalities, refer to [VS Code Extension: IDE Context and Diff Management](https://codewiki.google/github.com/google-gemini/gemini-cli#user-interface-and-ide-integration-vs-code-extension-ide-context-and-diff-management).

## Model Context Protocol (MCP) and Authentication



The Model Context Protocol (MCP) in the Gemini CLI enables secure communication with MCP servers, which can provide various tools and generative AI capabilities. This protocol is managed through a layered configuration system that handles authentication and token storage, ensuring that interactions are both secure and efficient.

The CLI supports several authentication methods for MCP servers and other Google services, abstracting the complexities of credential management. A core interface, [`McpAuthProvider`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/auth-provider.ts#L13), defined in [`packages/core/src/mcp/auth-provider.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/auth-provider.ts), allows for the injection of custom headers into transport requests, providing flexibility for diverse authentication needs.

Key authentication providers include:

-   **Google Application Default Credentials (ADC)**: The [`GoogleCredentialProvider`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/google-auth-provider.ts#L21) in [`packages/core/src/mcp/google-auth-provider.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/google-auth-provider.ts) leverages Google's ADC mechanism to obtain and cache access tokens. It enforces host whitelisting to ensure that Google credentials are only used with authorized Google API domains or [`luci.app`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/google-auth-provider.test.ts#L51) endpoints, preventing their misuse with arbitrary URLs. The provider also integrates [`quotaProjectId`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/google-auth-provider.ts#L150) to ensure proper billing and quota enforcement for API requests.

-   **OAuth 2.0 with PKCE**: For broader compatibility, the [`MCPOAuthProvider`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/oauth-provider.ts#L98) in [`packages/core/src/mcp/oauth-provider.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/oauth-provider.ts) manages the full OAuth 2.0 authorization code flow with Proof Key for Code Exchange (PKCE). This includes dynamic client registration, launching a browser for user authorization, handling the callback via a local HTTP server, and exchanging the authorization code for access and refresh tokens. This approach enhances security by mitigating authorization code interception attacks.

-   **Service Account Impersonation**: The [`ServiceAccountImpersonationProvider`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/sa-impersonation-provider.ts#L25) in [`packages/core/src/mcp/sa-impersonation-provider.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/sa-impersonation-provider.ts) facilitates authentication by impersonating a Google Cloud service account. It issues OAuth ID tokens through the IAM Credentials API, enabling the CLI to interact with services that rely on ID tokens for authentication. This provider caches tokens to minimize repeated authentication requests.


Central to these authentication mechanisms is a robust token storage framework, located in [`packages/core/src/mcp/token-storage`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/token-storage). This framework manages OAuth credentials and other secrets using either the system keychain ([`KeychainTokenStorage`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/token-storage/hybrid-token-storage.ts#L28)) or an encrypted local file ([`FileTokenStorage`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/token-storage/file-token-storage.ts#L15)). A [`HybridTokenStorage`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/token-storage/hybrid-token-storage.ts#L14) prioritizes the more secure keychain storage when available and gracefully falls back to encrypted file storage otherwise. This ensures sensitive tokens are persistently stored with appropriate security measures, including encryption with [`aes-256-gcm`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/token-storage/file-token-storage.ts#L33) and restricted file permissions where applicable.

OAuth-related utility functions, such as those found in [`OAuthUtils`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/oauth-utils.ts#L56) in [`packages/core/src/mcp/oauth-utils.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/oauth-utils.ts), support these authentication flows. These utilities handle tasks like discovering OAuth metadata from well-known endpoints, parsing [`WWW-Authenticate`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/oauth-utils.ts#L311) headers to extract resource metadata URIs, and parsing JWT-like tokens to determine expiration times. These discovery and parsing capabilities allow the CLI to dynamically configure its OAuth interactions based on server responses, supporting various OAuth 2.0 and OpenID Connect specifications.

### Google Application Default Credentials (ADC) Authentication



The [`GoogleCredentialProvider`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/google-auth-provider.ts#L21) implements authentication using Google Application Default Credentials (ADC) to interact with Model Context Protocol (MCP) servers and Google services. ADC streamlines authentication by automatically discovering credentials based on the execution environment, such as environment variables or Google Cloud SDK configuration. This provider ensures secure communication by obtaining and caching access tokens, which are then included in API requests.

A key function of the [`GoogleCredentialProvider`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/google-auth-provider.ts#L21) is to manage access tokens. It retrieves tokens using the [`google-auth-library`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/package.json#L53) and implements a caching mechanism to reuse valid tokens, refreshing them only when they are near expiration. This proactive refresh strategy helps maintain continuous authentication without requiring frequent re-authentication.

For security, the [`GoogleCredentialProvider`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/google-auth-provider.ts#L21) enforces host whitelisting, ensuring that ADC can only be used with allowed Google API domains or specific internal applications. This prevents unauthorized use of Google credentials with arbitrary or potentially malicious endpoints.

The provider also facilitates billing and quota management by retrieving the [`quotaProjectId`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/google-auth-provider.ts#L150) associated with the authenticated credentials. This project ID is then included in request headers (specifically [`X-Goog-User-Project`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/google-auth-provider.ts#L146)), allowing Google Cloud services to correctly attribute API usage and enforce quotas. Configuration validation is performed during initialization to ensure that necessary parameters like a valid URL and OAuth scopes are provided, contributing to the robustness of the authentication process. While the provider primarily focuses on ADC, its design allows integration into broader authentication flows, as detailed in [Model Context Protocol (MCP) and Authentication](https://codewiki.google/github.com/google-gemini/gemini-cli#model-context-protocol-mcp-and-authentication).

### OAuth 2.0 with PKCE Flow for MCP Servers



The [`MCPOAuthProvider`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/oauth-provider.ts#L98) implementation within the Gemini CLI manages the OAuth 2.0 authentication flow with Proof Key for Code Exchange (PKCE) for Model Context Protocol (MCP) servers, allowing secure interaction with external services. This provider handles the entire lifecycle of obtaining and managing access tokens, which are essential for authenticated requests.

The process begins with OAuth configuration discovery, where the provider automatically identifies the necessary endpoints (authorization, token, and registration URLs) from an MCP server or [`WWW-Authenticate`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/oauth-utils.ts#L311) headers. If a client ID is not provided, the system supports dynamic client registration, where the [`MCPOAuthProvider`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/oauth-provider.ts#L98) registers itself with the OAuth server to obtain the required client credentials.

Once the OAuth configuration is established, the authorization code flow with PKCE is initiated. This involves generating a [`code_verifier`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/oauth-provider.ts#L509) and a [`code_challenge`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/oauth-provider.ts#L451) for enhanced security. The user is then directed to the authorization server's login page, typically opened in a browser. A local HTTP server is spun up to listen for the OAuth callback, which receives the authorization code after the user grants consent. This code is then exchanged for an [`access_token`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/code_assist/oauth-credential-storage.test.ts#L243) and a [`refresh_token`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/code_assist/oauth2.ts#L57) with the token endpoint.

The provider is responsible for securely storing these tokens using a dedicated token storage mechanism, as detailed in [Secure Token Storage Mechanisms](https://codewiki.google/github.com/google-gemini/gemini-cli#model-context-protocol-mcp-and-authentication-secure-token-storage-mechanisms). It also manages token refresh, automatically requesting new access tokens using the stored refresh token when the current access token is expired or near expiration. The [`MCPOAuthProvider`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/oauth-provider.ts#L98) in [`packages/core/src/mcp/oauth-provider.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/oauth-provider.ts) orchestrates these steps, including handling network requests and providing user feedback during the authentication process. Utility functions within [`packages/core/src/mcp/oauth-utils.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/oauth-utils.ts) assist in tasks like constructing discovery URLs and parsing token expiry.

### Service Account Impersonation Authentication



The Gemini CLI offers the ability to authenticate to Model Context Protocol (MCP) servers by impersonating a Google Cloud service account. This method enables the CLI to acquire OAuth ID tokens, which are essential for interacting with services that are secured by such tokens. The core component facilitating this is the [`ServiceAccountImpersonationProvider`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/sa-impersonation-provider.ts#L25) class, defined in [`packages/core/src/mcp/sa-impersonation-provider.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/sa-impersonation-provider.ts). This provider adheres to the [`McpAuthProvider`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/auth-provider.ts#L13) interface, which is detailed further in [Model Context Protocol (MCP) and Authentication](https://codewiki.google/github.com/google-gemini/gemini-cli#model-context-protocol-mcp-and-authentication), allowing it to seamlessly integrate into the CLI's authentication framework.

The [`ServiceAccountImpersonationProvider`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/sa-impersonation-provider.ts#L25) manages the process of obtaining and managing these ID tokens. It leverages the [`google-auth-library`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/package.json#L53) to issue ID tokens via the IAM Credentials API, effectively "impersonating" a specified Google Cloud service account. A key design choice is to map the obtained ID token to the [`access_token`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/code_assist/oauth-credential-storage.test.ts#L243) field expected by the CLI for constructing the [`Authorization: Bearer <token>`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/docs/ide-integration/ide-companion-spec.md?plain=1#L68) header, ensuring compatibility with standard token presentation.

To optimize performance and reduce redundant requests, the provider incorporates a token caching mechanism. It stores acquired ID tokens along with their expiration times and proactively refreshes them before they fully expire, typically within a five-minute buffer. This ensures that the CLI always operates with a valid and fresh token, minimizing authentication failures. The provider's configuration requires specifying the target service account, the target audience for the ID token, and the MCP server's URL, ensuring all necessary parameters are in place for successful impersonation and token generation. For more details on the general [`McpAuthProvider`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/auth-provider.ts#L13) interface, see [`packages/core/src/mcp/auth-provider.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/auth-provider.ts).

### OAuth Utility Functions and Discovery



The [`OAuthUtils`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/oauth-utils.ts#L56) component, located in [`packages/core/src/mcp/oauth-utils.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/oauth-utils.ts), provides a set of static helper methods designed to streamline various OAuth 2.0 operations within the Gemini CLI. Its primary role is to assist in the discovery of OAuth configuration, ensuring that the CLI can correctly identify and interact with authorization servers and protected resources.

One of its core functionalities involves constructing well-known discovery URLs, which are standardized endpoints where OAuth server metadata can be found. This allows the CLI to dynamically locate necessary OAuth endpoints without requiring them to be explicitly configured. Once these URLs are built, [`OAuthUtils`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/oauth-utils.ts#L56) facilitates fetching and parsing the metadata from both protected resources and authorization servers, converting the raw data into a structured OAuth configuration that the CLI can use. This capability is crucial for implementing secure and flexible authentication flows, particularly for the [Model Context Protocol (MCP) and Authentication](https://codewiki.google/github.com/google-gemini/gemini-cli#model-context-protocol-mcp-and-authentication).

Beyond discovery, [`OAuthUtils`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/oauth-utils.ts#L56) also assists in parsing [`WWW-Authenticate`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/oauth-utils.ts#L311) headers, which can provide critical information about authentication challenges from a server, including links to resource metadata. This allows the CLI to react appropriately to authentication requirements. Additionally, the utility includes methods for extracting token expiration times from JWTs, enabling the CLI to proactively manage token lifecycles and refresh tokens before they expire. These functionalities collectively ensure robust and adaptable authentication for the Gemini CLI's interactions with various services.

### Secure Token Storage Mechanisms



The Gemini CLI employs a framework for managing OAuth credentials and arbitrary secrets. This framework uses an abstract class, interfaces, and concrete implementations to provide secure and flexible storage options.

The core of this system is defined by two interfaces: [`TokenStorage`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/token-storage/types.ts#L30) and [`SecretStorage`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/token-storage/types.ts#L39), found in [`packages/core/src/mcp/token-storage/types.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/token-storage/types.ts). The [`TokenStorage`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/token-storage/types.ts#L30) interface outlines operations for managing [`OAuthCredentials`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/token-storage/types.ts#L21), including storing, retrieving, deleting, and listing authentication tokens. The [`SecretStorage`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/token-storage/types.ts#L39) interface defines methods for handling generic key-value secrets, enabling secure storage for sensitive data beyond OAuth tokens.

An abstract base class, [`BaseTokenStorage`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/token-storage/base-token-storage.ts#L9) located in [`packages/core/src/mcp/token-storage/base-token-storage.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/token-storage/base-token-storage.ts), provides a common foundation for all token storage implementations. It includes shared utility methods such as validating credentials, checking token expiration with a 5-minute buffer, and sanitizing server names for consistent storage keys. Concrete storage implementations extend this base class to inherit common logic and ensure adherence to the [`TokenStorage`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/token-storage/types.ts#L30) interface.

Two primary concrete implementations handle the actual persistence of credentials:

-   **Keychain Storage**: The [`KeychainTokenStorage`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/token-storage/hybrid-token-storage.ts#L28) class, implemented in [`packages/core/src/mcp/token-storage/keychain-token-storage.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/token-storage/keychain-token-storage.ts), leverages the operating system's keychain or credential manager (via the [`keytar`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/token-storage/keychain-token-storage.ts#L12) module) to store both OAuth credentials and secrets. This method provides a high level of security by utilizing system-level, often hardware-backed, encryption. [`KeychainTokenStorage`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/token-storage/hybrid-token-storage.ts#L28) dynamically loads [`keytar`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/token-storage/keychain-token-storage.ts#L12), making it an optional dependency and allowing the system to gracefully handle environments where keychain access is unavailable. It also includes an availability check to verify keychain functionality before attempting storage operations.
-   **Encrypted File Storage**: The [`FileTokenStorage`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/token-storage/file-token-storage.ts#L15) class, found in [`packages/core/src/mcp/token-storage/file-token-storage.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/token-storage/file-token-storage.ts), stores [`OAuthCredentials`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/token-storage/types.ts#L21) in an encrypted local file. This implementation uses [`aes-256-gcm`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/token-storage/file-token-storage.ts#L33) for encryption, ensuring confidentiality and integrity of the data at rest. The encryption key is derived using [`crypto.scryptSync`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/token-storage/file-token-storage.ts#L28) with a salt based on the system's hostname and the user's username, linking the key to the specific user and machine. File permissions are restrictively set to limit access to the owner only, enhancing security.

To intelligently manage these storage options, the [`HybridTokenStorage`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/token-storage/hybrid-token-storage.ts#L14) class, located in [`packages/core/src/mcp/token-storage/hybrid-token-storage.ts`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/token-storage/hybrid-token-storage.ts), acts as an abstraction layer. It prioritizes the use of [`KeychainTokenStorage`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/token-storage/hybrid-token-storage.ts#L28) if available and functional, falling back to [`FileTokenStorage`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/packages/core/src/mcp/token-storage/file-token-storage.ts#L15) otherwise. This selection process is performed lazily upon the first request for credentials, and the decision is cached for subsequent operations. An environment variable, [`GEMINI_FORCE_FILE_STORAGE`](https://github.com/google-gemini/gemini-cli/blob/cb772a5b7fcffa14d7b637e68c76b5f07bb7f0ed/integration-tests/globalSetup.ts#L63), allows administrators or developers to explicitly force the use of file-based storage, which can be useful in specific debugging scenarios or environments where keychain integration is problematic.

Overall, this layered approach ensures that OAuth credentials and sensitive secrets are stored securely and reliably, adapting to different operating environments and user preferences.
