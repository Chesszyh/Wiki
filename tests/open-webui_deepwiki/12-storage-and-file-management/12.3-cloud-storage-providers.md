# Cloud Storage Authentication

Relevant source files

-   [.github/workflows/integration-test.disabled](https://github.com/open-webui/open-webui/blob/a7271532/.github/workflows/integration-test.disabled)
-   [backend/open\_webui/storage/provider.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py)
-   [backend/open\_webui/test/apps/webui/storage/test\_provider.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/test/apps/webui/storage/test_provider.py)
-   [backend/requirements-min.txt](https://github.com/open-webui/open-webui/blob/a7271532/backend/requirements-min.txt)
-   [backend/requirements.txt](https://github.com/open-webui/open-webui/blob/a7271532/backend/requirements.txt)
-   [docker-compose.playwright.yaml](https://github.com/open-webui/open-webui/blob/a7271532/docker-compose.playwright.yaml)
-   [pyproject.toml](https://github.com/open-webui/open-webui/blob/a7271532/pyproject.toml)
-   [uv.lock](https://github.com/open-webui/open-webui/blob/a7271532/uv.lock)

## Purpose and Scope

This document describes the authentication strategies used by Open WebUI to connect to cloud storage providers (AWS S3, Google Cloud Storage, and Azure Blob Storage). It covers how each storage provider authenticates requests, the environment variables that control authentication, and how the system supports both explicit credentials and workload identity patterns.

For general information about the storage provider system and file operations, see [Storage Provider System](/open-webui/open-webui/12.1-storage-provider-architecture). For file upload and processing workflows, see [File Upload Processing](/open-webui/open-webui/12.2-local-storage-provider).

## Overview

Open WebUI's storage system supports three authentication patterns across all cloud providers:

1.  **Explicit Credentials** - Traditional credential-based authentication using access keys, service account JSON, or storage keys
2.  **Workload Identity** - Cloud-native authentication using IAM roles, service accounts, or managed identities
3.  **Default Credential Chain** - Automatic credential discovery from environment, instance metadata, or user credentials

Each `StorageProvider` implementation initializes its client with authentication logic that determines which pattern to use based on environment variables. If explicit credentials are not provided, the system automatically falls back to workload identity mechanisms.

**Sources:** [backend/open\_webui/storage/provider.py1-377](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L1-L377)

## Authentication Flow

```mermaid
flowchart TD
    Init["get_storage_provider(STORAGE_PROVIDER)"]
    CheckType["Provider Type?"]
    S3Init["S3StorageProvider.init()"]
    GCSInit["GCSStorageProvider.init()"]
    AzureInit["AzureStorageProvider.init()"]
    LocalInit["LocalStorageProvider()"]
    S3Creds["S3_ACCESS_KEY_IDandS3_SECRET_ACCESS_KEY?"]
    S3Explicit["boto3.client() withexplicit credentials"]
    S3Workload["boto3.client() withdefault credential chain(IAM roles, EC2 metadata)"]
    GCSCreds["GOOGLE_APPLICATION_CREDENTIALS_JSON?"]
    GCSExplicit["storage.Client.from_service_account_info()"]
    GCSWorkload["storage.Client()(metadata server, user creds)"]
    AzureCreds["AZURE_STORAGE_KEY?"]
    AzureExplicit["BlobServiceClient withstorage key"]
    AzureWorkload["BlobServiceClient withDefaultAzureCredential(managed identity)"]
    S3Client["self.s3_client"]
    GCSClient["self.gcs_client"]
    AzureClient["self.blob_service_client"]
    LocalReady["Storage ready"]
    Ready["Storage provider ready"]

    Init --> CheckType
    CheckType --> S3Init
    CheckType --> GCSInit
    CheckType --> AzureInit
    CheckType --> LocalInit
    S3Init --> S3Creds
    S3Creds --> S3Explicit
    S3Creds --> S3Workload
    GCSInit --> GCSCreds
    GCSCreds --> GCSExplicit
    GCSCreds --> GCSWorkload
    AzureInit --> AzureCreds
    AzureCreds --> AzureExplicit
    AzureCreds --> AzureWorkload
    S3Explicit --> S3Client
    S3Workload --> S3Client
    GCSExplicit --> GCSClient
    GCSWorkload --> GCSClient
    AzureExplicit --> AzureClient
    AzureWorkload --> AzureClient
    LocalInit --> LocalReady
    S3Client --> Ready
    GCSClient --> Ready
    AzureClient --> Ready
```
**Sources:** [backend/open\_webui/storage/provider.py362-376](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L362-L376) [backend/open\_webui/storage/provider.py109-141](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L109-L141) [backend/open\_webui/storage/provider.py227-239](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L227-L239) [backend/open\_webui/storage/provider.py293-311](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L293-L311)

## S3 Storage Authentication

### Initialization Logic

The `S3StorageProvider` class implements dual authentication paths in its `__init__` method:

```mermaid
flowchart TD
    Init["S3StorageProvider.init()"]
    Config["Create boto3 Configwith S3_USE_ACCELERATE_ENDPOINTand S3_ADDRESSING_STYLE"]
    CheckCreds["S3_ACCESS_KEY_IDandS3_SECRET_ACCESS_KEYdefined?"]
    ExplicitPath["boto3.client('s3')with aws_access_key_idand aws_secret_access_key"]
    WorkloadPath["boto3.client('s3')without credentials(uses default chain)"]
    Client["self.s3_client"]
    BucketConfig["self.bucket_name = S3_BUCKET_NAMEself.key_prefix = S3_KEY_PREFIX"]

    Init --> Config
    Config --> CheckCreds
    CheckCreds --> ExplicitPath
    CheckCreds --> WorkloadPath
    ExplicitPath --> Client
    WorkloadPath --> Client
    Client --> BucketConfig
```
**Sources:** [backend/open\_webui/storage/provider.py109-141](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L109-L141)

### Explicit Credentials

When explicit credentials are provided via environment variables, boto3 creates an authenticated client:

| Environment Variable | Purpose | Example |
| --- | --- | --- |
| `S3_ACCESS_KEY_ID` | AWS access key ID | `AKIAIOSFODNN7EXAMPLE` |
| `S3_SECRET_ACCESS_KEY` | AWS secret access key | `wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY` |
| `S3_REGION_NAME` | AWS region | `us-west-2` |
| `S3_ENDPOINT_URL` | Custom S3 endpoint (for S3-compatible services) | `https://s3.example.com` |

The client initialization with explicit credentials occurs at [backend/open\_webui/storage/provider.py121-129](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L121-L129):

-   Creates `boto3.client("s3", ...)` with `aws_access_key_id` and `aws_secret_access_key`
-   Applies region from `S3_REGION_NAME`
-   Uses custom endpoint from `S3_ENDPOINT_URL` if provided
-   Configures S3-specific options like accelerate endpoint and addressing style

**Sources:** [backend/open\_webui/storage/provider.py121-129](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L121-L129) [backend/open\_webui/config.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/config.py)

### Workload Identity (Default Credential Chain)

When explicit credentials are not provided, the fallback path at [backend/open\_webui/storage/provider.py131-138](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L131-L138) creates a boto3 client without credentials. This activates boto3's default credential provider chain, which searches for credentials in this order:

1.  **Environment variables** - `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`, `AWS_SESSION_TOKEN`
2.  **Shared credential file** - `~/.aws/credentials`
3.  **AWS config file** - `~/.aws/config`
4.  **IAM role for EC2** - Instance metadata service at `http://169.254.169.254/latest/meta-data/iam/security-credentials/`
5.  **IAM role for ECS** - Container credentials endpoint
6.  **IAM role for EKS** - Service account token via IRSA (IAM Roles for Service Accounts)

This pattern is demonstrated in the test at [backend/open\_webui/test/apps/webui/storage/test\_provider.py190-199](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/test/apps/webui/storage/test_provider.py#L190-L199) which verifies that `S3StorageProvider` can initialize without explicit credentials.

**Sources:** [backend/open\_webui/storage/provider.py131-138](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L131-L138) [backend/open\_webui/test/apps/webui/storage/test\_provider.py190-199](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/test/apps/webui/storage/test_provider.py#L190-L199)

### Configuration Options

Additional S3 configuration parameters control client behavior:

| Environment Variable | Default | Purpose |
| --- | --- | --- |
| `S3_BUCKET_NAME` | Required | S3 bucket name |
| `S3_KEY_PREFIX` | `""` | Prefix for all object keys (folder path) |
| `S3_USE_ACCELERATE_ENDPOINT` | `False` | Enable S3 Transfer Acceleration |
| `S3_ADDRESSING_STYLE` | `auto` | Addressing style (`path`, `virtual`, `auto`) |
| `S3_ENABLE_TAGGING` | `False` | Enable object tagging |

The boto3 `Config` object is constructed at [backend/open\_webui/storage/provider.py110-118](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L110-L118) with these settings, plus request/response checksum validation.

**Sources:** [backend/open\_webui/storage/provider.py110-141](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L110-L141) [backend/open\_webui/config.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/config.py)

## Google Cloud Storage Authentication

### Initialization Logic

The `GCSStorageProvider` class determines authentication method based on the presence of service account JSON:

```mermaid
flowchart TD
    Init["GCSStorageProvider.init()"]
    CheckJSON["GOOGLE_APPLICATION_CREDENTIALS_JSONdefined?"]
    ParseJSON["json.loads(GOOGLE_APPLICATION_CREDENTIALS_JSON)"]
    ServiceAcct["storage.Client.from_service_account_info(info=json_dict)"]
    DefaultCreds["storage.Client()no parameters"]
    Client["self.gcs_client"]
    Bucket["self.bucket =gcs_client.bucket(GCS_BUCKET_NAME)"]

    Init --> CheckJSON
    CheckJSON --> ParseJSON
    ParseJSON --> ServiceAcct
    CheckJSON --> DefaultCreds
    ServiceAcct --> Client
    DefaultCreds --> Client
    Client --> Bucket
```
**Sources:** [backend/open\_webui/storage/provider.py227-239](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L227-L239)

### Explicit Credentials (Service Account JSON)

When `GOOGLE_APPLICATION_CREDENTIALS_JSON` is set, the provider uses service account credentials:

| Environment Variable | Purpose | Format |
| --- | --- | --- |
| `GOOGLE_APPLICATION_CREDENTIALS_JSON` | Service account JSON key | JSON string with `type`, `project_id`, `private_key_id`, `private_key`, `client_email`, etc. |
| `GCS_BUCKET_NAME` | GCS bucket name | `my-bucket-name` |

The implementation at [backend/open\_webui/storage/provider.py230-233](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L230-L233):

-   Parses the JSON string using `json.loads()`
-   Calls `storage.Client.from_service_account_info(info=json_dict)`
-   Creates an authenticated client with the service account's permissions

**Sources:** [backend/open\_webui/storage/provider.py230-233](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L230-L233)

### Workload Identity (Default Credentials)

Without explicit JSON credentials, the code path at [backend/open\_webui/storage/provider.py235-238](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L235-L238) creates a client with no parameters. The Google Cloud SDK's Application Default Credentials (ADC) mechanism then searches for credentials in this order:

1.  **GOOGLE\_APPLICATION\_CREDENTIALS environment variable** - Points to a service account JSON file path (not to be confused with the `_JSON` variant)
2.  **User credentials** - From `gcloud auth application-default login` (for local development)
3.  **Compute Engine service account** - Metadata server at `http://metadata.google.internal/computeMetadata/v1/`
4.  **Cloud Run service account** - Default service account via metadata
5.  **GKE Workload Identity** - Service account mapped to Kubernetes service account

This pattern supports scenarios described in the comments at [backend/open\_webui/storage/provider.py235-238](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L235-L238):

-   **Local development**: Uses user credentials from `gcloud auth`
-   **Compute Engine/Cloud Run**: Uses instance metadata service
-   **GKE with Workload Identity**: Uses mapped service account

**Sources:** [backend/open\_webui/storage/provider.py235-238](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L235-L238)

### Test Coverage

The GCS authentication is tested at [backend/open\_webui/test/apps/webui/storage/test\_provider.py202-291](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/test/apps/webui/storage/test_provider.py#L202-L291) using the `gcp-storage-emulator` package, which validates both upload and retrieval operations without requiring real GCP credentials.

**Sources:** [backend/open\_webui/test/apps/webui/storage/test\_provider.py202-291](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/test/apps/webui/storage/test_provider.py#L202-L291)

## Azure Blob Storage Authentication

### Initialization Logic

The `AzureStorageProvider` class supports two authentication methods: storage account key and managed identity:

```mermaid
flowchart TD
    Init["AzureStorageProvider.init()"]
    SetVars["self.endpoint = AZURE_STORAGE_ENDPOINTself.container_name =AZURE_STORAGE_CONTAINER_NAME"]
    CheckKey["AZURE_STORAGE_KEYdefined?"]
    KeyAuth["BlobServiceClient(account_url=endpoint,credential=storage_key)"]
    ManagedID["BlobServiceClient(account_url=endpoint,credential=DefaultAzureCredential())"]
    ServiceClient["self.blob_service_client"]
    Container["self.container_client =blob_service_client.get_container_client(container_name)"]

    Init --> SetVars
    SetVars --> CheckKey
    CheckKey --> KeyAuth
    CheckKey --> ManagedID
    KeyAuth --> ServiceClient
    ManagedID --> ServiceClient
    ServiceClient --> Container
```
**Sources:** [backend/open\_webui/storage/provider.py293-311](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L293-L311)

### Explicit Credentials (Storage Account Key)

When a storage account key is provided, the system uses key-based authentication:

| Environment Variable | Purpose | Example |
| --- | --- | --- |
| `AZURE_STORAGE_ENDPOINT` | Storage account endpoint URL | `https://mystorageacct.blob.core.windows.net` |
| `AZURE_STORAGE_KEY` | Storage account access key | Base64-encoded key string |
| `AZURE_STORAGE_CONTAINER_NAME` | Blob container name | `open-webui-files` |

The implementation at [backend/open\_webui/storage/provider.py298-302](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L298-L302):

-   Creates `BlobServiceClient` with `account_url=self.endpoint`
-   Passes `credential=storage_key` for authentication
-   Obtains container client for blob operations

**Sources:** [backend/open\_webui/storage/provider.py298-302](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L298-L302)

### Workload Identity (Managed Identity)

Without an explicit storage key, the fallback path at [backend/open\_webui/storage/provider.py304-308](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L304-L308) uses `DefaultAzureCredential()`. This Azure Identity library class attempts authentication methods in this order:

1.  **Environment variables** - `AZURE_TENANT_ID`, `AZURE_CLIENT_ID`, `AZURE_CLIENT_SECRET` for service principals
2.  **Managed Identity** - System-assigned or user-assigned managed identity
3.  **Azure CLI** - Credentials from `az login` (for local development)
4.  **Azure PowerShell** - Credentials from `Connect-AzAccount`
5.  **Visual Studio Code** - Credentials from Azure Account extension
6.  **Workload Identity** - Federated credentials for AKS workload identity

The comments at [backend/open\_webui/storage/provider.py304-306](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L304-L306) specifically note that this supports:

-   **Azure VM/AKS with managed identity**: Automatic credential acquisition
-   **Local development**: Falls back to Azure CLI or VS Code credentials

**Sources:** [backend/open\_webui/storage/provider.py304-308](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L304-L308)

### Test Coverage

Azure storage authentication is tested using mocked `BlobServiceClient` objects at [backend/open\_webui/test/apps/webui/storage/test\_provider.py294-435](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/test/apps/webui/storage/test_provider.py#L294-L435) verifying both initialization patterns and blob operations.

**Sources:** [backend/open\_webui/test/apps/webui/storage/test\_provider.py294-435](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/test/apps/webui/storage/test_provider.py#L294-L435)

## Configuration Environment Variables

### Complete Variable Reference

The table below summarizes all authentication-related environment variables across providers:

| Variable | Provider | Purpose | Required |
| --- | --- | --- | --- |
| `STORAGE_PROVIDER` | All | Selects provider (`local`, `s3`, `gcs`, `azure`) | Yes |
| `S3_ACCESS_KEY_ID` | S3 | AWS access key ID | No (workload identity) |
| `S3_SECRET_ACCESS_KEY` | S3 | AWS secret access key | No (workload identity) |
| `S3_REGION_NAME` | S3 | AWS region | No |
| `S3_ENDPOINT_URL` | S3 | Custom S3 endpoint | No |
| `S3_BUCKET_NAME` | S3 | S3 bucket name | Yes (if S3) |
| `S3_KEY_PREFIX` | S3 | Object key prefix | No |
| `GOOGLE_APPLICATION_CREDENTIALS_JSON` | GCS | Service account JSON | No (workload identity) |
| `GCS_BUCKET_NAME` | GCS | GCS bucket name | Yes (if GCS) |
| `AZURE_STORAGE_ENDPOINT` | Azure | Storage account endpoint | Yes (if Azure) |
| `AZURE_STORAGE_KEY` | Azure | Storage account key | No (managed identity) |
| `AZURE_STORAGE_CONTAINER_NAME` | Azure | Blob container name | Yes (if Azure) |

**Sources:** [backend/open\_webui/config.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/config.py) [backend/open\_webui/storage/provider.py1-377](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L1-L377)

### Dependencies

Each provider requires specific Python packages for authentication:

| Provider | Package | Version | Purpose |
| --- | --- | --- | --- |
| S3 | `boto3` | 1.41.5 | AWS SDK for Python |
| GCS | `google-cloud-storage` | 2.19.0 | GCS client library |
| Azure | `azure-storage-blob` | 12.24.1 | Blob storage client |
| Azure | `azure-identity` | 1.25.0 | Azure credential providers |

**Sources:** [backend/requirements.txt99-101](https://github.com/open-webui/open-webui/blob/a7271532/backend/requirements.txt#L99-L101) [backend/requirements.txt108](https://github.com/open-webui/open-webui/blob/a7271532/backend/requirements.txt#L108-L108) [backend/requirements.txt113-114](https://github.com/open-webui/open-webui/blob/a7271532/backend/requirements.txt#L113-L114) [pyproject.toml111](https://github.com/open-webui/open-webui/blob/a7271532/pyproject.toml#L111-L111) [pyproject.toml113-114](https://github.com/open-webui/open-webui/blob/a7271532/pyproject.toml#L113-L114)

## Authentication Pattern Comparison

```mermaid
flowchart TD
    AzureExplicit["Explicit:AZURE_STORAGE_KEY"]
    AzureWorkload["Managed Identity:DefaultAzureCredential(VM, AKS, App Service)"]
    GCSExplicit["Explicit:GOOGLE_APPLICATION_CREDENTIALS_JSON"]
    GCSWorkload["Workload Identity:Service Account(GCE, GKE, Cloud Run)"]
    S3Explicit["Explicit:S3_ACCESS_KEY_ID +S3_SECRET_ACCESS_KEY"]
    S3Workload["Workload Identity:IAM Roles(EC2, ECS, EKS)"]

    AzureExplicit --> AzureWorkload
    GCSExplicit --> GCSWorkload
    S3Explicit --> S3Workload
```
All three providers follow the same architectural pattern:

1.  Check for explicit credentials in environment variables
2.  If present, create authenticated client with explicit credentials
3.  If absent, delegate to cloud provider's SDK for automatic credential discovery
4.  Cloud SDK attempts workload identity, then falls back to local development credentials

This design enables:

-   **Development flexibility**: Developers can use explicit credentials locally
-   **Production security**: Production deployments use IAM roles/managed identities without embedding credentials
-   **Cloud-agnostic patterns**: Same authentication approach across AWS, GCP, and Azure
-   **Zero-configuration workload identity**: No code changes needed when explicit credentials are removed

**Sources:** [backend/open\_webui/storage/provider.py109-311](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L109-L311)

## Provider Selection and Initialization

The storage provider is selected and initialized in `get_storage_provider()` at [backend/open\_webui/storage/provider.py362-376](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L362-L376):

```
def get_storage_provider(storage_provider: str):
    if storage_provider == "local":
        Storage = LocalStorageProvider()
    elif storage_provider == "s3":
        Storage = S3StorageProvider()
    elif storage_provider == "gcs":
        Storage = GCSStorageProvider()
    elif storage_provider == "azure":
        Storage = AzureStorageProvider()
    else:
        raise RuntimeError(f"Unsupported storage provider: {storage_provider}")
    return Storage
```
The global `Storage` instance is created at module import time based on the `STORAGE_PROVIDER` environment variable. This singleton pattern ensures authentication occurs once during application startup, with subsequent operations reusing the authenticated client.

**Sources:** [backend/open\_webui/storage/provider.py362-376](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L362-L376)
