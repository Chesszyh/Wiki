# Data and Storage Layer

Relevant source files

-   [.github/workflows/integration-test.disabled](https://github.com/open-webui/open-webui/blob/a7271532/.github/workflows/integration-test.disabled)
-   [backend/open\_webui/config.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/config.py)
-   [backend/open\_webui/main.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/main.py)
-   [backend/open\_webui/retrieval/loaders/datalab\_marker.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/retrieval/loaders/datalab_marker.py)
-   [backend/open\_webui/retrieval/loaders/external\_document.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/retrieval/loaders/external_document.py)
-   [backend/open\_webui/retrieval/loaders/external\_web.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/retrieval/loaders/external_web.py)
-   [backend/open\_webui/retrieval/loaders/main.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/retrieval/loaders/main.py)
-   [backend/open\_webui/retrieval/loaders/mineru.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/retrieval/loaders/mineru.py)
-   [backend/open\_webui/retrieval/loaders/mistral.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/retrieval/loaders/mistral.py)
-   [backend/open\_webui/retrieval/utils.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/retrieval/utils.py)
-   [backend/open\_webui/routers/retrieval.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/routers/retrieval.py)
-   [backend/open\_webui/storage/provider.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py)
-   [backend/open\_webui/test/apps/webui/storage/test\_provider.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/test/apps/webui/storage/test_provider.py)
-   [backend/open\_webui/utils/middleware.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/utils/middleware.py)
-   [backend/requirements-min.txt](https://github.com/open-webui/open-webui/blob/a7271532/backend/requirements-min.txt)
-   [backend/requirements.txt](https://github.com/open-webui/open-webui/blob/a7271532/backend/requirements.txt)
-   [docker-compose.playwright.yaml](https://github.com/open-webui/open-webui/blob/a7271532/docker-compose.playwright.yaml)
-   [pyproject.toml](https://github.com/open-webui/open-webui/blob/a7271532/pyproject.toml)
-   [src/lib/apis/retrieval/index.ts](https://github.com/open-webui/open-webui/blob/a7271532/src/lib/apis/retrieval/index.ts)
-   [src/lib/components/admin/Settings/Documents.svelte](https://github.com/open-webui/open-webui/blob/a7271532/src/lib/components/admin/Settings/Documents.svelte)
-   [src/lib/components/admin/Settings/WebSearch.svelte](https://github.com/open-webui/open-webui/blob/a7271532/src/lib/components/admin/Settings/WebSearch.svelte)
-   [uv.lock](https://github.com/open-webui/open-webui/blob/a7271532/uv.lock)

## Purpose and Scope

This document describes Open WebUI's data persistence architecture, which consists of three primary layers: a relational database (PostgreSQL or SQLite) for structured data, Redis for caching and distributed state management, and vector databases for semantic search capabilities. Additionally, the system implements an abstraction layer for file storage that supports local filesystem and multiple cloud providers.

For information about database models and their relationships, see the specific router documentation (e.g., [3](/open-webui/open-webui/3-installation-and-deployment) for chat data structures). For real-time communication mechanisms, see [Real-time Communication](/open-webui/open-webui/8-navigation-and-organization).

---

## System Architecture Overview

### Multi-Layered Storage Architecture

```mermaid
flowchart TD
    FastAPI["FastAPI Applicationbackend/open_webui/main.py"]
    SocketIO["Socket.IO Serverbackend/open_webui/socket/main.py"]
    Session["SQLAlchemy Sessionbackend/open_webui/internal/db.py"]
    RedisClient["Redis Clientbackend/open_webui/utils/redis.py"]
    VectorClient["VECTOR_DB_CLIENTbackend/open_webui/retrieval/vector/factory.py"]
    StorageProvider["Storage Providerbackend/open_webui/storage/provider.py"]
    PostgreSQL["PostgreSQL(Production)"]
    SQLite["SQLite(Development)"]
    RedisStandalone["RedisStandalone"]
    RedisSentinel["RedisSentinel (HA)"]
    RedisCluster["RedisCluster"]
    ChromaDB["ChromaDB(Default)"]
    Weaviate["Weaviate"]
    Milvus["Milvus"]
    Qdrant["Qdrant"]
    PGVector["pgvector"]
    Others["Pinecone/OpenSearch"]
    LocalFS["Local FilesystemUPLOAD_DIR"]
    S3["AWS S3"]
    GCS["Google Cloud Storage"]
    Azure["Azure Blob Storage"]

    FastAPI --> Session
    FastAPI --> RedisClient
    FastAPI --> VectorClient
    FastAPI --> StorageProvider
    SocketIO --> RedisClient
    Session --> PostgreSQL
    Session --> SQLite
    RedisClient --> RedisStandalone
    RedisClient --> RedisSentinel
    RedisClient --> RedisCluster
    VectorClient --> ChromaDB
    VectorClient --> Weaviate
    VectorClient --> Milvus
    VectorClient --> Qdrant
    VectorClient --> PGVector
    VectorClient --> Others
    StorageProvider --> LocalFS
    StorageProvider --> S3
    StorageProvider --> GCS
    StorageProvider --> Azure
```
**Sources:** [backend/open\_webui/main.py105-106](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/main.py#L105-L106) [backend/open\_webui/socket/main.py59-164](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/socket/main.py#L59-L164) [backend/open\_webui/utils/redis.py1-100](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/utils/redis.py#L1-L100) [backend/open\_webui/storage/provider.py1-50](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L1-L50)

---

## Primary Database System

### Database Connection Management

Open WebUI uses SQLAlchemy as the ORM layer with support for both PostgreSQL (production) and SQLite (development/single-user deployments). The database is initialized in `backend/open_webui/internal/db.py`.

```mermaid
flowchart TD
    ENV["DATABASE_URLenvironment variable"]
    PG_URL["postgresql://..."]
    SQLITE_URL["sqlite:///webui.db"]
    Engine["create_engine()backend/open_webui/internal/db.py"]
    SessionMaker["sessionmakerSession factory"]
    Base["declarative_base()Model base class"]
    User["Userbackend/open_webui/models/users.py"]
    Chat["Chatbackend/open_webui/models/chats.py"]
    File["Filebackend/open_webui/models/files.py"]
    Knowledge["Knowledgebackend/open_webui/models/knowledge.py"]
    Function["Functionbackend/open_webui/models/functions.py"]
    Model["Modelbackend/open_webui/models/models.py"]
    Config["Configbackend/open_webui/config.py"]
    Alembic["Alembicbackend/open_webui/alembic.ini"]
    Migrations["migrations/version scripts"]

    ENV --> PG_URL
    ENV --> SQLITE_URL
    PG --> URL_Engine
    SQLITE --> URL_Engine
    Engine --> SessionMaker
    Base --> User
    Base --> Chat
    Base --> File
    Base --> Knowledge
    Base --> Function
    Base --> Model
    Base --> Config
    Alembic --> Migrations
    Migrations --> Engine
```
**Database URL Configuration:**

The system selects the database based on the `DATABASE_URL` environment variable:

-   PostgreSQL: `postgresql://user:password@host:port/dbname`
-   SQLite: `sqlite:///path/to/webui.db` (default: `DATA_DIR/webui.db`)

**Sources:** [backend/open\_webui/env.py1-100](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/env.py#L1-L100) [backend/open\_webui/config.py52-70](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/config.py#L52-L70)

### Schema Migration System

The system uses Alembic for database schema migrations:

```mermaid
flowchart TD
    App["Application Startupbackend/open_webui/main.py"]
    RunMig["run_migrations()backend/open_webui/config.py:53-68"]
    AlembicCfg["Alembic Configbackend/open_webui/alembic.ini"]
    MigDir["migrations/Backend migration scripts"]
    DBEngine["Database Engine"]

    App --> RunMig
    RunMig --> AlembicCfg
    AlembicCfg --> MigDir
    MigDir --> DBEngine
```
Migrations are automatically run on application startup via `run_migrations()` which uses `alembic.command.upgrade(alembic_cfg, "head")`.

**Sources:** [backend/open\_webui/config.py52-70](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/config.py#L52-L70)

### Core Database Models

| Model | Purpose | Key Fields | File Path |
| --- | --- | --- | --- |
| `User` | User accounts and authentication | `id`, `email`, `name`, `role`, `profile_image_url` | `backend/open_webui/models/users.py` |
| `Chat` | Chat conversations and history | `id`, `user_id`, `title`, `chat`, `created_at` | `backend/open_webui/models/chats.py` |
| `File` | Uploaded files metadata | `id`, `user_id`, `filename`, `path`, `data` | `backend/open_webui/models/files.py` |
| `Knowledge` | Knowledge base collections | `id`, `user_id`, `name`, `description`, `data` | `backend/open_webui/models/knowledge.py` |
| `Function` | Custom functions and tools | `id`, `user_id`, `name`, `type`, `content` | `backend/open_webui/models/functions.py` |
| `Model` | Model configurations | `id`, `user_id`, `base_model_id`, `name`, `params` | `backend/open_webui/models/models.py` |
| `Config` | Application configuration | `id`, `data`, `version`, `updated_at` | `backend/open_webui/config.py:73-81` |

**Sources:** [backend/open\_webui/models/users.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/models/users.py) [backend/open\_webui/models/chats.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/models/chats.py) [backend/open\_webui/models/files.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/models/files.py) [backend/open\_webui/models/knowledge.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/models/knowledge.py) [backend/open\_webui/config.py73-81](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/config.py#L73-L81)

### Session Management Pattern

Database sessions are managed using a context manager pattern:

```
# backend/open_webui/internal/db.py
with get_db() as db:
    user = db.query(User).filter(User.id == user_id).first()
```
The `get_db()` function yields a session and ensures proper cleanup via `try/finally` blocks.

**Sources:** [backend/open\_webui/internal/db.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/internal/db.py)

---

## Redis Cache and Distributed State

### Redis Connection Architecture

```mermaid
flowchart TD
    REDIS_URL["REDIS_URL"]
    REDIS_SENTINEL["REDIS_SENTINEL_HOSTSREDIS_SENTINEL_PORT"]
    REDIS_CLUSTER["REDIS_CLUSTER"]
    GetRedis["get_redis_connection()backend/open_webui/utils/redis.py:100-200"]
    Standalone["redis.RedisSingle instance"]
    Sentinel["redis.SentinelHigh availability"]
    Cluster["redis.RedisClusterHorizontal scaling"]
    Sync["Synchronous Clientdecode_responses=True"]
    Async["Async Clientredis.asyncio"]
    AppState["app.state.redisbackend/open_webui/main.py:582-589"]
    SessionStore["RedisStoreStarSessionsMiddleware"]
    SocketRedis["REDISbackend/open_webui/socket/main.py"]

    REDIS --> URL_GetRedis
    REDIS --> SENTINEL_GetRedis
    REDIS --> CLUSTER_GetRedis
    GetRedis --> Standalone
    GetRedis --> Sentinel
    GetRedis --> Cluster
    Standalone --> Sync
    Standalone --> Async
    Sentinel --> Sync
    Sentinel --> Async
    Cluster --> Sync
    Cluster --> Async
    Async --> AppState
    Sync --> SessionStore
    Async --> SocketRedis
```
**Configuration Options:**

| Environment Variable | Purpose | Default |
| --- | --- | --- |
| `REDIS_URL` | Redis connection URL | None (Redis disabled) |
| `REDIS_SENTINEL_HOSTS` | Comma-separated sentinel hosts | Empty |
| `REDIS_SENTINEL_PORT` | Sentinel port | 26379 |
| `REDIS_CLUSTER` | Enable cluster mode | False |
| `REDIS_KEY_PREFIX` | Key namespace prefix | "open-webui" |

**Sources:** [backend/open\_webui/utils/redis.py100-200](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/utils/redis.py#L100-L200) [backend/open\_webui/env.py1-100](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/env.py#L1-L100)

### Distributed State Management

Redis is used to synchronize state across multiple Open WebUI instances:

```mermaid
flowchart TD
    App1["Instance 1main.py"]
    App2["Instance 2main.py"]
    App3["Instance 3main.py"]
    SessionPool["SESSION_POOLRedisDictKey: session_idValue: user_data"]
    UsagePool["USAGE_POOLRedisDictKey: model_idValue: active_users"]
    YdocStorage["Ydoc DocumentsRedisDictKey: document_idValue: Y.Doc state"]
    ConfigCache["Config CacheRedis KeysPattern: open-webui:config:*"]
    TaskRegistry["Task RegistryRedis HashKey: open-webui:tasks"]
    PubSub["Redis Pub/SubTask commands channel"]
    Lock["RedisLockDistributed locking"]

    App1 --> SessionPool
    App2 --> SessionPool
    App3 --> SessionPool
    App1 --> UsagePool
    App2 --> UsagePool
    App3 --> UsagePool
    App1 --> YdocStorage
    App2 --> YdocStorage
    App3 --> YdocStorage
    App1 --> ConfigCache
    App2 --> ConfigCache
    App3 --> ConfigCache
    App1 --> TaskRegistry
    App2 --> TaskRegistry
    App3 --> TaskRegistry
    App1 --> PubSub
    App2 --> PubSub
    App3 --> PubSub
    App1 --> Lock
    App2 --> Lock
    App3 --> Lock
```
**Sources:** [backend/open\_webui/socket/main.py122-164](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/socket/main.py#L122-L164) [backend/open\_webui/socket/utils.py1-50](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/socket/utils.py#L1-L50)

### RedisDict and RedisLock Utilities

The system implements custom Redis data structures in [backend/open\_webui/socket/utils.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/socket/utils.py):

**RedisDict:**

-   Wrapper around Redis hash operations
-   Provides dict-like interface (`__getitem__`, `__setitem__`, `__delitem__`)
-   Serializes values as JSON
-   Used for `SESSION_POOL`, `USAGE_POOL`, `MODELS`

**RedisLock:**

-   Distributed locking mechanism
-   Uses `SET key value NX EX` for atomic lock acquisition
-   Implements lock renewal for long-running operations
-   Used in `periodic_usage_pool_cleanup()`

**Sources:** [backend/open\_webui/socket/utils.py9-150](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/socket/utils.py#L9-L150)

### Configuration Caching with Redis

The `AppConfig` class [backend/open\_webui/config.py224-284](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/config.py#L224-L284) implements a two-tier caching system:

```mermaid
flowchart TD
    EnvVar["Environment Variables"]
    PersistentCfg["PersistentConfigDatabase storage"]
    AppCfg["AppConfigIn-memory cache"]
    RedisCache["Redis CacheKey: open-webui:config:*"]
    API["Config Update API"]
    SaveDB["save_to_db()"]
    RedisSet["redis.set()"]
    OtherInstance["Other Instances"]
    RedisGet["redis.get()"]

    EnvVar --> PersistentCfg
    PersistentCfg --> AppCfg
    API --> SaveDB
    SaveDB --> AppCfg
    AppCfg --> RedisSet
    RedisGet --> OtherInstance
    RedisSet --> RedisGet
```
When a configuration value is updated:

1.  Value is saved to the database via `PersistentConfig.save()`
2.  Value is written to Redis via `AppConfig.__setattr__`
3.  Other instances read from Redis when accessing the config value

**Sources:** [backend/open\_webui/config.py224-284](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/config.py#L224-L284)

### Session Storage

HTTP sessions are stored in Redis using the `starsessions` library:

```
# backend/open_webui/main.py (implied from imports)
from starsessions.stores.redis import RedisStore

# Session middleware configuration
SessionMiddleware(
    store=RedisStore(redis_url=REDIS_URL),
    cookie_name="session",
    secret_key=WEBUI_SECRET_KEY
)
```
**Sources:** [backend/open\_webui/main.py54-58](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/main.py#L54-L58) [backend/requirements.txt22](https://github.com/open-webui/open-webui/blob/a7271532/backend/requirements.txt#L22-L22)

### Task Coordination System

Redis Pub/Sub enables cross-instance task management [backend/open\_webui/tasks.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/tasks.py):

```mermaid
flowchart TD
    Instance1["Instance 1"]
    Instance2["Instance 2"]
    Instance3["Instance 3"]
    TaskHash["REDIS_TASKS_KEYHash: task_id -> item_id"]
    ItemTasks["REDIS_ITEM_TASKS_KEYSet per item_id"]
    PubSubChannel["REDIS_PUBSUB_CHANNELTask commands"]

    Instance1 --> TaskHash
    Instance1 --> ItemTasks
    Instance2 --> PubSubChannel
    PubSubChannel --> Instance1
    PubSubChannel --> Instance3
    Instance3 --> TaskHash
```
Commands published to the Pub/Sub channel:

```
{
  "action": "stop",
  "task_id": "uuid-here"
}
```
Any instance can cancel tasks running on any other instance.

**Sources:** [backend/open\_webui/tasks.py1-150](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/tasks.py#L1-L150) [backend/open\_webui/main.py591-594](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/main.py#L591-L594)

### Ydoc Collaborative Document Storage

The `YdocManager` [backend/open\_webui/socket/utils.py150-250](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/socket/utils.py#L150-L250) stores CRDT documents in Redis for real-time collaborative editing:

```mermaid
flowchart TD
    User1["User 1 Browser"]
    User2["User 2 Browser"]
    YdocMgr["YdocManagerbackend/open_webui/socket/utils.py"]
    DocState["Document StateKey: open-webui:ydoc:documents:DOC_ID:state"]
    DocUsers["Active UsersKey: open-webui:ydoc:documents:DOC_ID:users"]
    UpdateQueue["Update QueueList: open-webui:ydoc:documents:DOC_ID:updates"]

    User1 --> YdocMgr
    User2 --> YdocMgr
    YdocMgr --> UpdateQueue
    YdocMgr --> DocState
    YdocMgr --> DocUsers
    UpdateQueue --> YdocMgr
    DocState --> YdocMgr
    DocUsers --> YdocMgr
```
The Ydoc system stores:

-   **Document state**: Binary-encoded Y.Doc state
-   **Update queue**: Recent changes for synchronization
-   **Active users**: Set of user IDs currently editing

**Sources:** [backend/open\_webui/socket/utils.py150-250](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/socket/utils.py#L150-L250) [backend/requirements.txt29](https://github.com/open-webui/open-webui/blob/a7271532/backend/requirements.txt#L29-L29)

---

## Vector Database Integration

### Vector Database Abstraction

The system provides a unified interface for multiple vector databases via `VECTOR_DB_CLIENT`:

```mermaid
flowchart TD
    RAGRouter["RAG Routerbackend/open_webui/routers/retrieval.py"]
    Middleware["RAG Middlewarebackend/open_webui/utils/middleware.py"]
    VectorFactory["VECTOR_DB_CLIENTbackend/open_webui/retrieval/vector/factory.py"]
    BaseClient["VectorDBClientAbstract base class"]
    Chroma["ChromaClientbackend/open_webui/retrieval/vector/dbs/chroma.py"]
    Weaviate["WeaviateClientbackend/open_webui/retrieval/vector/dbs/weaviate.py"]
    Milvus["MilvusClientbackend/open_webui/retrieval/vector/dbs/milvus.py"]
    Qdrant["QdrantClientbackend/open_webui/retrieval/vector/dbs/qdrant.py"]
    PGVector["PGVectorClientbackend/open_webui/retrieval/vector/dbs/pgvector.py"]
    OpenSearch["OpenSearchClientbackend/open_webui/retrieval/vector/dbs/opensearch.py"]
    Pinecone["PineconeClientbackend/open_webui/retrieval/vector/dbs/pinecone.py"]

    RAGRouter --> VectorFactory
    Middleware --> VectorFactory
    VectorFactory --> BaseClient
    BaseClient --> Chroma
    BaseClient --> Weaviate
    BaseClient --> Milvus
    BaseClient --> Qdrant
    BaseClient --> PGVector
    BaseClient --> OpenSearch
    BaseClient --> Pinecone
```
**Sources:** [backend/open\_webui/retrieval/vector/factory.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/retrieval/vector/factory.py) [backend/open\_webui/config.py1-50](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/config.py#L1-L50)

### Vector Database Client Interface

All vector database clients implement a common interface:

| Method | Purpose | Returns |
| --- | --- | --- |
| `insert(collection_name, vectors, documents, metadatas, ids)` | Insert embeddings | None |
| `upsert(collection_name, vectors, documents, metadatas, ids)` | Insert or update | None |
| `search(collection_name, vectors, limit)` | Similarity search | `GetResult` |
| `get(collection_name, ids=None, where=None)` | Get documents | `GetResult` |
| `delete(collection_name, ids)` | Delete documents | None |
| `reset()` | Delete all collections | None |
| `has_collection(collection_name)` | Check existence | bool |
| `delete_collection(collection_name)` | Delete collection | None |

**GetResult Structure:**

```
class GetResult:
    ids: list[list[str]]
    documents: list[list[str]]
    metadatas: list[list[dict]]
    distances: list[list[float]]  # Only in search results
```
**Sources:** [backend/open\_webui/retrieval/vector/main.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/retrieval/vector/main.py)

### Embedding and Retrieval Flow

```mermaid
flowchart TD
    Upload["File Upload"]
    Loader["Document Loaderbackend/open_webui/retrieval/loaders/main.py"]
    Splitter["Text SplitterRecursiveCharacterTextSplitter"]
    EmbedFunc["Embedding Functionget_embedding_function()"]
    Insert["VECTOR_DB_CLIENT.insert()"]
    Query["User Query"]
    QueryEmbed["Generate Query Embedding"]
    VectorSearch["VECTOR_DB_CLIENT.search()"]
    Rerank["Reranking FunctionCrossEncoder/ColBERT"]
    Results["Retrieved Documents"]
    BM25["BM25RetrieverKeyword search"]
    VectorRet["VectorSearchRetrieverSemantic search"]
    Ensemble["EnsembleRetrieverCombine results"]
    Compress["ContextualCompressionRetrieverApply reranking"]

    Query --> QueryEmbed
    QueryEmbed --> VectorSearch
    VectorSearch --> Rerank
    Rerank --> Results
    Query --> BM25
    Query --> VectorRet
    BM25 --> Ensemble
    VectorRet --> Ensemble
    Ensemble --> Compress
    Compress --> Results
    Upload --> Loader
    Loader --> Splitter
    Splitter --> EmbedFunc
    EmbedFunc --> Insert
```
**Sources:** [backend/open\_webui/retrieval/utils.py88-315](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/retrieval/utils.py#L88-L315) [backend/open\_webui/routers/retrieval.py1-100](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/routers/retrieval.py#L1-L100)

### Embedding Function Configuration

The system supports multiple embedding engines:

| Engine | Implementation | Configuration |
| --- | --- | --- |
| Local | `SentenceTransformer` | `RAG_EMBEDDING_MODEL` (HuggingFace model) |
| OpenAI | OpenAI API | `RAG_OPENAI_API_BASE_URL`, `RAG_OPENAI_API_KEY` |
| Ollama | Ollama API | `RAG_OLLAMA_BASE_URL`, `RAG_OLLAMA_API_KEY` |
| Azure OpenAI | Azure API | `RAG_AZURE_OPENAI_BASE_URL`, `RAG_AZURE_OPENAI_API_KEY` |

Embedding functions are initialized at startup [backend/open\_webui/main.py985-1041](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/main.py#L985-L1041) and stored in `app.state.EMBEDDING_FUNCTION`.

**Sources:** [backend/open\_webui/retrieval/utils.py400-500](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/retrieval/utils.py#L400-L500) [backend/open\_webui/main.py985-1041](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/main.py#L985-L1041)

### Hybrid Search Implementation

When `ENABLE_RAG_HYBRID_SEARCH` is enabled, the system uses both vector similarity and BM25 keyword matching:

```
# backend/open_webui/retrieval/utils.py:207-315
bm25_retriever = BM25Retriever.from_texts(
    texts=collection_result.documents[0],
    metadatas=collection_result.metadatas[0]
)

vector_search_retriever = VectorSearchRetriever(
    collection_name=collection_name,
    embedding_function=embedding_function,
    top_k=k
)

ensemble_retriever = EnsembleRetriever(
    retrievers=[bm25_retriever, vector_search_retriever],
    weights=[hybrid_bm25_weight, 1.0 - hybrid_bm25_weight]
)
```
Results are then reranked using CrossEncoder or ColBERT models for improved relevance.

**Sources:** [backend/open\_webui/retrieval/utils.py207-315](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/retrieval/utils.py#L207-L315)

---

## File Storage Providers

### Storage Provider Abstraction

Open WebUI implements a provider pattern for file storage:

```mermaid
flowchart TD
    StorageProvider["StorageProvider (ABC)backend/open_webui/storage/provider.py:43-61"]
    Local["LocalStorageProviderlines 63-106"]
    S3["S3StorageProviderlines 108-200"]
    GCS["GCSStorageProviderlines 202-300"]
    Azure["AzureStorageProviderlines 302-400"]
    Factory["get_storage_provider()STORAGE_PROVIDER env var"]
    CurrentStorage["Storage (Global)Singleton instance"]

    StorageProvider --> Local
    StorageProvider --> S3
    StorageProvider --> GCS
    StorageProvider --> Azure
    Factory --> Local
    Factory --> S3
    Factory --> GCS
    Factory --> Azure
    Factory --> CurrentStorage
```
**Sources:** [backend/open\_webui/storage/provider.py1-450](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L1-L450)

### Storage Provider Interface

All storage providers implement these methods:

```
class StorageProvider(ABC):
    @abstractmethod
    def upload_file(file: BinaryIO, filename: str, tags: Dict[str, str]) -> Tuple[bytes, str]:
        """Upload file and return (contents, file_path)"""
        pass

    @abstractmethod
    def get_file(file_path: str) -> str:
        """Get file path for download"""
        pass

    @abstractmethod
    def delete_file(file_path: str) -> None:
        """Delete a file"""
        pass

    @abstractmethod
    def delete_all_files() -> None:
        """Delete all files"""
        pass
```
**Sources:** [backend/open\_webui/storage/provider.py43-61](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L43-L61)

### Local Storage Provider

The default provider stores files in `UPLOAD_DIR`:

```
# backend/open_webui/storage/provider.py:63-106
class LocalStorageProvider(StorageProvider):
    @staticmethod
    def upload_file(file: BinaryIO, filename: str, tags: Dict[str, str]) -> Tuple[bytes, str]:
        contents = file.read()
        file_path = f"{UPLOAD_DIR}/{filename}"
        with open(file_path, "wb") as f:
            f.write(contents)
        return contents, file_path
```
**Configuration:**

-   `UPLOAD_DIR`: Base directory for file storage (default: `DATA_DIR/uploads`)

**Sources:** [backend/open\_webui/storage/provider.py63-106](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L63-L106)

### S3 Storage Provider

Supports AWS S3 and S3-compatible services:

```mermaid
flowchart TD
    URL["S3_ENDPOINT_URL(None for AWS)"]
    Bucket["S3_BUCKET_NAME"]
    KeyID["S3_ACCESS_KEY_ID"]
    Secret["S3_SECRET_ACCESS_KEY"]
    Region["S3_REGION_NAME"]
    Prefix["S3_KEY_PREFIX"]
    Boto3["boto3.client('s3')"]
    Config["botocore.ConfigAccelerate/Addressing"]
    Upload["put_object()With tagging"]
    Download["generate_presigned_url()"]
    Delete["delete_object()"]

    URL --> Boto3
    KeyID --> Boto3
    Secret --> Boto3
    Region --> Boto3
    Config --> Boto3
    Boto3 --> Upload
    Boto3 --> Download
    Boto3 --> Delete
    Bucket --> Upload
    Bucket --> Download
    Bucket --> Delete
    Prefix --> Upload
    Prefix --> Download
    Prefix --> Delete
```
**Configuration Options:**

| Variable | Purpose | Default |
| --- | --- | --- |
| `S3_ENDPOINT_URL` | Custom S3 endpoint (e.g., MinIO) | None (AWS S3) |
| `S3_BUCKET_NAME` | Bucket name | Required |
| `S3_ACCESS_KEY_ID` | AWS access key | Required |
| `S3_SECRET_ACCESS_KEY` | AWS secret key | Required |
| `S3_REGION_NAME` | AWS region | `us-east-1` |
| `S3_KEY_PREFIX` | Object key prefix | Empty |
| `S3_USE_ACCELERATE_ENDPOINT` | Enable transfer acceleration | False |
| `S3_ADDRESSING_STYLE` | Path or virtual-hosted | `auto` |
| `S3_ENABLE_TAGGING` | Add metadata tags | True |

**Sources:** [backend/open\_webui/storage/provider.py108-200](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L108-L200) [backend/open\_webui/config.py1-100](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/config.py#L1-L100)

### Google Cloud Storage Provider

Supports GCS with workload identity or explicit credentials:

```mermaid
flowchart TD
    WorkloadID["Workload Identity(GKE/Cloud Run)"]
    ExplicitCreds["Explicit CredentialsGOOGLE_APPLICATION_CREDENTIALS_JSON"]
    StorageClient["storage.Client()"]
    DefaultCreds["DefaultAzureCredential()"]
    JSONCreds["service_account.Credentials"]
    Upload["bucket.blob().upload_from_file()"]
    Download["blob.generate_signed_url()"]
    Delete["blob.delete()"]

    WorkloadID --> DefaultCreds
    ExplicitCreds --> JSONCreds
    DefaultCreds --> StorageClient
    JSONCreds --> StorageClient
    StorageClient --> Upload
    StorageClient --> Download
    StorageClient --> Delete
```
**Configuration:**

-   `GCS_BUCKET_NAME`: Bucket name
-   `GOOGLE_APPLICATION_CREDENTIALS_JSON`: JSON credentials (optional if using workload identity)

**Sources:** [backend/open\_webui/storage/provider.py202-300](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L202-L300)

### Azure Blob Storage Provider

Supports Azure Blob Storage with workload identity or storage keys:

```mermaid
flowchart TD
    WorkloadID["Workload IdentityDefaultAzureCredential"]
    StorageKey["Storage Account KeyAZURE_STORAGE_KEY"]
    BlobService["BlobServiceClient"]
    Container["ContainerClient"]
    Upload["blob_client.upload_blob()"]
    Download["blob_client.generate_blob_sas()"]
    Delete["blob_client.delete_blob()"]

    WorkloadID --> BlobService
    StorageKey --> BlobService
    BlobService --> Container
    Container --> Upload
    Container --> Download
    Container --> Delete
```
**Configuration:**

-   `AZURE_STORAGE_ENDPOINT`: Storage account endpoint
-   `AZURE_STORAGE_CONTAINER_NAME`: Container name
-   `AZURE_STORAGE_KEY`: Account key (optional if using workload identity)

**Sources:** [backend/open\_webui/storage/provider.py302-400](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L302-L400)

### Storage Provider Selection

The active storage provider is determined at startup:

```
# backend/open_webui/storage/provider.py:450-500
STORAGE_PROVIDER = os.getenv("STORAGE_PROVIDER", "local")

Storage = get_storage_provider(STORAGE_PROVIDER)
```
Supported values:

-   `local`: LocalStorageProvider
-   `s3`: S3StorageProvider
-   `gcs`: GCSStorageProvider
-   `azure`: AzureStorageProvider

**Sources:** [backend/open\_webui/storage/provider.py450-500](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L450-L500)

---

## Configuration System

### Environment-Driven Configuration

Open WebUI uses a dual-layer configuration system:

```mermaid
flowchart TD
    EnvVars["Environment Variablesbackend/open_webui/env.py"]
    DBConfig["Database ConfigConfig table"]
    PersistentCfg["PersistentConfigbackend/open_webui/config.py:165-222"]
    AppConfig["AppConfigbackend/open_webui/config.py:224-284"]
    AppState["app.state.configbackend/open_webui/main.py:646-651"]
    RedisCache["Redis Config CacheKey: open-webui:config:*"]

    EnvVars --> PersistentCfg
    DBConfig --> PersistentCfg
    PersistentCfg --> AppConfig
    AppConfig --> AppState
    AppConfig --> RedisCache
    RedisCache --> AppConfig
```
**Sources:** [backend/open\_webui/config.py165-284](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/config.py#L165-L284) [backend/open\_webui/main.py646-651](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/main.py#L646-L651)

### PersistentConfig Pattern

Configuration values can be overridden at runtime and persisted to the database:

```
# backend/open_webui/config.py:165-222
class PersistentConfig(Generic[T]):
    def __init__(self, env_name: str, config_path: str, env_value: T):
        self.env_name = env_name
        self.config_path = config_path  # e.g., "auth.jwt_expiry"
        self.env_value = env_value
        self.config_value = get_config_value(config_path)

        # Load from DB if available
        if self.config_value is not None and ENABLE_PERSISTENT_CONFIG:
            self.value = self.config_value
        else:
            self.value = env_value
```
Example usage:

```
JWT_EXPIRES_IN = PersistentConfig(
    "JWT_EXPIRES_IN",
    "auth.jwt_expiry",
    os.environ.get("JWT_EXPIRES_IN", "4w")
)
```
**Sources:** [backend/open\_webui/config.py165-222](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/config.py#L165-L222)

### AppConfig Redis Synchronization

The `AppConfig` class provides automatic Redis synchronization across instances:

```
# backend/open_webui/config.py:224-284
class AppConfig:
    def __setattr__(self, key, value):
        # Save to database
        self._state[key].value = value
        self._state[key].save()

        # Broadcast to other instances via Redis
        if self._redis:
            redis_key = f"{self._redis_key_prefix}:config:{key}"
            self._redis.set(redis_key, json.dumps(value))

    def __getattr__(self, key):
        # Check Redis for updates from other instances
        if self._redis:
            redis_key = f"{self._redis_key_prefix}:config:{key}"
            redis_value = self._redis.get(redis_key)
            if redis_value and self._state[key].value != decoded_value:
                self._state[key].value = decoded_value

        return self._state[key].value
```
**Sources:** [backend/open\_webui/config.py251-284](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/config.py#L251-L284)

### Database Configuration Storage

Configuration is stored in the `config` table:

```
# backend/open_webui/config.py:73-81
class Config(Base):
    __tablename__ = "config"

    id = Column(Integer, primary_key=True)
    data = Column(JSON, nullable=False)  # Nested JSON structure
    version = Column(Integer, nullable=False, default=0)
    created_at = Column(DateTime, nullable=False, server_default=func.now())
    updated_at = Column(DateTime, nullable=True, onupdate=func.now())
```
The `data` column stores a nested JSON structure like:

```
{
  "auth": {
    "jwt_expiry": "4w",
    "enable_api_keys": false
  },
  "oauth": {
    "google": {
      "client_id": "...",
      "client_secret": "..."
    }
  }
}
```
**Sources:** [backend/open\_webui/config.py73-81](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/config.py#L73-L81) [backend/open\_webui/config.py113-156](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/config.py#L113-L156)

---

## Key Configuration Variables by Subsystem

### Database Configuration

| Variable | Default | Description |
| --- | --- | --- |
| `DATABASE_URL` | `sqlite:///${DATA_DIR}/webui.db` | Database connection string |
| `DATA_DIR` | `./data` | Base directory for data storage |

### Redis Configuration

| Variable | Default | Description |
| --- | --- | --- |
| `REDIS_URL` | None | Redis connection URL |
| `REDIS_SENTINEL_HOSTS` | Empty | Sentinel hosts (comma-separated) |
| `REDIS_SENTINEL_PORT` | 26379 | Sentinel port |
| `REDIS_CLUSTER` | False | Enable cluster mode |
| `REDIS_KEY_PREFIX` | `open-webui` | Key namespace prefix |
| `WEBSOCKET_REDIS_URL` | `REDIS_URL` | Redis for WebSocket state |
| `WEBSOCKET_REDIS_LOCK_TIMEOUT` | 10 | Lock timeout in seconds |

### Vector Database Configuration

| Variable | Default | Description |
| --- | --- | --- |
| `VECTOR_DB` | `chroma` | Vector database type |
| `RAG_EMBEDDING_ENGINE` | Empty (local) | Embedding engine |
| `RAG_EMBEDDING_MODEL` | Required for local | Model name |
| `RAG_EMBEDDING_BATCH_SIZE` | 1 | Batch size for embeddings |
| `ENABLE_ASYNC_EMBEDDING` | True | Async embedding generation |

### Storage Configuration

| Variable | Default | Description |
| --- | --- | --- |
| `STORAGE_PROVIDER` | `local` | Storage provider type |
| `UPLOAD_DIR` | `${DATA_DIR}/uploads` | Local storage directory |
| `S3_BUCKET_NAME` | Required for S3 | S3 bucket name |
| `GCS_BUCKET_NAME` | Required for GCS | GCS bucket name |
| `AZURE_STORAGE_CONTAINER_NAME` | Required for Azure | Azure container name |

**Sources:** [backend/open\_webui/env.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/env.py) [backend/open\_webui/config.py1-500](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/config.py#L1-L500)
