# Vector Database Integration

Relevant source files

-   [.github/workflows/integration-test.disabled](https://github.com/open-webui/open-webui/blob/a7271532/.github/workflows/integration-test.disabled)
-   [backend/open\_webui/config.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/config.py)
-   [backend/open\_webui/main.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/main.py)
-   [backend/open\_webui/retrieval/loaders/datalab\_marker.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/retrieval/loaders/datalab_marker.py)
-   [backend/open\_webui/retrieval/loaders/external\_document.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/retrieval/loaders/external_document.py)
-   [backend/open\_webui/retrieval/loaders/external\_web.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/retrieval/loaders/external_web.py)
-   [backend/open\_webui/retrieval/loaders/main.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/retrieval/loaders/main.py)
-   [backend/open\_webui/retrieval/loaders/mineru.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/retrieval/loaders/mineru.py)
-   [backend/open\_webui/retrieval/loaders/mistral.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/retrieval/loaders/mistral.py)
-   [backend/open\_webui/retrieval/utils.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/retrieval/utils.py)
-   [backend/open\_webui/routers/retrieval.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/routers/retrieval.py)
-   [backend/open\_webui/storage/provider.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py)
-   [backend/open\_webui/test/apps/webui/storage/test\_provider.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/test/apps/webui/storage/test_provider.py)
-   [backend/open\_webui/utils/middleware.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/utils/middleware.py)
-   [backend/requirements-min.txt](https://github.com/open-webui/open-webui/blob/a7271532/backend/requirements-min.txt)
-   [backend/requirements.txt](https://github.com/open-webui/open-webui/blob/a7271532/backend/requirements.txt)
-   [docker-compose.playwright.yaml](https://github.com/open-webui/open-webui/blob/a7271532/docker-compose.playwright.yaml)
-   [pyproject.toml](https://github.com/open-webui/open-webui/blob/a7271532/pyproject.toml)
-   [src/lib/apis/retrieval/index.ts](https://github.com/open-webui/open-webui/blob/a7271532/src/lib/apis/retrieval/index.ts)
-   [src/lib/components/admin/Settings/Documents.svelte](https://github.com/open-webui/open-webui/blob/a7271532/src/lib/components/admin/Settings/Documents.svelte)
-   [src/lib/components/admin/Settings/WebSearch.svelte](https://github.com/open-webui/open-webui/blob/a7271532/src/lib/components/admin/Settings/WebSearch.svelte)
-   [uv.lock](https://github.com/open-webui/open-webui/blob/a7271532/uv.lock)

This document describes the vector database abstraction layer in Open WebUI, which provides a unified interface for storing and retrieving document embeddings across multiple vector database backends. This layer enables semantic search and forms the core storage mechanism for the RAG (Retrieval-Augmented Generation) system.

For information about how embeddings are generated before storage, see [Embedding Generation](/open-webui/open-webui/7.4-embedding-generation). For details on retrieval strategies and hybrid search, see [Retrieval Strategies](/open-webui/open-webui/7.6-retrieval-strategies). For an overview of the entire RAG pipeline, see [RAG and Knowledge System](/open-webui/open-webui/7-rag-and-knowledge-system).

---

## Supported Vector Databases

Open WebUI supports multiple vector database backends through a pluggable architecture. The system uses a factory pattern to instantiate the appropriate client based on configuration.

### Available Backends

| Database | Package | Required Configuration | Use Case |
| --- | --- | --- | --- |
| **ChromaDB** | `chromadb==1.3.7` | None (default) | Local development, single-node deployments |
| **Qdrant** | `qdrant-client==1.16.2` | `QDRANT_URL`, `QDRANT_API_KEY` | Production, distributed deployments |
| **Milvus** | `pymilvus==2.6.5` | `MILVUS_URI` | Large-scale production, GPU-accelerated search |
| **Weaviate** | `weaviate-client==4.19.0` | `WEAVIATE_URL`, `WEAVIATE_API_KEY` | Cloud-native deployments |
| **OpenSearch** | `opensearch-py==3.1.0` | `OPENSEARCH_URI` | Enterprise search, AWS deployments |
| **PGVector** | `pgvector==0.4.2`, `psycopg2-binary` | `DATABASE_URL` (PostgreSQL) | PostgreSQL-based deployments |
| **Pinecone** | `pinecone==6.0.2` | `PINECONE_API_KEY` | Serverless vector search |
| **Oracle** | `oracledb==3.4.1` | Oracle connection parameters | Oracle database integration |

**Sources:**

-   [backend/requirements.txt54-56](https://github.com/open-webui/open-webui/blob/a7271532/backend/requirements.txt#L54-L56)
-   [pyproject.toml152-158](https://github.com/open-webui/open-webui/blob/a7271532/pyproject.toml#L152-L158)

---

## Vector Database Client Architecture

The system uses a factory pattern to abstract vector database operations behind a unified `VECTOR_DB_CLIENT` interface. This design allows the application to switch between vector database backends without code changes.

### Factory Pattern Implementation

**Diagram: Vector Database Client Factory Architecture**

The factory is initialized at application startup and provides a singleton client instance used throughout the application.

**Sources:**

-   [backend/open\_webui/config.py22](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/config.py#L22-L22)
-   [backend/open\_webui/retrieval/vector/factory.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/retrieval/vector/factory.py) (referenced)
-   [backend/open\_webui/routers/retrieval.py44](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/routers/retrieval.py#L44-L44)

---

## Client Interface Operations

The `VECTOR_DB_CLIENT` provides a consistent interface regardless of the underlying database backend. All vector database implementations must support these core operations:

### Collection Management

```mermaid
flowchart TD
    Create["create_collection()"]
    Get["get()"]
    Delete["delete_collection()"]
    Has["has_collection()"]
    Insert["insert()"]
    Search["search()"]
    Update["update()"]

    Create --> Insert
    Insert --> Search
    Search --> Get
    Get --> Update
    Update --> Delete
```
**Diagram: Vector Database Operations Flow**

### Key Operations

| Operation | Purpose | Return Type |
| --- | --- | --- |
| `create_collection(collection_name, vectors)` | Initialize new collection with vectors | Collection |
| `has_collection(collection_name)` | Check if collection exists | bool |
| `delete_collection(collection_name)` | Remove collection and all vectors | None |
| `search(collection_name, vectors, limit)` | Perform similarity search | QueryResult |
| `get(collection_name)` | Retrieve all vectors from collection | GetResult |
| `insert(collection_name, vectors, documents, metadatas)` | Add new vectors | None |
| `upsert(collection_name, vectors, documents, metadatas, ids)` | Insert or update vectors | None |

**Sources:**

-   [backend/open\_webui/retrieval/utils.py89-168](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/retrieval/utils.py#L89-L168)
-   [backend/open\_webui/retrieval/vector/main.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/retrieval/vector/main.py) (referenced)

---

## Configuration and Initialization

### Environment Variables

The vector database backend is selected via the `VECTOR_DB` environment variable:

```
# ChromaDB (default)
VECTOR_DB=chroma

# Qdrant
VECTOR_DB=qdrant
QDRANT_URL=http://localhost:6333
QDRANT_API_KEY=your-api-key

# Milvus
VECTOR_DB=milvus
MILVUS_URI=http://localhost:19530

# PGVector (requires PostgreSQL with pgvector extension)
VECTOR_DB=pgvector
DATABASE_URL=postgresql://user:pass@localhost/dbname
```
### Application Startup Initialization

The vector database client is initialized during application startup in the lifespan context:

> **[Mermaid sequence]**
> *(图表结构无法解析)*

**Diagram: Vector Database Initialization Sequence**

**Sources:**

-   [backend/open\_webui/main.py570-632](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/main.py#L570-L632)
-   [backend/open\_webui/config.py1-40](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/config.py#L1-L40)

---

## Query Operations

### Standard Vector Search

The standard vector search performs cosine similarity search using embeddings:

```mermaid
flowchart TD
    Query["User Query Text"]
    CollectionName["Collection Name"]
    EmbedFunc["EMBEDDING_FUNCTION"]
    QueryEmbed["Query Embedding Vector"]
    VectorDB["VECTOR_DB_CLIENT.search()"]
    Result["QueryResult{ids, metadatas, documents, distances}"]
    TopK["Top K Results"]
    Threshold["Relevance Threshold Filter"]
    Sorted["Sort by Distance"]

    Query --> EmbedFunc
    EmbedFunc --> QueryEmbed
    QueryEmbed --> VectorDB
    CollectionName --> VectorDB
    VectorDB --> Result
    Result --> TopK
    TopK --> Threshold
    Threshold --> Sorted
```
**Diagram: Standard Vector Search Flow**

The `query_doc()` function in `retrieval/utils.py` implements standard vector search:

```
def query_doc(
    collection_name: str,
    query_embedding: list[float],
    k: int,
    user: UserModel = None
):
    result = VECTOR_DB_CLIENT.search(
        collection_name=collection_name,
        vectors=[query_embedding],
        limit=k,
    )
    return result
```
**Sources:**

-   [backend/open\_webui/retrieval/utils.py136-154](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/retrieval/utils.py#L136-L154)
-   [backend/open\_webui/config.py836-840](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/config.py#L836-L840)

### Collection Retrieval

Full collection retrieval is used for hybrid search and reranking:

```
def get_doc(collection_name: str, user: UserModel = None):
    result = VECTOR_DB_CLIENT.get(collection_name=collection_name)
    return result
```
**Sources:**

-   [backend/open\_webui/retrieval/utils.py156-168](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/retrieval/utils.py#L156-L168)

---

## Integration with RAG Pipeline

The vector database integrates with multiple components in the RAG system:

```mermaid
flowchart TD
    Upload["File Upload"]
    Extract["Content ExtractionSee 7.2"]
    Split["Text SplittingSee 7.3"]
    Embed["Embedding GenerationSee 7.4"]
    VectorDB["VECTOR_DB_CLIENT"]
    Collections["Collections(one per file/knowledge)"]
    UserQuery["User Query"]
    QueryEmbed["Query EmbeddingEMBEDDING_FUNCTION"]
    Search["Vector Search orHybrid Search"]
    Rerank["Optional RerankingSee 7.6"]
    Context["Retrieved Context"]
    LLM["LLM with Context"]
    Response["Generated Response"]

    Upload --> Extract
    Extract --> Split
    Split --> Embed
    Embed --> VectorDB
    VectorDB --> Collections
    UserQuery --> QueryEmbed
    QueryEmbed --> Search
    Collections --> Search
    Search --> Rerank
    Rerank --> Context
    Context --> LLM
    LLM --> Response
```
**Diagram: Vector Database in RAG Pipeline**

### File and Knowledge Collection Management

Each uploaded file or knowledge item creates its own collection in the vector database:

-   **File collections**: Named using file metadata hash
-   **Knowledge collections**: Named using knowledge base ID
-   **Collection metadata**: Stored with each vector including source file, chunk position, timestamps

**Sources:**

-   [backend/open\_webui/routers/retrieval.py1-118](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/routers/retrieval.py#L1-L118)
-   [backend/open\_webui/retrieval/utils.py386-401](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/retrieval/utils.py#L386-L401)

---

## Query Results and Data Structures

### GetResult Structure

Full collection retrieval returns a `GetResult` object:

```
GetResult:
    ids: [[str, ...]]          # Document IDs
    documents: [[str, ...]]    # Text content
    metadatas: [[dict, ...]]   # Metadata for each chunk
```
### QueryResult Structure

Search operations return a `QueryResult` object:

```
QueryResult:
    ids: [[str, ...]]          # Document IDs
    documents: [[str, ...]]    # Text content
    metadatas: [[dict, ...]]   # Metadata
    distances: [[float, ...]]  # Similarity scores (higher = more similar)
```
### Metadata Fields

Standard metadata stored with each vector:

| Field | Type | Description |
| --- | --- | --- |
| `name` | string | Source filename |
| `title` | string | Document title (if available) |
| `source` | string | File path or URL |
| `headings` | list | Section headings (from markdown splitter) |
| `snippet` | string | Search result snippet |
| `created_at` | timestamp | Document creation time |
| `file_id` | string | Reference to Files table |

**Sources:**

-   [backend/open\_webui/retrieval/utils.py170-206](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/retrieval/utils.py#L170-L206)
-   [backend/open\_webui/retrieval/vector/main.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/retrieval/vector/main.py) (referenced)

---

## Multi-Collection Query Operations

The system supports querying multiple collections simultaneously for comprehensive knowledge retrieval:

```mermaid
flowchart TD
    Query["User Query"]
    Collections["List of Collection Names"]
    C1["Query Collection 1"]
    C2["Query Collection 2"]
    CN["Query Collection N"]
    Dedupe["Deduplicate by Document Hash"]
    Merge["Merge Results"]
    Sort["Sort by Distance"]
    TopK["Take Top K"]

    Query --> C1
    Query --> C2
    Query --> CN
    Collections --> C1
    Collections --> C2
    Collections --> CN
    C1 --> Dedupe
    C2 --> Dedupe
    CN --> Dedupe
    Dedupe --> Merge
    Merge --> Sort
    Sort --> TopK
```
**Diagram: Multi-Collection Query Process**

The `merge_and_sort_query_results()` function combines results from multiple collections:

-   Deduplicates documents using SHA-256 content hashing
-   Keeps the best (highest) distance score for duplicates
-   Sorts by relevance and returns top K results

**Sources:**

-   [backend/open\_webui/retrieval/utils.py339-384](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/retrieval/utils.py#L339-L384)
-   [backend/open\_webui/retrieval/utils.py318-337](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/retrieval/utils.py#L318-L337)

---

## Configuration Management via Admin API

The vector database configuration can be queried and updated through admin API endpoints:

### GET `/api/v1/retrieval/config`

Returns current RAG and vector database configuration including:

-   `ENABLE_RAG_HYBRID_SEARCH`: Hybrid search enabled
-   `TOP_K`: Number of results to retrieve
-   `TOP_K_RERANKER`: Number of results after reranking
-   `RELEVANCE_THRESHOLD`: Minimum similarity threshold
-   `HYBRID_BM25_WEIGHT`: Weight for BM25 in hybrid search

### POST `/api/v1/retrieval/config/update`

Updates RAG configuration. Changes are persisted to the database and applied immediately.

### POST `/api/v1/retrieval/reset`

Deletes all collections from the vector database. This is a destructive operation requiring admin privileges.

**Sources:**

-   [backend/open\_webui/routers/retrieval.py443-532](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/routers/retrieval.py#L443-L532)
-   [backend/open\_webui/config.py224-284](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/config.py#L224-L284)

---

## Collection Metadata and Access Control

Collections are associated with files and knowledge bases through metadata:

```mermaid
flowchart TD
    Files["files table"]
    Knowledge["knowledge table"]
    Collections["Collections"]
    Vectors["Vector Embeddings"]
    Meta["Chunk Metadata"]
    Users["users table"]
    Groups["groups table"]
    Access["has_access()"]

    Files --> Collections
    Knowledge --> Collections
    Collections --> Vectors
    Collections --> Meta
    Users --> Access
    Groups --> Access
    Access --> Collections
```
**Diagram: Collection Metadata and Access Control**

Access control is enforced at query time using the `has_access()` utility function, which checks:

-   User ownership of files/knowledge
-   Group membership permissions
-   Admin bypass flags

**Sources:**

-   [backend/open\_webui/retrieval/utils.py26-36](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/retrieval/utils.py#L26-L36)
-   [backend/open\_webui/utils/access\_control.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/utils/access_control.py) (referenced)

---

## Testing and Validation

The vector database providers are tested through a comprehensive test suite that validates:

### Test Coverage

| Test | Purpose | File |
| --- | --- | --- |
| Provider Instantiation | Verify factory pattern | `test_provider.py` |
| Upload Operations | Test vector insertion | Storage provider tests |
| Retrieval Operations | Test search accuracy | Integration tests |
| Collection Management | Test CRUD operations | Unit tests |

The test suite uses mocking for external dependencies and supports both local and cloud-based vector databases.

**Sources:**

-   [backend/open\_webui/test/apps/webui/storage/test\_provider.py1-308](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/test/apps/webui/storage/test_provider.py#L1-L308)
-   [.github/workflows/integration-test.disabled1-174](https://github.com/open-webui/open-webui/blob/a7271532/.github/workflows/integration-test.disabled#L1-L174)

---

## Performance Considerations

### Connection Pooling

Each vector database client manages its own connection pool:

-   ChromaDB: Persistent local client
-   Qdrant: HTTP client with connection reuse
-   Milvus: gRPC connection pool
-   Weaviate: REST API with session management

### Batch Operations

Large document collections are processed in batches to avoid memory issues:

-   Embedding batch size: Configurable via `RAG_EMBEDDING_BATCH_SIZE`
-   Insert batch size: Database-specific limits
-   Query limits: Enforced by `TOP_K` configuration

### Caching Strategy

The system uses Redis for caching at multiple levels:

-   Configuration cache (AppConfig)
-   Query results cache (optional)
-   Embedding cache (for repeated queries)

**Sources:**

-   [backend/open\_webui/config.py224-284](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/config.py#L224-L284)
-   [backend/open\_webui/routers/retrieval.py256-261](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/routers/retrieval.py#L256-L261)
-   [backend/open\_webui/main.py586-656](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/main.py#L586-L656)
