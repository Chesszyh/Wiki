# Testing Infrastructure

Relevant source files

-   [.github/workflows/integration-test.disabled](https://github.com/open-webui/open-webui/blob/a7271532/.github/workflows/integration-test.disabled)
-   [backend/open\_webui/storage/provider.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py)
-   [backend/open\_webui/test/apps/webui/storage/test\_provider.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/test/apps/webui/storage/test_provider.py)
-   [backend/requirements-min.txt](https://github.com/open-webui/open-webui/blob/a7271532/backend/requirements-min.txt)
-   [backend/requirements.txt](https://github.com/open-webui/open-webui/blob/a7271532/backend/requirements.txt)
-   [docker-compose.playwright.yaml](https://github.com/open-webui/open-webui/blob/a7271532/docker-compose.playwright.yaml)
-   [pyproject.toml](https://github.com/open-webui/open-webui/blob/a7271532/pyproject.toml)
-   [uv.lock](https://github.com/open-webui/open-webui/blob/a7271532/uv.lock)

This document describes the testing infrastructure for Open WebUI, including unit tests, integration tests, and testing frameworks. It covers test organization, execution strategies, and mocking approaches used throughout the codebase.

For information about development environment setup, see [Development Environment Setup](/open-webui/open-webui/18.1-development-environment-setup). For build system configuration, see [Build System](/open-webui/open-webui/18.3-build-system).

---

## Testing Framework Overview

Open WebUI uses **pytest** as the primary testing framework for Python backend code. The testing infrastructure includes unit tests for critical components, integration tests for database migrations, and web loading capabilities via Playwright. The test suite supports multiple database backends (SQLite, PostgreSQL) and cloud storage providers (S3, GCS, Azure Blob Storage).

```mermaid
flowchart TD
    pytest["pytest"]
    pytest_docker["pytest-docker"]
    pytest_asyncio["pytest-asyncio"]
    moto["moto[s3]"]
    gcs_emulator["gcp-storage-emulator"]
    docker_lib["docker~=7.1.0"]
    playwright["playwright==1.57.0"]
    unit["Unit Tests"]
    storage["Storage Provider Tests"]
    migration["Migration Tests"]
    web_loading["Web Loading Tests"]
    local_storage["LocalStorageProvider"]
    s3["S3StorageProvider"]
    gcs["GCSStorageProvider"]
    azure["AzureStorageProvider"]
    sqlite_db["SQLite Database"]
    postgres_db["PostgreSQL Database"]
    server_startup["Server Startup"]

    pytest --> unit
    pytest --> storage
    pytest --> migration
    pytest --> docker_migration
    pytest --> asyncio_unit
    moto --> storage
    gcs --> emulator_storage
    docker --> lib_migration
    playwright --> web_loading
    storage --> local_storage
    storage --> s3
    storage --> gcs
    storage --> azure
    migration --> sqlite_db
    migration --> postgres_db
    migration --> server_startup
```
**Sources:**

-   [backend/requirements.txt133-136](https://github.com/open-webui/open-webui/blob/a7271532/backend/requirements.txt#L133-L136)
-   [pyproject.toml134-162](https://github.com/open-webui/open-webui/blob/a7271532/pyproject.toml#L134-L162)
-   [pyproject.toml206-210](https://github.com/open-webui/open-webui/blob/a7271532/pyproject.toml#L206-L210)

---

## Testing Dependencies

### Core Testing Packages

Open WebUI's testing infrastructure is defined in both `requirements.txt` and `pyproject.toml`. The core testing packages include:

| Package | Version | Purpose |
| --- | --- | --- |
| `pytest` | ~=8.4.1 | Primary testing framework |
| `pytest-docker` | ~=3.2.5 | Docker container orchestration for tests |
| `pytest-asyncio` | \>=1.0.0 | Async test support |
| `docker` | ~=7.1.0 | Docker Python client for containerized tests |
| `playwright` | \==1.57.0 | Browser automation for web content loading |

**Sources:**

-   [backend/requirements.txt133-136](https://github.com/open-webui/open-webui/blob/a7271532/backend/requirements.txt#L133-L136)
-   [pyproject.toml206-210](https://github.com/open-webui/open-webui/blob/a7271532/pyproject.toml#L206-L210)

### Testing Support Libraries

Additional libraries support specific testing scenarios:

| Package | Purpose |
| --- | --- |
| `moto[s3]` | AWS S3 service mocking (>=5.0.26) |
| `gcp-storage-emulator` | Google Cloud Storage emulation (>=2024.8.3) |
| `unittest.mock.MagicMock` | Azure service mocking (stdlib) |

**Sources:**

-   [pyproject.toml144-145](https://github.com/open-webui/open-webui/blob/a7271532/pyproject.toml#L144-L145)
-   [backend/open\_webui/test/apps/webui/storage/test\_provider.py11](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/test/apps/webui/storage/test_provider.py#L11-L11)

---

## Storage Provider Tests

The storage provider test suite validates all four storage backends: local filesystem, AWS S3, Google Cloud Storage, and Azure Blob Storage. Tests are located in `backend/open_webui/test/apps/webui/storage/test_provider.py`.

### Test Structure

```mermaid
flowchart TD
    test_file["test_provider.py"]
    TestLocal["TestLocalStorageProvider"]
    TestS3["TestS3StorageProvider"]
    TestGCS["TestGCSStorageProvider"]
    TestAzure["TestAzureStorageProvider"]
    upload["test_upload_file()"]
    get["test_get_file()"]
    delete["test_delete_file()"]
    delete_all["test_delete_all_files()"]
    mock_aws["@mock_aws decorator"]
    gcs_server["create_server()"]
    azure_mock["MagicMock"]

    test --> file_TestLocal
    test --> file_TestS3
    test --> file_TestGCS
    test --> file_TestAzure
    TestLocal --> upload
    TestLocal --> get
    TestLocal --> delete
    TestLocal --> delete_all
    TestS3 --> upload
    TestS3 --> get
    TestS3 --> delete
    TestS3 --> delete_all
    TestGCS --> upload
    TestGCS --> get
    TestGCS --> delete
    TestGCS --> delete_all
    TestAzure --> upload
    TestAzure --> get
    TestAzure --> delete
    TestAzure --> delete_all
    TestS3 --> mock_aws
    TestGCS --> gcs_server
    TestAzure --> azure_mock
```
**Sources:**

-   [backend/open\_webui/test/apps/webui/storage/test\_provider.py1-436](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/test/apps/webui/storage/test_provider.py#L1-L436)

### Test Fixtures and Helpers

The test suite uses a common fixture for directory mocking:

```
def mock_upload_dir(monkeypatch, tmp_path):
    """Fixture to monkey-patch the UPLOAD_DIR and create a temporary directory."""
    directory = tmp_path / "uploads"
    directory.mkdir()
    monkeypatch.setattr(provider, "UPLOAD_DIR", str(directory))
    return directory
```
This fixture:

-   Creates a temporary upload directory for each test
-   Monkey-patches `provider.UPLOAD_DIR` to use the temporary location
-   Ensures test isolation by using pytest's `tmp_path` fixture

**Sources:**

-   [backend/open\_webui/test/apps/webui/storage/test\_provider.py14-19](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/test/apps/webui/storage/test_provider.py#L14-L19)

### LocalStorageProvider Tests

The `TestLocalStorageProvider` class validates basic file operations without external dependencies:

| Test Method | Validates |
| --- | --- |
| `test_upload_file()` | File upload, content verification, empty file rejection |
| `test_get_file()` | File path retrieval |
| `test_delete_file()` | Single file deletion |
| `test_delete_all_files()` | Bulk file deletion |

**Key test pattern:**

```
def test_upload_file(self, monkeypatch, tmp_path):
    upload_dir = mock_upload_dir(monkeypatch, tmp_path)
    contents, file_path = self.Storage.upload_file(self.file_bytesio, self.filename)
    assert (upload_dir / self.filename).exists()
    assert (upload_dir / self.filename).read_bytes() == self.file_content
```
**Sources:**

-   [backend/open\_webui/test/apps/webui/storage/test\_provider.py59-98](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/test/apps/webui/storage/test_provider.py#L59-L98)

### S3StorageProvider Tests

The `TestS3StorageProvider` uses the `@mock_aws` decorator from the `moto` library to simulate AWS S3 without real cloud resources:

```
@mock_aws
class TestS3StorageProvider:
    def __init__(self):
        self.Storage = provider.S3StorageProvider()
        self.Storage.bucket_name = "my-bucket"
        self.s3_client = boto3.resource("s3", region_name="us-east-1")
```
**Test workflow:**

1.  `@mock_aws` intercepts all boto3 S3 calls
2.  Test creates mock bucket: `self.s3_client.create_bucket(Bucket=self.Storage.bucket_name)`
3.  Operations validated against mocked S3 service
4.  Local and S3 storage verified in parallel

**S3-specific validations:**

-   Verifies files stored in both local staging and S3
-   Tests bucket existence checking
-   Validates S3 key formatting with prefix support
-   Tests credential-less initialization (workload identity)

**Sources:**

-   [backend/open\_webui/test/apps/webui/storage/test\_provider.py100-200](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/test/apps/webui/storage/test_provider.py#L100-L200)

### GCSStorageProvider Tests

The `TestGCSStorageProvider` uses `gcp-storage-emulator` to create an in-memory GCS server:

```
@pytest.fixture(scope="class")
def setup(self):
    host, port = "localhost", 9023
    server = create_server(host, port, in_memory=True)
    server.start()
    os.environ["STORAGE_EMULATOR_HOST"] = f"http://{host}:{port}"

    gcs_client = storage.Client()
    bucket = gcs_client.bucket(self.Storage.bucket_name)
    bucket.create()
    self.Storage.gcs_client, self.Storage.bucket = gcs_client, bucket
    yield
    bucket.delete(force=True)
    server.stop()
```
**Test characteristics:**

-   Class-scoped fixture starts/stops emulator once per test class
-   Uses `STORAGE_EMULATOR_HOST` environment variable for redirection
-   Tests bucket lifecycle (create, use, delete with `force=True`)
-   Validates blob operations (upload, download, delete)

**Sources:**

-   [backend/open\_webui/test/apps/webui/storage/test\_provider.py202-292](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/test/apps/webui/storage/test_provider.py#L202-L292)

### AzureStorageProvider Tests

The `TestAzureStorageProvider` uses `unittest.mock.MagicMock` to mock Azure SDK clients:

```
@pytest.fixture(scope="class")
def setup_storage(self, monkeypatch):
    mock_blob_service_client = MagicMock()
    mock_container_client = MagicMock()
    mock_blob_client = MagicMock()

    mock_blob_service_client.get_container_client.return_value = mock_container_client
    mock_container_client.get_blob_client.return_value = mock_blob_client

    monkeypatch.setattr(
        azure.storage.blob,
        "BlobServiceClient",
        lambda *args, **kwargs: mock_blob_service_client
    )
```
**Mocking strategy:**

-   All Azure SDK clients replaced with `MagicMock` instances
-   Method return values configured via `.return_value` attributes
-   Side effects simulated via `.side_effect` for error testing
-   Call assertions validate API usage: `assert_called_with()`, `assert_called_once()`

**Sources:**

-   [backend/open\_webui/test/apps/webui/storage/test\_provider.py294-436](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/test/apps/webui/storage/test_provider.py#L294-L436)

---

## Provider Factory Tests

Basic instantiation and factory pattern tests ensure correct provider selection:

```
def test_get_storage_provider():
    Storage = provider.get_storage_provider("local")
    assert isinstance(Storage, provider.LocalStorageProvider)
    Storage = provider.get_storage_provider("s3")
    assert isinstance(Storage, provider.S3StorageProvider)
    Storage = provider.get_storage_provider("gcs")
    assert isinstance(Storage, provider.GCSStorageProvider)
    Storage = provider.get_storage_provider("azure")
    assert isinstance(Storage, provider.AzureStorageProvider)
    with pytest.raises(RuntimeError):
        provider.get_storage_provider("invalid")
```
This validates:

-   `get_storage_provider()` factory function
-   Correct provider class instantiation based on string identifier
-   Exception handling for invalid provider names

**Sources:**

-   [backend/open\_webui/test/apps/webui/storage/test\_provider.py31-42](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/test/apps/webui/storage/test_provider.py#L31-L42)

---

## Integration Tests (Disabled)

The repository contains a disabled GitHub Actions workflow for integration testing at `.github/workflows/integration-test.disabled`. This workflow previously included:

### Cypress End-to-End Tests

The workflow configured a full Docker Compose stack for browser-based testing:

```mermaid
flowchart TD
    checkout["Checkout Repository"]
    build["Build Docker Compose Stack"]
    wait["Wait for Ollama"]
    preload["Preload Modelqwen:0.5b-chat-v1.5-q2_K"]
    cypress["Run Cypress Tests"]
    upload["Upload Artifacts"]

    checkout --> build
    build --> wait
    wait --> preload
    preload --> cypress
    cypress --> upload
```
**Stack components:**

-   `docker-compose.yaml`: Base Open WebUI service
-   `docker-compose.api.yaml`: API configuration
-   `docker-compose.a1111-test.yaml`: Stable Diffusion integration testing

**Test execution:**

```
- name: Cypress run
  uses: cypress-io/github-action@v6
  env:
    LIBGL_ALWAYS_SOFTWARE: 1
  with:
    browser: chrome
    wait-on: 'http://localhost:3000'
    config: baseUrl=http://localhost:3000
```
**Sources:**

-   [.github/workflows/integration-test.disabled14-82](https://github.com/open-webui/open-webui/blob/a7271532/.github/workflows/integration-test.disabled#L14-L82)

### Migration Tests

The migration test job validates database migrations and server startup with multiple backends:

```mermaid
flowchart TD
    postgres["PostgreSQL ServicePort 5432"]
    install["Install Dependenciesuv pip install"]
    sqlite["Test SQLite Backend"]
    pg["Test PostgreSQL Backend"]
    reconnect["Test DB Reconnection"]
    startup["Server Startup Check"]
    health["Health Endpoint Check/api/config"]
    running["Process Running Check"]
    db_health["DB Health Check/health/db"]
    terminate["Terminate Connections"]
    recheck["Recheck DB Health"]

    postgres --> pg
    install --> sqlite
    sqlite --> pg
    sqlite --> startup
    sqlite --> health
    sqlite --> running
    pg --> startup
    pg --> health
    pg --> running
    pg --> reconnect
    reconnect --> db_health
    reconnect --> terminate
    reconnect --> recheck
```
**SQLite test sequence:**

```
uvicorn open_webui.main:app --port "8080" --forwarded-allow-ips '*' &
UVICORN_PID=$!
# Wait up to 40 seconds for server start
for i in {1..40}; do
    curl -s http://localhost:8080/api/config > /dev/null && break
    sleep 1
done
# Check server still running after 5 seconds
sleep 5
if ! kill -0 $UVICORN_PID; then
    echo "Server has stopped"
    exit 1
fi
```
**PostgreSQL reconnection test:**

```
# Terminate all PostgreSQL connections
python -c "import os, psycopg2 as pg2; \
  conn = pg2.connect(dsn=os.environ['DATABASE_URL'].replace('+pool', '')); \
  cur = conn.cursor(); \
  cur.execute('SELECT pg_terminate_backend(psa.pid) FROM pg_stat_activity psa WHERE datname = current_database() AND pid <> pg_backend_pid();')"

# Verify server reconnects
status_code=$(curl --write-out %{http_code} -s --output /dev/null http://localhost:8081/health/db)
if [[ "$status_code" -ne 200 ]] ; then
  echo "Server has not reconnected to postgres"
  exit 1
fi
```
**Test environment variables:**

-   `WEBUI_SECRET_KEY=secret-key`
-   `GLOBAL_LOG_LEVEL=debug`
-   `DATABASE_URL=postgresql://postgres:postgres@localhost:5432/postgres`
-   `DATABASE_POOL_SIZE=10`
-   `DATABASE_POOL_MAX_OVERFLOW=10`
-   `DATABASE_POOL_TIMEOUT=30`

**Sources:**

-   [.github/workflows/integration-test.disabled105-229](https://github.com/open-webui/open-webui/blob/a7271532/.github/workflows/integration-test.disabled#L105-L229)

---

## Playwright Web Loading Tests

Open WebUI supports Playwright for advanced web content extraction, configured via Docker Compose:

### Playwright Service Configuration

```
services:
  playwright:
    image: mcr.microsoft.com/playwright:v1.57.0-noble
    container_name: playwright
    command: npx -y playwright@1.57.0 run-server --port 3000 --host 0.0.0.0

  open-webui:
    environment:
      - 'WEB_LOADER_ENGINE=playwright'
      - 'PLAYWRIGHT_WS_URL=ws://playwright:3000'
```
**Key configuration:**

-   Playwright version **must match** `requirements.txt`: `playwright==1.57.0`
-   Runs as WebSocket server on port 3000
-   Open WebUI connects via `PLAYWRIGHT_WS_URL` environment variable
-   Enables `WEB_LOADER_ENGINE=playwright` for web search content loading

**Sources:**

-   [docker-compose.playwright.yaml1-11](https://github.com/open-webui/open-webui/blob/a7271532/docker-compose.playwright.yaml#L1-L11)
-   [backend/requirements.txt123](https://github.com/open-webui/open-webui/blob/a7271532/backend/requirements.txt#L123-L123)

### Playwright Integration

The Playwright container provides:

-   Headless browser automation
-   JavaScript execution for dynamic content
-   Screenshot capture capabilities
-   Cookie and session management
-   Network request interception

This supports the web search integration system (see [Web Search Integration](/open-webui/open-webui/6.5-web-search-integration)) by enabling full page rendering and JavaScript evaluation for content extraction.

**Sources:**

-   [docker-compose.playwright.yaml1-11](https://github.com/open-webui/open-webui/blob/a7271532/docker-compose.playwright.yaml#L1-L11)

---

## Test Execution

### Running Storage Provider Tests

Execute storage provider tests with pytest:

```
# Run all storage tests
pytest backend/open_webui/test/apps/webui/storage/test_provider.py

# Run specific test class
pytest backend/open_webui/test/apps/webui/storage/test_provider.py::TestS3StorageProvider

# Run specific test method
pytest backend/open_webui/test/apps/webui/storage/test_provider.py::TestS3StorageProvider::test_upload_file

# Run with verbose output
pytest -v backend/open_webui/test/apps/webui/storage/test_provider.py

# Run with debug logging
pytest -o log_cli=true -o log_cli_level=INFO backend/open_webui/test/apps/webui/storage/test_provider.py
```
**Sources:**

-   [backend/open\_webui/test/apps/webui/storage/test\_provider.py1](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/test/apps/webui/storage/test_provider.py#L1-L1)

### Installing Test Dependencies

Install testing dependencies using pip or uv:

```
# Install all dependencies including test packages
pip install -r backend/requirements.txt

# Or using uv for faster installation
uv pip install -r backend/requirements.txt

# Install optional dependencies for all storage providers
pip install -e ".[all]"
```
**Sources:**

-   [backend/requirements.txt133-136](https://github.com/open-webui/open-webui/blob/a7271532/backend/requirements.txt#L133-L136)
-   [pyproject.toml140-162](https://github.com/open-webui/open-webui/blob/a7271532/pyproject.toml#L140-L162)

---

## Test Organization

```mermaid
flowchart TD
    root["backend/"]
    test_dir["open_webui/test/"]
    apps["apps/"]
    webui["webui/"]
    storage["storage/"]
    test_file["test_provider.py"]
    src_storage["open_webui/storage/"]
    provider_src["provider.py"]

    root --> test_dir
    root --> src_storage
    test --> dir_apps
    apps --> webui
    webui --> storage
    storage --> test_file
    src --> storage_provider_src
    test --> file_provider_src
```
**Directory structure:**

-   Tests located in `backend/open_webui/test/` directory
-   Mirrors source code structure: `test/apps/webui/storage/` tests `storage/provider.py`
-   Test files follow `test_*.py` naming convention
-   One test file per module, with multiple test classes per file

**Sources:**

-   [backend/open\_webui/test/apps/webui/storage/test\_provider.py1](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/test/apps/webui/storage/test_provider.py#L1-L1)
-   [backend/open\_webui/storage/provider.py1](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L1-L1)

---

## Testing Best Practices

Based on the existing test suite, Open WebUI follows these testing patterns:

1.  **Isolation**: Use fixtures (`tmp_path`, `monkeypatch`) to isolate tests
2.  **Mocking**: Mock external services (AWS, GCS, Azure) to avoid real cloud resources
3.  **Cleanup**: Properly teardown resources in fixtures (GCS server, temporary directories)
4.  **Assertions**: Validate both successful operations and error conditions
5.  **Realism**: Test with realistic data (binary file content, multiple file operations)

**Common test patterns:**

| Pattern | Implementation |
| --- | --- |
| Directory isolation | `tmp_path` fixture with `monkeypatch` |
| Service mocking | `@mock_aws`, `gcp-storage-emulator`, `MagicMock` |
| Error testing | `pytest.raises()` for exception validation |
| Cleanup | Fixture `yield` with teardown logic |
| Parallel validation | Check both local and cloud storage states |

**Sources:**

-   [backend/open\_webui/test/apps/webui/storage/test\_provider.py14-19](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/test/apps/webui/storage/test_provider.py#L14-L19)
-   [backend/open\_webui/test/apps/webui/storage/test\_provider.py100-111](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/test/apps/webui/storage/test_provider.py#L100-L111)
-   [backend/open\_webui/test/apps/webui/storage/test\_provider.py210-225](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/test/apps/webui/storage/test_provider.py#L210-L225)
-   [backend/open\_webui/test/apps/webui/storage/test\_provider.py298-325](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/test/apps/webui/storage/test_provider.py#L298-L325)
