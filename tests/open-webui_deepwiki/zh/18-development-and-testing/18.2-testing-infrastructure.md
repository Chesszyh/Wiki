# 测试基础设施 (Testing Infrastructure)

相关源文件

-   [.github/workflows/integration-test.disabled](https://github.com/open-webui/open-webui/blob/a7271532/.github/workflows/integration-test.disabled)
-   [backend/open_webui/storage/provider.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py)
-   [backend/open_webui/test/apps/webui/storage/test_provider.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/test/apps/webui/storage/test_provider.py)
-   [backend/requirements-min.txt](https://github.com/open-webui/open-webui/blob/a7271532/backend/requirements-min.txt)
-   [backend/requirements.txt](https://github.com/open-webui/open-webui/blob/a7271532/backend/requirements.txt)
-   [docker-compose.playwright.yaml](https://github.com/open-webui/open-webui/blob/a7271532/docker-compose.playwright.yaml)
-   [pyproject.toml](https://github.com/open-webui/open-webui/blob/a7271532/pyproject.toml)
-   [uv.lock](https://github.com/open-webui/open-webui/blob/a7271532/uv.lock)

本文档描述了 Open WebUI 的测试基础设施，包括单元测试、集成测试以及测试框架。它涵盖了测试组织结构、执行策略以及在整个代码库中使用的模拟 (mocking) 方法。

有关开发环境设置的信息，请参阅 [开发环境设置](/open-webui/open-webui/18.1-development-environment-setup)。有关构建系统配置，请参阅 [构建系统](/open-webui/open-webui/18.3-build-system)。

---

## 测试框架概览

Open WebUI 使用 **pytest** 作为 Python 后端代码的主要测试框架。测试基础设施包含了针对关键组件的单元测试、针对数据库迁移的集成测试，以及通过 Playwright 实现的网页加载能力。测试套件支持多种数据库后端（SQLite, PostgreSQL）和云存储提供商（S3, GCS, Azure Blob Storage）。

```mermaid
flowchart TD
    pytest["pytest"]
    pytest_docker["pytest-docker"]
    pytest_asyncio["pytest-asyncio"]
    moto["moto[s3]"]
    gcs_emulator["gcp-storage-emulator"]
    docker_lib["docker~=7.1.0"]
    playwright["playwright==1.57.0"]
    unit["单元测试"]
    storage["存储提供商测试"]
    migration["迁移测试"]
    web_loading["网页加载测试"]
    local_storage["LocalStorageProvider"]
    s3["S3StorageProvider"]
    gcs["GCSStorageProvider"]
    azure["AzureStorageProvider"]
    sqlite_db["SQLite 数据库"]
    postgres_db["PostgreSQL 数据库"]
    server_startup["服务器启动"]

    pytest --> unit
    pytest --> storage
    pytest --> migration
    pytest --> pytest_docker
    pytest --> pytest_asyncio
    moto --> storage
    gcs_emulator --> storage
    docker_lib --> migration
    playwright --> web_loading
    storage --> local_storage
    storage --> s3
    storage --> gcs
    storage --> azure
    migration --> sqlite_db
    migration --> postgres_db
    migration --> server_startup
```
**来源：**

-   [backend/requirements.txt133-136](https://github.com/open-webui/open-webui/blob/a7271532/backend/requirements.txt#L133-L136)
-   [pyproject.toml134-162](https://github.com/open-webui/open-webui/blob/a7271532/pyproject.toml#L134-L162)
-   [pyproject.toml206-210](https://github.com/open-webui/open-webui/blob/a7271532/pyproject.toml#L206-L210)

---

## 测试依赖项

### 核心测试包

Open WebUI 的测试基础设施定义在 `requirements.txt` 和 `pyproject.toml` 中。核心测试包包括：

| 包名 | 版本 | 用途 |
| --- | --- | --- |
| `pytest` | ~=8.4.1 | 主要测试框架 |
| `pytest-docker` | ~=3.2.5 | 针对测试的 Docker 容器编排 |
| `pytest-asyncio` | >=1.0.0 | 异步测试支持 |
| `docker` | ~=7.1.0 | 针对容器化测试的 Docker Python 客户端 |
| `playwright` | ==1.57.0 | 用于网页内容加载的浏览器自动化 |

**来源：**

-   [backend/requirements.txt133-136](https://github.com/open-webui/open-webui/blob/a7271532/backend/requirements.txt#L133-L136)
-   [pyproject.toml206-210](https://github.com/open-webui/open-webui/blob/a7271532/pyproject.toml#L206-L210)

### 测试支持库

其它支持特定测试场景的库：

| 包名 | 用途 |
| --- | --- |
| `moto[s3]` | AWS S3 服务模拟 (>=5.0.26) |
| `gcp-storage-emulator` | Google Cloud Storage 仿真 (>=2024.8.3) |
| `unittest.mock.MagicMock` | Azure 服务模拟 (标准库) |

**来源：**

-   [pyproject.toml144-145](https://github.com/open-webui/open-webui/blob/a7271532/pyproject.toml#L144-L145)
-   [backend/open_webui/test/apps/webui/storage/test_provider.py11](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/test/apps/webui/storage/test_provider.py#L11-L11)

---

## 存储提供商测试

存储提供商测试套件验证了所有四个存储后端：本地文件系统、AWS S3、Google Cloud Storage 和 Azure Blob Storage。测试文件位于 `backend/open_webui/test/apps/webui/storage/test_provider.py`。

### 测试结构

```mermaid
flowchart TD
    test_file["test_provider.py"]
    TestLocal["TestLocalStorageProvider"]
    TestS3["TestS3StorageProvider"]
    TestGCS["TestGCSStorageProvider"]
    TestAzure["TestAzureStorageProvider"]
    upload["test_upload_file()"]
    get["test_get_file()"]
    delete["test_delete_file()"]
    delete_all["test_delete_all_files()"]
    mock_aws["@mock_aws 装饰器"]
    gcs_server["create_server()"]
    azure_mock["MagicMock"]

    test_file --> TestLocal
    test_file --> TestS3
    test_file --> TestGCS
    test_file --> TestAzure
    TestLocal --> upload
    TestLocal --> get
    TestLocal --> delete
    TestLocal --> delete_all
    TestS3 --> upload
    TestS3 --> get
    TestS3 --> delete
    TestS3 --> delete_all
    TestGCS --> upload
    TestGCS --> get
    TestGCS --> delete
    TestGCS --> delete_all
    TestAzure --> upload
    TestAzure --> get
    TestAzure --> delete
    TestAzure --> delete_all
    TestS3 --> mock_aws
    TestGCS --> gcs_server
    TestAzure --> azure_mock
```
**来源：**

-   [backend/open_webui/test/apps/webui/storage/test_provider.py1-436](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/test/apps/webui/storage/test_provider.py#L1-L436)

### 测试固件 (Fixtures) 与辅助工具

测试套件使用了一个通用的固件来进行目录模拟：

```python
def mock_upload_dir(monkeypatch, tmp_path):
    """用于对 UPLOAD_DIR 进行 monkey-patch 并创建一个临时目录的固件。"""
    directory = tmp_path / "uploads"
    directory.mkdir()
    monkeypatch.setattr(provider, "UPLOAD_DIR", str(directory))
    return directory
```
该固件：

-   为每个测试创建一个临时的上传目录。
-   对 `provider.UPLOAD_DIR` 进行 monkey-patch 以使用临时位置。
-   通过使用 pytest 的 `tmp_path` 固件确保测试隔离。

**来源：**

-   [backend/open_webui/test/apps/webui/storage/test_provider.py14-19](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/test/apps/webui/storage/test_provider.py#L14-L19)

### LocalStorageProvider 测试

`TestLocalStorageProvider` 类在没有外部依赖的情况下验证基础文件操作：

| 测试方法 | 验证内容 |
| --- | --- |
| `test_upload_file()` | 文件上传、内容验证、拒绝空文件 |
| `test_get_file()` | 文件路径检索 |
| `test_delete_file()` | 单个文件删除 |
| `test_delete_all_files()` | 批量文件删除 |

**关键测试模式：**

```python
def test_upload_file(self, monkeypatch, tmp_path):
    upload_dir = mock_upload_dir(monkeypatch, tmp_path)
    contents, file_path = self.Storage.upload_file(self.file_bytesio, self.filename)
    assert (upload_dir / self.filename).exists()
    assert (upload_dir / self.filename).read_bytes() == self.file_content
```
**来源：**

-   [backend/open_webui/test/apps/webui/storage/test_provider.py59-98](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/test/apps/webui/storage/test_provider.py#L59-L98)

### S3StorageProvider 测试

`TestS3StorageProvider` 使用 `moto` 库中的 `@mock_aws` 装饰器，在没有真实云资源的情况下模拟 AWS S3：

```python
@mock_aws
class TestS3StorageProvider:
    def __init__(self):
        self.Storage = provider.S3StorageProvider()
        self.Storage.bucket_name = "my-bucket"
        self.s3_client = boto3.resource("s3", region_name="us-east-1")
```
**测试工作流：**

1.  `@mock_aws` 拦截所有的 boto3 S3 调用。
2.  测试创建模拟存储桶：`self.s3_client.create_bucket(Bucket=self.Storage.bucket_name)`。
3.  针对模拟的 S3 服务验证各项操作。
4.  本地和 S3 存储同时得到验证。

**S3 特定的验证：**

-   验证文件同时存储在本地暂存区和 S3 中。
-   测试存储桶存在性检查。
-   验证支持前缀的 S3 键 (key) 格式化。
-   测试无凭据初始化（工作负载身份）。

**来源：**

-   [backend/open_webui/test/apps/webui/storage/test_provider.py100-200](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/test/apps/webui/storage/test_provider.py#L100-L200)

### GCSStorageProvider 测试

`TestGCSStorageProvider` 使用 `gcp-storage-emulator` 创建内存中的 GCS 服务器：

```python
@pytest.fixture(scope="class")
def setup(self):
    host, port = "localhost", 9023
    server = create_server(host, port, in_memory=True)
    server.start()
    os.environ["STORAGE_EMULATOR_HOST"] = f"http://{host}:{port}"

    gcs_client = storage.Client()
    bucket = gcs_client.bucket(self.Storage.bucket_name)
    bucket.create()
    self.Storage.gcs_client, self.Storage.bucket = gcs_client, bucket
    yield
    bucket.delete(force=True)
    server.stop()
```
**测试特征：**

-   类作用域 (class-scoped) 的固件在每个测试类中启动/停止一次模拟器。
-   使用 `STORAGE_EMULATOR_HOST` 环境变量进行重定向。
-   测试存储桶生命周期（创建、使用、带 `force=True` 的删除）。
-   验证 blob 操作（上传、下载、删除）。

**来源：**

-   [backend/open_webui/test/apps/webui/storage/test_provider.py202-292](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/test/apps/webui/storage/test_provider.py#L202-L292)

### AzureStorageProvider 测试

`TestAzureStorageProvider` 使用 `unittest.mock.MagicMock` 来模拟 Azure SDK 客户端：

```python
@pytest.fixture(scope="class")
def setup_storage(self, monkeypatch):
    mock_blob_service_client = MagicMock()
    mock_container_client = MagicMock()
    mock_blob_client = MagicMock()

    mock_blob_service_client.get_container_client.return_value = mock_container_client
    mock_container_client.get_blob_client.return_value = mock_blob_client

    monkeypatch.setattr(
        azure.storage.blob,
        "BlobServiceClient",
        lambda *args, **kwargs: mock_blob_service_client
    )
```
**模拟策略：**

-   所有 Azure SDK 客户端均替换为 `MagicMock` 实例。
-   通过 `.return_value` 属性配置方法返回值。
-   通过 `.side_effect` 模拟副作用，用于错误测试。
-   调用断言验证 API 的使用情况：`assert_called_with()`, `assert_called_once()`。

**来源：**

-   [backend/open_webui/test/apps/webui/storage/test_provider.py294-436](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/test/apps/webui/storage/test_provider.py#L294-L436)

---

## 提供商工厂测试

基础的实例化和工厂模式测试确保了提供商的正确选择：

```python
def test_get_storage_provider():
    Storage = provider.get_storage_provider("local")
    assert isinstance(Storage, provider.LocalStorageProvider)
    Storage = provider.get_storage_provider("s3")
    assert isinstance(Storage, provider.S3StorageProvider)
    Storage = provider.get_storage_provider("gcs")
    assert isinstance(Storage, provider.GCSStorageProvider)
    Storage = provider.get_storage_provider("azure")
    assert isinstance(Storage, provider.AzureStorageProvider)
    with pytest.raises(RuntimeError):
        provider.get_storage_provider("invalid")
```
这验证了：

-   `get_storage_provider()` 工厂函数。
-   基于字符串标识符的正确提供商类实例化。
-   针对无效提供商名称的异常处理。

**来源：**

-   [backend/open_webui/test/apps/webui/storage/test_provider.py31-42](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/test/apps/webui/storage/test_provider.py#L31-L42)

---

## 集成测试 (已禁用)

代码库在 `.github/workflows/integration-test.disabled` 处包含一个已禁用的针对集成测试的 GitHub Actions 工作流。该工作流之前包含了：

### Cypress 端到端测试

该工作流配置了一个完整的 Docker Compose 栈用于基于浏览器的测试：

```mermaid
flowchart TD
    checkout["检出代码库"]
    build["构建 Docker Compose 栈"]
    wait["等待 Ollama"]
    preload["预加载模型 qwen:0.5b-chat-v1.5-q2_K"]
    cypress["运行 Cypress 测试"]
    upload["上传构件"]

    checkout --> build
    build --> wait
    wait --> preload
    preload --> cypress
    cypress --> upload
```
**技术栈组件：**

-   `docker-compose.yaml`：基础 Open WebUI 服务。
-   `docker-compose.api.yaml`：API 配置。
-   `docker-compose.a1111-test.yaml`：Stable Diffusion 集成测试。

**测试执行：**

```yaml
- name: Cypress run
  uses: cypress-io/github-action@v6
  env:
    LIBGL_ALWAYS_SOFTWARE: 1
  with:
    browser: chrome
    wait-on: 'http://localhost:3000'
    config: baseUrl=http://localhost:3000
```
**来源：**

-   [.github/workflows/integration-test.disabled14-82](https://github.com/open-webui/open-webui/blob/a7271532/.github/workflows/integration-test.disabled#L14-L82)

### 迁移测试

迁移测试作业验证了数据库迁移和带有多个后端的服务器启动情况：

```mermaid
flowchart TD
    postgres["PostgreSQL 服务 端口 5432"]
    install["安装依赖 uv pip install"]
    sqlite["测试 SQLite 后端"]
    pg["测试 PostgreSQL 后端"]
    reconnect["测试数据库重连"]
    startup["服务器启动检查"]
    health["健康检查端点 /api/config"]
    running["进程运行检查"]
    db_health["数据库健康检查 /health/db"]
    terminate["断开连接"]
    recheck["重新检查数据库健康状态"]

    postgres --> pg
    install --> sqlite
    sqlite --> pg
    sqlite --> startup
    sqlite --> health
    sqlite --> running
    pg --> startup
    pg --> health
    pg --> running
    pg --> reconnect
    reconnect --> db_health
    reconnect --> terminate
    reconnect --> recheck
```
**SQLite 测试序列：**

```bash
uvicorn open_webui.main:app --port "8080" --forwarded-allow-ips '*' &
UVICORN_PID=$!
# 等待最多 40 秒直到服务器启动
for i in {1..40}; do
    curl -s http://localhost:8080/api/config > /dev/null && break
    sleep 1
done
# 在 5 秒后检查服务器是否仍在运行
sleep 5
if ! kill -0 $UVICORN_PID; then
    echo "Server has stopped"
    exit 1
fi
```
**PostgreSQL 重连测试：**

```bash
# 断开所有 PostgreSQL 连接
python -c "import os, psycopg2 as pg2; \
  conn = pg2.connect(dsn=os.environ['DATABASE_URL'].replace('+pool', '')); \
  cur = conn.cursor(); \
  cur.execute('SELECT pg_terminate_backend(psa.pid) FROM pg_stat_activity psa WHERE datname = current_database() AND pid <> pg_backend_pid();')"

# 验证服务器是否重连
status_code=$(curl --write-out %{http_code} -s --output /dev/null http://localhost:8081/health/db)
if [[ "$status_code" -ne 200 ]] ; then
  echo "Server has not reconnected to postgres"
  exit 1
fi
```
**测试环境变量：**

-   `WEBUI_SECRET_KEY=secret-key`
-   `GLOBAL_LOG_LEVEL=debug`
-   `DATABASE_URL=postgresql://postgres:postgres@localhost:5432/postgres`
-   `DATABASE_POOL_SIZE=10`
-   `DATABASE_POOL_MAX_OVERFLOW=10`
-   `DATABASE_POOL_TIMEOUT=30`

**来源：**

-   [.github/workflows/integration-test.disabled105-229](https://github.com/open-webui/open-webui/blob/a7271532/.github/workflows/integration-test.disabled#L105-L229)

---

## Playwright 网页加载测试

Open WebUI 支持使用 Playwright 进行高级网页内容提取，通过 Docker Compose 进行配置：

### Playwright 服务配置

```yaml
services:
  playwright:
    image: mcr.microsoft.com/playwright:v1.57.0-noble
    container_name: playwright
    command: npx -y playwright@1.57.0 run-server --port 3000 --host 0.0.0.0

  open-webui:
    environment:
      - 'WEB_LOADER_ENGINE=playwright'
      - 'PLAYWRIGHT_WS_URL=ws://playwright:3000'
```
**关键配置：**

-   Playwright 版本 **必须与** `requirements.txt` 匹配：`playwright==1.57.0`。
-   作为 WebSocket 服务器运行在端口 3000。
-   Open WebUI 通过 `PLAYWRIGHT_WS_URL` 环境变量进行连接。
-   启用 `WEB_LOADER_ENGINE=playwright` 用于网页搜索内容加载。

**来源：**

-   [docker-compose.playwright.yaml1-11](https://github.com/open-webui/open-webui/blob/a7271532/docker-compose.playwright.yaml#L1-L11)
-   [backend/requirements.txt123](https://github.com/open-webui/open-webui/blob/a7271532/backend/requirements.txt#L123-L123)

### Playwright 集成

Playwright 容器提供：

-   无头浏览器自动化。
-   针对动态内容的 JavaScript 执行。
-   屏幕截图捕获能力。
-   Cookie 和会话管理。
-   网络请求拦截。

这通过支持全页面渲染和针对内容提取的 JavaScript 评估，支撑了网页搜索集成系统（参见 [网页搜索集成](/open-webui/open-webui/6.5-web-search-integration)）。

**来源：**

-   [docker-compose.playwright.yaml1-11](https://github.com/open-webui/open-webui/blob/a7271532/docker-compose.playwright.yaml#L1-L11)

---

## 测试执行

### 运行存储提供商测试

使用 pytest 执行存储提供商测试：

```bash
# 运行所有存储测试
pytest backend/open_webui/test/apps/webui/storage/test_provider.py

# 运行特定的测试类
pytest backend/open_webui/test/apps/webui/storage/test_provider.py::TestS3StorageProvider

# 运行特定的测试方法
pytest backend/open_webui/test/apps/webui/storage/test_provider.py::TestS3StorageProvider::test_upload_file

# 使用详细输出模式运行
pytest -v backend/open_webui/test/apps/webui/storage/test_provider.py

# 使用调试日志记录运行
pytest -o log_cli=true -o log_cli_level=INFO backend/open_webui/test/apps/webui/storage/test_provider.py
```
**来源：**

-   [backend/open_webui/test/apps/webui/storage/test_provider.py1](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/test/apps/webui/storage/test_provider.py#L1-L1)

### 安装测试依赖项

使用 pip 或 uv 安装测试依赖项：

```bash
# 安装包含测试包在内的所有依赖项
pip install -r backend/requirements.txt

# 或者使用 uv 以实现更快的安装
uv pip install -r backend/requirements.txt

# 为所有存储提供商安装可选依赖项
pip install -e ".[all]"
```
**来源：**

-   [backend/requirements.txt133-136](https://github.com/open-webui/open-webui/blob/a7271532/backend/requirements.txt#L133-L136)
-   [pyproject.toml140-162](https://github.com/open-webui/open-webui/blob/a7271532/pyproject.toml#L140-L162)

---

## 测试组织结构

```mermaid
flowchart TD
    root["backend/"]
    test_dir["open_webui/test/"]
    apps["apps/"]
    webui["webui/"]
    storage["storage/"]
    test_file["test_provider.py"]
    src_storage["open_webui/storage/"]
    provider_src["provider.py"]

    root --> test_dir
    root --> src_storage
    test_dir --> apps
    apps --> webui
    webui --> storage
    storage --> test_file
    src_storage --> provider_src
    test_file -.-> provider_src
```
**目录结构：**

-   测试位于 `backend/open_webui/test/` 目录下。
-   镜像源码结构：`test/apps/webui/storage/` 测试 `storage/provider.py`。
-   测试文件遵循 `test_*.py` 命名约定。
-   每个模块对应一个测试文件，每个文件包含多个测试类。

**来源：**

-   [backend/open_webui/test/apps/webui/storage/test_provider.py1](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/test/apps/webui/storage/test_provider.py#L1-L1)
-   [backend/open_webui/storage/provider.py1](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L1-L1)

---

## 测试最佳实践

基于现有的测试套件，Open WebUI 遵循以下测试模式：

1.  **隔离性**：使用固件 (`tmp_path`, `monkeypatch`) 来隔离测试。
2.  **模拟 (Mocking)**：模拟外部服务 (AWS, GCS, Azure) 以避免使用真实的云资源。
3.  **清理**：在固件中正确销毁资源（GCS 服务器、临时目录）。
4.  **断言**：同时验证成功的操作和错误条件。
5.  **现实性**：使用现实数据进行测试（二进制文件内容、多个文件操作）。

**常用测试模式：**

| 模式 | 实现方式 |
| --- | --- |
| 目录隔离 | 结合 `monkeypatch` 使用 `tmp_path` 固件 |
| 服务模拟 | `@mock_aws`, `gcp-storage-emulator`, `MagicMock` |
| 错误测试 | 使用 `pytest.raises()` 进行异常验证 |
| 清理 | 固件 `yield` 后的清理逻辑 |
| 并行验证 | 同时检查本地和云存储状态 |

**来源：**

-   [backend/open_webui/test/apps/webui/storage/test_provider.py14-19](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/test/apps/webui/storage/test_provider.py#L14-L19)
-   [backend/open_webui/test/apps/webui/storage/test_provider.py100-111](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/test/apps/webui/storage/test_provider.py#L100-L111)
-   [backend/open_webui/test/apps/webui/storage/test_provider.py210-225](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/test/apps/webui/storage/test_provider.py#L210-L225)
-   [backend/open_webui/test/apps/webui/storage/test_provider.py298-325](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/test/apps/webui/storage/test_provider.py#L298-L325)
