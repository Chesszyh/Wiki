# 云存储身份验证

相关源文件

-   [.github/workflows/integration-test.disabled](https://github.com/open-webui/open-webui/blob/a7271532/.github/workflows/integration-test.disabled)
-   [backend/open\_webui/storage/provider.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py)
-   [backend/open\_webui/test/apps/webui/storage/test\_provider.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/test/apps/webui/storage/test_provider.py)
-   [backend/requirements-min.txt](https://github.com/open-webui/open-webui/blob/a7271532/backend/requirements-min.txt)
-   [backend/requirements.txt](https://github.com/open-webui/open-webui/blob/a7271532/backend/requirements.txt)
-   [docker-compose.playwright.yaml](https://github.com/open-webui/open-webui/blob/a7271532/docker-compose.playwright.yaml)
-   [pyproject.toml](https://github.com/open-webui/open-webui/blob/a7271532/pyproject.toml)
-   [uv.lock](https://github.com/open-webui/open-webui/blob/a7271532/uv.lock)

## 目的与范围

本文档描述了 Open WebUI 用于连接云存储提供商（AWS S3、Google Cloud Storage 和 Azure Blob Storage）的身份验证策略。它涵盖了每个存储提供者如何验证请求、控制身份验证的环境变量，以及系统如何同时支持显式凭据和工作负载标识 (Workload Identity) 模式。

有关存储提供者系统和文件操作的常规信息，请参阅 [存储提供者系统](/open-webui/open-webui/12.1-storage-provider-architecture)。有关文件上传和处理工作流，请参阅 [文件上传处理](/open-webui/open-webui/12.2-local-storage-provider)。

## 概览

Open WebUI 的存储系统在所有云提供商中支持三种身份验证模式：

1.  **显式凭据 (Explicit Credentials)**：使用访问密钥、服务账户 JSON 或存储密钥的传统凭据身份验证。
2.  **工作负载标识 (Workload Identity)**：使用 IAM 角色、服务账户或托管标识的云原生身份验证。
3.  **默认凭据链 (Default Credential Chain)**：从环境、实例元数据或用户凭据中自动发现凭据。

每个 `StorageProvider` 实现都通过其初始化逻辑来根据环境变量确定使用哪种模式。如果未提供显式凭据，系统会自动回退到工作负载标识机制。

**来源：** [backend/open\_webui/storage/provider.py1-377](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L1-L377)

## 身份验证流程

```mermaid
flowchart TD
    Init["get_storage_provider(STORAGE_PROVIDER)"]
    CheckType["提供者类型？"]
    S3Init["S3StorageProvider.init()"]
    GCSInit["GCSStorageProvider.init()"]
    AzureInit["AzureStorageProvider.init()"]
    LocalInit["LocalStorageProvider()"]
    S3Creds["是否有 S3_ACCESS_KEY_ID 和 S3_SECRET_ACCESS_KEY？"]
    S3Explicit["boto3.client() 使用显式凭据"]
    S3Workload["boto3.client() 使用默认凭据链 (IAM 角色, EC2 元数据)"]
    GCSCreds["是否有 GOOGLE_APPLICATION_CREDENTIALS_JSON？"]
    GCSExplicit["storage.Client.from_service_account_info()"]
    GCSWorkload["storage.Client() (元数据服务器, 用户凭据)"]
    AzureCreds["是否有 AZURE_STORAGE_KEY？"]
    AzureExplicit["BlobServiceClient 使用存储密钥"]
    AzureWorkload["BlobServiceClient 使用 DefaultAzureCredential (托管标识)"]
    S3Client["self.s3_client"]
    GCSClient["self.gcs_client"]
    AzureClient["self.blob_service_client"]
    LocalReady["存储已就绪"]
    Ready["存储提供者已就绪"]

    Init --> CheckType
    CheckType --> S3Init
    CheckType --> GCSInit
    CheckType --> AzureInit
    CheckType --> LocalInit
    S3Init --> S3Creds
    S3Creds -- 是 --> S3Explicit
    S3Creds -- 否 --> S3Workload
    GCSInit --> GCSCreds
    GCSCreds -- 是 --> GCSExplicit
    GCSCreds -- 否 --> GCSWorkload
    AzureInit --> AzureCreds
    AzureCreds -- 是 --> AzureExplicit
    AzureCreds -- 否 --> AzureWorkload
    S3Explicit --> S3Client
    S3Workload --> S3Client
    GCSExplicit --> GCSClient
    GCSWorkload --> GCSClient
    AzureExplicit --> AzureClient
    AzureWorkload --> AzureClient
    LocalInit --> LocalReady
    S3Client --> Ready
    GCSClient --> Ready
    AzureClient --> Ready
```
**来源：** [backend/open\_webui/storage/provider.py362-376](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L362-L376) [backend/open\_webui/storage/provider.py109-141](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L109-L141) [backend/open\_webui/storage/provider.py227-239](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L227-L239) [backend/open\_webui/storage/provider.py293-311](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L293-L311)

## S3 存储身份验证

### 初始化逻辑

`S3StorageProvider` 类在其 `__init__` 方法中实现了双重身份验证路径：

```mermaid
flowchart TD
    Init["S3StorageProvider.init()"]
    Config["使用 S3_USE_ACCELERATE_ENDPOINT 和 S3_ADDRESSING_STYLE 创建 boto3 配置"]
    CheckCreds["是否定义了 S3_ACCESS_KEY_ID 和 S3_SECRET_ACCESS_KEY？"]
    ExplicitPath["boto3.client('s3') 附带 aws_access_key_id 和 aws_secret_access_key"]
    WorkloadPath["boto3.client('s3') 不附带凭据 (使用默认链)"]
    Client["self.s3_client"]
    BucketConfig["self.bucket_name = S3_BUCKET_NAME, self.key_prefix = S3_KEY_PREFIX"]

    Init --> Config
    Config --> CheckCreds
    CheckCreds -- 是 --> ExplicitPath
    CheckCreds -- 否 --> WorkloadPath
    ExplicitPath --> Client
    WorkloadPath --> Client
    Client --> BucketConfig
```
**来源：** [backend/open\_webui/storage/provider.py109-141](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L109-L141)

### 显式凭据 (Explicit Credentials)

当通过环境变量提供显式凭据时，boto3 会创建一个已认证的客户端：

| 环境变量 | 用途 | 示例 |
| --- | --- | --- |
| `S3_ACCESS_KEY_ID` | AWS 访问密钥 ID | `AKIAIOSFODNN7EXAMPLE` |
| `S3_SECRET_ACCESS_KEY` | AWS 机密访问密钥 | `wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY` |
| `S3_REGION_NAME` | AWS 区域 | `us-west-2` |
| `S3_ENDPOINT_URL` | 自定义 S3 端点 (用于 S3 兼容服务) | `https://s3.example.com` |

使用显式凭据的客户端初始化发生在 [backend/open\_webui/storage/provider.py121-129](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L121-L129)：

-   使用 `aws_access_key_id` 和 `aws_secret_access_key` 创建 `boto3.client("s3", ...)`。
-   应用来自 `S3_REGION_NAME` 的区域设置。
-   如果提供了自定义端点，则使用 `S3_ENDPOINT_URL`。
-   配置 S3 特定选项，如加速端点和寻址样式。

**来源：** [backend/open\_webui/storage/provider.py121-129](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L121-L129) [backend/open\_webui/config.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/config.py)

### 工作负载标识 (默认凭据链)

当未提供显式凭据时，[backend/open\_webui/storage/provider.py131-138](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L131-L138) 处的回退路径会创建一个不带凭据的 boto3 客户端。这将激活 boto3 的默认凭据提供者链，按以下顺序搜索凭据：

1.  **环境变量** - `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`, `AWS_SESSION_TOKEN`。
2.  **共享凭据文件** - `~/.aws/credentials`。
3.  **AWS 配置文件** - `~/.aws/config`。
4.  **EC2 的 IAM 角色** - 实例元数据服务，位于 `http://169.254.169.254/latest/meta-data/iam/security-credentials/`。
5.  **ECS 的 IAM 角色** - 容器凭据端点。
6.  **EKS 的 IAM 角色** - 通过 IRSA (IAM Roles for Service Accounts) 提供的服务账户令牌。

这种模式在 [backend/open\_webui/test/apps/webui/storage/test\_provider.py190-199](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/test/apps/webui/storage/test_provider.py#L190-L199) 的测试中得到了演示，该测试验证了 `S3StorageProvider` 在没有显式凭据的情况下也能完成初始化。

**来源：** [backend/open\_webui/storage/provider.py131-138](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L131-L138) [backend/open\_webui/test/apps/webui/storage/test\_provider.py190-199](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/test/apps/webui/storage/test_provider.py#L190-L199)

### 配置选项

额外的 S3 配置参数用于控制客户端行为：

| 环境变量 | 默认值 | 用途 |
| --- | --- | --- |
| `S3_BUCKET_NAME` | 必需 | S3 存储桶名称 |
| `S3_KEY_PREFIX` | `""` | 所有对象键的前缀 (文件夹路径) |
| `S3_USE_ACCELERATE_ENDPOINT` | `False` | 启用 S3 传输加速 |
| `S3_ADDRESSING_STYLE` | `auto` | 寻址样式 (`path`, `virtual`, `auto`) |
| `S3_ENABLE_TAGGING` | `False` | 启用对象标签 (Tagging) |

boto3 的 `Config` 对象在 [backend/open\_webui/storage/provider.py110-118](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L110-L118) 处使用这些设置构造，并包含了请求/响应校验和验证。

**来源：** [backend/open\_webui/storage/provider.py110-141](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L110-L141) [backend/open\_webui/config.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/config.py)

## Google Cloud Storage 身份验证

### 初始化逻辑

`GCSStorageProvider` 类根据是否存在服务账户 JSON 来决定身份验证方法：

```mermaid
flowchart TD
    Init["GCSStorageProvider.init()"]
    CheckJSON["是否定义了 GOOGLE_APPLICATION_CREDENTIALS_JSON？"]
    ParseJSON["json.loads(GOOGLE_APPLICATION_CREDENTIALS_JSON)"]
    ServiceAcct["storage.Client.from_service_account_info(info=json_dict)"]
    DefaultCreds["storage.Client() 不带参数"]
    Client["self.gcs_client"]
    Bucket["self.bucket = gcs_client.bucket(GCS_BUCKET_NAME)"]

    Init --> CheckJSON
    CheckJSON -- 是 --> ParseJSON
    ParseJSON --> ServiceAcct
    CheckJSON -- 否 --> DefaultCreds
    ServiceAcct --> Client
    DefaultCreds --> Client
    Client --> Bucket
```
**来源：** [backend/open\_webui/storage/provider.py227-239](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L227-L239)

### 显式凭据 (服务账户 JSON)

当设置了 `GOOGLE_APPLICATION_CREDENTIALS_JSON` 时，提供者使用服务账户凭据：

| 环境变量 | 用途 | 格式 |
| --- | --- | --- |
| `GOOGLE_APPLICATION_CREDENTIALS_JSON` | 服务账户 JSON 密钥 | 包含 `type`, `project_id`, `private_key_id`, `private_key`, `client_email` 等字段的 JSON 字符串 |
| `GCS_BUCKET_NAME` | GCS 存储桶名称 | `my-bucket-name` |

[backend/open\_webui/storage/provider.py230-233](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L230-L233) 处的实现：

-   使用 `json.loads()` 解析 JSON 字符串。
-   调用 `storage.Client.from_service_account_info(info=json_dict)`。
-   创建一个具有该服务账户权限的已认证客户端。

**来源：** [backend/open\_webui/storage/provider.py230-233](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L230-L233)

### 工作负载标识 (默认凭据)

在没有显式 JSON 凭据的情况下，[backend/open\_webui/storage/provider.py235-238](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L235-L238) 处的代码路径会创建一个不带参数的客户端。Google Cloud SDK 的应用默认凭据 (ADC) 机制随后会按以下顺序搜索凭据：

1.  **GOOGLE\_APPLICATION\_CREDENTIALS 环境变量** - 指向服务账户 JSON 文件路径（不要与 `_JSON` 变体混淆）。
2.  **用户凭据** - 通过 `gcloud auth application-default login` 获取（用于本地开发）。
3.  **Compute Engine 服务账户** - 位于 `http://metadata.google.internal/computeMetadata/v1/` 的元数据服务器。
4.  **Cloud Run 服务账户** - 通过元数据获取的默认服务账户。
5.  **GKE 工作负载标识** - 映射到 Kubernetes 服务账户的服务账户。

这种模式支持了 [backend/open\_webui/storage/provider.py235-238](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L235-L238) 注释中描述的场景：

-   **本地开发**：使用来自 `gcloud auth` 的用户凭据。
-   **Compute Engine/Cloud Run**：使用实例元数据服务。
-   **带有工作负载标识的 GKE**：使用映射后的服务账户。

**来源：** [backend/open\_webui/storage/provider.py235-238](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L235-L238)

### 测试覆盖范围

GCS 身份验证在 [backend/open\_webui/test/apps/webui/storage/test\_provider.py202-291](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/test/apps/webui/storage/test_provider.py#L202-L291) 处使用 `gcp-storage-emulator` 包进行了测试，验证了上传和检索操作，而无需真实的 GCP 凭据。

**来源：** [backend/open\_webui/test/apps/webui/storage/test\_provider.py202-291](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/test/apps/webui/storage/test_provider.py#L202-L291)

## Azure Blob Storage 身份验证

### 初始化逻辑

`AzureStorageProvider` 类支持存储账户密钥和托管标识两种身份验证方式：

```mermaid
flowchart TD
    Init["AzureStorageProvider.init()"]
    SetVars["self.endpoint = AZURE_STORAGE_ENDPOINT, self.container_name = AZURE_STORAGE_CONTAINER_NAME"]
    CheckKey["是否定义了 AZURE_STORAGE_KEY？"]
    KeyAuth["BlobServiceClient(account_url=endpoint, credential=storage_key)"]
    ManagedID["BlobServiceClient(account_url=endpoint, credential=DefaultAzureCredential())"]
    ServiceClient["self.blob_service_client"]
    Container["self.container_client = blob_service_client.get_container_client(container_name)"]

    Init --> SetVars
    SetVars --> CheckKey
    CheckKey -- 是 --> KeyAuth
    CheckKey -- 否 --> ManagedID
    KeyAuth --> ServiceClient
    ManagedID --> ServiceClient
    ServiceClient --> Container
```
**来源：** [backend/open\_webui/storage/provider.py293-311](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L293-L311)

### 显式凭据 (存储账户密钥)

当提供了存储账户密钥时，系统使用基于密钥的身份验证：

| 环境变量 | 用途 | 示例 |
| --- | --- | --- |
| `AZURE_STORAGE_ENDPOINT` | 存储账户端点 URL | `https://mystorageacct.blob.core.windows.net` |
| `AZURE_STORAGE_KEY` | 存储账户访问密钥 | Base64 编码的密钥字符串 |
| `AZURE_STORAGE_CONTAINER_NAME` | Blob 容器名称 | `open-webui-files` |

[backend/open\_webui/storage/provider.py298-302](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L298-L302) 处的实现：

-   使用 `account_url=self.endpoint` 创建 `BlobServiceClient`。
-   传递 `credential=storage_key` 进行身份验证。
-   获取容器客户端用于 blob 操作。

**来源：** [backend/open\_webui/storage/provider.py298-302](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L298-L302)

### 工作负载标识 (托管标识)

在没有显式存储密钥的情况下，[backend/open\_webui/storage/provider.py304-308](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L304-L308) 处的回退路径会使用 `DefaultAzureCredential()`。该 Azure Identity 库类会按以下顺序尝试身份验证方法：

1.  **环境变量** - `AZURE_TENANT_ID`, `AZURE_CLIENT_ID`, `AZURE_CLIENT_SECRET`（用于服务主体）。
2.  **托管标识** - 系统分配或用户分配的托管标识。
3.  **Azure CLI** - 通过 `az login` 获取的凭据（用于本地开发）。
4.  **Azure PowerShell** - 通过 `Connect-AzAccount` 获取的凭据。
5.  **Visual Studio Code** - 来自 Azure Account 扩展的凭据。
6.  **工作负载标识** - 用于 AKS 工作负载标识的同盟凭据。

[backend/open\_webui/storage/provider.py304-306](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L304-L306) 处的注释明确指出，该方式支持：

-   **带有托管标识的 Azure VM/AKS**：自动获取凭据。
-   **本地开发**：回退到 Azure CLI 或 VS Code 凭据。

**来源：** [backend/open\_webui/storage/provider.py304-308](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L304-L308)

### 测试覆盖范围

Azure 存储身份验证在 [backend/open\_webui/test/apps/webui/storage/test\_provider.py294-435](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/test/apps/webui/storage/test_provider.py#L294-L435) 处通过模拟 `BlobServiceClient` 对象进行测试，验证了初始化模式和 blob 操作。

**来源：** [backend/open\_webui/test/apps/webui/storage/test\_provider.py294-435](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/test/apps/webui/storage/test_provider.py#L294-L435)

## 配置环境变量

### 完整变量参考

下表总结了跨提供商的所有身份验证相关环境变量：

| 变量 | 提供商 | 用途 | 是否必需 |
| --- | --- | --- | --- |
| `STORAGE_PROVIDER` | 所有 | 选择提供者 (`local`, `s3`, `gcs`, `azure`) | 是 |
| `S3_ACCESS_KEY_ID` | S3 | AWS 访问密钥 ID | 否 (工作负载标识) |
| `S3_SECRET_ACCESS_KEY` | S3 | AWS 机密访问密钥 | 否 (工作负载标识) |
| `S3_REGION_NAME` | S3 | AWS 区域 | 否 |
| `S3_ENDPOINT_URL` | S3 | 自定义 S3 端点 | 否 |
| `S3_BUCKET_NAME` | S3 | S3 存储桶名称 | 是 (若使用 S3) |
| `S3_KEY_PREFIX` | S3 | 对象键前缀 | 否 |
| `GOOGLE_APPLICATION_CREDENTIALS_JSON` | GCS | 服务账户 JSON | 否 (工作负载标识) |
| `GCS_BUCKET_NAME` | GCS | GCS 存储桶名称 | 是 (若使用 GCS) |
| `AZURE_STORAGE_ENDPOINT` | Azure | 存储账户端点 | 是 (若使用 Azure) |
| `AZURE_STORAGE_KEY` | Azure | 存储账户密钥 | 否 (托管标识) |
| `AZURE_STORAGE_CONTAINER_NAME` | Azure | Blob 容器名称 | 是 (若使用 Azure) |

**来源：** [backend/open\_webui/config.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/config.py) [backend/open\_webui/storage/provider.py1-377](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L1-L377)

### 依赖项

每个提供者都需要特定的 Python 包进行身份验证：

| 提供者 | 软件包 | 版本 | 用途 |
| --- | --- | --- | --- |
| S3 | `boto3` | 1.41.5 | AWS SDK for Python |
| GCS | `google-cloud-storage` | 2.19.0 | GCS 客户端库 |
| Azure | `azure-storage-blob` | 12.24.1 | Blob 存储客户端 |
| Azure | `azure-identity` | 1.25.0 | Azure 凭据提供程序 |

**来源：** [backend/requirements.txt99-101](https://github.com/open-webui/open-webui/blob/a7271532/backend/requirements.txt#L99-L101) [backend/requirements.txt108](https://github.com/open-webui/open-webui/blob/a7271532/backend/requirements.txt#L108-L108) [backend/requirements.txt113-114](https://github.com/open-webui/open-webui/blob/a7271532/backend/requirements.txt#L113-L114) [pyproject.toml111](https://github.com/open-webui/open-webui/blob/a7271532/pyproject.toml#L111-L111) [pyproject.toml113-114](https://github.com/open-webui/open-webui/blob/a7271532/pyproject.toml#L113-L114)

## 身份验证模式比较

```mermaid
flowchart TD
    AzureExplicit["显式凭据: AZURE_STORAGE_KEY"]
    AzureWorkload["托管标识: DefaultAzureCredential (VM, AKS, App Service)"]
    GCSExplicit["显式凭据: GOOGLE_APPLICATION_CREDENTIALS_JSON"]
    GCSWorkload["工作负载标识: 服务账户 (GCE, GKE, Cloud Run)"]
    S3Explicit["显式凭据: S3_ACCESS_KEY_ID + S3_SECRET_ACCESS_KEY"]
    S3Workload["工作负载标识: IAM 角色 (EC2, ECS, EKS)"]

    AzureExplicit --> AzureWorkload
    GCSExplicit --> GCSWorkload
    S3Explicit --> S3Workload
```
所有三个提供者都遵循相同的架构模式：

1.  检查环境变量中是否存在显式凭据。
2.  如果存在，使用显式凭据创建已认证的客户端。
3.  如果不存在，委托给云提供商的 SDK 进行自动凭据发现。
4.  云 SDK 会依次尝试工作负载标识，最后回退到本地开发凭据。

这种设计实现了：

-   **开发灵活性**：开发人员可以在本地使用显式凭据。
-   **生产安全性**：生产部署使用 IAM 角色/托管标识，无需嵌入凭据。
-   **云无关模式**：在 AWS、GCP 和 Azure 之间采用相同的身份验证方法。
-   **零配置工作负载标识**：移除显式凭据时无需更改代码。

**来源：** [backend/open\_webui/storage/provider.py109-311](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L109-L311)

## 提供者选择与初始化

存储提供者在 [backend/open\_webui/storage/provider.py362-376](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L362-L376) 的 `get_storage_provider()` 中被选择并初始化：

```python
def get_storage_provider(storage_provider: str):
    if storage_provider == "local":
        Storage = LocalStorageProvider()
    elif storage_provider == "s3":
        Storage = S3StorageProvider()
    elif storage_provider == "gcs":
        Storage = GCSStorageProvider()
    elif storage_provider == "azure":
        Storage = AzureStorageProvider()
    else:
        raise RuntimeError(f"不支持的存储提供者: {storage_provider}")
    return Storage
```
全局 `Storage` 实例在模块导入时根据 `STORAGE_PROVIDER` 环境变量创建。这种单例模式确保身份验证在应用启动期间仅发生一次，后续操作将重用已认证的客户端。

**来源：** [backend/open\_webui/storage/provider.py362-376](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L362-L376)
