# 可选依赖项 (Optional Dependencies)

相关源文件

-   [.github/workflows/integration-test.disabled](https://github.com/open-webui/open-webui/blob/a7271532/.github/workflows/integration-test.disabled)
-   [backend/open\_webui/storage/provider.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py)
-   [backend/open\_webui/test/apps/webui/storage/test\_provider.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/test/apps/webui/storage/test_provider.py)
-   [backend/requirements-min.txt](https://github.com/open-webui/open-webui/blob/a7271532/backend/requirements-min.txt)
-   [backend/requirements.txt](https://github.com/open-webui/open-webui/blob/a7271532/backend/requirements.txt)
-   [docker-compose.playwright.yaml](https://github.com/open-webui/open-webui/blob/a7271532/docker-compose.playwright.yaml)
-   [pyproject.toml](https://github.com/open-webui/open-webui/blob/a7271532/pyproject.toml)
-   [uv.lock](https://github.com/open-webui/open-webui/blob/a7271532/uv.lock)

## 目的与范围

本页面记录了 Open WebUI 后端 Python 环境中的可选依赖系统。Open WebUI 使用分层依赖结构，允许用户仅安装其特定部署场景所需的包。这减小了安装体积，避免了冲突，并支持逐步采用新特性。

有关核心必需依赖项的信息，请参阅 [后端依赖](/open-webui/open-webui/16.1-websocket-architecture)。有关特定于部署的配置，请参阅 [安装与设置](/open-webui/open-webui/17.1-backend-dependencies)。

## 依赖组概览

Open WebUI 在 `pyproject.toml` 中使用 PEP 621 可选依赖组来定义其依赖项。该系统提供了三个安装层级：

```mermaid
flowchart TD
    Base["基础安装 (pip install open-webui)"]
    Postgres["PostgreSQL 组 (pip install open-webui[postgres])"]
    All["全特性组 (pip install open-webui[all])"]
    CoreDeps["核心依赖 FastAPI, SQLAlchemy, ChromaDB, OpenAI, Anthropic 等"]
    PostgresDeps["psycopg2-binary==2.9.10, pgvector==0.4.1"]
    AllDeps["测试: pytest, docker, playwright; 向量数据库: Qdrant, Milvus, Pinecone; 搜索: Elasticsearch, Firecrawl; 模拟器: moto, gcp-storage-emulator"]

    Base --> CoreDeps
    Postgres --> PostgresDeps
    All --> AllDeps
    Base --> CoreDeps
    Postgres --> CoreDeps
    Postgres --> PostgresDeps
    All --> CoreDeps
    All --> PostgresDeps
    All --> AllDeps
```
**来源：** [pyproject.toml131-158](https://github.com/open-webui/open-webui/blob/a7271532/pyproject.toml#L131-L158) [backend/requirements.txt1-153](https://github.com/open-webui/open-webui/blob/a7271532/backend/requirements.txt#L1-L153)

## 可选依赖组

### PostgreSQL 组 (`postgres`)

`postgres` 可选依赖组增加了对将 PostgreSQL 作为主数据库后端的支持，以替换默认的 SQLite。

| 包名 | 版本 | 用途 |
| --- | --- | --- |
| `psycopg2-binary` | 2.9.10 | PostgreSQL 数据库适配器 |
| `pgvector` | 0.4.1 | 支持向量相似度搜索的 PostgreSQL 扩展 |

**安装命令：**

```bash
pip install open-webui[postgres]
```
**配置要求：**

-   将 `DATABASE_URL` 环境变量设置为 PostgreSQL 连接字符串。
-   示例：`postgresql://user:password@localhost:5432/openwebui`。
-   通过 SQLAlchemy 连接池参数支持连接池。

**来源：** [pyproject.toml132-135](https://github.com/open-webui/open-webui/blob/a7271532/pyproject.toml#L132-L135) [.github/workflows/integration-test.disabled181-209](https://github.com/open-webui/open-webui/blob/a7271532/.github/workflows/integration-test.disabled#L181-L209)

### 全特性组 (`all`)

`all` 可选依赖组包含了用于开发、测试和高级部署的所有可选特性。该组主要适用于：

-   开发环境。
-   全面的测试套件。
-   需要多个向量数据库的部署。
-   高级搜索和文档处理能力。

#### 测试与开发依赖项

| 包名 | 版本 | 用途 |
| --- | --- | --- |
| `docker` | ~7.1.0 | 用于测试的 Docker 容器编排 |
| `pytest` | ~8.3.2 | 测试框架 |
| `pytest-docker` | ~3.2.5 | 针对 pytest 的 Docker 固件 |
| `moto[s3]` | >=5.0.26 | AWS S3 服务模拟器 |
| `gcp-storage-emulator` | >=2024.8.3 | Google Cloud Storage 模拟器 |

#### 额外的向量数据库

| 包名 | 版本 | 用途 |
| --- | --- | --- |
| `qdrant-client` | 1.14.3 | Qdrant 向量数据库客户端 |
| `pymilvus` | 2.6.4 | Milvus 向量数据库客户端 |
| `pinecone` | 6.0.2 | Pinecone 云向量数据库 |
| `oracledb` | 3.2.0 | Oracle 数据库连接 |

注：ChromaDB, Weaviate 和 OpenSearch 已包含在基础安装中。

#### 搜索与文档处理

| 包名 | 版本 | 用途 |
| --- | --- | --- |
| `elasticsearch` | 9.1.0 | 用于搜索的 Elasticsearch 客户端 |
| `firecrawl-py` | 4.10.0 | 网页抓取与爬取 |
| `azure-search-documents` | 11.6.0 | Azure 认知搜索集成 |
| `playwright` | 1.56.0 | 用于网页抓取的浏览器自动化 |

#### 高级检索

| 包名 | 版本 | 用途 |
| --- | --- | --- |
| `colbert-ai` | 0.2.21 | ColBERT 重排序模型支持 |

**安装命令：**

```bash
pip install open-webui[all]
```
**来源：** [pyproject.toml137-158](https://github.com/open-webui/open-webui/blob/a7271532/pyproject.toml#L137-L158) [backend/open\_webui/test/apps/webui/storage/test\_provider.py1-436](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/test/apps/webui/storage/test_provider.py#L1-L436)

## 安装模式

### 标准 pip 安装

```bash
# 基础安装 (SQLite, ChromaDB)
pip install open-webui

# 带有 PostgreSQL 支持
pip install open-webui[postgres]

# 完整安装
pip install open-webui[all]

# 同时安装多个组
pip install open-webui[postgres,all]
```
### 使用 uv (现代包管理器)

```bash
# 使用 uv 安装
uv pip install open-webui[postgres]

# 包含所有特性的开发环境
uv pip install -r backend/requirements.txt
```
### 对 Docker 的影响

Docker 镜像可以使用不同的依赖配置进行构建：

-   **标准镜像**：包含 `requirements.txt` 中的所有依赖项。
-   **最小镜像**：可以使用 `requirements-min.txt` 以减小体积。
-   **自定义镜像**：安装基础版 + 特定的可选组。

**来源：** [backend/requirements-min.txt1-52](https://github.com/open-webui/open-webui/blob/a7271532/backend/requirements-min.txt#L1-L52) [.github/workflows/integration-test.disabled141-153](https://github.com/open-webui/open-webui/blob/a7271532/.github/workflows/integration-test.disabled#L141-L153)

## 有条件的依赖项使用

多个子系统通过条件导入和运行时检测来优雅地处理可选依赖项。

### 云存储提供商模式

存储提供商系统展示了 Open WebUI 如何处理可选的云依赖：

```mermaid
flowchart TD
    GetProvider["get_storage_provider(provider: str)"]
    Local["LocalStorageProvider 无额外依赖"]
    S3Check["boto3 是否可用？"]
    GCSCheck["google.cloud.storage 是否可用？"]
    AzureCheck["azure.storage.blob 是否可用？"]
    S3["S3StorageProvider"]
    Error1["RuntimeError"]
    GCS["GCSStorageProvider"]
    Error2["RuntimeError"]
    Azure["AzureStorageProvider"]
    Error3["RuntimeError"]

    GetProvider --> Local
    GetProvider --> S3Check
    GetProvider --> GCSCheck
    GetProvider --> AzureCheck
    S3Check -- 是 --> S3
    S3Check -- 否 --> Error1
    GCSCheck -- 是 --> GCS
    GCSCheck -- 否 --> Error2
    AzureCheck -- 是 --> Azure
    AzureCheck -- 否 --> Error3
```
其实现依赖于基础安装中始终存在的包：

| 提供商 | 所需包名 | 安装状态 |
| --- | --- | --- |
| S3 | `boto3`, `botocore` | 始终安装 (基础版) |
| GCS | `google-cloud-storage`, `google-api-python-client` | 始终安装 (基础版) |
| Azure | `azure-storage-blob`, `azure-identity` | 始终安装 (基础版) |

**导入模式：**

```python
# backend/open_webui/storage/provider.py:9-34
import boto3
from google.cloud import storage
from azure.identity import DefaultAzureCredential
from azure.storage.blob import BlobServiceClient
```
所有云存储依赖项都会被无条件导入，因为它们已包含在基础 `requirements.txt` 中。

**来源：** [backend/open\_webui/storage/provider.py1-377](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L1-L377) [backend/requirements.txt97-116](https://github.com/open-webui/open-webui/blob/a7271532/backend/requirements.txt#L97-L116)

### 向量数据库的条件加载

```mermaid
flowchart TD
    Config["向量数据库配置 VECTOR_DB 环境变量"]
    ChromaAlways["ChromaDB (始终可用)"]
    WeaviateAlways["Weaviate (始终可用)"]
    MilvusOpt["Milvus (可选: all 组)"]
    QdrantOpt["Qdrant (可选: all 组)"]
    PineconeOpt["Pinecone (可选: all 组)"]
    PGVectorOpt["pgvector (可选: postgres 组)"]
    Required["位于 requirements.txt 中"]
    Optional["位于 all extras 中"]
    PostgresGroup["位于 postgres extras 中"]

    Config --> ChromaAlways
    Config --> WeaviateAlways
    Config --> MilvusOpt
    Config --> QdrantOpt
    Config --> PineconeOpt
    Config --> PGVectorOpt
    ChromaAlways --> Required
    WeaviateAlways --> Required
    MilvusOpt --> Optional
    QdrantOpt --> Optional
    PineconeOpt --> Optional
    PGVectorOpt --> PostgresGroup
```
**基础安装中的向量数据库** (始终可用)：

-   `chromadb==1.1.0` - 默认向量存储。
-   `weaviate-client==4.17.0` - Weaviate 支持。
-   `opensearch-py==2.8.0` - OpenSearch 支持。

**可选向量数据库** (需要 `[all]` 组)：

-   `qdrant-client==1.14.3` - Qdrant 支持。
-   `pymilvus==2.6.4` - Milvus 支持。
-   `pinecone==6.0.2` - Pinecone 云服务支持。
-   `elasticsearch==9.1.0` - Elasticsearch 支持。

**PostgreSQL 向量扩展** (需要 `[postgres]` 组)：

-   `pgvector==0.4.1` - PostgreSQL 中的向量相似度。

**来源：** [backend/requirements.txt51-123](https://github.com/open-webui/open-webui/blob/a7271532/backend/requirements.txt#L51-L123) [pyproject.toml132-158](https://github.com/open-webui/open-webui/blob/a7271532/pyproject.toml#L132-L158)

## 测试依赖项

### 测试框架依赖

`all` 可选组包含全面的测试基础设施：

```mermaid
flowchart TD
    PyTest["pytest~=8.3.2 核心测试框架"]
    PyTestDocker["pytest-docker~=3.2.5 Docker 固件"]
    Docker["docker~=7.1.0 容器管理"]
    Playwright["playwright==1.56.0 浏览器自动化"]
    MotoS3["moto[s3]>=5.0.26 AWS S3 模拟器"]
    GCSEmulator["gcp-storage-emulator>=2024.8.3 GCS 模拟器"]
    StorageTests["存储提供商测试"]
    VectorDBTests["向量数据库测试"]
    IntegrationTests["集成测试"]

    PyTest --> StorageTests
    PyTestDocker --> IntegrationTests
    Docker --> IntegrationTests
    Playwright --> IntegrationTests
    MotoS3 --> StorageTests
    GCSEmulator --> StorageTests
```
### 存储提供商测试模式

测试展示了模拟器如何替换真实的云服务：

**使用 Moto 进行 S3 测试：**

```python
# 使用 @mock_aws 装饰器
# backend/open_webui/test/apps/webui/storage/test_provider.py:100-189
@mock_aws
class TestS3StorageProvider:
    def __init__(self):
        self.Storage = provider.S3StorageProvider()
        self.s3_client = boto3.resource("s3", region_name="us-east-1")
```
**使用模拟器进行 GCS 测试：**

```python
# 使用 gcp_storage_emulator 服务器
# backend/open_webui/test/apps/webui/storage/test_provider.py:202-292
@pytest.fixture(scope="class")
def setup(self):
    host, port = "localhost", 9023
    server = create_server(host, port, in_memory=True)
    server.start()
    os.environ["STORAGE_EMULATOR_HOST"] = f"http://{host}:{port}"
```
**使用 Mock 进行 Azure 测试：**

```python
# 使用 unittest.mock.MagicMock
# backend/open_webui/test/apps/webui/storage/test_provider.py:294-436
mock_blob_service_client = MagicMock()
mock_container_client = MagicMock()
```
**来源：** [backend/open\_webui/test/apps/webui/storage/test\_provider.py1-436](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/test/apps/webui/storage/test_provider.py#L1-L436) [pyproject.toml137-158](https://github.com/open-webui/open-webui/blob/a7271532/pyproject.toml#L137-L158)

## 最小化安装

对于资源受限的环境或物理隔离 (air-gapped) 的部署，Open WebUI 提供了一个最小 requirements 文件：

```mermaid
flowchart TD
    Core["核心框架 FastAPI, Uvicorn, Pydantic"]
    Auth["身份验证 JWT, bcrypt, OAuth"]
    HTTP["HTTP 客户端 httpx, aiohttp, requests"]
    DB["基础数据库 SQLAlchemy, Alembic, Peewee"]
    RT["实时特性 Socket.IO, Redis, pycrdt"]
    AI["最小 AI OpenAI 客户端, MCP, LangChain"]
    VectorMin["基础向量 仅 ChromaDB"]
    MinimalDeployment["最小化部署"]
    FullDeployment["标准部署"]
    RequirementsTxt["requirements.txt + 文档处理 + 多个向量数据库 + 云存储 + 网页抓取"]

    MinimalDeployment --> Core
    MinimalDeployment --> Auth
    MinimalDeployment --> HTTP
    MinimalDeployment --> DB
    MinimalDeployment --> RT
    MinimalDeployment --> AI
    MinimalDeployment --> VectorMin
    FullDeployment --> RequirementsTxt
```
**最小化安装排除的内容：**

-   文档处理库 (pypdf, python-pptx, docx2txt 等)。
-   计算机视觉 (opencv, pillow)。
-   音频处理 (faster-whisper, pydub)。
-   OCR 与高级提取 (rapidocr, unstructured)。
-   机器学习模型 (sentence-transformers, transformers)。
-   备选向量数据库 (weaviate, milvus, qdrant)。
-   云特定 SDK (详细的 Azure/GCS 包)。
-   网页自动化 (playwright, selenium)。

**最小化安装包含的内容：**

-   带有 ChromaDB 的基础 RAG。
-   OpenAI API 兼容性。
-   SQLite 或 PostgreSQL (手动安装)。
-   用于实时特性的 Redis。
-   核心 LangChain 功能。

**来源：** [backend/requirements-min.txt1-52](https://github.com/open-webui/open-webui/blob/a7271532/backend/requirements-min.txt#L1-L52)

## 依赖版本管理

### 版本锁定策略

Open WebUI 对大多数依赖项使用严格的版本锁定，以确保可重现性：

| 类别 | 锁定策略 | 示例 |
| --- | --- | --- |
| 核心框架 | 精确版本 | `fastapi==0.123.0` |
| AI 库 | 精确版本 | `openai`, `anthropic` (未锁定) |
| 向量数据库 | 精确版本 | `chromadb==1.1.0` |
| 云 SDK | 精确版本 | `boto3==1.41.5` |
| 测试 | 兼容版本 (`~=`) | `pytest~=8.3.2` |
| 模拟器 | 最小版本 (`>=`) | `moto[s3]>=5.0.26` |

### 锁定文件

`uv.lock` 文件为所有平台提供可重现的构建，包含：

-   已解析的依赖树。
-   特定平台的轮子 (wheels)。
-   用于完整性验证的内容哈希。
-   针对不同 Python 版本和平台的解析标记。

**来源：** [pyproject.toml8-117](https://github.com/open-webui/open-webui/blob/a7271532/pyproject.toml#L8-L117) [uv.lock1-17](https://github.com/open-webui/open-webui/blob/a7271532/uv.lock#L1-L17)

## 常见安装场景

### 使用 PostgreSQL 的生产环境部署

```bash
pip install open-webui[postgres]
export DATABASE_URL="postgresql://user:pass@host:5432/db"
export VECTOR_DB="pgvector"  # 向量也使用 PostgreSQL
```
### 开发环境

```bash
pip install open-webui[all]
# 或者直接从 requirements.txt 安装
pip install -r backend/requirements.txt
```
### 物理隔离/最小化部署

```bash
pip install -r backend/requirements-min.txt
# 手动复制 ChromaDB 数据目录
# SQLite 数据库是可移植的
```
### 带有自定义依赖项的 Docker

```dockerfile
FROM python:3.11
COPY backend/requirements.txt .
# 安装基础版 + 特定的额外项
RUN pip install -r requirements.txt
# 或者: RUN pip install open-webui[postgres]
```
**来源：** [.github/workflows/integration-test.disabled141-153](https://github.com/open-webui/open-webui/blob/a7271532/.github/workflows/integration-test.disabled#L141-L153) [pyproject.toml160-193](https://github.com/open-webui/open-webui/blob/a7271532/pyproject.toml#L160-L193)

## 可选依赖项故障排除

### 缺失依赖错误

**症状：** 运行时出现 `ImportError` 或 `ModuleNotFoundError`。

**常见原因：**

-   使用了需要可选依赖项的功能。
-   未安装 `[all]` 组就尝试配置 Qdrant/Milvus/Pinecone。
-   未安装 `[postgres]` 组就使用 PostgreSQL。

**解决方案：**

```bash
# 安装缺失的组
pip install open-webui[postgres,all]

# 或者安装特定的包
pip install qdrant-client==1.14.3
```
### 版本冲突

**症状：** 安装期间出现依赖解析器错误。

**常见原因：**

-   来自其它项目的冲突包版本。
-   平台特定问题（尤其是 ARM/树莓派）。

**解决方案：**

```bash
# 使用虚拟环境
python -m venv venv
source venv/bin/activate
pip install open-webui[postgres]

# 或者使用 uv 以获得更好的解析效果
uv pip install open-webui[postgres]
```
### 平台特定问题

某些依赖项具有平台特定的约束：

-   **树莓派：** 为适配兼容性，`pyarrow==20.0.0` 已锁定 ([requirements.txt58](https://github.com/open-webui/open-webui/blob/a7271532/requirements.txt#L58-L58))。
-   **FIPS 系统：** `av==14.0.1` 已锁定以避免 FIPS 自检失败 ([requirements.txt125](https://github.com/open-webui/open-webui/blob/a7271532/requirements.txt#L125-L125))。
-   **ARM 系统：** 某些机器学习依赖项可能需要系统库。

**来源：** [backend/requirements.txt58-125](https://github.com/open-webui/open-webui/blob/a7271532/backend/requirements.txt#L58-L125)
