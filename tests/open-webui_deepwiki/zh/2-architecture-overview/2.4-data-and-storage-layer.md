# 数据与存储层

相关源文件

-   [.github/workflows/integration-test.disabled](https://github.com/open-webui/open-webui/blob/a7271532/.github/workflows/integration-test.disabled)
-   [backend/open\_webui/config.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/config.py)
-   [backend/open\_webui/main.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/main.py)
-   [backend/open\_webui/retrieval/loaders/datalab\_marker.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/retrieval/loaders/datalab_marker.py)
-   [backend/open\_webui/retrieval/loaders/external\_document.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/retrieval/loaders/external_document.py)
-   [backend/open\_webui/retrieval/loaders/external\_web.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/retrieval/loaders/external_web.py)
-   [backend/open\_webui/retrieval/loaders/main.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/retrieval/loaders/main.py)
-   [backend/open\_webui/retrieval/loaders/mineru.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/retrieval/loaders/mineru.py)
-   [backend/open\_webui/retrieval/loaders/mistral.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/retrieval/loaders/mistral.py)
-   [backend/open\_webui/retrieval/utils.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/retrieval/utils.py)
-   [backend/open\_webui/routers/retrieval.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/routers/retrieval.py)
-   [backend/open\_webui/storage/provider.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py)
-   [backend/open\_webui/test/apps/webui/storage/test\_provider.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/test/apps/webui/storage/test_provider.py)
-   [backend/open\_webui/utils/middleware.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/utils/middleware.py)
-   [backend/requirements-min.txt](https://github.com/open-webui/open-webui/blob/a7271532/backend/requirements-min.txt)
-   [backend/requirements.txt](https://github.com/open-webui/open-webui/blob/a7271532/backend/requirements.txt)
-   [docker-compose.playwright.yaml](https://github.com/open-webui/open-webui/blob/a7271532/docker-compose.playwright.yaml)
-   [pyproject.toml](https://github.com/open-webui/open-webui/blob/a7271532/pyproject.toml)
-   [src/lib/apis/retrieval/index.ts](https://github.com/open-webui/open-webui/blob/a7271532/src/lib/apis/retrieval/index.ts)
-   [src/lib/components/admin/Settings/Documents.svelte](https://github.com/open-webui/open-webui/blob/a7271532/src/lib/components/admin/Settings/Documents.svelte)
-   [src/lib/components/admin/Settings/WebSearch.svelte](https://github.com/open-webui/open-webui/blob/a7271532/src/lib/components/admin/Settings/WebSearch.svelte)
-   [uv.lock](https://github.com/open-webui/open-webui/blob/a7271532/uv.lock)

## 目的和范围

本文档描述了 Open WebUI 的数据持久化架构，该架构由三个主要层级组成：用于结构化数据的关系型数据库（PostgreSQL 或 SQLite）、用于缓存和分布式状态管理的 Redis，以及用于语义搜索能力的向量数据库。此外，系统实现了一个文件存储抽象层，支持本地文件系统和多种云提供商。

有关数据库模型及其关系的信息，请参阅特定的路由文档（例如，关于聊天数据结构的 [3](/open-webui/open-webui/3-installation-and-deployment)）。有关实时通信机制的信息，请参阅[实时通信](/open-webui/open-webui/8-navigation-and-organization)。

---

## 系统架构概览

### 多层存储架构

```mermaid
flowchart TD
    FastAPI["FastAPI 应用程序 backend/open_webui/main.py"]
    SocketIO["Socket.IO 服务器 backend/open_webui/socket/main.py"]
    Session["SQLAlchemy 会话 backend/open_webui/internal/db.py"]
    RedisClient["Redis 客户端 backend/open_webui/utils/redis.py"]
    VectorClient["VECTOR_DB_CLIENT backend/open_webui/retrieval/vector/factory.py"]
    StorageProvider["存储提供商 backend/open_webui/storage/provider.py"]
    PostgreSQL["PostgreSQL (生产环境)"]
    SQLite["SQLite (开发环境)"]
    RedisStandalone["Redis 单机模式"]
    RedisSentinel["Redis Sentinel (高可用)"]
    RedisCluster["Redis 集群模式"]
    ChromaDB["ChromaDB (默认)"]
    Weaviate["Weaviate"]
    Milvus["Milvus"]
    Qdrant["Qdrant"]
    PGVector["pgvector"]
    Others["Pinecone/OpenSearch"]
    LocalFS["本地文件系统 UPLOAD_DIR"]
    S3["AWS S3"]
    GCS["Google Cloud Storage"]
    Azure["Azure Blob Storage"]

    FastAPI --> Session
    FastAPI --> RedisClient
    FastAPI --> VectorClient
    FastAPI --> StorageProvider
    SocketIO --> RedisClient
    Session --> PostgreSQL
    Session --> SQLite
    RedisClient --> RedisStandalone
    RedisClient --> RedisSentinel
    RedisClient --> RedisCluster
    VectorClient --> ChromaDB
    VectorClient --> Weaviate
    VectorClient --> Milvus
    VectorClient --> Qdrant
    VectorClient --> PGVector
    VectorClient --> Others
    StorageProvider --> LocalFS
    StorageProvider --> S3
    StorageProvider --> GCS
    StorageProvider --> Azure
```
**来源：** [backend/open\_webui/main.py105-106](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/main.py#L105-L106) [backend/open\_webui/socket/main.py59-164](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/socket/main.py#L59-L164) [backend/open\_webui/utils/redis.py1-100](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/utils/redis.py#L1-L100) [backend/open\_webui/storage/provider.py1-50](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L1-L50)

---

## 主数据库系统

### 数据库连接管理

Open WebUI 使用 SQLAlchemy 作为 ORM 层，支持 PostgreSQL（生产环境）和 SQLite（开发/单用户部署）。数据库在 `backend/open_webui/internal/db.py` 中初始化。

```mermaid
flowchart TD
    ENV["DATABASE_URL 环境变量"]
    PG_URL["postgresql://..."]
    SQLITE_URL["sqlite:///webui.db"]
    Engine["create_engine() backend/open_webui/internal/db.py"]
    SessionMaker["sessionmaker 会话工厂"]
    Base["declarative_base() 模型基类"]
    User["User backend/open_webui/models/users.py"]
    Chat["Chat backend/open_webui/models/chats.py"]
    File["File backend/open_webui/models/files.py"]
    Knowledge["Knowledge backend/open_webui/models/knowledge.py"]
    Function["Function backend/open_webui/models/functions.py"]
    Model["Model backend/open_webui/models/models.py"]
    Config["Config backend/open_webui/config.py"]
    Alembic["Alembic backend/open_webui/alembic.ini"]
    Migrations["migrations/ 迁移脚本"]

    ENV --> PG_URL
    ENV --> SQLITE_URL
    PG_URL --> Engine
    SQLITE_URL --> Engine
    Engine --> SessionMaker
    Base --> User
    Base --> Chat
    Base --> File
    Base --> Knowledge
    Base --> Function
    Base --> Model
    Base --> Config
    Alembic --> Migrations
    Migrations --> Engine
```
**数据库 URL 配置：**

系统根据 `DATABASE_URL` 环境变量选择数据库：

-   PostgreSQL：`postgresql://user:password@host:port/dbname`
-   SQLite：`sqlite:///path/to/webui.db`（默认：`DATA_DIR/webui.db`）

**来源：** [backend/open\_webui/env.py1-100](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/env.py#L1-L100) [backend/open\_webui/config.py52-70](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/config.py#L52-L70)

### 模式迁移系统 (Schema Migration)

系统使用 Alembic 进行数据库模式迁移：

```mermaid
flowchart TD
    App["应用程序启动 backend/open_webui/main.py"]
    RunMig["run_migrations() backend/open_webui/config.py:53-68"]
    AlembicCfg["Alembic 配置 backend/open_webui/alembic.ini"]
    MigDir["migrations/ 后端迁移脚本"]
    DBEngine["数据库引擎"]

    App --> RunMig
    RunMig --> AlembicCfg
    AlembicCfg --> MigDir
    MigDir --> DBEngine
```
迁移会在应用程序启动时通过 `run_migrations()` 自动运行，该函数使用 `alembic.command.upgrade(alembic_cfg, "head")`。

**来源：** [backend/open\_webui/config.py52-70](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/config.py#L52-L70)

### 核心数据库模型

| 模型 | 用途 | 关键字段 | 文件路径 |
| --- | --- | --- | --- |
| `User` | 用户帐户和身份验证 | `id`, `email`, `name`, `role`, `profile_image_url` | `backend/open_webui/models/users.py` |
| `Chat` | 聊天对话和历史记录 | `id`, `user_id`, `title`, `chat`, `created_at` | `backend/open_webui/models/chats.py` |
| `File` | 上传文件的元数据 | `id`, `user_id`, `filename`, `path`, `data` | `backend/open_webui/models/files.py` |
| `Knowledge` | 知识库集合 | `id`, `user_id`, `name`, `description`, `data` | `backend/open_webui/models/knowledge.py` |
| `Function` | 自定义函数和工具 | `id`, `user_id`, `name`, `type`, `content` | `backend/open_webui/models/functions.py` |
| `Model` | 模型配置 | `id`, `user_id`, `base_model_id`, `name`, `params` | `backend/open_webui/models/models.py` |
| `Config` | 应用程序配置 | `id`, `data`, `version`, `updated_at` | `backend/open_webui/config.py:73-81` |

**来源：** [backend/open\_webui/models/users.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/models/users.py) [backend/open\_webui/models/chats.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/models/chats.py) [backend/open\_webui/models/files.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/models/files.py) [backend/open\_webui/models/knowledge.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/models/knowledge.py) [backend/open\_webui/config.py73-81](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/config.py#L73-L81)

### 会话管理模式

数据库会话使用上下文管理器模式进行管理：

```
# backend/open_webui/internal/db.py
with get_db() as db:
    user = db.query(User).filter(User.id == user_id).first()
```
`get_db()` 函数产生 (yield) 一个会话，并通过 `try/finally` 块确保正确的清理。

**来源：** [backend/open\_webui/internal/db.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/internal/db.py)

---

## Redis 缓存与分布式状态

### Redis 连接架构

```mermaid
flowchart TD
    REDIS_URL["REDIS_URL"]
    REDIS_SENTINEL["REDIS_SENTINEL_HOSTS REDIS_SENTINEL_PORT"]
    REDIS_CLUSTER["REDIS_CLUSTER"]
    GetRedis["get_redis_connection() backend/open_webui/utils/redis.py:100-200"]
    Standalone["redis.Redis 单实例"]
    Sentinel["redis.Sentinel 高可用"]
    Cluster["redis.RedisCluster 水平扩展"]
    Sync["同步客户端 decode_responses=True"]
    Async["异步客户端 redis.asyncio"]
    AppState["app.state.redis backend/open_webui/main.py:582-589"]
    SessionStore["RedisStore StarSessionsMiddleware"]
    SocketRedis["REDIS backend/open_webui/socket/main.py"]

    REDIS_URL --> GetRedis
    REDIS_SENTINEL --> GetRedis
    REDIS_CLUSTER --> GetRedis
    GetRedis --> Standalone
    GetRedis --> Sentinel
    GetRedis --> Cluster
    Standalone --> Sync
    Standalone --> Async
    Sentinel --> Sync
    Sentinel --> Async
    Cluster --> Sync
    Cluster --> Async
    Async --> AppState
    Sync --> SessionStore
    Async --> SocketRedis
```
**配置选项：**

| 环境变量 | 用途 | 默认值 |
| --- | --- | --- |
| `REDIS_URL` | Redis 连接 URL | None (Redis 禁用) |
| `REDIS_SENTINEL_HOSTS` | 逗号分隔的 Sentinel 主机列表 | 空 |
| `REDIS_SENTINEL_PORT` | Sentinel 端口 | 26379 |
| `REDIS_CLUSTER` | 启用集群模式 | False |
| `REDIS_KEY_PREFIX` | 键命名空间前缀 | "open-webui" |

**来源：** [backend/open\_webui/utils/redis.py100-200](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/utils/redis.py#L100-L200) [backend/open\_webui/env.py1-100](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/env.py#L1-L100)

### 分布式状态管理

Redis 用于在多个 Open WebUI 实例之间同步状态：

```mermaid
flowchart TD
    App1["实例 1 main.py"]
    App2["实例 2 main.py"]
    App3["实例 3 main.py"]
    SessionPool["SESSION_POOL RedisDict 键: session_id 值: user_data"]
    UsagePool["USAGE_POOL RedisDict 键: model_id 值: active_users"]
    YdocStorage["Ydoc 文档 RedisDict 键: document_id 值: Y.Doc state"]
    ConfigCache["配置缓存 Redis Keys 模式: open-webui:config:*"]
    TaskRegistry["任务注册表 Redis Hash 键: open-webui:tasks"]
    PubSub["Redis 发布/订阅 任务命令频道"]
    Lock["RedisLock 分布式锁"]

    App1 --> SessionPool
    App2 --> SessionPool
    App3 --> SessionPool
    App1 --> UsagePool
    App2 --> UsagePool
    App3 --> UsagePool
    App1 --> YdocStorage
    App2 --> YdocStorage
    App3 --> YdocStorage
    App1 --> ConfigCache
    App2 --> ConfigCache
    App3 --> ConfigCache
    App1 --> TaskRegistry
    App2 --> TaskRegistry
    App3 --> TaskRegistry
    App1 --> PubSub
    App2 --> PubSub
    App3 --> PubSub
    App1 --> Lock
    App2 --> Lock
    App3 --> Lock
```
**来源：** [backend/open\_webui/socket/main.py122-164](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/socket/main.py#L122-L164) [backend/open\_webui/socket/utils.py1-50](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/socket/utils.py#L1-L50)

### RedisDict 和 RedisLock 实用程序

系统在 [backend/open\_webui/socket/utils.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/socket/utils.py) 中实现了自定义的 Redis 数据结构：

**RedisDict:**

-   基于 Redis Hash 操作的包装器
-   提供类似字典的接口 (`__getitem__`, `__setitem__`, `__delitem__`)
-   将值序列化为 JSON 存储
-   用于 `SESSION_POOL`, `USAGE_POOL`, `MODELS`

**RedisLock:**

-   分布式锁定机制
-   使用 `SET key value NX EX` 进行原子锁获取
-   实现针对长时间运行操作的锁续期 (renewal)
-   用于 `periodic_usage_pool_cleanup()`

**来源：** [backend/open\_webui/socket/utils.py9-150](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/socket/utils.py#L9-L150)

### 使用 Redis 进行配置缓存

`AppConfig` 类 [backend/open\_webui/config.py224-284](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/config.py#L224-L284) 实现了一个两层缓存系统：

```mermaid
flowchart TD
    EnvVar["环境变量"]
    PersistentCfg["PersistentConfig 数据库存储"]
    AppCfg["AppConfig 内存缓存"]
    RedisCache["Redis 缓存 键名: open-webui:config:*"]
    API["配置更新 API"]
    SaveDB["save_to_db()"]
    RedisSet["redis.set()"]
    OtherInstance["其他实例"]
    RedisGet["redis.get()"]

    EnvVar --> PersistentCfg
    PersistentCfg --> AppCfg
    API --> SaveDB
    SaveDB --> AppCfg
    AppCfg --> RedisSet
    RedisGet --> OtherInstance
    RedisSet --> RedisGet
```
当配置值更新时：

1.  值通过 `PersistentConfig.save()` 保存到数据库
2.  值通过 `AppConfig.__setattr__` 写入 Redis
3.  其他实例在访问该配置值时从 Redis 读取

**来源：** [backend/open\_webui/config.py224-284](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/config.py#L224-L284)

### 会话存储

HTTP 会话使用 `starsessions` 库存储在 Redis 中：

```
# backend/open_webui/main.py (根据导入推断)
from starsessions.stores.redis import RedisStore

# 会话中间件配置
SessionMiddleware(
    store=RedisStore(redis_url=REDIS_URL),
    cookie_name="session",
    secret_key=WEBUI_SECRET_KEY
)
```
**来源：** [backend/open\_webui/main.py54-58](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/main.py#L54-L58) [backend/requirements.txt22](https://github.com/open-webui/open-webui/blob/a7271532/backend/requirements.txt#L22-L22)

### 任务协调系统

Redis 发布/订阅实现了跨实例的任务管理 [backend/open\_webui/tasks.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/tasks.py)：

```mermaid
flowchart TD
    Instance1["实例 1"]
    Instance2["实例 2"]
    Instance3["实例 3"]
    TaskHash["REDIS_TASKS_KEY Hash: task_id -> item_id"]
    ItemTasks["REDIS_ITEM_TASKS_KEY 每个 item_id 的 Set"]
    PubSubChannel["REDIS_PUBSUB_CHANNEL 任务命令"]

    Instance1 --> TaskHash
    Instance1 --> ItemTasks
    Instance2 --> PubSubChannel
    PubSubChannel --> Instance1
    PubSubChannel --> Instance3
    Instance3 --> TaskHash
```
发布到发布/订阅频道的命令：

```
{
  "action": "stop",
  "task_id": "此处为 uuid"
}
```
任何实例都可以取消在任何其他实例上运行的任务。

**来源：** [backend/open\_webui/tasks.py1-150](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/tasks.py#L1-L150) [backend/open\_webui/main.py591-594](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/main.py#L591-L594)

### Ydoc 协作文档存储

`YdocManager` [backend/open\_webui/socket/utils.py150-250](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/socket/utils.py#L150-L250) 将 CRDT 文档存储在 Redis 中，用于实现实时协作编辑：

```mermaid
flowchart TD
    User1["用户 1 浏览器"]
    User2["用户 2 浏览器"]
    YdocMgr["YdocManager backend/open_webui/socket/utils.py"]
    DocState["文档状态 键名: open-webui:ydoc:documents:DOC_ID:state"]
    DocUsers["活跃用户 键名: open-webui:ydoc:documents:DOC_ID:users"]
    UpdateQueue["更新队列 列表: open-webui:ydoc:documents:DOC_ID:updates"]

    User1 --> YdocMgr
    User2 --> YdocMgr
    YdocMgr --> UpdateQueue
    YdocMgr --> DocState
    YdocMgr --> DocUsers
    UpdateQueue --> YdocMgr
    DocState --> YdocMgr
    DocUsers --> YdocMgr
```
Ydoc 系统存储：

-   **文档状态**：二进制编码的 Y.Doc 状态
-   **更新队列**：用于同步的近期更改
-   **活跃用户**：当前正在编辑的用户 ID 集合

**来源：** [backend/open\_webui/socket/utils.py150-250](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/socket/utils.py#L150-L250) [backend/requirements.txt29](https://github.com/open-webui/open-webui/blob/a7271532/backend/requirements.txt#L29-L29)

---

## 向量数据库集成

### 向量数据库抽象

系统通过 `VECTOR_DB_CLIENT` 为多种向量数据库提供统一接口：

```mermaid
flowchart TD
    RAGRouter["RAG 路由 backend/open_webui/routers/retrieval.py"]
    Middleware["RAG 中间件 backend/open_webui/utils/middleware.py"]
    VectorFactory["VECTOR_DB_CLIENT backend/open_webui/retrieval/vector/factory.py"]
    BaseClient["VectorDBClient 抽象基类"]
    Chroma["ChromaClient backend/open_webui/retrieval/vector/dbs/chroma.py"]
    Weaviate["WeaviateClient backend/open_webui/retrieval/vector/dbs/weaviate.py"]
    Milvus["MilvusClient backend/open_webui/retrieval/vector/dbs/milvus.py"]
    Qdrant["QdrantClient backend/open_webui/retrieval/vector/dbs/qdrant.py"]
    PGVector["PGVectorClient backend/open_webui/retrieval/vector/dbs/pgvector.py"]
    OpenSearch["OpenSearchClient backend/open_webui/retrieval/vector/dbs/opensearch.py"]
    Pinecone["PineconeClient backend/open_webui/retrieval/vector/dbs/pinecone.py"]

    RAGRouter --> VectorFactory
    Middleware --> VectorFactory
    VectorFactory --> BaseClient
    BaseClient --> Chroma
    BaseClient --> Weaviate
    BaseClient --> Milvus
    BaseClient --> Qdrant
    BaseClient --> PGVector
    BaseClient --> OpenSearch
    BaseClient --> Pinecone
```
**来源：** [backend/open\_webui/retrieval/vector/factory.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/retrieval/vector/factory.py) [backend/open\_webui/config.py1-50](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/config.py#L1-L50)

### 向量数据库客户端接口

所有向量数据库客户端都实现了一个通用接口：

| 方法 | 用途 | 返回值 |
| --- | --- | --- |
| `insert(collection_name, vectors, documents, metadatas, ids)` | 插入嵌入 | None |
| `upsert(collection_name, vectors, documents, metadatas, ids)` | 插入或更新 | None |
| `search(collection_name, vectors, limit)` | 相似度搜索 | `GetResult` |
| `get(collection_name, ids=None, where=None)` | 获取文档 | `GetResult` |
| `delete(collection_name, ids)` | 删除文档 | None |
| `reset()` | 删除所有集合 | None |
| `has_collection(collection_name)` | 检查是否存在 | bool |
| `delete_collection(collection_name)` | 删除集合 | None |

**GetResult 结构：**

```
class GetResult:
    ids: list[list[str]]
    documents: list[list[str]]
    metadatas: list[list[dict]]
    distances: list[list[float]]  # 仅在搜索结果中包含
```
**来源：** [backend/open\_webui/retrieval/vector/main.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/retrieval/vector/main.py)

### 嵌入与检索流程

```mermaid
flowchart TD
    Upload["文件上传"]
    Loader["文档加载器 backend/open_webui/retrieval/loaders/main.py"]
    Splitter["文本分割器 RecursiveCharacterTextSplitter"]
    EmbedFunc["嵌入函数 get_embedding_function()"]
    Insert["VECTOR_DB_CLIENT.insert()"]
    Query["用户查询"]
    QueryEmbed["生成查询嵌入"]
    VectorSearch["VECTOR_DB_CLIENT.search()"]
    Rerank["重排序函数 CrossEncoder/ColBERT"]
    Results["检索出的文档"]
    BM25["BM25Retriever 关键字搜索"]
    VectorRet["VectorSearchRetriever 语义搜索"]
    Ensemble["EnsembleRetriever 合并结果"]
    Compress["ContextualCompressionRetriever 应用重排序"]

    Query --> QueryEmbed
    QueryEmbed --> VectorSearch
    VectorSearch --> Rerank
    Rerank --> Results
    Query --> BM25
    Query --> VectorRet
    BM25 --> Ensemble
    VectorRet --> Ensemble
    Ensemble --> Compress
    Compress --> Results
    Upload --> Loader
    Loader --> Splitter
    Splitter --> EmbedFunc
    EmbedFunc --> Insert
```
**来源：** [backend/open\_webui/retrieval/utils.py88-315](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/retrieval/utils.py#L88-L315) [backend/open\_webui/routers/retrieval.py1-100](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/routers/retrieval.py#L1-L100)

### 嵌入函数配置

系统支持多种嵌入引擎：

| 引擎 | 实现方式 | 配置项 |
| --- | --- | --- |
| 本地 (Local) | `SentenceTransformer` | `RAG_EMBEDDING_MODEL` (HuggingFace 模型) |
| OpenAI | OpenAI API | `RAG_OPENAI_API_BASE_URL`, `RAG_OPENAI_API_KEY` |
| Ollama | Ollama API | `RAG_OLLAMA_BASE_URL`, `RAG_OLLAMA_API_KEY` |
| Azure OpenAI | Azure API | `RAG_AZURE_OPENAI_BASE_URL`, `RAG_AZURE_OPENAI_API_KEY` |

嵌入函数在启动时初始化 [backend/open\_webui/main.py985-1041](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/main.py#L985-L1041)，并存储在 `app.state.EMBEDDING_FUNCTION` 中。

**来源：** [backend/open\_webui/retrieval/utils.py400-500](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/retrieval/utils.py#L400-L500) [backend/open\_webui/main.py985-1041](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/main.py#L985-L1041)

### 混合搜索实现

当启用 `ENABLE_RAG_HYBRID_SEARCH` 时，系统会同时使用向量相似度和 BM25 关键字匹配：

```
# backend/open_webui/retrieval/utils.py:207-315
bm25_retriever = BM25Retriever.from_texts(
    texts=collection_result.documents[0],
    metadatas=collection_result.metadatas[0]
)

vector_search_retriever = VectorSearchRetriever(
    collection_name=collection_name,
    embedding_function=embedding_function,
    top_k=k
)

ensemble_retriever = EnsembleRetriever(
    retrievers=[bm25_retriever, vector_search_retriever],
    weights=[hybrid_bm25_weight, 1.0 - hybrid_bm25_weight]
)
```
随后，使用 CrossEncoder 或 ColBERT 模型对结果进行重排序，以提高相关性。

**来源：** [backend/open\_webui/retrieval/utils.py207-315](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/retrieval/utils.py#L207-L315)

---

## 文件存储提供商

### 存储提供商抽象

Open WebUI 为文件存储实现了一个提供商模式：

```mermaid
flowchart TD
    StorageProvider["StorageProvider (抽象基类) backend/open_webui/storage/provider.py:43-61"]
    Local["LocalStorageProvider 第 63-106 行"]
    S3["S3StorageProvider 第 108-200 行"]
    GCS["GCSStorageProvider 第 202-300 行"]
    Azure["AzureStorageProvider 第 302-400 行"]
    Factory["get_storage_provider() STORAGE_PROVIDER 环境变量"]
    CurrentStorage["Storage (全局) 单例实例"]

    StorageProvider --> Local
    StorageProvider --> S3
    StorageProvider --> GCS
    StorageProvider --> Azure
    Factory --> Local
    Factory --> S3
    Factory --> GCS
    Factory --> Azure
    Factory --> CurrentStorage
```
**来源：** [backend/open\_webui/storage/provider.py1-450](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L1-L450)

### 存储提供商接口

所有存储提供商都实现这些方法：

```
class StorageProvider(ABC):
    @abstractmethod
    def upload_file(file: BinaryIO, filename: str, tags: Dict[str, str]) -> Tuple[bytes, str]:
        """上传文件并返回 (内容, 文件路径)"""
        pass

    @abstractmethod
    def get_file(file_path: str) -> str:
        """获取用于下载的文件路径"""
        pass

    @abstractmethod
    def delete_file(file_path: str) -> None:
        """删除文件"""
        pass

    @abstractmethod
    def delete_all_files() -> None:
        """删除所有文件"""
        pass
```
**来源：** [backend/open\_webui/storage/provider.py43-61](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L43-L61)

### 本地存储提供商

默认的提供商将文件存储在 `UPLOAD_DIR` 中：

```
# backend/open_webui/storage/provider.py:63-106
class LocalStorageProvider(StorageProvider):
    @staticmethod
    def upload_file(file: BinaryIO, filename: str, tags: Dict[str, str]) -> Tuple[bytes, str]:
        contents = file.read()
        file_path = f"{UPLOAD_DIR}/{filename}"
        with open(file_path, "wb") as f:
            f.write(contents)
        return contents, file_path
```
**配置：**

-   `UPLOAD_DIR`：文件存储的基础目录（默认：`DATA_DIR/uploads`）

**来源：** [backend/open\_webui/storage/provider.py63-106](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L63-L106)

### S3 存储提供商

支持 AWS S3 以及兼容 S3 的服务：

```mermaid
flowchart TD
    URL["S3_ENDPOINT_URL (AWS 为 None)"]
    Bucket["S3_BUCKET_NAME"]
    KeyID["S3_ACCESS_KEY_ID"]
    Secret["S3_SECRET_ACCESS_KEY"]
    Region["S3_REGION_NAME"]
    Prefix["S3_KEY_PREFIX"]
    Boto3["boto3.client('s3')"]
    Config["botocore.Config 加速/寻址"]
    Upload["put_object() 带有标签"]
    Download["generate_presigned_url()"]
    Delete["delete_object()"]

    URL --> Boto3
    KeyID --> Boto3
    Secret --> Boto3
    Region --> Boto3
    Config --> Boto3
    Boto3 --> Upload
    Boto3 --> Download
    Boto3 --> Delete
    Bucket --> Upload
    Bucket --> Download
    Bucket --> Delete
    Prefix --> Upload
    Prefix --> Download
    Prefix --> Delete
```
**配置选项：**

| 变量 | 用途 | 默认值 |
| --- | --- | --- |
| `S3_ENDPOINT_URL` | 自定义 S3 端点 (例如 MinIO) | None (AWS S3) |
| `S3_BUCKET_NAME` | 存储桶名称 | 必填 |
| `S3_ACCESS_KEY_ID` | AWS 访问密钥 | 必填 |
| `S3_SECRET_ACCESS_KEY` | AWS 秘密密钥 | 必填 |
| `S3_REGION_NAME` | AWS 区域 | `us-east-1` |
| `S3_KEY_PREFIX` | 对象键前缀 | 空 |
| `S3_USE_ACCELERATE_ENDPOINT` | 启用传输加速 | False |
| `S3_ADDRESSING_STYLE` | 路径式或虚拟托管式 | `auto` |
| `S3_ENABLE_TAGGING` | 添加元数据标签 | True |

**来源：** [backend/open\_webui/storage/provider.py108-200](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L108-L200) [backend/open\_webui/config.py1-100](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/config.py#L1-L100)

### Google Cloud Storage 提供商

通过工作负载身份 (workload identity) 或显式凭据支持 GCS：

```mermaid
flowchart TD
    WorkloadID["工作负载身份 (GKE/Cloud Run)"]
    ExplicitCreds["显式凭据 GOOGLE_APPLICATION_CREDENTIALS_JSON"]
    StorageClient["storage.Client()"]
    DefaultCreds["DefaultAzureCredential()"]
    JSONCreds["service_account.Credentials"]
    Upload["bucket.blob().upload_from_file()"]
    Download["blob.generate_signed_url()"]
    Delete["blob.delete()"]

    WorkloadID --> DefaultCreds
    ExplicitCreds --> JSONCreds
    DefaultCreds --> StorageClient
    JSONCreds --> StorageClient
    StorageClient --> Upload
    StorageClient --> Download
    StorageClient --> Delete
```
**配置：**

-   `GCS_BUCKET_NAME`：存储桶名称
-   `GOOGLE_APPLICATION_CREDENTIALS_JSON`：JSON 凭据（如果使用工作负载身份则可选）

**来源：** [backend/open\_webui/storage/provider.py202-300](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L202-L300)

### Azure Blob Storage 提供商

通过工作负载身份或存储密钥支持 Azure Blob Storage：

```mermaid
flowchart TD
    WorkloadID["工作负载身份 DefaultAzureCredential"]
    StorageKey["存储账号密钥 AZURE_STORAGE_KEY"]
    BlobService["BlobServiceClient"]
    Container["ContainerClient"]
    Upload["blob_client.upload_blob()"]
    Download["blob_client.generate_blob_sas()"]
    Delete["blob_client.delete_blob()"]

    WorkloadID --> BlobService
    StorageKey --> BlobService
    BlobService --> Container
    Container --> Upload
    Container --> Download
    Container --> Delete
```
**配置：**

-   `AZURE_STORAGE_ENDPOINT`：存储账号端点
-   `AZURE_STORAGE_CONTAINER_NAME`：容器名称
-   `AZURE_STORAGE_KEY`：账号密钥（如果使用工作负载身份则可选）

**来源：** [backend/open\_webui/storage/provider.py302-400](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L302-L400)

### 存储提供商选择

活跃的存储提供商在启动时确定：

```
# backend/open_webui/storage/provider.py:450-500
STORAGE_PROVIDER = os.getenv("STORAGE_PROVIDER", "local")

Storage = get_storage_provider(STORAGE_PROVIDER)
```
支持的值：

-   `local`: LocalStorageProvider
-   `s3`: S3StorageProvider
-   `gcs`: GCSStorageProvider
-   `azure`: AzureStorageProvider

**来源：** [backend/open\_webui/storage/provider.py450-500](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/storage/provider.py#L450-L500)

---

## 配置系统

### 环境驱动配置

Open WebUI 使用一个双层配置系统：

```mermaid
flowchart TD
    EnvVars["环境变量 backend/open_webui/env.py"]
    DBConfig["数据库配置 Config 表"]
    PersistentCfg["PersistentConfig backend/open_webui/config.py:165-222"]
    AppConfig["AppConfig backend/open_webui/config.py:224-284"]
    AppState["app.state.config backend/open_webui/main.py:646-651"]
    RedisCache["Redis 配置缓存 键名: open-webui:config:*"]

    EnvVars --> PersistentCfg
    DBConfig --> PersistentCfg
    PersistentCfg --> AppConfig
    AppConfig --> AppState
    AppConfig --> RedisCache
    RedisCache --> AppConfig
```
**来源：** [backend/open\_webui/config.py165-284](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/config.py#L165-L284) [backend/open\_webui/main.py646-651](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/main.py#L646-L651)

### PersistentConfig 模式

配置值可以在运行时被覆盖并持久化到数据库中：

```
# backend/open_webui/config.py:165-222
class PersistentConfig(Generic[T]):
    def __init__(self, env_name: str, config_path: str, env_value: T):
        self.env_name = env_name
        self.config_path = config_path  # 例如 "auth.jwt_expiry"
        self.env_value = env_value
        self.config_value = get_config_value(config_path)

        # 如果数据库可用，则从数据库加载
        if self.config_value is not None and ENABLE_PERSISTENT_CONFIG:
            self.value = self.config_value
        else:
            self.value = env_value
```
使用示例：

```
JWT_EXPIRES_IN = PersistentConfig(
    "JWT_EXPIRES_IN",
    "auth.jwt_expiry",
    os.environ.get("JWT_EXPIRES_IN", "4w")
)
```
**来源：** [backend/open\_webui/config.py165-222](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/config.py#L165-L222)

### AppConfig Redis 同步

`AppConfig` 类实现了跨实例的自动 Redis 同步：

```
# backend/open_webui/config.py:224-284
class AppConfig:
    def __setattr__(self, key, value):
        # 保存到数据库
        self._state[key].value = value
        self._state[key].save()

        # 通过 Redis 广播到其他实例
        if self._redis:
            redis_key = f"{self._redis_key_prefix}:config:{key}"
            self._redis.set(redis_key, json.dumps(value))

    def __getattr__(self, key):
        # 检查 Redis 中是否有来自其他实例的更新
        if self._redis:
            redis_key = f"{self._redis_key_prefix}:config:{key}"
            redis_value = self._redis.get(redis_key)
            if redis_value and self._state[key].value != decoded_value:
                self._state[key].value = decoded_value

        return self._state[key].value
```
**来源：** [backend/open\_webui/config.py251-284](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/config.py#L251-L284)

### 数据库配置存储

配置存储在 `config` 表中：

```
# backend/open_webui/config.py:73-81
class Config(Base):
    __tablename__ = "config"

    id = Column(Integer, primary_key=True)
    data = Column(JSON, nullable=False)  # 嵌套的 JSON 结构
    version = Column(Integer, nullable=False, default=0)
    created_at = Column(DateTime, nullable=False, server_default=func.now())
    updated_at = Column(DateTime, nullable=True, onupdate=func.now())
```
`data` 列存储了一个类似以下的嵌套 JSON 结构：

```
{
  "auth": {
    "jwt_expiry": "4w",
    "enable_api_keys": false
  },
  "oauth": {
    "google": {
      "client_id": "...",
      "client_secret": "..."
    }
  }
}
```
**来源：** [backend/open\_webui/config.py73-81](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/config.py#L73-L81) [backend/open\_webui/config.py113-156](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/config.py#L113-L156)

---

## 各子系统的关键配置变量

### 数据库配置

| 变量 | 默认值 | 描述 |
| --- | --- | --- |
| `DATABASE_URL` | `sqlite:///${DATA_DIR}/webui.db` | 数据库连接字符串 |
| `DATA_DIR` | `./data` | 数据存储的基础目录 |

### Redis 配置

| 变量 | 默认值 | 描述 |
| --- | --- | --- |
| `REDIS_URL` | None | Redis 连接 URL |
| `REDIS_SENTINEL_HOSTS` | 空 | Sentinel 主机（逗号分隔） |
| `REDIS_SENTINEL_PORT` | 26379 | Sentinel 端口 |
| `REDIS_CLUSTER` | False | 启用集群模式 |
| `REDIS_KEY_PREFIX` | `open-webui` | 键命名空间前缀 |
| `WEBSOCKET_REDIS_URL` | `REDIS_URL` | 用于 WebSocket 状态的 Redis |
| `WEBSOCKET_REDIS_LOCK_TIMEOUT` | 10 | 锁过期时间（秒） |

### 向量数据库配置

| 变量 | 默认值 | 描述 |
| --- | --- | --- |
| `VECTOR_DB` | `chroma` | 向量数据库类型 |
| `RAG_EMBEDDING_ENGINE` | 空 (本地) | 嵌入引擎 |
| `RAG_EMBEDDING_MODEL` | 本地引擎时必填 | 模型名称 |
| `RAG_EMBEDDING_BATCH_SIZE` | 1 | 嵌入分批大小 |
| `ENABLE_ASYNC_EMBEDDING` | True | 异步嵌入生成 |

### 存储配置

| 变量 | 默认值 | 描述 |
| --- | --- | --- |
| `STORAGE_PROVIDER` | `local` | 存储提供商类型 |
| `UPLOAD_DIR` | `${DATA_DIR}/uploads` | 本地存储目录 |
| `S3_BUCKET_NAME` | S3 时必填 | S3 存储桶名称 |
| `GCS_BUCKET_NAME` | GCS 时必填 | GCS 存储桶名称 |
| `AZURE_STORAGE_CONTAINER_NAME` | Azure 时必填 | Azure 容器名称 |

**来源：** [backend/open\_webui/env.py](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/env.py) [backend/open\_webui/config.py1-500](https://github.com/open-webui/open-webui/blob/a7271532/backend/open_webui/config.py#L1-L500)
