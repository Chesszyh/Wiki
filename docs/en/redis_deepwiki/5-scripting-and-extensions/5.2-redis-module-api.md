# Redis Module API

Relevant source files

-   [runtest-moduleapi](https://github.com/redis/redis/blob/8ad54215/runtest-moduleapi)
-   [src/redismodule.h](https://github.com/redis/redis/blob/8ad54215/src/redismodule.h)
-   [tests/modules/Makefile](https://github.com/redis/redis/blob/8ad54215/tests/modules/Makefile)
-   [tests/modules/misc.c](https://github.com/redis/redis/blob/8ad54215/tests/modules/misc.c)
-   [tests/unit/moduleapi/misc.tcl](https://github.com/redis/redis/blob/8ad54215/tests/unit/moduleapi/misc.tcl)

The Redis Module API provides a comprehensive interface for extending Redis functionality through dynamically loaded modules. The API is defined in `redismodule.h` and exposes Redis's core capabilities through a structured function interface that enables modules to register commands, manage memory, handle data types, and interact with the Redis server safely.

The API is organized around function pointers that modules obtain through `RedisModule_GetApi()`, providing version-compatible access to Redis internals while maintaining binary compatibility across Redis versions.

## API Structure and Organization

The Redis Module API is organized into a comprehensive function interface defined in `redismodule.h`. The API uses a dynamic function pointer system where modules obtain function addresses through `RedisModule_GetApi()` at initialization time.

### API Function Pointer System

```mermaid
flowchart TD
    REDISMODULEH["redismodule.hFunction declarations"]
    GETAPI["RedisModule_GetApi()Function pointer retrieval"]
    FUNCPTRS["Module function pointersPopulated at init"]
    APIVER["REDISMODULE_APIVER_1API version compatibility"]
    MEMORY["Memory ManagementRM_Alloc, RM_Free, RM_PoolAlloc"]
    STRINGS["String OperationsRM_CreateString, RM_StringPtrLen"]
    KEYS["Key OperationsRM_OpenKey, RM_CloseKey, RM_KeyType"]
    REPLIES["Reply FunctionsRM_ReplyWithString, RM_ReplyWithLongLong"]
    COMMANDS["Command RegistrationRM_CreateCommand, RM_SetCommandInfo"]
    CONTEXT["Context ManagementRM_GetThreadSafeContext, RM_FreeThreadSafeContext"]
    EVENTS["Event SystemRM_SubscribeToKeyspaceEvents, RM_SubscribeToServerEvent"]
    DATATYPES["Data TypesRM_CreateDataType, RM_ModuleTypeSetValue"]
    ONLOAD["RedisModule_OnLoadModule entry point"]
    INIT["RedisModule_InitInitialize module context"]
    POPULATE["Populate function pointersvia RedisModule_GetApi"]
    REGISTER["Register commands and typesusing API functions"]

    REDISMODULEH --> GETAPI
    GETAPI --> FUNCPTRS
    APIVER --> INIT
    FUNCPTRS --> MEMORY
    FUNCPTRS --> STRINGS
    FUNCPTRS --> KEYS
    FUNCPTRS --> REPLIES
    FUNCPTRS --> COMMANDS
    FUNCPTRS --> CONTEXT
    FUNCPTRS --> EVENTS
    FUNCPTRS --> DATATYPES
    ONLOAD --> INIT
    INIT --> POPULATE
    POPULATE --> REGISTER
```
Sources: [src/redismodule.h41-43](https://github.com/redis/redis/blob/8ad54215/src/redismodule.h#L41-L43) [src/redismodule.h888-904](https://github.com/redis/redis/blob/8ad54215/src/redismodule.h#L888-L904) [tests/modules/misc.c551-627](https://github.com/redis/redis/blob/8ad54215/tests/modules/misc.c#L551-L627)

The API provides approximately 300+ functions organized into logical categories. Each module obtains these function pointers during initialization, ensuring version compatibility and allowing Redis to maintain binary compatibility across versions.

## Core API Functions

The Redis Module API is organized into functional categories, each providing specific capabilities for module development. The API uses consistent naming patterns and return value conventions.

### Key API Function Categories

| API Category | Primary Functions | Purpose |
| --- | --- | --- |
| Memory Management | `RedisModule_Alloc`, `RedisModule_Free`, `RedisModule_Calloc`, `RedisModule_TryAlloc`, `RedisModule_PoolAlloc` | Redis-aware memory allocation and pool management |
| String Operations | `RedisModule_CreateString`, `RedisModule_StringPtrLen`, `RedisModule_StringToLongLong`, `RedisModule_StringCompare` | String creation, conversion, and manipulation |
| Key Operations | `RedisModule_OpenKey`, `RedisModule_CloseKey`, `RedisModule_KeyExists`, `RedisModule_KeyType`, `RedisModule_RandomKey` | Database key access, metadata, and operations |
| Reply Functions | `RedisModule_ReplyWithString`, `RedisModule_ReplyWithLongLong`, `RedisModule_ReplyWithArray`, `RedisModule_ReplyWithCallReply` | Client response generation and formatting |
| Command System | `RedisModule_CreateCommand`, `RedisModule_GetCommand`, `RedisModule_SetCommandInfo`, `RedisModule_CreateSubcommand` | Command registration and metadata |
| Context Management | `RedisModule_GetThreadSafeContext`, `RedisModule_FreeThreadSafeContext`, `RedisModule_GetClientId` | Execution context and client information |
| Call Interface | `RedisModule_Call`, `RedisModule_CallReplyType`, `RedisModule_FreeCallReply` | Inter-command execution and reply handling |
| Event System | `RedisModule_SubscribeToKeyspaceEvents`, `RedisModule_SubscribeToServerEvent`, `RedisModule_NotifyKeyspaceEvent` | Event subscription and notification |

Sources: [src/redismodule.h33-100](https://github.com/redis/redis/blob/8ad54215/src/redismodule.h#L33-L100) [src/redismodule.h1000-1100](https://github.com/redis/redis/blob/8ad54215/src/redismodule.h#L1000-L1100) [tests/modules/misc.c60-92](https://github.com/redis/redis/blob/8ad54215/tests/modules/misc.c#L60-L92) [tests/modules/misc.c146-173](https://github.com/redis/redis/blob/8ad54215/tests/modules/misc.c#L146-L173)

### API Return Value Conventions

```mermaid
flowchart TD
    OK["REDISMODULE_OKValue: 0"]
    ERR["REDISMODULE_ERRValue: 1"]
    AUTH_HANDLED["REDISMODULE_AUTH_HANDLEDValue: 0"]
    AUTH_NOT_HANDLED["REDISMODULE_AUTH_NOT_HANDLEDValue: 1"]
    SUCCESS_FUNCTIONS["Most API functionsReturn OK/ERR"]
    POINTER_FUNCTIONS["Creation functionsReturn pointer or NULL"]
    INFO_FUNCTIONS["Query functionsReturn specific values"]
    VOID_FUNCTIONS["Reply functionsReturn void"]

    OK --> SUCCESS_FUNCTIONS
    ERR --> SUCCESS_FUNCTIONS
    SUCCESS --> FUNCTIONS_POINTER_FUNCTIONS
    POINTER --> FUNCTIONS_INFO_FUNCTIONS
    INFO --> FUNCTIONS_VOID_FUNCTIONS
```
Sources: [src/redismodule.h33-39](https://github.com/redis/redis/blob/8ad54215/src/redismodule.h#L33-L39) [tests/modules/misc.c554-627](https://github.com/redis/redis/blob/8ad54215/tests/modules/misc.c#L554-L627)

Most API functions return `REDISMODULE_OK` (0) on success or `REDISMODULE_ERR` (1) on failure, providing consistent error handling across the API. Functions that create objects typically return pointers or NULL, while query functions return specific data types.

## Function Registration and Callback Patterns

Redis modules register functionality through callback functions that integrate with Redis's command processing and event systems. The API provides several callback types for different integration points.

### Command Function Registration

```mermaid
flowchart TD
    CMDFUNC["RedisModuleCmdFuncint (*func)(RedisModuleCtx *ctx, RedisModuleString **argv, int argc)"]
    FUNCIMPL["Module implementationProcess arguments, execute logic, send reply"]
    RETVAL["Return REDISMODULE_OKor REDISMODULE_ERR"]
    CREATECMD["RedisModule_CreateCommand(ctx, name, func, flags, arity, keystart, keystop)"]
    CMDSTRUCT["RedisModuleCommand structureLinks module function to Redis command system"]
    REDISCMD["struct redisCommandAdded to server.commands dict"]
    CMDINFO["RedisModule_SetCommandInfoProvide command metadata"]
    KEYSPEC["RedisModuleCommandKeySpecbegin_search_type, find_keys_type, bs, fk"]
    CMDARG["RedisModuleCommandArgname, type, key_spec_index, flags"]
    HISTORY["RedisModuleCommandHistoryEntrysince, changes"]
    CMDINFO_STRUCT["RedisModuleCommandInfosummary, complexity, arity, key_specs, args"]

    CREATECMD --> CMDSTRUCT
    CMDSTRUCT --> REDISCMD
    CMDINFO --> KEYSPEC
    CMDINFO --> CMDARG
    CMDINFO --> HISTORY
    CMDINFO --> CMDINFO_STRUCT
    CMDFUNC --> FUNCIMPL
    FUNCIMPL --> RETVAL
```
Sources: [src/redismodule.h888-904](https://github.com/redis/redis/blob/8ad54215/src/redismodule.h#L888-L904) [src/redismodule.h380-480](https://github.com/redis/redis/blob/8ad54215/src/redismodule.h#L380-L480) [tests/modules/misc.c551-627](https://github.com/redis/redis/blob/8ad54215/tests/modules/misc.c#L551-L627) [tests/modules/misc.c60-92](https://github.com/redis/redis/blob/8ad54215/tests/modules/misc.c#L60-L92)

Command functions receive a `RedisModuleCtx`, argument array (`RedisModuleString **argv`), and argument count (`int argc`). They must return `REDISMODULE_OK` on success or `REDISMODULE_ERR` on failure.

### Event Callback Registration

```mermaid
flowchart TD
    KEYSPACE["RedisModule_SubscribeToKeyspaceEvents(ctx, types, callback)"]
    SERVER["RedisModule_SubscribeToServerEvent(ctx, event, callback)"]
    POSTEXEC["RedisModule_SubscribeToCommandFilter(ctx, callback, flags)"]
    NOTIFYFUNC["RedisModuleNotificationFuncint (*)(RedisModuleCtx *ctx, int type, const char *event, RedisModuleString *key)"]
    EVENTFUNC["RedisModuleEventCallbackvoid (*)(RedisModuleCtx *ctx, RedisModuleEvent eid, uint64_t subevent, void *data)"]
    FILTERFUNC["RedisModuleCommandFilterFuncvoid (*)(RedisModuleCommandFilterCtx *filter)"]
    KEYEVENTTYPES["REDISMODULE_NOTIFY_KEYSPACEREDISMODULE_NOTIFY_GENERICREDISMODULE_NOTIFY_STRING, etc."]
    SERVEREVENTS["RedisModuleEvent_PersistenceRedisModuleEvent_LoadingRedisModuleEvent_ClientChange, etc."]
    SUBEVENTTYPES["REDISMODULE_SUBEVENT_PERSISTENCE_RDB_STARTREDISMODULE_SUBEVENT_LOADING_ENDED, etc."]

    KEYSPACE --> NOTIFYFUNC
    SERVER --> EVENTFUNC
    POSTEXEC --> FILTERFUNC
    NOTIFYFUNC --> KEYEVENTTYPES
    EVENTFUNC --> SERVEREVENTS
    EVENTFUNC --> SUBEVENTTYPES
```
Sources: [src/redismodule.h486-520](https://github.com/redis/redis/blob/8ad54215/src/redismodule.h#L486-L520) [src/redismodule.h547-621](https://github.com/redis/redis/blob/8ad54215/src/redismodule.h#L547-L621) [src/redismodule.h222-245](https://github.com/redis/redis/blob/8ad54215/src/redismodule.h#L222-L245) [tests/modules/misc.c13-20](https://github.com/redis/redis/blob/8ad54215/tests/modules/misc.c#L13-L20)

Event callbacks provide modules with reactive capabilities, allowing them to respond to keyspace changes, server events, and command execution. Each callback type has specific signature requirements and return value expectations.

## Context Management and Execution Environment

The `RedisModuleCtx` structure serves as the primary interface between modules and Redis, providing execution context, resource management, and API access. Understanding context management is crucial for proper module development.

### RedisModuleCtx Structure and Usage

```mermaid
flowchart TD
    GETAPI["getapifuncptrFirst field - API function access"]
    MODULE["moduleRedisModule* - Module reference"]
    CLIENT["clientclient* - Current client connection"]
    FLAGS["flagsREDISMODULE_CTX_* - Context state flags"]
    USER["userRedisModuleUser* - ACL permissions"]
    AMQUEUE["amqueueAutoMemEntry* - Auto memory tracking"]
    POOLALLOC["pa_headRedisModulePoolAllocBlock* - Pool allocation"]
    POSTPONED["postponed_arrayslist* - Deferred array lengths"]
    KEYS_RESULT["keys_resultgetKeysResult* - Key analysis cache"]
    COMMAND["Command ContextCreated for each command execution"]
    THREADSAFE["Thread-Safe ContextRedisModule_GetThreadSafeContext()"]
    BLOCKING["Blocking ContextFor async operations"]
    TEMP["Temporary ContextFor internal operations"]
    AUTO_MEMORY["AUTO_MEMORY (1<<0)Automatic resource cleanup"]
    THREAD_SAFE["THREAD_SAFE (1<<4)Safe for background threads"]
    BLOCKED_REPLY["BLOCKED_REPLY (1<<2)Client is blocked"]
    KEYS_POS_REQUEST["KEYS_POS_REQUEST (1<<1)Key position analysis"]

    GETAPI --> MODULE
    MODULE --> CLIENT
    CLIENT --> FLAGS
    FLAGS --> USER
    FLAGS --> AUTO_MEMORY
    FLAGS --> THREAD_SAFE
    FLAGS --> BLOCKED_REPLY
    FLAGS --> KEYS_POS_REQUEST
    AMQUEUE --> COMMAND
    POOLALLOC --> THREADSAFE
    POSTPONED --> BLOCKING
    KEYS --> RESULT_TEMP
```
Sources: [src/redismodule.h888](https://github.com/redis/redis/blob/8ad54215/src/redismodule.h#L888-L888) [tests/modules/misc.c352-374](https://github.com/redis/redis/blob/8ad54215/tests/modules/misc.c#L352-L374) [tests/modules/misc.c287-329](https://github.com/redis/redis/blob/8ad54215/tests/modules/misc.c#L287-L329)

The context provides both execution environment and resource management. The `getapifuncptr` field must be first to enable the macro-based API function lookup system used by modules.

### Context Lifecycle and Memory Management

```mermaid
flowchart TD
    POOLALLOC["RedisModule_PoolAllocFast temporary allocation"]
    POOLBLOCK["RedisModulePoolAllocBlocksize, used, next, memory[]"]
    POOLRELEASE["poolAllocReleaseFree all pool blocks"]
    TRACK["Resource TrackingAutoMemEntry structures"]
    TYPES["Resource TypesREDISMODULE_AM_KEY, AM_STRING, AM_REPLY, AM_DICT"]
    CLEANUP["Automatic CleanupWhen context ends"]
    CREATE["Context CreationmoduleCreateContext()"]
    EXECUTE["Command ExecutionModule function called"]
    COLLECT["Resource CleanupautoMemoryCollect()"]
    FREE["Context DestructionmoduleFreeContext()"]

    POOLALLOC --> POOLBLOCK
    POOLBLOCK --> POOLRELEASE
    TRACK --> TYPES
    TYPES --> CLEANUP
    CREATE --> EXECUTE
    EXECUTE --> COLLECT
    COLLECT --> FREE
```
Sources: [tests/modules/misc.c506-525](https://github.com/redis/redis/blob/8ad54215/tests/modules/misc.c#L506-L525) [src/redismodule.h1000-1100](https://github.com/redis/redis/blob/8ad54215/src/redismodule.h#L1000-L1100)

Context management ensures proper resource cleanup through automatic memory tracking and pool allocation systems, preventing memory leaks in module operations.

## Memory Management API

The Redis Module API provides sophisticated memory management capabilities that integrate with Redis's memory tracking and management systems. Understanding the different allocation strategies is essential for building efficient modules.

### Memory Allocation Functions

```mermaid
flowchart TD
    AUTOTRACK["Automatic resource trackingWhen REDISMODULE_CTX_AUTO_MEMORY set"]
    AMENTRY["AutoMemEntry structuresptr, type tracking"]
    AMTYPES["REDISMODULE_AM_STRING = 1REDISMODULE_AM_KEY = 0REDISMODULE_AM_REPLY = 2"]
    AUTOCOLLECT["autoMemoryCollect(ctx)Automatic cleanup on context end"]
    ALLOC["RedisModule_Alloc(size)Returns: void* or NULL"]
    TRYALLOC["RedisModule_TryAlloc(size)Non-failing allocation"]
    CALLOC["RedisModule_Calloc(nmemb, size)Zero-initialized allocation"]
    TRYCALLOC["RedisModule_TryCalloc(nmemb, size)Non-failing zero-init"]
    REALLOC["RedisModule_Realloc(ptr, size)Resize existing allocation"]
    FREE["RedisModule_Free(ptr)Free allocated memory"]
    POOLALLOC["RedisModule_PoolAlloc(ctx, bytes)Fast context-scoped allocation"]
    POOLSTRUCT["RedisModulePoolAllocBlocksize, used, next, memory[]"]
    POOLALIGN["REDISMODULE_POOL_ALLOC_ALIGNsizeof(void*) alignment"]
    MINSIZE["REDISMODULE_POOL_ALLOC_MIN_SIZE8192 bytes minimum block"]

    ALLOC --> POOLSTRUCT
    TRYALLOC --> POOLSTRUCT
    POOLALLOC --> POOLSTRUCT
    POOLSTRUCT --> POOLALIGN
    POOLSTRUCT --> MINSIZE
    AUTOTRACK --> AMENTRY
    AMENTRY --> AMTYPES
    AMENTRY --> AUTOCOLLECT
```
Sources: [src/redismodule.h1000-1100](https://github.com/redis/redis/blob/8ad54215/src/redismodule.h#L1000-L1100) [tests/modules/misc.c506-525](https://github.com/redis/redis/blob/8ad54215/tests/modules/misc.c#L506-L525)

The API provides both standard heap allocation and efficient pool allocation for temporary objects. Pool allocation is particularly useful for command-scoped allocations that are automatically freed when the command completes.

### Memory Management Strategies

```mermaid
flowchart TD
    MANUAL["Manual ManagementRedisModule_Alloc/Free"]
    POOL["Pool AllocationRedisModule_PoolAlloc"]
    AUTO["Auto MemoryTracked and auto-freed"]
    PERSISTENT["Long-lived objectsModule data structures"]
    TEMPORARY["Command-scoped objectsRequest processing"]
    STRINGS["String operationsArgument parsing"]
    TRACKING["Redis memory trackingCounted in used_memory"]
    POLICIES["Maxmemory policiesSubject to eviction pressure"]
    OOM["OOM detectionTryAlloc functions don't panic"]

    MANUAL --> PERSISTENT
    POOL --> TEMPORARY
    AUTO --> STRINGS
    PERSISTENT --> TRACKING
    TEMPORARY --> POLICIES
    STRINGS --> OOM
```
Sources: [tests/modules/misc.c506-525](https://github.com/redis/redis/blob/8ad54215/tests/modules/misc.c#L506-L525) [src/redismodule.h510-590](https://github.com/redis/redis/blob/8ad54215/src/redismodule.h#L510-L590)

Module memory allocations are integrated with Redis's memory management system, contributing to `used_memory` statistics and being subject to maxmemory policies and OOM detection.

## Error Handling and Debugging

The Redis Module API provides comprehensive error handling mechanisms and debugging capabilities to help developers build robust modules.

### Error Reporting and Return Values

```mermaid
flowchart TD
    OK["REDISMODULE_OK (0)Success return value"]
    ERR["REDISMODULE_ERR (1)Generic error return"]
    WRONGTYPE["REDISMODULE_ERRORMSG_WRONGTYPEStandard error message"]
    WRONGARITY["RedisModule_WrongArity(ctx)Argument count error"]
    REPLYERR["RedisModule_ReplyWithError(ctx, err_string)"]
    REPLYSIMPLE["RedisModule_ReplyWithSimpleString(ctx, msg)"]
    REPLYERRF["RedisModule_ReplyWithErrorFormat(ctx, fmt, ...)"]
    LOG["RedisModule_Log(ctx, level, fmt, ...)"]
    VALIDATE["Parameter ValidationCheck argc, argument types"]
    EARLYRET["Early ReturnReturn REDISMODULE_ERR on failure"]
    CLEANUP["Resource CleanupFree allocations before return"]
    CONTEXTUAL["Contextual ErrorsProvide meaningful error messages"]
    LOGLEVEL["Log Levelsdebug, verbose, notice, warning"]
    ASSERT["AssertionsDevelopment-time checks"]
    CLIENTINFO["RedisModule_GetClientInfoByIdClient connection details"]
    SERVERINFO["RedisModule_GetServerVersionVersion compatibility"]

    OK --> REPLYERR
    ERR --> REPLYSIMPLE
    WRONGTYPE --> REPLYERRF
    WRONGARITY --> LOG
    REPLYERR --> VALIDATE
    REPLYSIMPLE --> EARLYRET
    REPLYERRF --> CLEANUP
    LOG --> CONTEXTUAL
    VALIDATE --> LOGLEVEL
    EARLYRET --> ASSERT
    CLEANUP --> CLIENTINFO
    CONTEXTUAL --> SERVERINFO
```
Sources: [src/redismodule.h33-39](https://github.com/redis/redis/blob/8ad54215/src/redismodule.h#L33-L39) [src/redismodule.h251-276](https://github.com/redis/redis/blob/8ad54215/src/redismodule.h#L251-L276) [tests/modules/misc.c22-35](https://github.com/redis/redis/blob/8ad54215/tests/modules/misc.c#L22-L35) [tests/modules/misc.c331-350](https://github.com/redis/redis/blob/8ad54215/tests/modules/misc.c#L331-L350)

Modules should consistently use `REDISMODULE_OK` and `REDISMODULE_ERR` return values, provide meaningful error messages through reply functions, and use logging for debugging purposes.

### Common Error Handling Patterns

```
// Example error handling pattern from misc.c
int test_keyexists(RedisModuleCtx *ctx, RedisModuleString **argv, int argc) {
    if (argc < 2) return RedisModule_WrongArity(ctx);  // Validate arguments

    RedisModuleString *key = argv[1];
    int exists = RedisModule_KeyExists(ctx, key);
    return RedisModule_ReplyWithBool(ctx, exists);      // Always send reply
}

// Error with cleanup pattern
int test_getlru(RedisModuleCtx *ctx, RedisModuleString **argv, int argc) {
    if (argc < 2) {
        RedisModule_WrongArity(ctx);
        return REDISMODULE_OK;  // WrongArity sends reply
    }

    RedisModuleKey *key = open_key_or_reply(ctx, argv[1], REDISMODULE_READ);
    if (!key) return REDISMODULE_OK;  // open_key_or_reply sent error reply

    mstime_t lru;
    RedisModule_GetLRU(key, &lru);
    RedisModule_ReplyWithLongLong(ctx, lru);
    RedisModule_CloseKey(key);  // Always clean up resources
    return REDISMODULE_OK;
}
```
Sources: [tests/modules/misc.c174-179](https://github.com/redis/redis/blob/8ad54215/tests/modules/misc.c#L174-L179) [tests/modules/misc.c190-202](https://github.com/redis/redis/blob/8ad54215/tests/modules/misc.c#L190-L202) [tests/modules/misc.c181-188](https://github.com/redis/redis/blob/8ad54215/tests/modules/misc.c#L181-L188)

## API Testing and Development

Redis provides comprehensive testing infrastructure and development tools specifically designed for module API development and validation.

### Module Testing Framework

```mermaid
flowchart TD
    MAKEFILE["tests/modules/MakefileBuild system for test modules"]
    RUNNER["runtest-moduleapiTest execution script"]
    TESTDIR["tests/unit/moduleapi/TCL test files"]
    MODDIR["tests/modules/Test module implementations"]
    BASICS["basics.soCore API functionality"]
    MISC["misc.soVarious API features"]
    DATATYPE["datatype.so datatype2.soCustom data type testing"]
    BLOCKING["blockonkeys.so blockonbackground.soBlocking operations"]
    HOOKS["hooks.soEvent system testing"]
    AUTH["auth.so aclcheck.soAuthentication and ACL"]
    CONFIG["moduleconfigs.soConfiguration system"]
    CFLAGS["SHOBJ_CFLAGSPlatform-specific compiler flags"]
    LDFLAGS["SHOBJ_LDFLAGSPlatform-specific linker flags"]
    PLATFORMS["Linux, Darwin, othersPlatform detection"]
    SANITIZERS["SANITIZER=memoryMemory sanitizer support"]
    COMPILE["make -C tests/modulesCompile test modules"]
    LOAD["MODULE LOADLoad modules in Redis"]
    EXECUTE["Execute test casesTCL test framework"]
    VALIDATE["Validate resultsAssert conditions"]

    MAKEFILE --> CFLAGS
    MAKEFILE --> LDFLAGS
    MAKEFILE --> PLATFORMS
    PLATFORMS --> SANITIZERS
    BASICS --> COMPILE
    MISC --> LOAD
    DATATYPE --> EXECUTE
    BLOCKING --> VALIDATE
    RUNNER --> TESTDIR
    TESTDIR --> MODDIR
    MODDIR --> COMPILE
```
Sources: [tests/modules/Makefile1-105](https://github.com/redis/redis/blob/8ad54215/tests/modules/Makefile#L1-L105) [runtest-moduleapi1-63](https://github.com/redis/redis/blob/8ad54215/runtest-moduleapi#L1-L63) [tests/unit/moduleapi/misc.tcl1-10](https://github.com/redis/redis/blob/8ad54215/tests/unit/moduleapi/misc.tcl#L1-L10)

The testing framework provides over 40 test modules covering different aspects of the Module API, from basic functionality to advanced features like blocking operations and custom data types.

### API Development Patterns

```mermaid
flowchart TD
    WRITE["Write module codeInclude redismodule.h"]
    BUILD["Compile with test flagsmake -C tests/modules"]
    TEST["Run specific tests--single unit/moduleapi/misc"]
    DEBUG["Debug issuesgdb, logging, assertions"]
    ITERATE["Iterate and refineFix bugs and add features"]
    CMDPATTERN["Command PatternValidate args, process, reply"]
    MEMPATTERN["Memory PatternAllocate, use, cleanup"]
    ERRPATTERN["Error PatternCheck return values, send error replies"]
    EVENTPATTERN["Event PatternSubscribe, handle callbacks"]
    COVERAGE["API CoverageTest all function paths"]
    ERRORS["Error ConditionsTest failure cases"]
    CLEANUP["Resource CleanupVerify no leaks"]
    INTEGRATION["Integration TestingReal Redis scenarios"]

    CMDPATTERN --> COVERAGE
    MEMPATTERN --> ERRORS
    ERRPATTERN --> CLEANUP
    EVENTPATTERN --> INTEGRATION
    WRITE --> BUILD
    BUILD --> TEST
    TEST --> DEBUG
    DEBUG --> ITERATE
```
Sources: [tests/modules/misc.c551-627](https://github.com/redis/redis/blob/8ad54215/tests/modules/misc.c#L551-L627) [tests/unit/moduleapi/misc.tcl200-300](https://github.com/redis/redis/blob/8ad54215/tests/unit/moduleapi/misc.tcl#L200-L300) [runtest-moduleapi16-62](https://github.com/redis/redis/blob/8ad54215/runtest-moduleapi#L16-L62)

### Example API Usage from Test Modules

The test modules demonstrate proper API usage patterns:

```
// Command registration pattern from misc.c
int RedisModule_OnLoad(RedisModuleCtx *ctx, RedisModuleString **argv, int argc) {
    if (RedisModule_Init(ctx,"misc",1,REDISMODULE_APIVER_1) == REDISMODULE_ERR)
        return REDISMODULE_ERR;

    // Register commands with proper flags and arity
    if (RedisModule_CreateCommand(ctx,"test.call_generic", test_call_generic,"",0,0,0) == REDISMODULE_ERR)
        return REDISMODULE_ERR;

    // Subscribe to keyspace events
    if (RedisModule_SubscribeToKeyspaceEvents(ctx,
        REDISMODULE_NOTIFY_KEY_MISS | REDISMODULE_NOTIFY_EXPIRED,
        KeySpace_NotificationModuleKeyMissExpired) != REDISMODULE_OK) {
        return REDISMODULE_ERR;
    }

    return REDISMODULE_OK;
}

// API call pattern with error handling
int test_call_generic(RedisModuleCtx *ctx, RedisModuleString **argv, int argc) {
    if (argc < 2) {
        RedisModule_WrongArity(ctx);
        return REDISMODULE_OK;
    }

    const char* cmdname = RedisModule_StringPtrLen(argv[1], NULL);
    RedisModuleCallReply *reply = RedisModule_Call(ctx, cmdname, "v", argv+2, (size_t)argc-2);
    if (reply) {
        RedisModule_ReplyWithCallReply(ctx, reply);
        RedisModule_FreeCallReply(reply);
    } else {
        RedisModule_ReplyWithError(ctx, strerror(errno));
    }
    return REDISMODULE_OK;
}
```
Sources: [tests/modules/misc.c554-627](https://github.com/redis/redis/blob/8ad54215/tests/modules/misc.c#L554-L627) [tests/modules/misc.c60-76](https://github.com/redis/redis/blob/8ad54215/tests/modules/misc.c#L60-L76) [tests/modules/misc.c557-559](https://github.com/redis/redis/blob/8ad54215/tests/modules/misc.c#L557-L559)

The test framework validates API behavior through comprehensive test cases that exercise both success and failure paths, ensuring modules can be developed with confidence in the API's reliability and consistency.

## Module Building and Testing

Redis provides comprehensive build and test infrastructure for module development.

```mermaid
flowchart TD
    MAKEFILE["tests/modules/MakefileModule compilation"]
    CFLAGS["SHOBJ_CFLAGSCompilation flags"]
    LDFLAGS["SHOBJ_LDFLAGSLinking flags"]
    MODULES["TEST_MODULESModule list"]
    RUNNER["runtest-moduleapiTest runner script"]
    TESTFILES["tests/unit/moduleapi/*.tclTest cases"]
    TESTMODULES["tests/modules/*.cTest module implementations"]
    COMPILE["Compile .so files"]
    LOAD["Load in Redis"]
    TEST["Run test suite"]
    DEBUG["Debug and iterate"]

    MAKEFILE --> CFLAGS
    MAKEFILE --> LDFLAGS
    MAKEFILE --> MODULES
    MODULES --> COMPILE
    RUNNER --> TESTFILES
    TESTFILES --> TESTMODULES
    TESTMODULES --> LOAD
    LOAD --> TEST
    TEST --> DEBUG
```
Sources: [tests/modules/Makefile1-104](https://github.com/redis/redis/blob/8ad54215/tests/modules/Makefile#L1-L104) [runtest-moduleapi1-62](https://github.com/redis/redis/blob/8ad54215/runtest-moduleapi#L1-L62) [tests/unit/moduleapi/misc.tcl1-10](https://github.com/redis/redis/blob/8ad54215/tests/unit/moduleapi/misc.tcl#L1-L10)

The build system supports multiple platforms and provides standardized compilation flags for creating Redis modules. The test framework includes comprehensive test cases covering API functionality, error conditions, and integration scenarios.
