# Linux and macOS Build Process

Relevant source files

-   [.circleci/Dockerfile](https://github.com/LeelaChessZero/lc0/blob/b4e98c19/.circleci/Dockerfile)
-   [.circleci/config.yml](https://github.com/LeelaChessZero/lc0/blob/b4e98c19/.circleci/config.yml)
-   [.clang-format](https://github.com/LeelaChessZero/lc0/blob/b4e98c19/.clang-format)
-   [.gitmodules](https://github.com/LeelaChessZero/lc0/blob/b4e98c19/.gitmodules)
-   [CONTRIBUTING.md](https://github.com/LeelaChessZero/lc0/blob/b4e98c19/CONTRIBUTING.md)
-   [README.md](https://github.com/LeelaChessZero/lc0/blob/b4e98c19/README.md)
-   [cross-files/x86\_64-darwin](https://github.com/LeelaChessZero/lc0/blob/b4e98c19/cross-files/x86_64-darwin)
-   [install\_openSUSE\_lc0.sh](https://github.com/LeelaChessZero/lc0/blob/b4e98c19/install_openSUSE_lc0.sh)
-   [openSUSE\_install.md](https://github.com/LeelaChessZero/lc0/blob/b4e98c19/openSUSE_install.md)
-   [pyproject.toml](https://github.com/LeelaChessZero/lc0/blob/b4e98c19/pyproject.toml)
-   [subprojects/protobuf.wrap](https://github.com/LeelaChessZero/lc0/blob/b4e98c19/subprojects/protobuf.wrap)

This document covers the build process for Leela Chess Zero on Unix-like systems (Linux and macOS), including the Meson build system configuration, platform-specific requirements, and continuous integration workflows.

For Windows-specific build instructions, see [Windows Build Process](/LeelaChessZero/lc0/2.3-windows-build-process). For overall build system architecture and backend selection, see [Build System Architecture](/LeelaChessZero/lc0/2.1-build-system-architecture).

## Build System Overview

Lc0 uses the Meson build system for cross-platform compilation, with Ninja as the backend build tool. The build process is orchestrated through shell scripts and CI/CD pipelines that handle dependency resolution, backend selection, and platform-specific optimizations.

### Build System Architecture

```mermaid
flowchart TD
    BuildScript["build.shMain Build Script"]
    MesonSetup["meson setupConfiguration"]
    PyProject["pyproject.tomlPython Bindings"]
    MesonOptions["meson_options.txtBuild Options"]
    CrossFiles["cross-files/Platform Configs"]
    Subprojects["subprojects/Dependencies"]
    LinuxDetect["Linux DetectionDistribution-specific"]
    MacOSDetect["macOS DetectionXcode/Clang"]
    BackendDetect["Backend DetectionCUDA/ONNX/BLAS"]
    SystemLibs["System LibrariesOpenBLAS/DNNL"]
    Submodules["Git Submoduleslczero-common"]
    WrapFiles["Wrap Filesprotobuf.wrap"]
    NinjaBuild["ninjaParallel Compilation"]
    TargetBinary["lc0 BinaryRelease/Debug"]
    PythonBindings["Python Bindingslczero_bindings"]

    BuildScript --> MesonSetup
    MesonSetup --> MesonOptions
    MesonSetup --> CrossFiles
    MesonOptions --> BackendDetect
    CrossFiles --> MacOSDetect
    LinuxDetect --> SystemLibs
    MacOSDetect --> SystemLibs
    BackendDetect --> SystemLibs
    MesonSetup --> Submodules
    MesonSetup --> Subprojects
    Subprojects --> WrapFiles
    MesonSetup --> NinjaBuild
    NinjaBuild --> TargetBinary
    PyProject --> PythonBindings
```
Sources: [README.md43-49](https://github.com/LeelaChessZero/lc0/blob/b4e98c19/README.md#L43-L49) [build.sh](https://github.com/LeelaChessZero/lc0/blob/b4e98c19/build.sh) [meson\_options.txt](https://github.com/LeelaChessZero/lc0/blob/b4e98c19/meson_options.txt) [cross-files/x86\_64-darwin](https://github.com/LeelaChessZero/lc0/blob/b4e98c19/cross-files/x86_64-darwin) [subprojects/protobuf.wrap](https://github.com/LeelaChessZero/lc0/blob/b4e98c19/subprojects/protobuf.wrap) [pyproject.toml](https://github.com/LeelaChessZero/lc0/blob/b4e98c19/pyproject.toml)

## Linux Build Process

The Linux build process supports multiple distributions and compiler toolchains, with automatic dependency detection and backend configuration.

### Prerequisites and Dependencies

| Component | Purpose | Installation |
| --- | --- | --- |
| `meson` | Build system | `pip3 install meson` |
| `ninja-build` | Build backend | Distribution package |
| `gcc-10`/`clang-12` | C++20 compiler | Distribution package |
| `git` | Submodule handling | Distribution package |
| `python3-pip` | Python dependencies | Distribution package |

### Linux Build Workflow

```mermaid
flowchart TD
    EnvVars["CC/CXX VariablesCompiler Selection"]
    InstallPrefix["INSTALL_PREFIXInstallation Path"]
    SubmoduleInit["git submodule update --initlczero-common"]
    MesonConfigure["meson setup buildBackend Detection"]
    NinjaBuild["ninja -C buildParallel Compilation"]
    CUDAPath["CUDA_PATH DetectionNVIDIA GPU Support"]
    ONNXLibs["ONNX Library Detectiononnx_libdir/onnx_include"]
    BLASLibs["BLAS Library DetectionOpenBLAS/DNNL"]
    Lc0Binary["build/release/lc0Main Executable"]
    TestBinary["build/lc0_testUnit Tests"]
    DebugSymbols["Debug InformationOptional"]

    EnvVars --> MesonConfigure
    InstallPrefix --> MesonConfigure
    SubmoduleInit --> MesonConfigure
    MesonConfigure --> CUDAPath
    MesonConfigure --> ONNXLibs
    MesonConfigure --> BLASLibs
    CUDAPath --> NinjaBuild
    ONNXLibs --> NinjaBuild
    BLASLibs --> NinjaBuild
    NinjaBuild --> Lc0Binary
    NinjaBuild --> TestBinary
    NinjaBuild --> DebugSymbols
```
Sources: [README.md51-82](https://github.com/LeelaChessZero/lc0/blob/b4e98c19/README.md#L51-L82) [install\_openSUSE\_lc0.sh46-70](https://github.com/LeelaChessZero/lc0/blob/b4e98c19/install_openSUSE_lc0.sh#L46-L70)

### Distribution-Specific Examples

#### Ubuntu 20.04 Build Commands

```
apt-get update
apt-get -y install git python3-pip gcc-10 g++-10 zlib1g zlib1g-dev
pip3 install meson ninja
CC=gcc-10 CXX=g++-10 INSTALL_PREFIX=~/.local ./build.sh
```
#### openSUSE Build Commands

```
zypper in -y git gcc-c++ gcc7-c++ meson ninja python3-abseil openblas_pthreads-devel-static
git clone --recurse-submodules https://github.com/LeelaChessZero/lc0.git
cd lc0 && ./build.sh
```
Sources: [README.md70-81](https://github.com/LeelaChessZero/lc0/blob/b4e98c19/README.md#L70-L81) [install\_openSUSE\_lc0.sh54-70](https://github.com/LeelaChessZero/lc0/blob/b4e98c19/install_openSUSE_lc0.sh#L54-L70)

## macOS Build Process

The macOS build process supports both Intel x86\_64 and Apple Silicon architectures, with universal binary creation for distribution.

### macOS Build Requirements

| Component | Version | Installation Method |
| --- | --- | --- |
| Xcode | 14.1.0+ | App Store |
| Python 3 | 3.8+ | System/Homebrew |
| Meson | 1.3.0+ | `pip3 install meson` |
| Ninja | Latest | `pip3 install ninja` |

### macOS Build Architecture

```mermaid
flowchart TD
    Xcode["Xcode 14.1.0+Apple Development Tools"]
    Python3["Python 3.8+Build System Runtime"]
    CommandLineTools["Command Line ToolsClang/LLVM"]
    x86Build["x86_64 BuildIntel Compatibility"]
    ARMBuild["ARM64 BuildApple Silicon Native"]
    UniversalBinary["Universal Binarylipo Combination"]
    CrossFileX86["cross-files/x86_64-darwinIntel Target Config"]
    NativeARM["Native ARM BuildApple Silicon Host"]
    LipoTool["lipo -createBinary Combination"]
    MetalBackend["Metal Performance ShadersApple GPU Acceleration"]
    AccelerateFramework["Accelerate FrameworkBLAS Implementation"]
    ISPCVectorization["ISPC VectorizationPerformance Optimization"]

    Xcode --> CommandLineTools
    Python3 --> x86Build
    Python3 --> ARMBuild
    x86Build --> CrossFileX86
    ARMBuild --> NativeARM
    CrossFileX86 --> LipoTool
    NativeARM --> LipoTool
    LipoTool --> UniversalBinary
    x86Build --> MetalBackend
    ARMBuild --> MetalBackend
    MetalBackend --> AccelerateFramework
    AccelerateFramework --> ISPCVectorization
```
Sources: [README.md106-121](https://github.com/LeelaChessZero/lc0/blob/b4e98c19/README.md#L106-L121) [.circleci/config.yml45-88](https://github.com/LeelaChessZero/lc0/blob/b4e98c19/.circleci/config.yml#L45-L88) [cross-files/x86\_64-darwin](https://github.com/LeelaChessZero/lc0/blob/b4e98c19/cross-files/x86_64-darwin)

### macOS Build Commands

#### Basic Build Process

```
pip3 install meson ninja
git clone --recurse-submodules -b release/0.32 https://github.com/LeelaChessZero/lc0.git
cd lc0
./build.sh -Dgtest=false
```
#### Universal Binary Creation

```
# x86_64 build
meson build --buildtype=release -Dgtest=false --cross-file cross-files/x86_64-darwin
cd build && ninja && cd ..

# ARM64 build
meson build-arm --buildtype=release -Dgtest=false
cd build-arm && ninja && cd ..

# Combine architectures
lipo -create -o lc0-universal build/lc0 build-arm/lc0
```
Sources: [README.md110-117](https://github.com/LeelaChessZero/lc0/blob/b4e98c19/README.md#L110-L117) [.circleci/config.yml64-76](https://github.com/LeelaChessZero/lc0/blob/b4e98c19/.circleci/config.yml#L64-L76)

## CircleCI Continuous Integration

The CI system provides automated testing and release artifact generation for both Linux and macOS platforms.

### CircleCI Workflow Structure

```mermaid
flowchart TD
    PushCommit["Git PushCode Changes"]
    TagRelease["Git TagRelease Triggers"]
    PRSubmission["Pull RequestCode Review"]
    UbuntuContainer["Ubuntu 20.04 Containernvidia/cuda:11.6.1-cudnn8-devel"]
    GCCBuild["GCC-10 Buildbuild-gcc Directory"]
    ClangBuild["Clang-12 Buildbuild-clang Directory"]
    ONNXDownload["ONNX Runtime Downloadv1.22.0 Integration"]
    MacOSRunner["macOS RunnerXcode 14.1.0/16.4.0"]
    IntelBuild["Intel x86_64 BuildCross-compilation"]
    AppleSiliconBuild["Apple Silicon BuildNative ARM64"]
    UniversalArtifact["Universal Binarylipo Combination"]
    WorkspacePersist["Workspace PersistenceBuild Artifacts"]
    GitHubUpload["GitHub Release Uploadgh CLI Tool"]
    VersionTagging["Version TaggingSemantic Versioning"]

    PushCommit --> UbuntuContainer
    PushCommit --> MacOSRunner
    TagRelease --> MacOSRunner
    UbuntuContainer --> ONNXDownload
    ONNXDownload --> GCCBuild
    ONNXDownload --> ClangBuild
    MacOSRunner --> IntelBuild
    MacOSRunner --> AppleSiliconBuild
    IntelBuild --> UniversalArtifact
    AppleSiliconBuild --> UniversalArtifact
    UniversalArtifact --> WorkspacePersist
    WorkspacePersist --> GitHubUpload
    TagRelease --> VersionTagging
    VersionTagging --> GitHubUpload
```
Sources: [.circleci/config.yml](https://github.com/LeelaChessZero/lc0/blob/b4e98c19/.circleci/config.yml)

### CI Job Configuration Details

#### Linux Build Job

-   **Container**: `nvidia/cuda:11.6.1-cudnn8-devel-ubuntu20.04`
-   **Compilers**: GCC-10, Clang-12
-   **ONNX Integration**: Downloads onnxruntime-linux-x64-1.22.0.tgz
-   **Build Commands**:

    ```
    meson build-gcc -Dgtest=false -Donnx_include=/tmp/onnxruntime-linux-x64-1.22.0/include
    meson build-clang -Dgtest=false -Db_lto=false -Donnx_include=/tmp/onnxruntime-linux-x64-1.22.0/include
    ```


#### macOS Build Jobs

-   **Xcode Versions**: 14.1.0 (stable), 16.4.0 (latest)
-   **Resource Class**: `macos.m1.medium.gen1`
-   **ISPC Integration**: Downloads ispc-v1.21.0 for vectorization
-   **Universal Binary**: Uses `lipo -create` to combine architectures

Sources: [.circleci/config.yml3-44](https://github.com/LeelaChessZero/lc0/blob/b4e98c19/.circleci/config.yml#L3-L44) [.circleci/config.yml45-108](https://github.com/LeelaChessZero/lc0/blob/b4e98c19/.circleci/config.yml#L45-L108)

## Backend and Dependency Management

The build system automatically detects and configures various neural network backends and mathematical libraries.

### Backend Detection Matrix

| Backend | Linux Detection | macOS Detection | Configuration Options |
| --- | --- | --- | --- |
| CUDA | `CUDA_PATH` environment | Not supported | `-Dcuda=true`, `-Dnvcc_ccbin=` |
| ONNX | `onnx_libdir`/`onnx_include` | System/Homebrew | `-Donnx_include=`, `-Donnx_libdir=` |
| OpenBLAS | Package manager | Homebrew | Automatic detection |
| DNNL | Manual download | Manual download | `-Ddnnl=true`, `-Ddnnl_dir=` |
| Metal | Not supported | Automatic | macOS framework |
| Accelerate | Not supported | Automatic | macOS framework |

### Dependency Resolution Process

```mermaid
flowchart TD
    OSDetection["OS DetectionLinux/macOS/Distribution"]
    CompilerDetection["Compiler DetectionGCC/Clang Version"]
    LibraryProbe["Library Probingpkg-config/find_library"]
    SystemPackages["System PackagesDistribution-specific"]
    MesonSubprojects["Meson SubprojectsFallback Dependencies"]
    GitSubmodules["Git Submoduleslczero-common"]
    BackendSelection["Backend SelectionPriority Order"]
    FeatureDetection["Feature DetectionCapability Probing"]
    BuildOptions["Build Options-D flags"]

    OSDetection --> SystemPackages
    CompilerDetection --> LibraryProbe
    LibraryProbe --> MesonSubprojects
    SystemPackages --> BackendSelection
    MesonSubprojects --> BackendSelection
    GitSubmodules --> BackendSelection
    BackendSelection --> FeatureDetection
    FeatureDetection --> BuildOptions
```
Sources: [README.md43-46](https://github.com/LeelaChessZero/lc0/blob/b4e98c19/README.md#L43-L46) [README.md122-170](https://github.com/LeelaChessZero/lc0/blob/b4e98c19/README.md#L122-L170) [subprojects/protobuf.wrap](https://github.com/LeelaChessZero/lc0/blob/b4e98c19/subprojects/protobuf.wrap) [.gitmodules](https://github.com/LeelaChessZero/lc0/blob/b4e98c19/.gitmodules)
