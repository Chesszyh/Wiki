# Utilities and Support Functions

Relevant source files

-   [src/misc.cpp](https://github.com/official-stockfish/Stockfish/blob/c27c1747/src/misc.cpp)
-   [src/misc.h](https://github.com/official-stockfish/Stockfish/blob/c27c1747/src/misc.h)

This document covers the infrastructure and utility systems that support Stockfish's core chess engine functionality. These utilities provide essential services including logging, debugging, thread-safe I/O, memory management, string processing, and platform abstraction. The utilities are primarily implemented in the `misc.h` and `misc.cpp` files and serve as foundational components used throughout the engine.

For information about the build system and compilation infrastructure, see [Build System](/official-stockfish/Stockfish/7.1-build-system). For testing and benchmarking tools, see [Testing and Benchmarking](/official-stockfish/Stockfish/7.3-testing-and-benchmarking).

## Overview of Utility Systems

The utility infrastructure in Stockfish consists of several key subsystems that provide foundational services to the chess engine:

```mermaid
flowchart TD
    Prefetch["prefetch()Cache Preloading"]
    PRNG["PRNG Classxorshift64star"]
    MathUtils["Mathematical Utilitiesmul_hi64()"]
    Logger["Logger ClassTie Streams"]
    SyncIO["Thread-Safe I/OSyncCout, sync_cout"]
    DebugStats["Debug Statisticsdbg_hit_on(), dbg_mean_of()"]
    VersionInfo["engine_version_info()engine_info()"]
    StringUtils["String Processingsplit(), remove_whitespace()"]
    FileUtils["File Operationsread_file_to_string()"]
    TimeUtils["Time ManagementTimePoint, now()"]
    ValueList["ValueListFixed-Size Container"]
    MultiArray["MultiArrayN-Dimensional Array"]
    CommandLine["CommandLineArgument Processing"]
    PlatformDetect["Platform DetectionCompiler Info"]
    PathUtils["Path UtilitiesDirectory Management"]
    Endianness["Endianness DetectionIsLittleEndian"]

    CommandLine --> PathUtils
    Logger --> SyncIO
    DebugStats --> SyncIO
    VersionInfo --> StringUtils
    FileUtils --> StringUtils
```
Sources: [src/misc.h1-338](https://github.com/official-stockfish/Stockfish/blob/c27c1747/src/misc.h#L1-L338) [src/misc.cpp1-527](https://github.com/official-stockfish/Stockfish/blob/c27c1747/src/misc.cpp#L1-L527)

## Version and Engine Information

Stockfish provides comprehensive version and compiler information through dedicated utility functions:

| Function | Purpose | Return Type |
| --- | --- | --- |
| `engine_version_info()` | Returns full version string with git information | `std::string` |
| `engine_info(bool to_uci)` | Returns engine info formatted for UCI or display | `std::string` |
| `compiler_info()` | Returns detailed compilation and platform information | `std::string` |

The version system automatically incorporates git commit information during development builds:

```mermaid
flowchart TD
    VersionCheck["version == 'dev'"]
    GitInfo["Git InformationGIT_DATE, GIT_SHA"]
    CompilerDate["Compiler DATEFallback"]
    VersionString["Final Version StringStockfish dev-YYYYMMDD-SHA"]

    VersionCheck --> GitInfo
    VersionCheck --> VersionString
    GitInfo --> VersionString
    GitInfo --> CompilerDate
    CompilerDate --> VersionString
```
Sources: [src/misc.cpp127-162](https://github.com/official-stockfish/Stockfish/blob/c27c1747/src/misc.cpp#L127-L162) [src/misc.cpp166-283](https://github.com/official-stockfish/Stockfish/blob/c27c1747/src/misc.cpp#L166-L283)

## Logging System

The logging system provides a sophisticated mechanism for redirecting standard I/O streams to log files without modifying existing code:

### Tie Stream Architecture

```mermaid
flowchart TD
    classId_Tie_4["Tie"]
    classId_Logger_5["Logger"]
    classId_iostream_6["iostream"]
    classId_streambuf_7["streambuf"]
    note0["Intercepts I/O and duplicatesto both original stream and log file"]
    note1["Singleton pattern managesglobal logging state"]
```
The `Tie` class intercepts stream operations and duplicates them to both the original stream and the log file, with prefixes indicating input (`>>`) and output (`<<`) operations.

Sources: [src/misc.cpp51-111](https://github.com/official-stockfish/Stockfish/blob/c27c1747/src/misc.cpp#L51-L111)

## Debug Statistics System

Stockfish includes a comprehensive debugging system for collecting runtime statistics during engine development and tuning:

### Statistical Collection Functions

| Function | Purpose | Data Collected |
| --- | --- | --- |
| `dbg_hit_on(bool cond, int slot)` | Tracks conditional hit rates | Total calls, successful hits |
| `dbg_mean_of(int64_t value, int slot)` | Calculates average values | Count, sum |
| `dbg_stdev_of(int64_t value, int slot)` | Tracks standard deviation | Count, sum, sum of squares |
| `dbg_extremes_of(int64_t value, int slot)` | Records min/max values | Count, minimum, maximum |
| `dbg_correl_of(int64_t v1, int64_t v2, int slot)` | Measures correlation | Two-variable statistics |

The system supports up to 32 concurrent debugging slots (`MaxDebugSlots = 32`) for different measurements:

```mermaid
flowchart TD
    HitArrays["hit[32]DebugInfo<2>"]
    MeanArrays["mean[32]DebugInfo<2>"]
    StdevArrays["stdev[32]DebugInfo<3>"]
    CorrelArrays["correl[32]DebugInfo<6>"]
    ExtremeArrays["extremes[32]DebugExtremes"]
    HitOn["dbg_hit_on()"]
    MeanOf["dbg_mean_of()"]
    StdevOf["dbg_stdev_of()"]
    CorrelOf["dbg_correl_of()"]
    ExtremesOf["dbg_extremes_of()"]
    Print["dbg_print()"]
    Clear["dbg_clear()"]

    HitOn --> HitArrays
    MeanOf --> MeanArrays
    StdevOf --> StdevArrays
    CorrelOf --> CorrelArrays
    ExtremesOf --> ExtremeArrays
    HitArrays --> Print
    MeanArrays --> Print
    StdevArrays --> Print
    CorrelArrays --> Print
    ExtremeArrays --> Print
    Clear --> HitArrays
    Clear --> MeanArrays
    Clear --> StdevArrays
    Clear --> CorrelArrays
    Clear --> ExtremeArrays
```
Sources: [src/misc.cpp287-411](https://github.com/official-stockfish/Stockfish/blob/c27c1747/src/misc.cpp#L287-L411)

## Thread-Safe I/O System

Stockfish implements a thread-safe console output system to prevent garbled output in multi-threaded search:

### SyncCout Implementation

The system uses the `SyncCout` enum and overloaded stream operator to provide mutex-protected console access through convenient macros.

Sources: [src/misc.cpp415-429](https://github.com/official-stockfish/Stockfish/blob/c27c1747/src/misc.cpp#L415-L429) [src/misc.h111-121](https://github.com/official-stockfish/Stockfish/blob/c27c1747/src/misc.h#L111-L121)

## Memory and Performance Utilities

### Cache Prefetching

The `prefetch()` function provides platform-specific cache preloading to improve memory access performance:

```mermaid
flowchart TD
    PrefetchCall["prefetch(const void* addr)"]
    MSVCCheck["#ifdef _MSC_VER"]
    NoPreCheck["#ifdef NO_PREFETCH"]
    GCCCheck["Default: __builtin_prefetch"]
    MSVCImpl["_mm_prefetch((char*)addr, _MM_HINT_T0)"]
    NoImpl["Empty function"]
    GCCImpl["__builtin_prefetch(addr)"]

    PrefetchCall --> NoPreCheck
    NoPreCheck --> NoImpl
    NoPreCheck --> MSVCCheck
    MSVCCheck --> MSVCImpl
    MSVCCheck --> GCCCheck
    GCCCheck --> GCCImpl
```
Sources: [src/misc.cpp435-450](https://github.com/official-stockfish/Stockfish/blob/c27c1747/src/misc.cpp#L435-L450)

### High-Precision Multiplication

The `mul_hi64()` function provides efficient 64-bit multiplication with 128-bit intermediate results:

```mermaid
flowchart TD
    Input["mul_hi64(uint64_t a, uint64_t b)"]
    GCC64["GNUC && IS_64BIT"]
    Fallback["Generic Implementation"]
    Uint128["__int128 native support(uint128(a) * uint128(b)) >> 64"]
    Manual["Manual 32-bit decompositionFour partial products"]

    Input --> GCC64
    GCC64 --> Uint128
    GCC64 --> Fallback
    Fallback --> Manual
```
Sources: [src/misc.h279-291](https://github.com/official-stockfish/Stockfish/blob/c27c1747/src/misc.h#L279-L291)

## Data Structure Utilities

### ValueList Template

The `ValueList` template provides a fixed-size container optimized for small collections:

```mermaid
flowchart TD
    classId_ValueList_8["ValueList<T_MaxSize>"]
    note0["Stack-allocated containerwith fixed maximum size"]
```
### MultiArray Template

The `MultiArray` template implements N-dimensional arrays with compile-time dimensions:

```mermaid
flowchart TD
    classId_MultiArray_9["MultiArray<T_Size_Sizes>"]
    classId_MultiArrayHelper_10["MultiArrayHelper<T_Size_Sizes>"]
    note0["Recursive template structuresupports arbitrary dimensions"]
    note1["Type helper for recursivedimension resolution"]
```
Sources: [src/misc.h128-232](https://github.com/official-stockfish/Stockfish/blob/c27c1747/src/misc.h#L128-L232)

## String and File Processing

Stockfish provides various string manipulation and file I/O utilities:

### String Processing Functions

| Function | Purpose | Implementation |
| --- | --- | --- |
| `split(string_view s, string_view delimiter)` | Splits string by delimiter | Returns `vector<string_view>` |
| `remove_whitespace(string& s)` | Removes all whitespace in-place | Uses `std::remove_if` with `std::isspace` |
| `is_whitespace(string_view s)` | Checks if string contains only whitespace | Uses `std::all_of` with `std::isspace` |
| `str_to_size_t(const string& s)` | Safe string to size\_t conversion | Bounds checking with exit on overflow |

### File Operations

```mermaid
flowchart TD
    ReadFile["read_file_to_string(const string& path)"]
    OpenFile["std::ifstream(path, binary)"]
    CheckOpen["File opened successfully?"]
    ReadData["std::istreambuf_iterator"]
    ReturnData["Return std::string"]
    ReturnNull["Return std::nullopt"]

    ReadFile --> OpenFile
    OpenFile --> CheckOpen
    CheckOpen --> ReadData
    CheckOpen --> ReturnNull
    ReadData --> ReturnData
```
Sources: [src/misc.h86-109](https://github.com/official-stockfish/Stockfish/blob/c27c1747/src/misc.h#L86-L109) [src/misc.cpp460-480](https://github.com/official-stockfish/Stockfish/blob/c27c1747/src/misc.cpp#L460-L480)

## Platform Abstraction

### CommandLine Utilities

The `CommandLine` class provides cross-platform utilities for handling command-line arguments and directory operations:

```mermaid
flowchart TD
    classId_CommandLine_11["CommandLine"]
    note0["Handles platform differencesin path separators andworking directory access"]
```
### Platform-Specific Implementations

| Feature | Windows | Unix/Linux | Implementation |
| --- | --- | --- | --- |
| Path Separator | `\\` | `/` | Conditional compilation |
| Working Directory | `_getcwd()` | `getcwd()` | `GETCWD` macro |
| Program Path | `_get_pgmptr()` | `argv[0]` | MSVC-specific handling |

Sources: [src/misc.cpp482-524](https://github.com/official-stockfish/Stockfish/blob/c27c1747/src/misc.cpp#L482-L524) [src/misc.h294-305](https://github.com/official-stockfish/Stockfish/blob/c27c1747/src/misc.h#L294-L305)

## PRNG and Mathematical Utilities

### xorshift64star Pseudo-Random Number Generator

Stockfish implements a high-quality PRNG based on Sebastiano Vigna's xorshift64star algorithm:

```mermaid
flowchart TD
    classId_PRNG_12["PRNG"]
    note0["Period: 2^64 - 1Speed: 1.60 ns/callPasses Dieharder tests"]
```
The `sparse_rand()` method produces values with only 1/8th of bits set on average, useful for generating magic numbers in bitboard operations.

Sources: [src/misc.h250-277](https://github.com/official-stockfish/Stockfish/blob/c27c1747/src/misc.h#L250-L277)

## Compiler and Build Integration

### Compiler Hint Macros

Stockfish provides compiler-specific optimization hints through the `sf_assume()` macro:

```mermaid
flowchart TD
    CompilerCheck["Compiler Detection"]
    GCC13["GCC >= 13"]
    GCCOlder["GCC < 13"]
    GCCAssume["attribute((assume(cond)))"]
    GCCUnreach["__builtin_unreachable()"]
    OtherComp["Clang, MSVC, etc."]
    NoOp["No operation"]

    CompilerCheck --> GCC13
    CompilerCheck --> GCCOlder
    CompilerCheck --> OtherComp
    GCC13 --> GCCAssume
    GCCOlder --> GCCUnreach
    OtherComp --> NoOp
```
### Endianness Detection

The system provides compile-time endianness detection through a simple but effective method:

```
static inline const std::uint16_t Le = 1;
static inline const bool IsLittleEndian = *reinterpret_cast<const char*>(&Le) == 1;
```
Sources: [src/misc.h320-334](https://github.com/official-stockfish/Stockfish/blob/c27c1747/src/misc.h#L320-L334) [src/misc.h124-125](https://github.com/official-stockfish/Stockfish/blob/c27c1747/src/misc.h#L124-L125)
