# 8.2 身份验证与多租户 (Authentication and Multi-tenancy)

相关源文件：

- [api/db/db_models.py](https://github.com/infiniflow/ragflow/blob/80a16e71/api/db/db_models.py)
- [api/db/services/knowledgebase_service.py](https://github.com/infiniflow/ragflow/blob/80a16e71/api/db/services/knowledgebase_service.py)
- [api/utils/api_utils.py](https://github.com/infiniflow/ragflow/blob/80a16e71/api/utils/api_utils.py)

## 目的与范围 (Purpose and Scope)

本文档介绍了 RAGFlow 的身份验证和多租户（Multi-tenancy）实现，涵盖了 API 请求的验证方式、租户隔离的强制执行以及系统中资源所有权的验证机制。

## 身份验证机制 (Authentication Mechanisms)

RAGFlow 实现了基于 API Key 的令牌验证系统。所有 HTTP API 请求必须在 `Authorization` 标头中包含 Bearer 令牌。

**授权标头格式：**
```text
Authorization: Bearer <YOUR_API_KEY>
```

**令牌验证流程：**
1.  从 `Authorization` 标头中提取令牌。
2.  在 `APIToken` 表中查询该令牌。
3.  验证令牌是否存在并提取关联的 `tenant_id`（租户 ID）。
4.  将 `tenant_id` 传递给端点处理函数。

## 身份验证装饰器 (Authentication Decorators)

RAGFlow 使用 Python 装饰器在 API 端点上强制执行身份验证。

-   **`@token_required`**：用于 SDK 或外部 API 访问。它会解析标头、查询数据库、提取 `tenant_id` 并将其注入到函数的关键字参数（kwargs）中。
-   **`@login_required`**：用于 Web UI 请求，验证用户的会话（Session）或 JWT 令牌。
-   **`@active_required`**：在允许 API 访问前，检查用户账号的激活状态。

## 多租户架构 (Multi-tenancy Architecture)

RAGFlow 采用严格的租户隔离模型，所有资源（数据集、文档、聊天助手等）都属于特定的租户。

### 租户隔离与传播
1.  **自动注入**：`@token_required` 装饰器会自动将 `tenant_id` 注入到端点函数中。
2.  **查询隔离**：服务层（Service Layer）的所有查询方法都必须接收并使用 `tenant_id` 进行过滤，确保用户无法访问其他租户的资源。

### 资源所有权验证
系统在多个层级验证资源所有权：
-   **直接查询**：通过 `id` 和 `tenant_id` 联合查询资源。
-   **权限检查**：使用 `KnowledgebaseService.accessible()` 方法检查用户是否具有读取或操作特定知识库的权限。

## 权限模型 (Permission Models)

RAGFlow 提供两级权限系统：
-   **`me` (个人)**：仅创建者（租户）可以访问。
-   **`team` (团队)**：属于同一团队的所有成员均可访问。

知识库资源通过 `permission` 字段存储此设置，并在访问时由业务逻辑进行校验。

## OpenAI 兼容端点验证 (OpenAI-Compatible API Authentication)

兼容 OpenAI 的端点（如 `/api/v1/chats_openai/...`）遵循相同的验证模式，要求提供 `Authorization: Bearer <YOUR_API_KEY>` 标头，并执行一致的租户隔离逻辑。

## 环境变量控制 (Environment Variable Controls)

-   **`DISABLE_SDK`**：设置后将完全禁用 SDK/API 访问。
-   **`REGISTER_ENABLED`**：控制是否允许新用户注册。

## 最佳实践 (Best Practices)

-   **安全性**：API Key 应妥善保存，切勿提交至版本控制系统。
-   **开发建议**：开发者应始终使用 `@token_required` 装饰器，并确保所有数据库操作都包含 `tenant_id` 过滤，利用现有的服务层方法（如 `accessible()`）来简化权限校验。
