# 9.1 画布引擎与 DSL (Canvas Engine and DSL)

相关源文件：

- [agent/canvas.py](https://github.com/infiniflow/ragflow/blob/80a16e71/agent/canvas.py)
- [agent/component/agent_with_tools.py](https://github.com/infiniflow/ragflow/blob/80a16e71/agent/component/agent_with_tools.py)
- [agent/component/base.py](https://github.com/infiniflow/ragflow/blob/80a16e71/agent/component/base.py)
- [agent/component/categorize.py](https://github.com/infiniflow/ragflow/blob/80a16e71/agent/component/categorize.py)
- [agent/component/llm.py](https://github.com/infiniflow/ragflow/blob/80a16e71/agent/component/llm.py)
- [agent/tools/base.py](https://github.com/infiniflow/ragflow/blob/80a16e71/agent/tools/base.py)
- [api/apps/api_app.py](https://github.com/infiniflow/ragflow/blob/80a16e71/api/apps/api_app.py)
- [api/apps/canvas_app.py](https://github.com/infiniflow/ragflow/blob/80a16e71/api/apps/canvas_app.py)
- [rag/prompts/generator.py](https://github.com/infiniflow/ragflow/blob/80a16e71/rag/prompts/generator.py)
- [web/src/components/knowledge-base-item.tsx](https://github.com/infiniflow/ragflow/blob/80a16e71/web/src/components/knowledge-base-item.tsx)
- [web/src/interfaces/request/flow.ts](https://github.com/infiniflow/ragflow/blob/80a16e71/web/src/interfaces/request/flow.ts)

本文档描述了画布工作流引擎及其基于 JSON 的领域特定语言（DSL）。画布引擎通过执行有向图结构中定义的组件来编排多步 AI 智能体工作流。

---

## 概述 (Overview)

画布引擎允许用户通过在图结构中连接组件来构建复杂的 AI 工作流。每个工作流都定义为一个 JSON DSL 文档，其中包含：
- 组件及其配置
- 组件间的执行流
- 全局变量和状态
- 对话历史和检索结果

引擎支持两种模式：
1. **智能体模式** (`Canvas` 类)：具有历史追踪的交互式对话工作流。
2. **数据流模式** (`Graph` 类基类)：文档处理流水线。

---

## DSL 结构 (DSL Structure)

### 完整 DSL 模式 (Complete DSL Schema)
DSL 是一个具有以下顶级结构的 JSON 对象：

```json
{
  "components": {},  // 组件定义
  "history": [],     // 对话历史
  "path": [],        // 执行路径
  "retrieval": {},   // 检索结果
  "memory": [],      // 长期记忆
  "globals": {},     // 系统/全局变量
  "variables": {},   // 用户定义变量
  "graph": {}        // 前端 UI 元数据
}
```

### 组件字段 (Components Field)
`components` 字段是一个映射，将组件 ID 映射到组件定义：

| 字段 | 类型 | 描述 |
| --- | --- | --- |
| `obj.component_name` | string | 组件类型标识符（如 "Begin", "Retrieval", "Generate"） |
| `obj.params` | object | 组件特定的配置参数 |
| `downstream` | string[] | 此组件之后要执行的组件 ID 列表 |
| `upstream` | string[] | 在此组件之前执行的组件 ID 列表 |
| `parent_id` | string (可选) | 嵌套组件（循环/迭代项）的父组件 ID |

---

## Graph 与 Canvas 类 (Graph and Canvas Classes)

### Graph 类 (基类)
`Graph` 类 (`agent/canvas.py`) 提供基础的工作流编排功能。
- **加载 (load)**：解析 DSL，实例化组件并校验参数。
- **变量解析 (get_variable_value)**：解析形如 `{cpn_id@output}` 的变量表达式。
- **任务管理 (is_canceled)**：支持通过 Redis 标志进行任务取消。

### Canvas 类 (智能体模式)
`Canvas` 类扩展了 `Graph`，用于对话式智能体工作流：
- **run()**：异步执行工作流，通过 SSE（服务器发送事件）生成实时反馈。
- **状态管理**：管理对话历史 (`history`)、检索切片 (`retrieval`) 和情节记忆 (`memory`)。

---

## 变量引用语法 (Variable Reference Syntax)

DSL 中的变量使用特定语法引用组件输出和全局变量：

| 模式 | 描述 | 示例 |
| --- | --- | --- |
| `{component_id@output_name}` | 组件输出 | `{retrieval_0@content}` |
| `{sys.variable_name}` | 系统变量 | `{sys.query}` |
| `{env.variable_name}` | 环境变量 | `{env.api_key}` |
| `{component_id@output.field}` | 嵌套字段访问 | `{retrieval_0@result.score}` |

---

## 任务管理 (Task Management)

每个工作流执行都有一个唯一的 `task_id`，用于：
- **Redis 取消标志**：`{task_id}-cancel`。执行循环在每个批次前检查此标志，若设置则抛出 `TaskCanceledException`。
- **日志追踪**：`{task_id}-{message_id}-logs`。记录工具调用、分析过程和耗时。

---

## 总结 (Summary)

画布引擎与 DSL 提供了：
1. **灵活的工作流定义**：基于 JSON 的 DSL 描述了带参数的组件图。
2. **变量系统**：使用 `{expr}` 语法引用组件输出和全局变量。
3. **编排与执行**：具有动态路径构建和流控机制的图遍历。
4. **状态持久化**：跨执行轮次保留历史、检索结果、记忆和变量。

DSL 将工作流定义与执行分离，从而支持可视化编辑器、工作流模板化以及 API 驱动的自动化执行。
