# 10.1 查询处理与精炼 (Query Processing and Refinement)

相关源文件：

- [api/db/services/dialog_service.py](https://github.com/infiniflow/ragflow/blob/80a16e71/api/db/services/dialog_service.py)
- [rag/nlp/query.py](https://github.com/infiniflow/ragflow/blob/80a16e71/rag/nlp/query.py)
- [rag/nlp/search.py](https://github.com/infiniflow/ragflow/blob/80a16e71/rag/nlp/search.py)
- [rag/prompts/generator.py](https://github.com/infiniflow/ragflow/blob/80a16e71/rag/prompts/generator.py)

本页面描述了查询预处理与精炼流水线，该流程将用户的问题转化为针对检索优化的表示形式。这包括文本规范化、分词、关键词提取、跨语言翻译以及多轮对话精炼。

---

## 查询处理流水线概览 (Pipeline Overview)

查询处理流水线在检索前通过多个精炼阶段转换原始用户输入。该流水线由 `DialogService` 中的 `async_chat` 函数协调。

---

## 文本规范化与清洗 (Text Normalization)

`FulltextQueryer` 类执行初始文本规范化，以标准化查询表示：
- **字符规范化**：全角转半角，繁体转简体。
- **疑问词移除 (`rmWWW`)**：移除对语义贡献较小的疑问词（如“怎么办”、“如何”、“what”、“how”）。
- **空格规范化**：在中英文边界自动添加空格，以提高分词准确性。

---

## 多轮查询精炼 (Multi-turn Refinement)

对于包含多轮对话的上下文，系统可以将对话历史整合为单个语义完整的查询。
- **触发条件**：在 `prompt_config` 中开启 `refine_multiturn`。
- **功能**：利用 LLM 将诸如“那价格呢？”（接在“介绍一下 RAGFlow”之后）的问题改写为“RAGFlow 的价格是多少？”。

---

## 跨语言查询翻译 (Cross-language Translation)

当配置了 `cross_languages` 参数时，系统会翻译查询以改进在多语言知识库中的检索效果。
- **效果**：生成的检索词通常包含原始语言和目标语言（如：“如何使用系统 How to use the system”），从而同时触发双语切片的召回。

---

## 关键词提取 (Keyword Extraction)

基于 LLM 的关键词提取能够通过增加语义相关的术语来增强查询。
- **机制**：调用 LLM 识别核心术语并追加到查询末尾，从而通过扩展词汇量来提高全文检索的召回率（Recall）。

---

## 查询分词与嵌入 (Tokenization and Embedding)

- **查询分词**：使用 `rag_tokenizer` 将文本转换为搜索 Token。支持粗粒度（单词/短语）和细粒度（字符/子词）两种模式。
- **向量生成**：对于向量相似度搜索，通过配置的嵌入模型将处理后的查询文本转换为稠密向量（Dense Embeddings）。

---

## 基于元数据的文档过滤 (Metadata Filtering)

在检索开始前，系统支持根据文档元数据条件缩小搜索范围。
- **逻辑运算符**：支持 `and` 和 `or`。
- **比较符**：支持 `is` (等于), `is_not` (不等于), `contains` (包含), `greater_equal` (大于等于) 等。
- **作用**：显著减少搜索空间并提高检索精度。

---

## 总结 (Summary)

查询精炼步骤确保了检索系统能够理解用户的真实意图并从海量数据中精准召回：
- **多轮一致性**：解决了指代模糊和语境缺失问题。
- **语义增强**：通过关键词和翻译跨越了语言和词汇表达的鸿沟。
- **结构化约束**：结合元数据过滤，实现了结构化与非结构化数据的联合检索。
