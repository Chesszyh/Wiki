# 后端实现 (Backend Implementations)

相关源文件

-   [celery/app/builtins.py](https://github.com/celery/celery/blob/4d068b56/celery/app/builtins.py)
-   [celery/backends/\_\_init\_\_.py](https://github.com/celery/celery/blob/4d068b56/celery/backends/__init__.py)
-   [celery/backends/base.py](https://github.com/celery/celery/blob/4d068b56/celery/backends/base.py)
-   [celery/backends/cache.py](https://github.com/celery/celery/blob/4d068b56/celery/backends/cache.py)
-   [celery/backends/redis.py](https://github.com/celery/celery/blob/4d068b56/celery/backends/redis.py)
-   [celery/backends/rpc.py](https://github.com/celery/celery/blob/4d068b56/celery/backends/rpc.py)
-   [celery/result.py](https://github.com/celery/celery/blob/4d068b56/celery/result.py)
-   [docs/userguide/configuration.rst](https://github.com/celery/celery/blob/4d068b56/docs/userguide/configuration.rst)
-   [t/unit/backends/test\_base.py](https://github.com/celery/celery/blob/4d068b56/t/unit/backends/test_base.py)
-   [t/unit/backends/test\_redis.py](https://github.com/celery/celery/blob/4d068b56/t/unit/backends/test_redis.py)
-   [t/unit/tasks/test\_chord.py](https://github.com/celery/celery/blob/4d068b56/t/unit/tasks/test_chord.py)
-   [t/unit/tasks/test\_result.py](https://github.com/celery/celery/blob/4d068b56/t/unit/tasks/test_result.py)

本文件涵盖了 Celery 中结果后端的具体实现。这些实现提供了使用不同存储系统存储、检索和管理任务结果的具体功能。有关整体后端架构和接口，请参阅[结果后端架构](/celery/celery/6.1-backend-architecture)。有关从用户角度处理结果的信息，请参阅[并发模型](/celery/celery/5.3-concurrency-models)（原文此处可能引用有误，应指处理结果的相关章节）。

## 后端实现概览

Celery 提供了多种后端实现，这些实现扩展了基础后端架构以支持不同的存储系统。每种实现都为结果存储和检索提供了特定的能力和权衡。

### 后端实现架构

```mermaid
flowchart TD
    BaseBackend["BaseBackendbase.py"]
    KeyValueBackend["BaseKeyValueStoreBackendbase.py"]
    AsyncMixin["AsyncBackendMixinasynchronous.py"]
    RedisBackend["RedisBackendredis.py"]
    ElasticsearchBackend["ElasticsearchBackendelasticsearch.py"]
    MongoBackend["MongoBackendmongodb.py"]
    CassandraBackend["CassandraBackendcassandra.py"]
    RedisClient["redis.StrictRedis"]
    ESClient["elasticsearch.Elasticsearch"]
    MongoClient["pymongo.MongoClient"]
    CassandraCluster["cassandra.cluster.Cluster"]

    BaseBackend --> KeyValueBackend
    BaseBackend --> MongoBackend
    BaseBackend --> CassandraBackend
    KeyValueBackend --> RedisBackend
    KeyValueBackend --> ElasticsearchBackend
    AsyncMixin --> RedisBackend
    RedisBackend --> RedisClient
    ElasticsearchBackend --> ESClient
    MongoBackend --> MongoClient
    CassandraBackend --> CassandraCluster
```
### 后端特性矩阵

| 后端 | 基类 | 异步支持 | Chord 支持 | 自动过期 | 原生 Join |
| --- | --- | --- | --- | --- | --- |
| `RedisBackend` | `BaseKeyValueStoreBackend` | ✅ | ✅ | ✅ | ✅ |
| `MongoBackend` | `BaseBackend` | ❌ | ❌ | ❌ | ❌ |
| `CassandraBackend` | `BaseBackend` | ❌ | ❌ | ✅ | ❌ |
| `ElasticsearchBackend` | `KeyValueStoreBackend` | ❌ | ❌ | ❌ | ❌ |

来源：[celery/backends/mongodb.py54](https://github.com/celery/celery/blob/4d068b56/celery/backends/mongodb.py#L54-L54) [celery/backends/cassandra.py86](https://github.com/celery/celery/blob/4d068b56/celery/backends/cassandra.py#L86-L86) [celery/backends/elasticsearch.py30](https://github.com/celery/celery/blob/4d068b56/celery/backends/elasticsearch.py#L30-L30)

## Redis 后端实现

`RedisBackend` 是特性最完备的后端实现，提供高性能的结果存储，并支持完整的异步操作和 chord 协调。它扩展了 `BaseKeyValueStoreBackend` 和 `AsyncBackendMixin`。

### Redis 后端架构

```mermaid
flowchart TD
    RedisBackend["RedisBackendredis.py:188"]
    ResultConsumer["ResultConsumerredis.py:81"]
    BaseKVStore["BaseKeyValueStoreBackend"]
    AsyncMixin["AsyncBackendMixin"]
    BasicOps["基础操作GET, SET, MGET, DEL"]
    ChordOps["Chord 操作ZADD, ZRANGE, INCR"]
    PubSubOps["发布/订阅操作PUBLISH, SUBSCRIBE"]
    PipelineOps["流水线操作批量命令"]
    ConnPool["连接池redis.ConnectionPool"]
    RetryPolicy["重试策略retry_over_time()"]
    ConnErrors["连接错误get_redis_error_classes()"]
    PubSub["发布/订阅redis.pubsub()"]
    EventDrain["drain_events()消息处理"]
    StateChange["on_state_change()结果交付"]

    RedisBackend --> BaseKVStore
    RedisBackend --> AsyncMixin
    RedisBackend --> ResultConsumer
    RedisBackend --> BasicOps
    RedisBackend --> ChordOps
    RedisBackend --> PubSubOps
    RedisBackend --> PipelineOps
    RedisBackend --> ConnPool
    RedisBackend --> RetryPolicy
    RedisBackend --> ConnErrors
    ResultConsumer --> PubSub
    ResultConsumer --> EventDrain
    ResultConsumer --> StateChange
```
### Redis 后端特性

`RedisBackend` 类 [celery/backends/redis.py188-615](https://github.com/celery/celery/blob/4d068b56/celery/backends/redis.py#L188-L615) 提供了全面的结果后端能力：

**特性支持：**

-   `supports_autoexpire = True` —— 基于 TTL 的自动过期 [celery/backends/redis.py204](https://github.com/celery/celery/blob/4d068b56/celery/backends/redis.py#L204-L204)
-   `supports_native_join = True` —— 原生结果合并 (join) [celery/backends/redis.py205](https://github.com/celery/celery/blob/4d068b56/celery/backends/redis.py#L205-L205)
-   `implements_incr = True` —— 通过 `incr()` 实现原子递增操作 [celery/backends/redis.py424-425](https://github.com/celery/celery/blob/4d068b56/celery/backends/redis.py#L424-L425)

**核心操作：**

-   `get(key)` —— 单个键检索 [celery/backends/redis.py381-382](https://github.com/celery/celery/blob/4d068b56/celery/backends/redis.py#L381-L382)
-   `mget(keys)` —— 批量键检索 [celery/backends/redis.py384-385](https://github.com/celery/celery/blob/4d068b56/celery/backends/redis.py#L384-L385)
-   `set(key, value)` —— 带有流水线发布 (pipeline publish) 的存储 [celery/backends/redis.py402-415](https://github.com/celery/celery/blob/4d068b56/celery/backends/redis.py#L402-L415)
-   `delete(key)` —— 键删除 [celery/backends/redis.py421-422](https://github.com/celery/celery/blob/4d068b56/celery/backends/redis.py#L421-L422)

**Chord 协调：** Redis 后端通过 `on_chord_part_return()` [celery/backends/redis.py469-556](https://github.com/celery/celery/blob/4d068b56/celery/backends/redis.py#L469-L556) 实现了复杂的 chord 协调，使用 Redis 有序集合 (`ZADD`/`ZRANGE`) 或列表 (`RPUSH`/`LRANGE`) 进行有序的结果收集。

### Redis 连接配置

该后端支持广泛的 Redis 连接配置 [celery/backends/redis.py234-273](https://github.com/celery/celery/blob/4d068b56/celery/backends/redis.py#L234-L273)：

| 参数 | 配置键 | 描述 |
| --- | --- | --- |
| `host` | `redis_host` | Redis 服务器主机名 |
| `port` | `redis_port` | Redis 服务器端口 |
| `db` | `redis_db` | Redis 数据库编号 |
| `password` | `redis_password` | 认证密码 |
| `username` | `redis_username` | 用户名 (Redis 6.0+) |
| `max_connections` | `redis_max_connections` | 连接池大小 |

来源：[celery/backends/redis.py188-615](https://github.com/celery/celery/blob/4d068b56/celery/backends/redis.py#L188-L615) [celery/backends/redis.py81-186](https://github.com/celery/celery/blob/4d068b56/celery/backends/redis.py#L81-L186)

## MongoDB 后端实现

`MongoBackend` 使用 MongoDB 文档数据库提供结果存储。它直接扩展了 `BaseBackend`，并支持基于文档的存储和 BSON 序列化。

### MongoDB 后端架构

```mermaid
flowchart TD
    MongoBackend["MongoBackend"]
    BaseBackend["BaseBackend"]
    PymongoClient["pymongo.MongoClient"]
    PymongoURIParser["pymongo.uri_parser"]
    collection["collection 属性"]
    group_collection["group_collection 属性"]
    taskmeta_collection["taskmeta_collection"]
    groupmeta_collection["groupmeta_collection"]
    create_index["create_index('date_done')"]
    encode_method["encode()"]
    decode_method["decode()"]
    Binary["Binary() 包装器"]
    BINARY_CODECS["BINARY_CODECS frozenset"]
    _store_result["_store_result()"]
    _get_task_meta_for["_get_task_meta_for()"]
    _save_group["_save_group()"]
    _restore_group["_restore_group()"]
    replace_one["replace_one(upsert=True)"]
    find_one["find_one()"]

    MongoBackend --> BaseBackend
    MongoBackend --> PymongoClient
    MongoBackend --> PymongoURIParser
    MongoBackend --> collection
    MongoBackend --> group_collection
    collection --> taskmeta_collection
    group --> collection_groupmeta_collection
    collection --> create_index
    MongoBackend --> encode_method
    MongoBackend --> decode_method
    encode --> method_Binary
    encode --> method_BINARY_CODECS
    MongoBackend --> _store_result
    MongoBackend --> _get_task_meta_for
    MongoBackend --> _save_group
    MongoBackend --> _restore_group
    _store --> result_replace_one
    _get --> task_meta_for_find_one
```
### MongoDB 后端操作

`MongoBackend` 类 [celery/backends/mongodb.py35-334](https://github.com/celery/celery/blob/4d068b56/celery/backends/mongodb.py#L35-L334) 实现了基于文档的结果存储：

**核心操作：**

-   `_store_result()` —— 使用带有 upsert 的 `replace_one()` 存储任务结果 [celery/backends/mongodb.py181-194](https://github.com/celery/celery/blob/4d068b56/celery/backends/mongodb.py#L181-L194)
-   `_get_task_meta_for()` —— 使用 `find_one()` 检索任务元数据 [celery/backends/mongodb.py197-224](https://github.com/celery/celery/blob/4d068b56/celery/backends/mongodb.py#L197-L224)
-   `_save_group()` —— 存储组结果 [celery/backends/mongodb.py226-234](https://github.com/celery/celery/blob/4d068b56/celery/backends/mongodb.py#L226-L234)
-   `_restore_group()` —— 检索组结果 [celery/backends/mongodb.py236-247](https://github.com/celery/celery/blob/4d068b56/celery/backends/mongodb.py#L236-L247)
-   `_delete_group()` —— 按 ID 删除组 [celery/backends/mongodb.py249-251](https://github.com/celery/celery/blob/4d068b56/celery/backends/mongodb.py#L249-L251)
-   `_forget()` —— 使用 `delete_one()` 移除结果 [celery/backends/mongodb.py253-263](https://github.com/celery/celery/blob/4d068b56/celery/backends/mongodb.py#L253-L263)
-   `cleanup()` —— 删除过期的文档 [celery/backends/mongodb.py265-275](https://github.com/celery/celery/blob/4d068b56/celery/backends/mongodb.py#L265-L275)

**文档结构**：每个任务结果都存储为一个 MongoDB 文档，其中 `_id` 是任务 ID [celery/backends/mongodb.py188](https://github.com/celery/celery/blob/4d068b56/celery/backends/mongodb.py#L188-L188)，并包含标准的元数据字段，如 `status`, `result`, `date_done` 和 `traceback`。扩展元数据包含 `name`, `args`, `kwargs`, `queue`, `worker` 和 `retries` [celery/backends/mongodb.py201-215](https://github.com/celery/celery/blob/4d068b56/celery/backends/mongodb.py#L201-L215)。

**二进制编解码器处理**：该后端通过 `BINARY_CODECS = frozenset(['pickle', 'msgpack'])` [celery/backends/mongodb.py32](https://github.com/celery/celery/blob/4d068b56/celery/backends/mongodb.py#L32-L32) 处理序列化，并使用 `Binary()` 包装二进制数据以便在 MongoDB 中存储 [celery/backends/mongodb.py172-173](https://github.com/celery/celery/blob/4d068b56/celery/backends/mongodb.py#L172-L173)。

**连接管理：**

-   `_get_connection()` —— 使用连接选项创建 `MongoClient` [celery/backends/mongodb.py136-163](https://github.com/celery/celery/blob/4d068b56/celery/backends/mongodb.py#L136-L163)
-   `_ensure_mongodb_uri_compliance()` —— 验证并规范化 MongoDB URI [celery/backends/mongodb.py118-127](https://github.com/celery/celery/blob/4d068b56/celery/backends/mongodb.py#L118-L127)
-   `_prepare_client_options()` —— 根据 PyMongo 版本配置客户端选项 [celery/backends/mongodb.py129-134](https://github.com/celery/celery/blob/4d068b56/celery/backends/mongodb.py#L129-L134)

来源：[celery/backends/mongodb.py32](https://github.com/celery/celery/blob/4d068b56/celery/backends/mongodb.py#L32-L32) [celery/backends/mongodb.py136-163](https://github.com/celery/celery/blob/4d068b56/celery/backends/mongodb.py#L136-L163) [celery/backends/mongodb.py181-275](https://github.com/celery/celery/blob/4d068b56/celery/backends/mongodb.py#L181-L275)

## Cassandra 后端实现

`CassandraBackend` 使用 Apache Cassandra 或 AstraDB 提供结果存储。它扩展了 `BaseBackend`，并支持常规 Cassandra 集群以及带有安全连接捆绑包 (secure connect bundles) 的云端 AstraDB。

### Cassandra 后端架构

```mermaid
flowchart TD
    CassandraBackend["CassandraBackend"]
    BaseBackend["BaseBackend"]
    cassandra_cluster_Cluster["cassandra.cluster.Cluster"]
    cassandra_query_SimpleStatement["cassandra.query.SimpleStatement"]
    servers["servers 参数"]
    bundle_path["bundle_path 参数"]
    auth_provider["auth_provider"]
    cassandra_options["cassandra_options"]
    _cluster["_cluster 实例"]
    _session["_session 实例"]
    Q_INSERT_RESULT["Q_INSERT_RESULT"]
    Q_SELECT_RESULT["Q_SELECT_RESULT"]
    Q_CREATE_RESULT_TABLE["Q_CREATE_RESULT_TABLE"]
    Q_EXPIRES["Q_EXPIRES (TTL)"]
    _write_stmt["_write_stmt"]
    _read_stmt["_read_stmt"]
    write_consistency["write_consistency"]
    read_consistency["read_consistency"]
    _get_connection["_get_connection()"]
    _store_result["_store_result()"]
    _get_task_meta_for["_get_task_meta_for()"]
    buf_t["buf_t() 编码"]

    CassandraBackend --> BaseBackend
    CassandraBackend --> cassandra_cluster_Cluster
    CassandraBackend --> cassandra_query_SimpleStatement
    CassandraBackend --> servers
    CassandraBackend --> bundle_path
    CassandraBackend --> auth_provider
    CassandraBackend --> cassandra_options
    CassandraBackend --> _cluster
    CassandraBackend --> _session
    CassandraBackend --> Q_INSERT_RESULT
    CassandraBackend --> Q_SELECT_RESULT
    CassandraBackend --> Q_CREATE_RESULT_TABLE
    CassandraBackend --> Q_EXPIRES
    CassandraBackend --> _write_stmt
    CassandraBackend --> _read_stmt
    CassandraBackend --> write_consistency
    CassandraBackend --> read_consistency
    CassandraBackend --> _get_connection
    CassandraBackend --> _store_result
    CassandraBackend --> _get_task_meta_for
    CassandraBackend --> buf_t
```
### Cassandra 后端特性

`CassandraBackend` 类 [celery/backends/cassandra.py71-257](https://github.com/celery/celery/blob/4d068b56/celery/backends/cassandra.py#L71-L257) 提供分布式结果存储：

**特性支持：**

-   `supports_autoexpire = True` —— 基于 TTL 的自动过期 [celery/backends/cassandra.py86](https://github.com/celery/celery/blob/4d068b56/celery/backends/cassandra.py#L86-L86)
-   双连接模式：标准集群或 AstraDB 云捆绑包 [celery/backends/cassandra.py104-110](https://github.com/celery/celery/blob/4d068b56/celery/backends/cassandra.py#L104-L110)
-   读/写操作的一致性级别配置 [celery/backends/cassandra.py117-125](https://github.com/celery/celery/blob/4d068b56/celery/backends/cassandra.py#L117-L125)

**查询模板**：后端将 CQL 查询模板定义为常量 [celery/backends/cassandra.py37-64](https://github.com/celery/celery/blob/4d068b56/celery/backends/cassandra.py#L37-L64)：

-   `Q_INSERT_RESULT` —— 带有可选 TTL 的任务结果插入
-   `Q_SELECT_RESULT` —— 按 task\_id 进行任务结果选择
-   `Q_CREATE_RESULT_TABLE` —— 带有聚簇排序 (clustering order) 的表创建
-   `Q_EXPIRES` —— 使用 `USING TTL {0}` 的 TTL 子句模板

**表模式 (Schema)**：后端使用 `Q_CREATE_RESULT_TABLE` 创建表 [celery/backends/cassandra.py50-60](https://github.com/celery/celery/blob/4d068b56/celery/backends/cassandra.py#L50-L60)：

```
CREATE TABLE {table} (
    task_id text,
    status text,
    result blob,
    date_done timestamp,
    traceback blob,
    children blob,
    PRIMARY KEY ((task_id), date_done)
) WITH CLUSTERING ORDER BY (date_done DESC);
```
**连接管理：**

-   `_get_connection()` 通过 `threading.RLock()` 处理线程安全的连接设置 [celery/backends/cassandra.py142-212](https://github.com/celery/celery/blob/4d068b56/celery/backends/cassandra.py#L142-L212)
-   使用 `servers` 列表创建标准集群 [celery/backends/cassandra.py155-159](https://github.com/celery/celery/blob/4d068b56/celery/backends/cassandra.py#L155-L159)
-   AstraDB 云端使用来自 `bundle_path` 的 `secure_connect_bundle` [celery/backends/cassandra.py161-167](https://github.com/celery/celery/blob/4d068b56/celery/backends/cassandra.py#L161-L167)
-   通过 `cassandra.auth` 提供者进行认证 [celery/backends/cassandra.py128-134](https://github.com/celery/celery/blob/4d068b56/celery/backends/cassandra.py#L128-L134)

**操作：**

-   `_store_result()` 执行带有 `buf_t()` 编码的预处理写语句 [celery/backends/cassandra.py214-226](https://github.com/celery/celery/blob/4d068b56/celery/backends/cassandra.py#L214-L226)
-   `_get_task_meta_for()` 使用预处理读语句返回元数据字典 [celery/backends/cassandra.py231-248](https://github.com/celery/celery/blob/4d068b56/celery/backends/cassandra.py#L231-L248)
-   在首次写操作时自动创建结果表 [celery/backends/cassandra.py183-200](https://github.com/celery/celery/blob/4d068b56/celery/backends/cassandra.py#L183-L200)

来源：[celery/backends/cassandra.py37-64](https://github.com/celery/celery/blob/4d068b56/celery/backends/cassandra.py#L37-L64) [celery/backends/cassandra.py86](https://github.com/celery/celery/blob/4d068b56/celery/backends/cassandra.py#L86-L86) [celery/backends/cassandra.py142-248](https://github.com/celery/celery/blob/4d068b56/celery/backends/cassandra.py#L142-L248)

## Elasticsearch 后端实现

`ElasticsearchBackend` 使用 Elasticsearch 提供结果存储，并支持乐观并发控制和时间序列索引。它扩展了 `KeyValueStoreBackend`。

### Elasticsearch 后端架构

```mermaid
flowchart TD
    ElasticsearchBackend["ElasticsearchBackend"]
    KeyValueStoreBackend["KeyValueStoreBackend"]
    elasticsearch_Elasticsearch["elasticsearch.Elasticsearch"]
    elastic_transport["elastic_transport"]
    index["index 属性"]
    doc_type["doc_type 属性"]
    scheme["scheme 属性"]
    host_port["host/port 属性"]
    es_timeout["es_timeout"]
    es_max_retries["es_max_retries"]
    es_save_meta_as_text["es_save_meta_as_text"]
    get_method["get()"]
    _get_method["_get()"]
    set_method["set()"]
    _set_with_state["_set_with_state()"]
    _index_method["_index()"]
    _update_method["_update()"]
    delete_method["delete()"]
    mget_method["mget()"]
    ConflictError["elasticsearch.exceptions.ConflictError"]
    NotFoundError["elasticsearch.exceptions.NotFoundError"]
    seq_no["_seq_no"]
    primary_term["_primary_term"]
    if_seq_no["if_seq_no"]
    if_primary_term["if_primary_term"]
    states_SUCCESS["states.SUCCESS"]
    states_READY_STATES["states.READY_STATES"]
    states_UNREADY_STATES["states.UNREADY_STATES"]
    decode_result["decode_result()"]

    ElasticsearchBackend --> KeyValueStoreBackend
    ElasticsearchBackend --> elasticsearch_Elasticsearch
    ElasticsearchBackend --> elastic_transport
    ElasticsearchBackend --> index
    ElasticsearchBackend --> doc_type
    ElasticsearchBackend --> scheme
    ElasticsearchBackend --> host_port
    ElasticsearchBackend --> es_timeout
    ElasticsearchBackend --> es_max_retries
    ElasticsearchBackend --> es_save_meta_as_text
    ElasticsearchBackend --> get_method
    ElasticsearchBackend --> _get_method
    ElasticsearchBackend --> set_method
    ElasticsearchBackend --> _set_with_state
    ElasticsearchBackend --> _index_method
    ElasticsearchBackend --> _update_method
    ElasticsearchBackend --> delete_method
    ElasticsearchBackend --> mget_method
    _update --> method_ConflictError
    _update --> method_NotFoundError
    _update --> method_seq_no
    _update --> method_primary_term
    _update --> method_if_seq_no
    _update --> method_if_primary_term
    _update --> method_states_SUCCESS
    _update --> method_states_READY_STATES
    _update --> method_states_UNREADY_STATES
    _update --> method_decode_result
```
### Elasticsearch 并发控制

`ElasticsearchBackend` 类 [celery/backends/elasticsearch.py30-284](https://github.com/celery/celery/blob/4d068b56/celery/backends/elasticsearch.py#L30-L284) 实现了先进的并发控制：

**乐观锁实现**：`_update()` 方法 [celery/backends/elasticsearch.py167-231](https://github.com/celery/celery/blob/4d068b56/celery/backends/elasticsearch.py#L167-L231) 使用了 Elasticsearch 的乐观并发控制：

-   从现有文档中检索当前的 `_seq_no` 和 `_primary_term` [celery/backends/elasticsearch.py201-202](https://github.com/celery/celery/blob/4d068b56/celery/backends/elasticsearch.py#L201-L202)
-   使用 `if_primary_term` 和 `if_seq_no` 参数进行更新 [celery/backends/elasticsearch.py211](https://github.com/celery/celery/blob/4d068b56/celery/backends/elasticsearch.py#L211-L211) [celery/backends/elasticsearch.py219](https://github.com/celery/celery/blob/4d068b56/celery/backends/elasticsearch.py#L219-L219)
-   如果序列号/主术语不匹配，则抛出 `ConflictError` [celery/backends/elasticsearch.py226-230](https://github.com/celery/celery/blob/4d068b56/celery/backends/elasticsearch.py#L226-L230)

**状态校验逻辑**：`_update()` 方法实现了状态保护 [celery/backends/elasticsearch.py187-197](https://github.com/celery/celery/blob/4d068b56/celery/backends/elasticsearch.py#L187-L197)：

-   使用 `decode_result()` 解码现有结果以检查当前状态 [celery/backends/elasticsearch.py188](https://github.com/celery/celery/blob/4d068b56/celery/backends/elasticsearch.py#L188-L188)
-   如果现有状态为 `SUCCESS`，则返回 `{'result': 'noop'}` [celery/backends/elasticsearch.py192-194](https://github.com/celery/celery/blob/4d068b56/celery/backends/elasticsearch.py#L192-L194)
-   防止 `UNREADY_STATES` 覆盖 `READY_STATES` [celery/backends/elasticsearch.py195-197](https://github.com/celery/celery/blob/4d068b56/celery/backends/elasticsearch.py#L195-L197)

**文档操作：**

-   `_set_with_state()` 尝试使用 `op_type: 'create'` 进行 `_index()`，若发生冲突则回退到 `_update()` [celery/backends/elasticsearch.py128-142](https://github.com/celery/celery/blob/4d068b56/celery/backends/elasticsearch.py#L128-L142)
-   `_index()` 同时处理常规模式和 doc\_type 模式 [celery/backends/elasticsearch.py147-165](https://github.com/celery/celery/blob/4d068b56/celery/backends/elasticsearch.py#L147-L165)
-   文档结构包含带 UTC 时区的 `@timestamp` 字段 [celery/backends/elasticsearch.py131-133](https://github.com/celery/celery/blob/4d068b56/celery/backends/elasticsearch.py#L131-L133)

**序列化模式：**

-   `es_save_meta_as_text` 配置控制序列化方式 [celery/backends/elasticsearch.py87](https://github.com/celery/celery/blob/4d068b56/celery/backends/elasticsearch.py#L87-L87)
-   `encode()`/`decode()` 方法同时处理文本和对象模式 [celery/backends/elasticsearch.py233-255](https://github.com/celery/celery/blob/4d068b56/celery/backends/elasticsearch.py#L233-L255)
-   对象模式将结果和回溯保留为嵌套对象 [celery/backends/elasticsearch.py239-243](https://github.com/celery/celery/blob/4d068b56/celery/backends/elasticsearch.py#L239-L243)

**异常处理：**

-   `exception_safe_to_retry()` 方法识别可重试的异常 [celery/backends/elasticsearch.py90-102](https://github.com/celery/celery/blob/4d068b56/celery/backends/elasticsearch.py#L90-L102)
-   处理 `ApiError` 状态码 (401, 409, 500, 502, 504) 和 `TransportError` [celery/backends/elasticsearch.py91-101](https://github.com/celery/celery/blob/4d068b56/celery/backends/elasticsearch.py#L91-L101)

来源：[celery/backends/elasticsearch.py87](https://github.com/celery/celery/blob/4d068b56/celery/backends/elasticsearch.py#L87-L87) [celery/backends/elasticsearch.py90-102](https://github.com/celery/celery/blob/4d068b56/celery/backends/elasticsearch.py#L90-L102) [celery/backends/elasticsearch.py128-142](https://github.com/celery/celery/blob/4d068b56/celery/backends/elasticsearch.py#L128-L142) [celery/backends/elasticsearch.py167-231](https://github.com/celery/celery/blob/4d068b56/celery/backends/elasticsearch.py#L167-L231) [celery/backends/elasticsearch.py233-255](https://github.com/celery/celery/blob/4d068b56/celery/backends/elasticsearch.py#L233-L255)

## 后端配置与选择

不同的后端通过 `result_backend` 配置项，使用 URL 协议 (scheme) 或后端名称进行选择：

### 后端 URL 协议

| 后端 | URL 协议 | 示例 |
| --- | --- | --- |
| Redis | `redis://` | `redis://localhost:6379/0` |
| MongoDB | `mongodb://` | `mongodb://user:pass@host/database` |
| Cassandra | `cassandra://` | `cassandra://` (使用配置设置) |
| Elasticsearch | `elasticsearch://` | `elasticsearch://localhost:9200/index` |

### 后端特定配置

**Redis 配置：**

```
result_backend = 'redis://localhost:6379/0'
redis_max_connections = 20
redis_socket_timeout = 30.0
redis_socket_keepalive = True
redis_backend_health_check_interval = 30
```
**MongoDB 配置：**

```
result_backend = 'mongodb://localhost:27017/celery'
mongodb_backend_settings = {
    'database': 'celery',
    'taskmeta_collection': 'celery_taskmeta',
    'groupmeta_collection': 'celery_groupmeta',
    'max_pool_size': 10,
    'options': {'maxPoolSize': 10}
}
```
**Cassandra 配置：**

```
result_backend = 'cassandra://'
cassandra_servers = ['localhost']
cassandra_keyspace = 'celery'
cassandra_table = 'task_results'
cassandra_entry_ttl = 86400  # 1 天 TTL
cassandra_read_consistency = 'LOCAL_QUORUM'
cassandra_write_consistency = 'LOCAL_QUORUM'
cassandra_auth_provider = 'PlainTextAuthProvider'
cassandra_auth_kwargs = {'username': 'user', 'password': 'pass'}
```
**Elasticsearch 配置：**

```
result_backend = 'elasticsearch://localhost:9200/celery'
elasticsearch_timeout = 10
elasticsearch_max_retries = 3
elasticsearch_retry_on_timeout = False
elasticsearch_save_meta_as_text = True
```
来源：[celery/backends/mongodb.py91-117](https://github.com/celery/celery/blob/4d068b56/celery/backends/mongodb.py#L91-L117) [celery/backends/cassandra.py88-141](https://github.com/celery/celery/blob/4d068b56/celery/backends/cassandra.py#L88-L141) [celery/backends/elasticsearch.py75-87](https://github.com/celery/celery/blob/4d068b56/celery/backends/elasticsearch.py#L75-L87)

## 后端实现对比

| 特性 | 缓存 (Cache) 后端 | RPC 后端 |
| --- | --- | --- |
| **基类** | `KeyValueStoreBackend` | `Backend + AsyncBackendMixin` |
| **存储方式** | 外部缓存服务器 | AMQP 消息 |
| **持久性** | 可配置 | 非持久性 |
| **Chord 支持** | ✅ 完全支持 | ❌ 不支持 |
| **组操作** | ✅ 已支持 | ❌ 不支持 |
| **自动过期** | ✅ 基于 TTL | ✅ 消息过期 |
| **原生 Join** | ✅ 批量操作 | ✅ 直接消费 |
| **递增操作** | ✅ 原子递增 | ❌ 不适用 |
| **结果重新加载** | ✅ 已支持 | ❌ 不支持 |
| **异步结果** | 通过轮询 | ✅ 事件驱动 |

### 内存与资源使用

**缓存后端：**

-   使用 `_DUMMY_CLIENT_CACHE = LRUCache(limit=5000)` [celery/backends/cache.py25](https://github.com/celery/celery/blob/4d068b56/celery/backends/cache.py#L25-L25) 进行内存存储。
-   在线程间共享以提高内存效率。
-   通过缓存客户端库支持连接池。

**RPC 后端：**

-   维护 `_out_of_band` 字典以缓冲非预期的结果 [celery/backends/rpc.py124](https://github.com/celery/celery/blob/4d068b56/celery/backends/rpc.py#L124-L124)。
-   使用 `BacklogLimitExceeded` 保护，默认限制为 1000 条消息 [celery/backends/rpc.py232](https://github.com/celery/celery/blob/4d068b56/celery/backends/rpc.py#L232-L232)。
-   通过 `app.thread_oid` 为每个客户端进程提供一个队列 [celery/backends/rpc.py340-342](https://github.com/celery/celery/blob/4d068b56/celery/backends/rpc.py#L340-L342)。

来源：[celery/backends/cache.py23-25](https://github.com/celery/celery/blob/4d068b56/celery/backends/cache.py#L23-L25) [celery/backends/rpc.py232-282](https://github.com/celery/celery/blob/4d068b56/celery/backends/rpc.py#L232-L282) [celery/backends/rpc.py339-342](https://github.com/celery/celery/blob/4d068b56/celery/backends/rpc.py#L339-L342)
